---
layout: post
Categories:  ["tech"]
Description:  " はじめに  FreeBSD 9.1でDTraceを試してみようとと思い、その機能を有効にしてみました。その手順をまとめてみます。 ※ここでは、DTraceの機能を有効にする手順を記載しており、使い方などは記載していません。   DTrac"
Tags: ["FreeBSD", "さくらのVPS", "DTrace"]
date: "2013-05-21T01:47:00+09:00"
title: "FreeBSD 9.1-RELEASEでDTraceの機能を有効にする"
author: "dshimizu"
archive: ["2013"]
draft: "true"
---

<body>
<h4>はじめに</h4>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a> 9.1でDTraceを試してみようとと思い、その機能を有効にしてみました。その手順をまとめてみます。<br>※ここでは、DTraceの機能を有効にする手順を記載しており、使い方などは記載していません。 </p>
<a name="more"></a><h5>DTraceとは</h5>
<p>DTraceとは，<a class="keyword" href="http://d.hatena.ne.jp/keyword/Sun%20Microsystems">Sun Microsystems</a>社(現<a class="keyword" href="http://d.hatena.ne.jp/keyword/Oracle">Oracle</a>社)によって開発された、実行中のプログラムのトレース(解析や診断)を動的に行なうための<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D5%A5%EC%A1%BC%A5%E0%A5%EF%A1%BC%A5%AF">フレームワーク</a>です。DTraceを使うことで、動作中のプログラムの実行状況をリアルタイムに確認することができるため、その時のHWリソースの使用状況や<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%DC%A5%C8%A5%EB%A5%CD%A5%C3%A5%AF">ボトルネック</a>の特定、それによるチューニングなどを行えます。 </p>
<ul>  <li><a href="http://docs.oracle.com/cd/E19253-01/819-5488/">DTrace ユーザーガイド ー Oracle Document</a></li>
</ul>
<p>ライセンス形態は<a class="keyword" href="http://d.hatena.ne.jp/keyword/Sun%20Microsystems">Sun Microsystems</a>社(現<a class="keyword" href="http://d.hatena.ne.jp/keyword/Oracle">Oracle</a>社)が策定した<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D5%A5%EA%A1%BC%A5%BD%A5%D5%A5%C8%A5%A6%A5%A7%A5%A2">フリーソフトウェア</a>向けのCommon Development and Distribution Licenseというもので、ライセンス上問題ないことから<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a>では7.1-RELEASEから取り込まれていました。当時は<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AB%A1%BC%A5%CD%A5%EB">カーネル</a>のみのサポートだったようですが、<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a> 9系からは<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%E6%A1%BC%A5%B6%A5%E9%A5%F3%A5%C9">ユーザランド</a>もサポートされたものが組み込まれているようです。 </p>
<h4>DTrace機能の有効化</h4>
<p>デフォルトではDTraceの機能は無効になっていますので、有効にしてみます。 </p>
<h5>環境</h5>
<p>環境は以下の通りです。 </p>
<table>
<tr>  <td bgcolor="#cccccc">プラットフォーム</td>  <td>さくらの<a class="keyword" href="http://d.hatena.ne.jp/keyword/VPS">VPS</a>(2Gモデル)</td>
</tr>
<tr>  <td bgcolor="#cccccc">OS</td>  <td>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a> 9.1-RELEASE <a class="keyword" href="http://d.hatena.ne.jp/keyword/amd64">amd64</a> (64bit)</td>
</tr>
</table> <h5>事前準備</h5>
<p>前述の通り、DTraceは標準では有効になっていません。 </p>
<pre class="terminal">  # dtrace -l | head dtrace: failed to initialize dtrace: DTrace device not available on system  
</pre>
<p>DTraceを有効にするには、<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AB%A1%BC%A5%CD%A5%EB">カーネル</a>のコンフィグレーションファイルに必要なオプションを追記し、<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AB%A1%BC%A5%CD%A5%EB">カーネル</a>の再構築を行う必要があります。公式手順を参考に<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AB%A1%BC%A5%CD%A5%EB">カーネル</a>の再構築を実施します。 </p>
<ul>  <li><a href="http://www.freebsd.org/doc/ja/books/handbook/kernelconfig-building.html">カスタムカーネルの構築とインストール</a></li>
</ul>
<p>既存の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AB%A1%BC%A5%CD%A5%EB">カーネル</a>コンフィグレーションファイル(GENERIC)を直接編集してはいけませんので、事前準備として、既存の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AB%A1%BC%A5%CD%A5%EB">カーネル</a>コンフィグレーションファイル(GENERIC)を適当な別名(ここではGENERIC-CUSTOM)でコピーして、それをDTraceを有効にするための新<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AB%A1%BC%A5%CD%A5%EB">カーネル</a>コンフィグレーションファイルとして利用します。ファイルの作成先はどこでも構いませんが、公式手順通りに/root/kernelsとしています。新<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AB%A1%BC%A5%CD%A5%EB">カーネル</a>コンフィグレーションファイルを/usr/src/sys/<a class="keyword" href="http://d.hatena.ne.jp/keyword/amd64">amd64</a>/confに<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B7%A5%F3%A5%DC%A5%EA%A5%C3%A5%AF%A5%EA%A5%F3%A5%AF">シンボリックリンク</a>として作成します。<br></p>
<pre class="terminal">  # mkdir /root/kernels   
</pre>
<p></p>
<pre class="terminal">  # cd /usr/src/sys/amd64/conf   
</pre>
<pre class="terminal">  # cp -p GENERIC /root/kernels/GENERIC-CUSTOM  
</pre>
<pre class="terminal">  # ln -s /root/kernels/GENERIC-CUSTOM  
</pre>
<pre class="terminal">  # ls -l /usr/src/sys/amd64/conf total 37 -rw-r--r--  1 root  wheel    491  1月  1 23:38 DEFAULTS -rw-r--r--  1 root  wheel  14189  1月  1 23:38 GENERIC lrwxr-xr-x  1 root  wheel     28  5月 19 21:27 GENERIC-CUSTOM -&gt; /root/kernels/GENERIC-CUSTOM -rw-r--r--  1 root  wheel    791  1月  1 23:38 GENERIC.hints -rw-r--r--  1 root  wheel    143  1月  1 23:38 Makefile -rw-r--r--  1 root  wheel  16552  1月  1 23:38 NOTES -rw-r--r--  1 root  wheel    646  1月  1 23:38 XENHVM  
</pre>
<h5>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AB%A1%BC%A5%CD%A5%EB">カーネル</a>コンフィグレーションファイルへDTraceオプションの追加</h5>
<p>公式手順を参考に、新<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AB%A1%BC%A5%CD%A5%EB">カーネル</a>コンフィグレーションファイル(GENERIC-CUSTOM)にDTraceを有効にするための<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AB%A1%BC%A5%CD%A5%EB">カーネル</a>オプションを追加します。 </p>
<ul>  <li><a href="https://wiki.freebsd.org/DTrace">DTrace on FreeBSD</a></li>
</ul>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a> 9系の場合は以下のオプションを追記します。 </p>
<pre class="terminal">  # vim /root/kernels/GENERIC-CUSTOM … ### USE DTrace ### options         KDTRACE_HOOKS options         DDB_CTF options         KDTRACE_FRAME makeoptions     WITH_CTF=1  
</pre>
<h5>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AB%A1%BC%A5%CD%A5%EB">カーネル</a>の再構築とインストール</h5>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AB%A1%BC%A5%CD%A5%EB">カーネル</a>の再構築(<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B3%A5%F3%A5%D1%A5%A4%A5%EB">コンパイル</a>)を実行します。KERNCONFオプションに、新<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AB%A1%BC%A5%CD%A5%EB">カーネル</a>コンフィグレーションファイル(ここではGENERIC-CUSTOM)を指定します。 </p>
<pre class="terminal">  # cd /usr/src  
</pre>
<pre class="terminal">  # make buildkernel KERNCONF=GENERIC-CUSTOM -------------------------------------------------------------- &gt;&gt;&gt; Kernel build for GENERIC-CUSTOM started on Sun May 19 22:35:01 JST 2013 -------------------------------------------------------------- ===&gt; GENERIC-CUSTOM … … … objcopy --only-keep-debug zlib.ko.debug zlib.ko.symbols objcopy --strip-debug --add-gnu-debuglink=zlib.ko.symbols zlib.ko.debug zlib.ko -------------------------------------------------------------- &gt;&gt;&gt; Kernel build for GENERIC-CUSTOM completed on Sun May 19 22:10:11 JST 2013 --------------------------------------------------------------  
</pre>
<p>新<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AB%A1%BC%A5%CD%A5%EB">カーネル</a>をインストールします。 </p>
<pre class="terminal">  # make installkernel KERNCONF=GENERIC-CUSTOM  
</pre>
<p>※ここで、新<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AB%A1%BC%A5%CD%A5%EB">カーネル</a>は /boot/kernelに/boot/kernel/kernelという名前で保存され、古い<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AB%A1%BC%A5%CD%A5%EB">カーネル</a>は/boot/kernel.old/kernelという名前で保存されます。  </p>
<pre class="terminal">  # ls -l /boot/kernel* /boot/kernel: total 376898 …  /boot/kernel.old: total 357491 …  
</pre>
<p>システムを再起動して、新<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AB%A1%BC%A5%CD%A5%EB">カーネル</a>で起動します。 </p>
<pre class="terminal">  # shutdown -r now  
</pre>
<h5>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AB%A1%BC%A5%CD%A5%EB">カーネル</a>モジュールの読み込み</h5>
<p>システムを再起動しても、この時点ではまだDTraceは有効化されていません。 </p>
<pre class="terminal">  # dtrace -l | head dtrace: failed to initialize dtrace: DTrace device not available on system  
</pre>
<p>再起動後にDTrace関連の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AB%A1%BC%A5%CD%A5%EB">カーネル</a>モジュールが作成されます。dtraceall.koモジュールを読み込むことで、DTrace関連のモジュールが全て読み込まれ、DTraceの機能が有効化されます。 </p>
<pre class="terminal">  # kldload dtraceall  
</pre>
<p></p>
<h5>確認</h5>DTraceが有効になっていることを確認します。 <pre class="terminal">  # dtrace -l     ID   PROVIDER            MODULE                          FUNCTION NAME     1     dtrace                                                     BEGIN     2     dtrace                                                     END     3     dtrace                                                     ERROR     4   dtmalloc                                       nfsclient_req malloc     5   dtmalloc                                       nfsclient_req free … … … 55380    profile                                                     tick-1 55381    profile                                                     tick-10 55382    profile                                                     tick-100 55383    profile                                                     tick-500 55384    profile                                                     tick-1000 55385    profile                                                     tick-5000  
</pre>
<p>以上で、DTraceの機能が有効化ができました。 </p>
<h5>※<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%E6%A1%BC%A5%B6%A5%E9%A5%F3%A5%C9">ユーザランド</a>DTraceの設定(参考)</h5>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%E6%A1%BC%A5%B6%A5%E9%A5%F3%A5%C9">ユーザランド</a>DTraceをより有効に活用できるように以下の設定をしておきます。これによって、<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%BF%A5%C3%A5%AF%A5%C8%A5%EC%A1%BC%A5%B9">スタックトレース</a>が動作し、より多くの情報を表示できるようになります。 </p>
<pre class="terminal">  # vim /etc/make.conf STRIP= CFLAGS+=-fno-omit-frame-pointer WITH_CTF=1  
</pre>
<p>ベースシステムを再構築します。 </p>
<pre class="terminal">  # cd /usr/src  
</pre>
<pre class="terminal">  # make buildworld  
</pre>
<pre class="terminal">  # shutdown -r now  
</pre>
<pre class="terminal">  # boot -s  
</pre>
<p>ベースシステムをインストールします。 </p>
<pre class="terminal">  # make installworld  
</pre>
<p>システムを再起動して、さくらの<a class="keyword" href="http://d.hatena.ne.jp/keyword/VPS">VPS</a>コン<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C8%A5%ED%A1%BC%A5%EB">トロール</a>パネルからシングルユーザモードで起動します。 </p>
<pre class="terminal">  # shutdown -r now  
</pre>
<p>さくらのコン<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C8%A5%ED%A1%BC%A5%EB">トロール</a>パネル上から<a class="keyword" href="http://d.hatena.ne.jp/keyword/VNC">VNC</a>コンソールを開き、以下の画面で「6」キーを入力します。"[S]ingle User"項目がOnになったことを確認して、起動させます。 </p>
<div align="center"><a href="http://2.bp.blogspot.com/-XjJ4mhHUbbs/UZl9mvF8RwI/AAAAAAAAAU8/cIOAgTxJ4w4/s1600/FreeBSD_Boot.png" imageanchor="1"><img border="0" src="https://cdn-ak.f.st-hatena.com/images/fotolife/d/dshimizu/20220322/20220322113745.png"></a></div>
<p>以下はシングルユーザモードでのオペレーションとなります。 </p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D5%A5%A1%A5%A4%A5%EB%A5%B7%A5%B9%A5%C6%A5%E0">ファイルシステム</a>を読み書き可能な状態にします。 </p>
<pre class="terminal">  # mount -u /  
</pre>
<p>ベースシステムのインストールを行います。 </p>
<pre class="terminal">  # cd /usr/src  
</pre>
<pre class="terminal">  # make installworld  
</pre>
<p>以上で、<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%E6%A1%BC%A5%B6%A5%E9%A5%F3%A5%C9">ユーザランド</a>DTraceの機能を拡張できました。 </p>
<h4>おわりに</h4>
<p>ここでは、DTraceを有効化する手順を記載しました。実際の使用法や動作についてはまだきちんと確認できていませんが、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Solaris">Solaris</a>でも導入されているこの機能を有効に使っていければと思います。 </p>
</body>

<!-- more -->


