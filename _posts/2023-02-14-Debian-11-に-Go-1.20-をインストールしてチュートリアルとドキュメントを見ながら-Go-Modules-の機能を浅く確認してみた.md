---
title: "Debian 11 に Go 1.20 をインストールしてチュートリアルとドキュメントを見ながら Go Modules の機能を浅く確認してみた"
date: 2023-02-14
slug: "Debian 11 に Go 1.20 をインストールしてチュートリアルとドキュメントを見ながら Go Modules の機能を浅く確認してみた"
category: blog
tags: [Go]
---
<h2 id="はじめに">はじめに</h2>

<p><a class="keyword" href="https://d.hatena.ne.jp/keyword/Debian">Debian</a> 11 を使い始めていて、Go を apt でインストールしたのですが、バージョンが 1.15.15 と古いものでした。</p>

<pre class="code shell" data-lang="shell" data-unlink>% go version
go version go1.15.15 linux/amd64</pre>


<p>なので新しいバージョンのものをインストールしてみることにしました。
goenv とかを使う手もありますが、特にこだわりもないので<a class="keyword" href="https://d.hatena.ne.jp/keyword/%A5%BD%A1%BC%A5%B9%A5%B3%A1%BC%A5%C9">ソースコード</a>からインストールしてみました。</p>

<h2 id="環境">環境</h2>

<p>環境は以下のようなものです。</p>

<pre class="code shell" data-lang="shell" data-unlink>% lsb_release -a
No LSB modules are available.
Distributor ID: Debian
Description:    Debian GNU/Linux 11 (bullseye)
Release:    11
Codename:   bullseye</pre>




<pre class="code shell" data-lang="shell" data-unlink>% uname -vos
Linux #1 SMP Debian 5.10.136-1 (2022-08-13) GNU/Linux</pre>


<h2 id="インストール">インストール</h2>

<p>ソースを取得して <code>/tmp/</code> に配置します。</p>

<pre class="code shell" data-lang="shell" data-unlink>% wget https://go.dev/dl/go1.20.linux-amd64.tar.gz -P /tmp/</pre>


<p>ローカルにインストールするので、ホーム<a class="keyword" href="https://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リに <code>.local</code> <a class="keyword" href="https://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リを作成します。</p>

<pre class="code shell" data-lang="shell" data-unlink>% mkdir $HOME/.local</pre>


<p>取得したソースを <code>~/.local</code> に展開します。</p>

<pre class="code shell" data-lang="shell" data-unlink>% tar -C $HOME/.local -xzf go1.20.linux-amd64.tar.gz</pre>


<p><code>~/.local/go/bin</code> にバイナリが配置されるので、PATH を通します。</p>

<pre class="code shell" data-lang="shell" data-unlink>% export PATH=$PATH:$HOME/.local/go/bin</pre>


<p>これで <code>go</code> コマンドが実行可能になりました。</p>

<pre class="code shell" data-lang="shell" data-unlink>% go version
go version go1.20 linux/amd64</pre>


<h3 id="Go-関係の環境変数の設定">Go 関係の<a class="keyword" href="https://d.hatena.ne.jp/keyword/%B4%C4%B6%AD%CA%D1%BF%F4">環境変数</a>の設定</h3>

<p>Go 関係の<a class="keyword" href="https://d.hatena.ne.jp/keyword/%B4%C4%B6%AD%CA%D1%BF%F4">環境変数</a>がいくつかあります。
<code>go env</code> コマンドで確認できます。</p>

<pre class="code shell" data-lang="shell" data-unlink>% go env
GO111MODULE=&#34;&#34;
GOARCH=&#34;amd64&#34;
GOBIN=&#34;&#34;
GOCACHE=&#34;/home/hogehoge/.cache/go-build&#34;
GOENV=&#34;/home/hogehoge/.config/go/env&#34;
GOEXE=&#34;&#34;
GOEXPERIMENT=&#34;&#34;
GOFLAGS=&#34;&#34;
GOHOSTARCH=&#34;amd64&#34;
GOHOSTOS=&#34;linux&#34;
GOINSECURE=&#34;&#34;
GOMODCACHE=&#34;/home/hogehoge/go/pkg/mod&#34;
GONOPROXY=&#34;&#34;
GONOSUMDB=&#34;&#34;
GOOS=&#34;linux&#34;
GOPATH=&#34;/home/hogehoge/go&#34;
GOPRIVATE=&#34;&#34;
GOPROXY=&#34;https://proxy.golang.org,direct&#34;
GOROOT=&#34;/home/hogehoge/.local/go&#34;
GOSUMDB=&#34;sum.golang.org&#34;
GOTMPDIR=&#34;&#34;
GOTOOLDIR=&#34;/home/hogehoge/.local/go/pkg/tool/linux_amd64&#34;
GOVCS=&#34;&#34;
GOVERSION=&#34;go1.20&#34;
GCCGO=&#34;gccgo&#34;
GOAMD64=&#34;v1&#34;
AR=&#34;ar&#34;
CC=&#34;gcc&#34;
CXX=&#34;g++&#34;
CGO_ENABLED=&#34;0&#34;
GOMOD=&#34;/home/hogehoge/workspcace/go-tutorial/hello/go.mod&#34;
GOWORK=&#34;&#34;
CGO_CFLAGS=&#34;-O2 -g&#34;
CGO_CPPFLAGS=&#34;&#34;
CGO_CXXFLAGS=&#34;-O2 -g&#34;
CGO_FFLAGS=&#34;-O2 -g&#34;
CGO_LDFLAGS=&#34;-O2 -g&#34;
PKG_CONFIG=&#34;pkg-config&#34;
GOGCCFLAGS=&#34;-fPIC -m64 -fno-caret-diagnostics -Qunused-arguments -Wl,--no-gc-sections -fmessage-length=0 -fdebug-prefix-map=/tmp/go-build308324398=/tmp/go-build -gno-record-gcc-switches&#34;</pre>


<p>メジャーなものを見てみます。
まず `GOROOT｀は go のインストール先の PATH で、今回のやり方だと以下のようになっています。</p>

<pre class="code shell" data-lang="shell" data-unlink>% go env GOROOT
/home/hogehoge/.local/go</pre>


<p><code>GOPATH</code> は外部モジュール等が配置される<a class="keyword" href="https://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リです。
ドキュメントを見ると Workspace だという記述がありますが、詳しくはわかっていませんが、古いバージョンの Go の環境だと <code>$GOPATH/src</code> 配下にモジュールパッケージとなる<a class="keyword" href="https://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リを配置して開発するというような形だったようです。
今は Go Modules がよしなにやってくれるようになり、外部モジュールも <code>$GOPATH/pkg</code> が使われ、 <code>$GOPATH/src</code> はなくても良いようなので、あまり意識せずデフォルト値を用いるので良さそうです。</p>

<ul>
<li><a href="https://go.dev/doc/gopath_code#GOPATH">How to Write Go Code (with GOPATH) - The Go Programming Language</a></li>
</ul>


<p>デフォルトでは <code>$HOME/go</code> です。</p>

<pre class="code shell" data-lang="shell" data-unlink>% go env GOPATH
/home/hogehoge/go</pre>


<h2 id="チュートリアルをやってGo-Modules-を学ぶ"><a class="keyword" href="https://d.hatena.ne.jp/keyword/%A5%C1%A5%E5%A1%BC%A5%C8%A5%EA%A5%A2%A5%EB">チュートリアル</a>をやってGo Modules を学ぶ</h2>

<p>以下の<a class="keyword" href="https://d.hatena.ne.jp/keyword/%A5%C1%A5%E5%A1%BC%A5%C8%A5%EA%A5%A2%A5%EB">チュートリアル</a>をやって Go Modules の理解を深めてみます。</p>

<ul>
<li><a href="https://go.dev/doc/tutorial/call-module-code">Call your code from another module - The Go Programming Language</a></li>
<li><a href="https://go.dev/doc/tutorial/create-module">Tutorial: Create a Go module - The Go Programming Language</a></li>
</ul>


<h3 id="モジュールとパッケージバイナリ関連">モジュールとパッケージ、バイナリ関連</h3>

<p>雰囲気で使ってましたが、Go Modules は Go 1.16 から導入され始めた新しいモジュール管理ツールで、 <code>go.mod</code> と <code>go.sum</code> を用いて依存しているモジュールの管理を行う機能のようです。</p>

<ul>
<li><a href="https://go.dev/blog/go116-module-changes">New module changes in Go 1.16 - The Go Programming Language</a></li>
<li><a href="https://go.dev/ref/mod">Go Modules Reference - The Go Programming Language</a></li>
</ul>


<p>上記のドキュメントによると、モジュールは配布されるパッケージ群で、バージョン管理<a class="keyword" href="https://d.hatena.ne.jp/keyword/%A5%EA%A5%DD%A5%B8%A5%C8%A5%EA">リポジトリ</a>またはモジュール プロキシ サーバーから直接ダウンロードできるものを指すようで、パッケージはモジュール内の<a class="keyword" href="https://d.hatena.ne.jp/keyword/%A5%BD%A1%BC%A5%B9%A5%B3%A1%BC%A5%C9">ソースコード</a>のファイル群を指すようです。</p>

<p>元々 <code>go get</code> でモジュールの管理もバイナリインストールも行われていたようですが、機能が分割され、今のところ Go Modulesの管理のための <code>go get</code>、ツールなどのバイナリインストールの <code>go install</code> という使い分けになっているようです。</p>

<p><code>go get</code> でダウンロードされたモジュール類はモジュールキャッシュと呼ばれる<a class="keyword" href="https://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リに配置されるようで、デフォルトでは <code>$GOPATH/go/pkg/mod</code> に配置されます。
コードの中の import 文で読み込まれるモジュールはこの<a class="keyword" href="https://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リ上のファイルを見ているようです。</p>

<ul>
<li><a href="https://go.dev/ref/mod#module-cache">Go Modules Reference - The Go Programming Language</a></li>
</ul>


<p> <code>go install</code> で取得されたものは  <code>$GOPATH/go/bin</code> に配置され、これらは実行ファイルとして利用できます。</p>

<h3 id="モジュールの作成">モジュールの作成</h3>

<p>Go のインストールは終わりました。このままでも簡単なコードであれば動かすことはできますが、標準パッケージを用いたものしか動かせません。
外部モジュールのパッケージを利用する場合は、モジュールを作成して、外部モジュールのパッケージを読み込めるようにする必要があります。
パッケージ管理ツールはかつてはいろいろあったようですが、今は Go Modules を使うのが一般的なようです。</p>

<p>適当な作業<a class="keyword" href="https://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リを作って移動します。ここでは <code>workspaces</code> という名前の<a class="keyword" href="https://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リにしています。</p>

<pre class="code shell" data-lang="shell" data-unlink>% mkdir workspaces &amp;&amp; cd workspaces</pre>


<p><code>workspaces</code> 以下の<a class="keyword" href="https://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リを作成します。</p>

<pre class="code shell" data-lang="shell" data-unlink>% mkdir greetings &amp;&amp; cd greetings</pre>


<p>モジュールの初期化を行います。
<code>localhost/greetings</code> の部分はモジュールパスと呼ばれる、モジュールの名前を表すもので、通常は<a class="keyword" href="https://d.hatena.ne.jp/keyword/%A5%BD%A1%BC%A5%B9%A5%B3%A1%BC%A5%C9">ソースコード</a>が保持される<a class="keyword" href="https://d.hatena.ne.jp/keyword/%A5%EA%A5%DD%A5%B8%A5%C8%A5%EA">リポジトリ</a>の場所を指定するようです。
ここでは手元で試す分には何でも良いので <code>localhost/greetings</code>としています。</p>

<ul>
<li><a href="https://go.dev/ref/mod#module-path">Go Modules Reference - The Go Programming Language</a></li>
</ul>


<p>外部公開する場合はその<a class="keyword" href="https://d.hatena.ne.jp/keyword/%A5%BD%A1%BC%A5%B9%A5%B3%A1%BC%A5%C9">ソースコード</a>を配置する<a class="keyword" href="https://d.hatena.ne.jp/keyword/%A5%EA%A5%DD%A5%B8%A5%C8%A5%EA">リポジトリ</a>の場所を指定します。<a class="keyword" href="https://d.hatena.ne.jp/keyword/GitHub">GitHub</a> に公開する場合は <code>github.com/aaaa</code>といった感じで、<a class="keyword" href="https://d.hatena.ne.jp/keyword/%C6%C8%BC%AB%A5%C9%A5%E1%A5%A4%A5%F3">独自ドメイン</a>の場所で公開する場合はその<a class="keyword" href="https://d.hatena.ne.jp/keyword/%A5%C9%A5%E1%A5%A4%A5%F3">ドメイン</a>名とパスを記載し、その名前を用いてダウンロード可能となるようにしておく必要があるようです。</p>

<pre class="code shell" data-lang="shell" data-unlink>% go mod init localhost/greetings</pre>


<p><code>go.mod</code> というファイルが作成されます。</p>

<pre class="code shell" data-lang="shell" data-unlink>% ls
go.mod</pre>


<p>初期状態の <code>go.mod</code> の中身を見るとこんな感じです。</p>

<pre class="code lang-go" data-lang="go" data-unlink>module localhost/greetings

<span class="synStatement">go</span> <span class="synConstant">1.20</span>
</pre>


<p>一旦 <code>localhost/greetings</code> のモジュールはこの状態にしておきます。</p>

<h3 id="別モジュールからのコードの呼び出し">別モジュールからのコードの呼び出し</h3>

<p>別のモジュール <code>localhost/hello</code> を作って <code>localhost/greetings</code> のモジュールを呼び出してみます。</p>

<p>一旦作業<a class="keyword" href="https://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リへ移動します。</p>

<pre class="code shell" data-lang="shell" data-unlink>% pwd
/path/to/workspaces</pre>


<p><code>hello</code> という<a class="keyword" href="https://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リを作成します。</p>

<pre class="code shell" data-lang="shell" data-unlink>% mkdir hello </pre>


<p>この時点で、以下のような<a class="keyword" href="https://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リ・ファイル構成になります。</p>

<pre class="code shell" data-lang="shell" data-unlink>% tree -L 2

├── greetings
│   ├── go.mod
│   └── greetings.go
└── hello

2 directories, 2 files</pre>


<p>hello <a class="keyword" href="https://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リへ移動します。</p>

<pre class="code shell" data-lang="shell" data-unlink>% cd hello</pre>


<p>モジュールの初期化を行います。
今度は <code>localhost/hello</code> というモジュールパスにします。</p>

<pre class="code shell" data-lang="shell" data-unlink>% go mod init localhost/hello</pre>


<p><code>go.mod</code> はこんな感じになります。</p>

<pre class="code lang-go" data-lang="go" data-unlink>module localhost/hello

<span class="synStatement">go</span> <span class="synConstant">1.20</span>
</pre>


<p>以下のようなコードを配置します。
<code>greetings.Hello(...)</code> が <code>greetings</code> モジュール内の関数です。 <code>import</code> 文で <code>"localhost/greetings"</code> を指定してあります。</p>

<pre class="code lang-go" data-lang="go" data-unlink><span class="synStatement">package</span> main

<span class="synStatement">import</span> (
    <span class="synConstant">&quot;fmt&quot;</span>

    <span class="synConstant">&quot;localhost/greetings&quot;</span>
)

<span class="synStatement">func</span> main() {
    <span class="synComment">// Get a greeting message and print it.</span>
    message := greetings.Hello(<span class="synConstant">&quot;Gopher&quot;</span>)
    fmt.Println(message)
}
</pre>


<p>この状態で実行すると <code>greetings</code> モジュールのパッケージが見つからないというエラーになります。</p>

<pre class="code shell" data-lang="shell" data-unlink>% go run main.go
main.go:6:2: package localhost/greetings is not in GOROOT (/path/to/.local/go/src/localhost/greetings)</pre>


<p><code>localhost/greetings</code> モジュールを参照できるよう、 <code>go.mod</code> を編集します。
<code>go mod edit</code> で編集できるので、 <code>localhost/greetings</code> のモジュールを <code>hello</code> モジュールから見た<a class="keyword" href="https://d.hatena.ne.jp/keyword/%C1%EA%C2%D0%A5%D1%A5%B9">相対パス</a> <code>../greetings</code> になるように指定します。</p>

<pre class="code" data-lang="" data-unlink>% go mod edit -replace localhost/greetings=../greetings</pre>


<p>この状態で <code>go.mod</code> は以下のようになります。</p>

<pre class="code lang-go" data-lang="go" data-unlink>module localhost/hello

<span class="synStatement">go</span> <span class="synConstant">1.20</span>

replace localhost/greetings =&gt; ../greetings
</pre>


<p>この状態で実行してもまだエラーになります。</p>

<pre class="code lang-go" data-lang="go" data-unlink>% <span class="synStatement">go</span> run main.<span class="synStatement">go</span>
main.<span class="synStatement">go</span>:<span class="synConstant">6</span>:<span class="synConstant">2</span>: module localhost/greetings provides <span class="synStatement">package</span> localhost/greetings and is replaced but not required; to add it:
    <span class="synStatement">go</span> get localhost/greetings
</pre>


<p><code>go get</code> しろと言われますが、<code>go mod tidy</code> で調整します。
<code>go mod tidy</code> は、簡単に言うと<a class="keyword" href="https://d.hatena.ne.jp/keyword/%A5%BD%A1%BC%A5%B9%A5%B3%A1%BC%A5%C9">ソースコード</a>で使われているモジュールと <code>go.mod</code> に記載されているファイルが同じになるよう追加・削除してくれます。</p>

<ul>
<li><a href="https://go.dev/ref/mod#go-mod-tidy">Go Modules Reference - The Go Programming Language</a></li>
</ul>


<pre class="code shell" data-lang="shell" data-unlink>% go mod tidy
go: found localhost/greetings in localhost/greetings v0.0.0-00010101000000-000000000000</pre>


<p>この状態で <code>go.mod</code> は以下のようになります。</p>

<pre class="code lang-go" data-lang="go" data-unlink>module localhost/hello

<span class="synStatement">go</span> <span class="synConstant">1.20</span>

replace localhost/greetings =&gt; ../greetings

require localhost/greetings v0.<span class="synConstant">0.0</span>-<span class="synConstant">00010101000000</span>-<span class="synConstant">000000000000</span>
</pre>


<p>これで実行できるようになりました。</p>

<pre class="code shell" data-lang="shell" data-unlink>% go run main.go
Hi, Gopher. Welcome!</pre>


<h2 id="まとめ">まとめ</h2>

<p>Go 1.20 のインストールと Go Modules 周りを設定しながらドキュメントを眺めて浅く理解するように努めました。
Go Modulesは公式ドキュメントがあるものの、ネットで検索すると他の情報が上位にヒットしてなかなか辿り着けなかったので、改めてドキュメントも確認できてよかったです。</p>

<h2 id="参考">参考</h2>

<ul>
<li><a href="https://go.dev/doc/gopath_code#GOPATH">How to Write Go Code (with GOPATH) - The Go Programming Language</a></li>
<li><a href="https://go.dev/ref/mod">Go Modules Reference - The Go Programming Language</a></li>
<li><a href="https://go.dev/doc/go-get-install-deprecation">Deprecation of &#39;go get&#39; for installing executables - The Go Programming Language</a></li>
<li><a href="https://github.com/golang/go/issues/40276">cmd/go: &#39;go install&#39; should install executables in module mode outside a module &middot; Issue #40276 &middot; golang/go &middot; GitHub</a></li>
<li><a href="https://go.dev/blog/go116-module-changes">New module changes in Go 1.16 - The Go Programming Language</a></li>
</ul>


