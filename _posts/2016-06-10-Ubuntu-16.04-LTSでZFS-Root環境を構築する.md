---
layout: post
Categories:  ["tech"]
Description:  " はじめに  Ubuntu 16.04 LTSでZFSが正式にサポートされました。       Ubuntu 16.04 Root on ZFS · zfsonlinux/zfs Wiki   さくらのVPS(KVM環境)にUbuntu 1"
Tags: ["tech", "Ubuntu", "ZFS"]
date: "2016-06-10T00:18:00+09:00"
title: "Ubuntu 16.04 LTSでZFS Root環境を構築する"
author: "dshimizu"
archive: ["2016"]
draft: "true"
---

<body>
<h3>はじめに</h3>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a> 16.04 LTSで<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a>が正式にサポートされました。</p>

<ul>
    <li><a href="https://github.com/zfsonlinux/zfs/wiki/Ubuntu-16.04-Root-on-ZFS" target="_blank" rel="noopener noreferrer">Ubuntu 16.04 Root on ZFS · zfsonlinux/zfs Wiki</a></li>
</ul>


<p>さくらの<a class="keyword" href="http://d.hatena.ne.jp/keyword/VPS">VPS</a>(<a class="keyword" href="http://d.hatena.ne.jp/keyword/KVM">KVM</a>環境)に<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a> 16.04 LTSで<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a> Root環境を構築してみたのでその手順のメモです。</p>
</body>

<!-- more -->

<body>
<h3>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a> 16.04 Root on <a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a>構築手順</h3>


<h4>環境</h4>


<table>
<tbody>
<tr>
<th>OS</th>
<td>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a> 16.04 LTS(4.4.0-21-generic)</td>
</tr>
<tr>
<th>プラットフォーム</th>
<td>さくらの<a class="keyword" href="http://d.hatena.ne.jp/keyword/VPS">VPS</a>
</td>
</tr>
</tbody>
</table>


<h4>事前準備</h4>


<p>まず、事前準備を行います。</p>

<h5>Live CDの取得</h5>


<p>64-bit <a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a> 16.04 Xenial Live CDをダウンロードします。</p>

<ul>
    <li><a href="http://ftp.jaist.ac.jp/pub/Linux/ubuntu-releases/16.04/ubuntu-16.04-desktop-amd64.iso" target="_blank" rel="noopener noreferrer">http://ftp.jaist.ac.jp/pub/Linux/ubuntu-releases/16.04/ubuntu-16.04-desktop-amd64.iso</a></li>
</ul>


<h5>ISOイメージのアップロード</h5>


<p>ダウンロードしたISOイメージをさくらの<a class="keyword" href="http://d.hatena.ne.jp/keyword/VPS">VPS</a>のISOイメージアップロード機能を使ってアップロードしておきます。</p>

<ul>
    <li><a href="https://help.sakura.ad.jp/app/answers/detail/a_id/2405/~/iso%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB" target="_blank" rel="noopener noreferrer">ISOイメージインストール｜さくらインターネット公式サポートサイト</a></li>
</ul>


<h5>Live CDの起動</h5>


<p>さくらの<a class="keyword" href="http://d.hatena.ne.jp/keyword/VPS">VPS</a>のカスタムイメージインストール機能を使って先ほどアップロードした<a class="keyword" href="http://d.hatena.ne.jp/keyword/ubuntu">ubuntu</a>-16.04-desktop-<a class="keyword" href="http://d.hatena.ne.jp/keyword/amd64">amd64</a>.isoからBootします。</p>

<p>Boot後以下のような画面になります。しばらく待てばWelcom画面が表示されます。</p>

<p><img src="../wp-content/uploads/2016/07/Ubuntu_16.04_BootLiveCD1.jpg"></p>

<p>以下の画面で「<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a>を試す」を選択します。</p>

<p><img src="../wp-content/uploads/2016/07/Ubuntu_16.04_BootLiveCD2.jpg"></p>

<p>起動後、ターミナルを起動します。
<code>Ctrl</code>+<code>Alt</code>+<code>t</code>でターミナルを起動できます。
<a class="keyword" href="http://d.hatena.ne.jp/keyword/ubuntu">ubuntu</a>ユーザでログインされています。</p>

<p><img src="../wp-content/uploads/2016/07/Ubuntu_16.04_BootLiveCD3.png"></p>

<p>さくらの<a class="keyword" href="http://d.hatena.ne.jp/keyword/VPS">VPS</a>に割り当てられているネットワーク情報を元に<code>/etc/network/interfaces</code>へ設定します。</p>

<pre class="terminal"> $ sudo vi /etc/network/interfaces
 </pre>


<p>以下のように記述します。(環境に合わせて読み替えてください。)</p>

<pre class="terminal"> # The primary network interface
auto ens3
iface ens3 inet static
    address xxx.xxx.xxx.xxx
    netmask 255.255.xxx.0
    network xxx.xxx.xxx.0
    broadcast xxx.xxx.xxx.255
    gateway xxx.xxx.xxx.xxx
    dns-nameservers xxx.xxx.xxx.xxx xxx.xxx.xxx.xxx
    dns-search sakura.ne.jp
 </pre>


<p>ネットワークインタフェースを有効化します。</p>

<pre class="terminal"> $ sudo ifup ens3
 </pre>


<h5>OpenSSHのインストール</h5>


<p>このままコンソールからの操作だとコマンドのコピペができず不便なので、外部からログインして作業できるようにOpenSSHをインストールします。</p>

<pre class="terminal"> $ sudo apt-get update
 </pre>


<pre class="terminal"> $ sudo apt-get --yes install openssh-server
 </pre>


<h5>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/ubuntu">ubuntu</a>ユーザにpasswordを設定</h5>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/ubuntu">ubuntu</a> ユーザでログインできるようパスワードを設定します。</p>

<pre class="terminal"> $ sudo passwd ubuntu
 </pre>


<h5>外部からログイン</h5>


<p>外部から<a class="keyword" href="http://d.hatena.ne.jp/keyword/ubuntu">ubuntu</a>ユーザでログインし直します。</p>

<pre class="terminal"> $ ssh ubuntu@さくらのVPSのIP
 </pre>


<p>これで準備完了です。</p>

<h4>LiveCD環境に<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a>のインストール</h4>


<p>root権限でシェルを実行します。</p>

<pre class="terminal"> $ sudo -i
 </pre>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a>環境構築に必要なパッケージをインストールします。</p>

<pre class="terminal"> # apt-add-repository universe

# apt-get update

# apt-get install --yes debootstrap gdisk zfs-initramfs
 </pre>


<h4>ディスクフォーマット&amp;<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D1%A1%BC%A5%C6%A5%A3%A5%B7%A5%E7%A5%F3">パーティション</a>作成</h4>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D1%A1%BC%A5%C6%A5%A3%A5%B7%A5%E7%A5%F3">パーティション</a>テーブルがないことを確認します。
<b>※<a class="keyword" href="http://d.hatena.ne.jp/keyword/KVM">KVM</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/%B2%BE%C1%DB%A5%DE%A5%B7%A5%F3">仮想マシン</a>で実行する場合は/dev/vda<em>を使う必要がありますが、物理サーバで実行する場合は /dev/disk/by-id/<a class="keyword" href="http://d.hatena.ne.jp/keyword/scsi">scsi</a>-</em> という<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A8%A5%A4%A5%EA%A5%A2%A5%B9">エイリアス</a>のデ<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D0%A5%A4%A5%B9">バイス</a>ファイルを指定する必要があります。</b></p>

<pre class="terminal"> # sgdisk -p /dev/vda1
Creating new GPT entries.
Disk /dev/vda1: 104855552 sectors, 50.0 GiB
Logical sector size: 512 bytes
Disk identifier (GUID): 192C5AB8-08B9-4947-8423-E0182A6E5C5F
Partition table holds up to 128 entries
First usable sector is 34, last usable sector is 104855518
Partitions will be aligned on 2048-sector boundaries
Total free space is 104855485 sectors (50.0 GiB)

Number  Start (sector)    End (sector)  Size       Code  Name
 </pre>


<p>※データがある場合は初期化します。</p>

<pre class="terminal"> # sgdisk -Z /dev/vda1
 </pre>


<p>レガシーブート(<a class="keyword" href="http://d.hatena.ne.jp/keyword/BIOS">BIOS</a>)用の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D1%A1%BC%A5%C6%A5%A3%A5%B7%A5%E7%A5%F3">パーティション</a>を作成します。</p>

<pre class="terminal"> # sgdisk -a1 -n2:34:2047  -t2:EF02 /dev/vda1
Creating new GPT entries.
Warning: The kernel is still using the old partition table.
The new table will be used at the next reboot or after you
run partprobe(8) or kpartx(8)
The operation has completed successfully.
 </pre>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D1%A1%BC%A5%C6%A5%A3%A5%B7%A5%E7%A5%F3">パーティション</a>の最後に余剰空間を作成しておきます。(たぶんなくても良い)</p>

<pre class="terminal"> # sgdisk     -n9:-8M:0    -t9:BF07 /dev/vda1
Warning: The kernel is still using the old partition table.
The new table will be used at the next reboot or after you
run partprobe(8) or kpartx(8)
The operation has completed successfully.
 </pre>


<p>データ領域用の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D1%A1%BC%A5%C6%A5%A3%A5%B7%A5%E7%A5%F3">パーティション</a>を作成します。</p>

<pre class="terminal"> # sgdisk     -n1:0:0      -t1:BF01 /dev/vda1
Warning: The kernel is still using the old partition table.
The new table will be used at the next reboot or after you
run partprobe(8) or kpartx(8)
The operation has completed successfully.
 </pre>


<p>作成した<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D1%A1%BC%A5%C6%A5%A3%A5%B7%A5%E7%A5%F3">パーティション</a>を確認します。</p>

<pre class="terminal"> # sgdisk -p /dev/vda1
Disk /dev/vda1: 104855552 sectors, 50.0 GiB
Logical sector size: 512 bytes
Disk identifier (GUID): D00D7469-F38C-4463-8725-86E9354C26AC
Partition table holds up to 128 entries
First usable sector is 34, last usable sector is 104855518
Partitions will be aligned on 2-sector boundaries
Total free space is 0 sectors (0 bytes)

Number  Start (sector)    End (sector)  Size       Code  Name
   1            2048       104839133   50.0 GiB    BF01
   2              34            2047   1007.0 KiB  EF02
   9       104839134       104855518   8.0 MiB     BF07
 </pre>


<h4>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a>ストレージプール作成</h4>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a> ストレージプールを作成します。</p>

<pre class="terminal"> # zpool create -f -o ashift=12 -O atime=off -O canmount=off -O compression=lz4 -O normalization=formD -O mountpoint=/ -R /mnt rpool /dev/vda1
 </pre>


<p>作成した<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a> ストレージプールを確認します。</p>

<pre class="terminal"> # zpool status
  pool: rpool
 state: ONLINE
  scan: none requested
config:

        NAME        STATE     READ WRITE CKSUM
        rpool       ONLINE       0     0     0
          vda1      ONLINE       0     0     0

errors: No known data errors
 </pre>


<h4>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D5%A5%A1%A5%A4%A5%EB%A5%B7%A5%B9%A5%C6%A5%E0">ファイルシステム</a>作成</h4>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D5%A5%A1%A5%A4%A5%EB%A5%B7%A5%B9%A5%C6%A5%E0">ファイルシステム</a>を作成します。</p>

<pre class="terminal"> # zfs create -o canmount=off -o mountpoint=none rpool/ROOT
 </pre>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a>ルート<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D5%A5%A1%A5%A4%A5%EB%A5%B7%A5%B9%A5%C6%A5%E0">ファイルシステム</a>を作成します。</p>

<pre class="terminal"> # zfs create -o canmount=noauto -o mountpoint=/ rpool/ROOT/ubuntu
 </pre>


<pre class="terminal"> # zfs mount rpool/ROOT/ubuntu
 </pre>


<p>他にも必要なデー<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BF%A5%BB%A5%C3%A5%C8">タセット</a>があれば、作成します。</p>

<pre class="terminal"> # zfs create                 -o setuid=off              rpool/home

# zfs create -o canmount=off -o setuid=off  -o exec=off rpool/var

# zfs create                                            rpool/var/log

# zfs create                                            rpool/tmp

# zfs create                                            rpool/usr

# zfs create -o com.sun:auto-snapshot=false -o exec=on  rpool/var/tmp
 </pre>


<h4>システムのインストール</h4>


<p>上記で<code>rpool/var/tmp</code>を作成している場合は、<code>/mnt/var/tmp</code>の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D1%A1%BC%A5%DF%A5%C3%A5%B7%A5%E7%A5%F3">パーミッション</a>を変更します。</p>

<pre class="terminal"> # chmod 1777 /mnt/var/tmp
 </pre>


<p>基本システムをインストールします。</p>

<pre class="terminal"> # debootstrap xenial /mnt
I: Retrieving InRelease
I: Checking Release signature
I: Valid Release signature (key id 790BC7277767219C42C86F933B4FE6ACC0B21F32)
I: Retrieving Packages
I: Validating Packages
:
I: Configuring systemd...
I: Configuring initramfs-tools...
I: Configuring ureadahead...
I: Configuring resolvconf...
I: Base system installed successfully.
 </pre>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D5%A5%A1%A5%A4%A5%EB%A5%B7%A5%B9%A5%C6%A5%E0">ファイルシステム</a>のデ<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D0%A5%A4%A5%B9">バイス</a>ファイルを開けないようにします。</p>

<pre class="terminal"> # zfs set devices=off rpool
 </pre>


<h4>System Configuration</h4>


<p><code>hosts</code>, <code>hostname</code>, <a class="keyword" href="http://d.hatena.ne.jp/keyword/DNS">DNS</a>リ<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BE%A5%EB">ゾル</a>バ, ネットワーク設定を、環境に合わせて編集します。</p>

<pre class="terminal"> # vi /mnt/etc/hosts
 </pre>


<pre class="terminal"> # vi /mnt/etc/hostname
 </pre>


<pre class="terminal"> # vi /mnt/etc/resolvconf/resolv.conf.d/base
 </pre>


<pre class="terminal"> # vi /mnt/etc/network/interfaces.d/ens3
 </pre>


<p>LiveCD環境の仮想<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D5%A5%A1%A5%A4%A5%EB%A5%B7%A5%B9%A5%C6%A5%E0">ファイルシステム</a>を新しいシステムの<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D5%A5%A1%A5%A4%A5%EB%A5%B7%A5%B9%A5%C6%A5%E0">ファイルシステム</a>へバインドします。</p>

<pre class="terminal"> # mount --rbind /dev  /mnt/dev
 </pre>


<pre class="terminal"> # mount --rbind /proc /mnt/proc
 </pre>


<pre class="terminal"> # mount --rbind /sys  /mnt/sys
 </pre>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/chroot">chroot</a>します。</p>

<pre class="terminal"> # chroot /mnt /bin/bash --login
 </pre>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%ED%A5%B1%A1%BC%A5%EB">ロケール</a>の設定を行います。</p>

<pre class="terminal"> # locale-gen en_US.UTF-8
Generating locales (this might take a while)...
  en_US.UTF-8... done
Generation complete.
 </pre>


<pre class="terminal"> # echo 'LANG="en_US.UTF-8"' &gt; /etc/default/locale
 </pre>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BF%A5%A4%A5%E0%A5%BE%A1%BC%A5%F3">タイムゾーン</a>を設定します。Asia/Tokyoを選択します。</p>

<pre class="terminal"> # dpkg-reconfigure tzdata
 </pre>


<p>外部<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EA%A5%DD%A5%B8%A5%C8%A5%EA">リポジトリ</a>の設定のため、以下を追記します。</p>

<pre class="terminal"> # vi /etc/apt/sources.list
deb http://archive.ubuntu.com/ubuntu xenial main universe
deb-src http://archive.ubuntu.com/ubuntu xenial main universe

deb http://security.ubuntu.com/ubuntu xenial-security main universe
deb-src http://security.ubuntu.com/ubuntu xenial-security main universe

deb http://archive.ubuntu.com/ubuntu xenial-updates main universe
deb-src http://archive.ubuntu.com/ubuntu xenial-updates main universe
 </pre>


<p>/proc/self/mounts を/etc/mtabへリンクします。</p>

<pre class="terminal"> # ln -s /proc/self/mounts /etc/mtab
 </pre>


<p>最小のパッケージをインストールします。</p>

<pre class="terminal"> # apt-get update
Get:1 http://security.ubuntu.com/ubuntu xenial-security InRelease [94.5 kB]
Hit:2 http://archive.ubuntu.com/ubuntu xenial InRelease
Get:3 http://archive.ubuntu.com/ubuntu xenial-updates InRelease [94.5 kB]
Get:4 http://security.ubuntu.com/ubuntu xenial-security/main Sources [30.5 kB]
Get:5 http://security.ubuntu.com/ubuntu xenial-security/universe Sources [7840 B]
Get:6 http://security.ubuntu.com/ubuntu xenial-security/main amd64 Packages [117 kB]
Get:7 http://security.ubuntu.com/ubuntu xenial-security/main Translation-en [44.8 kB]
Get:8 http://security.ubuntu.com/ubuntu xenial-security/universe amd64 Packages [33.2 kB]
Get:9 http://archive.ubuntu.com/ubuntu xenial/main Sources [868 kB]
Get:10 http://security.ubuntu.com/ubuntu xenial-security/universe Translation-en [19.9 kB]
Get:11 http://archive.ubuntu.com/ubuntu xenial/universe Sources [7728 kB]
Get:12 http://archive.ubuntu.com/ubuntu xenial/main Translation-en [568 kB]
Get:13 http://archive.ubuntu.com/ubuntu xenial/universe amd64 Packages [7532 kB]
Get:14 http://archive.ubuntu.com/ubuntu xenial/universe Translation-en [4354 kB]
Get:15 http://archive.ubuntu.com/ubuntu xenial-updates/main Sources [90.6 kB]
Get:16 http://archive.ubuntu.com/ubuntu xenial-updates/universe Sources [55.3 kB]
Get:17 http://archive.ubuntu.com/ubuntu xenial-updates/main amd64 Packages [248 kB]
Get:18 http://archive.ubuntu.com/ubuntu xenial-updates/main Translation-en [98.1 kB]
Get:19 http://archive.ubuntu.com/ubuntu xenial-updates/universe amd64 Packages [152 kB]
Get:20 http://archive.ubuntu.com/ubuntu xenial-updates/universe Translation-en [74.9 kB]
Fetched 22.2 MB in 9s (2317 kB/s)
 </pre>


<pre class="terminal"> # apt-get install --yes ubuntu-minimal
Reading package lists... Done
Building dependency tree... Done
ubuntu-minimal is already the newest version (1.361).
0 upgraded, 0 newly installed, 0 to remove and 43 not upgraded.
 </pre>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a>関連のパッケージをインストールします。</p>

<pre class="terminal"> # apt-get install --yes --no-install-recommends linux-image-generic
 </pre>


<pre class="terminal"> # apt-get install --yes zfs-initramfs
 </pre>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Grub">Grub</a>をインストールします。</p>

<pre class="terminal"> # apt-get install --yes grub-pc




                     lqqqqqqu Configuring grub-pc tqqqqqqqk
                     x GRUB install devices:              x
                     x                                    x
                     x    [*] /dev/vda (53687 MB; ???)    x
                     x    [ ] /dev/vda1 (53686 MB; ???)   x
                     x                                    x
                     x                                    x
                     x                                x
                     x                                    x
                     mqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqj
 </pre>


<p>必要なグループを作成します。</p>

<pre class="terminal"> # addgroup --system lpadmin
perl: warning: Setting locale failed.
perl: warning: Please check that your locale settings:
        LANGUAGE = (unset),
        LC_ALL = (unset),
        LANG = "ja_JP.UTF-8"
    are supported and installed on your system.
perl: warning: Falling back to the standard locale ("C").
Adding group `lpadmin' (GID 110) ...
Done.
 </pre>


<pre class="terminal"> # addgroup --system sambashare
perl: warning: Setting locale failed.
perl: warning: Please check that your locale settings:
        LANGUAGE = (unset),
        LC_ALL = (unset),
        LANG = "ja_JP.UTF-8"
    are supported and installed on your system.
perl: warning: Falling back to the standard locale ("C").
Adding group `sambashare' (GID 111) ...
Done.
 </pre>


<p>rootにパスワードを設定します。</p>

<pre class="terminal"> # passwd
 </pre>


<h4>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/GRUB">GRUB</a> Installation</h4>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a>が認識されていることを確認します。</p>

<pre class="terminal"> # grub-probe /
zfs
 </pre>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a>モジュールがインストールされていることを確認します。</p>

<pre class="terminal"> # ls /boot/grub/*/zfs.mod
/boot/grub/i386-pc/zfs.mod
 </pre>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a>の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AB%A1%BC%A5%CD%A5%EB">カーネル</a>モジュールをインストールしたのでInitramfsを再構築します。</p>

<pre class="terminal"> # update-initramfs -c -k all
perl: warning: Setting locale failed.
perl: warning: Please check that your locale settings:
        LANGUAGE = (unset),
        LC_ALL = (unset),
        LANG = "ja_JP.UTF-8"
    are supported and installed on your system.
perl: warning: Falling back to the standard locale ("C").
update-initramfs: Generating /boot/initrd.img-4.4.0-22-generic
 </pre>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Grub">Grub</a>を編集します。</p>

<pre class="terminal"> # vi /etc/default/grub
:
#GRUB_HIDDEN_TIMEOUT=0
:
GRUB_CMDLINE_LINUX_DEFAULT="quiet"
:
GRUB_TERMINAL=console
 </pre>


<p>変更を反映します。</p>

<pre class="terminal"> # update-grub
 </pre>


<pre class="terminal"> # grub-install /dev/vda
Installing for i386-pc platform.
Installation finished. No error reported.
 </pre>


<h4>First Boot</h4>


<p>初期インストール時点での<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a>スナップショットを作成します。</p>

<pre class="terminal"> # zfs snapshot rpool/ROOT/ubuntu@install
 </pre>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/chroot">chroot</a>環境の<a class="keyword" href="http://d.hatena.ne.jp/keyword/bash">bash</a>を終了します。</p>

<pre class="terminal"> # exit
 </pre>


<p>すべての<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D5%A5%A1%A5%A4%A5%EB%A5%B7%A5%B9%A5%C6%A5%E0">ファイルシステム</a>をアンマウントします。</p>

<pre class="terminal"> # mount | grep -v zfs | tac | awk '/\/mnt/ {print $3}' | xargs -i{} umount -lf {}
 </pre>


<p>ストレージプールをexportします。</p>

<pre class="terminal"> # zpool export rpool
 </pre>


<p>OSを停止します。</p>

<pre class="terminal"> # shutdown -h now
 </pre>


<p>さくらの<a class="keyword" href="http://d.hatena.ne.jp/keyword/VPS">VPS</a>のコン<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C8%A5%ED%A1%BC%A5%EB">トロール</a>パネルからOSを起動し、正常に起動したら、マネジメントコンソールからrootでログインしてユーザを作成し、パスワードを設定します。</p>

<pre class="terminal"> # groupadd -g 1000 hoge

# useradd -u 1000 -g hoge -s /bin/bash -m -d /home/hoge hoge

# usermod -a -G adm,cdrom,dip,lpadmin,plugdev,sambashare,sudo hoge

# passwd hoge
 </pre>


<p>openssh-serverのパッケージをインストールします。</p>

<pre class="terminal"> # apt-get update

# apt-get install openssh-server
 </pre>


<p>ここまでくればもうほとんど問題ありません。
外部から<a class="keyword" href="http://d.hatena.ne.jp/keyword/ssh">ssh</a>ログインします。</p>

<pre class="terminal"> $ ssh hoge@さくらのVPSのIP
 </pre>


<h4>Final Cleanup</h4>


<p>作成したスナップショットを削除します。</p>

<pre class="terminal"> $ sudo zfs destroy rpool/ROOT/ubuntu@install
 </pre>


<p>rootのパスワードをリセットします。</p>

<pre class="terminal"> $ sudo usermod -p '*' root
 </pre>


<h3>おわりに</h3>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a>でも<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a>が使えるようになって、今後より<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a>が身近なものになってくるかもしれません。</p>
</body>
