---
layout: post
Categories:  ["tech"]
Description:  " はじめに  Ubuntu 14.04 LTSにPostfixとDovecotを使ったメールサーバを構築しましたのでその手順をメモします。SMTPの認証にはCyrus SASLを使います。認証にはpamで行うこととします。 "
Tags: ["Dovecot", "Linux", "Postfix", "tech", "メールサーバ"]
date: "2016-02-07T02:37:00+09:00"
title: "Ubuntu 14.04でPostfixとDovecotとCyrus SASLを使ったメールサーバ構築"
author: "dshimizu"
archive: ["2016"]
draft: "true"
---

<body>
<h3>はじめに</h3>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a> 14.04 LTSに<a class="keyword" href="http://d.hatena.ne.jp/keyword/Postfix">Postfix</a>と<a class="keyword" href="http://d.hatena.ne.jp/keyword/Dovecot">Dovecot</a>を使ったメールサーバを構築しましたのでその手順をメモします。
<a class="keyword" href="http://d.hatena.ne.jp/keyword/SMTP">SMTP</a>の認証にはCyrus SASLを使います。
認証にはpamで行うこととします。</p>
</body>

<!-- more -->

<body>
<h3>環境</h3>


<p>OS、利用するソフトウェアは以下の通りです。</p>

<table>
<tbody>
<tr>
<th>OS</th>
<td>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a> 14.04.3 LTS(3.13.0-66-generic)</td>
</tr>
</tbody>
</table>


<table>
<tbody>
<tr>
<th>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/SMTP">SMTP</a>ソフトウェア</th>
<td>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/Postfix">Postfix</a> Version 2.11.0</td>
</tr>
<tr>
<th>POP/<a class="keyword" href="http://d.hatena.ne.jp/keyword/IMAP">IMAP</a>ソフト</th>
<td>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/dovecot">dovecot</a> (<a class="keyword" href="http://d.hatena.ne.jp/keyword/dovecot">dovecot</a>-imapd,<a class="keyword" href="http://d.hatena.ne.jp/keyword/dovecot">dovecot</a>-pop3d) Version 2.2.9</td>
</tr>
<tr>
<th>認証用ソフトウェア</th>
<td>sasl2(sasl2-bin) Version 2.1.25</td>
</tr>
</tbody>
</table>


<h3>構築手順</h3>


<h4>必要パッケージのインストール</h4>


<p>必要なパッケージをインストールします。</p>

<pre class="terminal"> # apt install postfix dovecot-imap dovecot-pop3 sasl2-bin
 </pre>


<h4>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/Postfix">Postfix</a>の設定</h4>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Postfix">Postfix</a>の設定を行います。
まず、 <code>/etc/postfix/main.cf</code> を編集します。</p>

<pre class="terminal"> ### myhostnameメールサーバのホスト名を指定
### メールサーバを外部公開している場合はインターネット上で名前解決できるホスト名
myhostname = メールサーバのホスト名

### mydomainにメール送信時に使う@より右のドメイン名を指定
mydomain = メールドメイン名
myorigin = $mydomain

### inet_interfacesにメールを受信するネットワークインタフェースを指定(allで0.0.0.0:25がLISTEN状態になる)
inet_interfaces = all

### 自ホストが最終目的地であるドメイン名の指定。
### メールアドレスの「@」の右側が mydestination の指定に一致すると、そのメールは他のサーバには配送せず、自ホスト内で処理しようとする。 
mydestination = $myhostname, $mydomain, localhost

### メールのリレーを許可するサーバのアドレス、またはネットワークを環境に合わせて指定 (以下は例)
mynetworks = 127.0.0.0/8, 168.100.XXX.0/24

### メールボックスをユーザのホームディレクトリに変更
home_mailbox = Maildir/

### TLSを使う場合の証明書と鍵ファイルの指定
smtpd_tls_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem
smtpd_tls_key_file=/etc/ssl/private/ssl-cert-snakeoil.key

### SMTP認証に使うSASLの設定
smtpd_sasl_type = dovecot
smtpd_sasl_path = private/auth
smtpd_sasl_auth_enable = yes
smtpd_sasl_security_options = noanonymous
smtpd_sasl_local_domain = $myhostname
broken_sasl_auth_clients = yes
 </pre>


<p>続いて <code>/etc/postfix/master.conf</code> を編集します。</p>

<pre class="terminal"> ### Submission ポート (ポート番号 587) でも SMTP を受けるようにする
### sasl認証を有効にする
submission inet n       -       -       -       -       smtpd
  -o smtpd_sasl_auth_enable=yes

### smtpsを有効にする
### TLSのラッパーモードを有効にする
smtps     inet  n       -       -       -       -       smtpd
  -o smtpd_tls_wrappermode=yes
 </pre>


<h4>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/dovecot">dovecot</a>の設定</h4>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/dovecot">dovecot</a>の設定を行います。
<code>/etc/dovecot/dovecot.conf</code>を編集します。</p>

<pre class="terminal"> ### 利用するプロトコルを記載
### dovecot-imapdとdovecot-pop3dをインストールしたので imap pop3 を記載
protocols = imap pop3

### LISTENするアドレスを指定
listen = *
 </pre>


<p><code>/etc/dovecot/conf.d/10-mail.conf</code>を編集します。</p>

<pre class="terminal"> ### Postfixの設定に合わせてMaildir形式を指定
mail_location = maildir:~/Maildir

### dovecotプロセスが chroot することができるディレクトリの指定
valid_chroot_dirs = /home

### UIDLのフォーマットを指定
pop3_uidl_format = %08Xu%08Xv
 </pre>


<p><code>/etc/dovecot/conf.d/10-auth.conf</code>を編集します。</p>

<pre class="terminal"> ### SSL/TLS接続のみ有効にする場合はyes
disable_plaintext_auth = yes

### 認証時のパスフレーズ送信方式の指定
### 通信が暗号化されているので以下
auth_mechanisms = plain login
 </pre>


<p><code>/etc/dovecot/conf.d/10-master.conf</code>を編集します。</p>

<pre class="terminal"> ### imapでの接続ポートの指定
### SSL/TLSのみ使う場合はimapsのみで良い
service imap-login {
  inet_listener imap {
    #port = 143
    port = 0
  }
  inet_listener imaps {
    port = 993
    ssl = yes
  }
}

### imapでの接続ポートの指定
### SSL/TLSのみ使う場合はimapsのみで良い
service pop3-login {
  inet_listener pop3 {
    #port = 110
    port = 0
  }
  inet_listener pop3s {
    port = 995
    ssl = yes
  }
}

### 認証用ソケットファイルへのアクセス権設定
  unix_listener /var/spool/postfix/private/auth {
    mode = 0666
    user = postfix
    group = postfix
  }
 </pre>


<p><code>/etc/dovecot/conf.d/10-ssl.conf</code> を編集します。</p>

<pre class="terminal"> ### SSL/TLSを有効化
ssl = yes

### SSL/TLSで利用する証明書の設定
### (別途作成の必要あり)
ssl_cert = &lt;/etc/ssl/certs/ssl-cert-snakeoil.pem
ssl_key = &lt;/etc/ssl/private/ssl-cert-snakeoil.key
 </pre>


<h4>sasl2の設定</h4>


<p><code>/etc/default/saslauthd</code>を編集します。</p>

<pre class="terminal"> ### 自動起動の設定
START=yes

### 認証メカニズムの設定
MECHANISMS="pam"
 </pre>


<h3>おわりに</h3>


<p>以上、メールサーバの構築メモです。</p>
</body>
