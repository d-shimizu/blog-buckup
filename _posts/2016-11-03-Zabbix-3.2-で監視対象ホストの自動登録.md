---
layout: post
Categories:  ["tech"]
Description:  " はじめに  Zabbixはサーバとエージェントから構成される監視ツールです。VMwareやKVMに加えて、DockerやLXCなど様々な仮想化技術やAWS,GCP,Azureなどのクラウド環境が進歩している昨今、簡単に増やすことが可能なサ"
Tags: ["monitor", "ops", "tech", "Zabbix", "監視", "運用"]
date: "2016-11-03T01:58:00+09:00"
title: "Zabbix 3.2 で監視対象ホストの自動登録"
author: "dshimizu"
archive: ["2016"]
draft: "true"
---

<body>
<h3>はじめに</h3>


<p>Zabbixはサーバとエージェントから構成される監視ツールです。
<a class="keyword" href="http://d.hatena.ne.jp/keyword/VMware">VMware</a>や<a class="keyword" href="http://d.hatena.ne.jp/keyword/KVM">KVM</a>に加えて、DockerやLXCなど様々な仮想化技術や<a class="keyword" href="http://d.hatena.ne.jp/keyword/AWS">AWS</a>,<a class="keyword" href="http://d.hatena.ne.jp/keyword/GCP">GCP</a>,Azureなどの<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AF%A5%E9%A5%A6%A5%C9">クラウド</a>環境が進歩している昨今、簡単に増やすことが可能なサーバに対して、逐一Zabbixエージェントの設定を行っていては監視設定の手間がかかって仕方ありません。</p>

<p>今回は監視対象の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A4%A5%F3%A5%B9%A5%BF%A5%F3%A5%B9">インスタンス</a>が自動で増えたとしても、Zabbix 3.2 のZabbixサーバで常に監対象<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A4%A5%F3%A5%B9%A5%BF%A5%F3%A5%B9">インスタンス</a>を自動登録して監視対象にする方法を記載します。</p>
</body>

<!-- more -->

<body>
<h3>環境</h3>


<table>
<tbody>
<tr>
<th>Zabbixバージョン</th>
<td>Zabbix 3.2</td>
</tr>
</tbody>
</table>


<h3>Zabbixエージェントの設定</h3>


<p><code>zabbix_agentd.conf</code> に以下のパラメータを設定します。
Ansibleなどであらかじめ設定ファイルが以下のようになるようにしておくと良いと思います。</p>

<pre class="terminal"> # Zabbix Server のホスト名 FQDN または IP アドレスを設定する。
Server=ZabbixServerHostName
# Zabbix Server のホスト名 FQDN または IP アドレスを設定する。
ServerActive=ZabbixServerHostName
# Zabbixサーバがホストを登録する際に、ホストの名称を設定するのに使われる。コメントアウトして有効化する。
HostnameItem=system.hostname
# ホストメタデータ。自動登録する際に使われる。任意の値を設定する。
# ここでは、“Linux”はプラットフォームを、続く文字列は推測困難な文字列を示す。
HostMetadata=Linux xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
 </pre>


<h3>Zabbixサーバの設定</h3>


<p>Zabbix サーバの設定をします。</p>

<p>画面上部メニューの<code>[設定]</code> タブ -&gt; <code>[アクション]</code> タブを押下して画面遷移します。
その画面右上メニューのイベントソースから <code>[自動登録]</code> を選択し、 <code>[アクションの作成]</code> を押下します。</p>

<p><img src="http://blog.dshimizu.jp/wp-content/uploads/2016/12/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88-2016-11-02-0.52.38.png" alt="" width="1364" height="621" class="alignnone size-full wp-image-290"></p>

<p>[アクション] タブの画面で、どういった条件の時にホストが自動登録されるかを設定します。</p>

<p>今回はホスト<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%E1%A5%BF%A5%C7%A1%BC%A5%BF">メタデータ</a>（Zabbix Agentの <code>HostMetadata</code> パラメータの値）に <code>Linux</code> と特定のランダム文字列(ここでは <code>xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</code>) が含まれる場合、自動登録されるようにします。
ホスト<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%E1%A5%BF%A5%C7%A1%BC%A5%BF">メタデータ</a>の値を細かく設定することによって、監視対象のOSの種類や、本番環境のホストか開発環境のホストかなどを判別できます。</p>

<p><img src="http://blog.dshimizu.jp/wp-content/uploads/2016/12/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88-2016-11-03-1.09.37.png" alt="" width="1364" height="621" class="alignnone size-medium wp-image-291"></p>

<p>[アクションの実行内容] タブの画面では、ホストの自動登録が行われた場合に Zabbix サーバにどのような動作をさせるかを設定します。</p>

<p>以下では、[アクション]タブ画面で設定した条件のホストが登録された場合に所定のメールアドレス宛にメールを送信し、指定したホストグループへ所属させ、指定したテンプレートへリンクさせるようにしています。</p>

<p><img src="http://blog.dshimizu.jp/wp-content/uploads/2016/12/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88-2016-11-03-1.05.05.png" alt="" width="1364" height="621" class="alignnone size-medium wp-image-292"></p>

<h3>対象サーバの Zabbix エージェントを起動して自動登録</h3>


<p>監視対象のZabbix エージェントの起動させた後、Zabbix サーバに登録されているか、 <code>[アクションの実行条件]</code> で設定した通りの動作が行われてるか確認します。
いずれも正常に処理されていれば成功です。</p>

<h3>おわりに</h3>


<p>以上が監視対象ホストを自動登録するための一連の流れです。
<a class="keyword" href="http://d.hatena.ne.jp/keyword/AWS">AWS</a> の AutoScaling などで自動でホストが追加された場合でも、監視も自動で行われるようになり、運用の手間が減らせると思います。</p>

<h4>参考</h4>


<ul>
    <li><a href="https://www.zabbix.com/documentation/3.2/manual/discovery/auto_registration" target="_blank" rel="noopener noreferrer">2 Active agent auto-registration [Zabbix Documentation 3.2]</a></li>
<a href="https://www.zabbix.com/documentation/3.2/manual/discovery/auto_registration" target="_blank" rel="noopener noreferrer">
</a>
    <li>
<a href="https://www.zabbix.com/documentation/3.2/manual/discovery/auto_registration" target="_blank" rel="noopener noreferrer"></a><a href="http://knowledge.sakura.ad.jp/tech/3592/" target="_blank" rel="noopener noreferrer">さくらのクラウドで Zabbix を使いこなそう！～アクティブエージェントで簡単自動登録～ - さくらのナレッジ</a>
</li>
<a href="http://knowledge.sakura.ad.jp/tech/3592/" target="_blank" rel="noopener noreferrer">
</a>
</ul>

</body>
