---
layout: post
Categories:  ["tech"]
Description:  " 以前にLVSのメンテナンスをする機会があってテスト用に環境構築していた時にいろいろ調べたことをメモとしてつらつらと残しておく。文字ベースだけど必要そうな図とかそのうち作るかもしれない。 "
Tags: ["Network", "tech"]
date: "2018-05-26T21:52:00+09:00"
title: "LVSとL2DSRに関しての自分用メモ書き"
author: "dshimizu"
archive: ["2018"]
draft: "true"
---

<body>
<p>以前に<a class="keyword" href="http://d.hatena.ne.jp/keyword/LVS">LVS</a>のメンテナンスをする機会があってテスト用に環境構築していた時にいろいろ調べたことをメモとしてつらつらと残しておく。
文字ベースだけど必要そうな図とかそのうち作るかもしれない。</p>
</body>

<!-- more -->

<body>
<h3><a class="keyword" href="http://d.hatena.ne.jp/keyword/LVS">LVS</a></h3>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/LVS">LVS</a>は<a class="keyword" href="http://d.hatena.ne.jp/keyword/Linux%20Virtual%20Server">Linux Virtual Server</a>の略で、<a href="http://www.linuxvirtualserver.org/" target="_brank" rel="noopener noreferrer">The Linux Virtual Server Project - Linux Server Cluster for Load Balancing</a>で開発されている。</p>

<p>多くのケースではIPVSを差すことが多いと思う。が、他にもある。
<a class="keyword" href="http://d.hatena.ne.jp/keyword/Linux%20Virtual%20Server">Linux Virtual Server</a>という表現だとピンとこないが、<a href="http://www.linuxvirtualserver.org/whatis.html" target="_brank" rel="noopener noreferrer">LVS Introduction - Load Balancing Server Cluster</a>の説明や図を見る限りだと、<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AF%A5%E9%A5%B9%A5%BF%A5%EA%A5%F3%A5%B0">クラスタリング</a>や負荷分散技術を利用してシステム全体を1つのサーバとみなせるよう可用性の高いシステムを構築しよう、という感じっぽい。
パケットのロードバランス周りではL4レベルでパケットをロードバランスするIPVS (IP Virtual Server)という<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AB%A1%BC%A5%CD%A5%EB">カーネル</a>モジュール(<a class="keyword" href="http://d.hatena.ne.jp/keyword/Linux">Linux</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AB%A1%BC%A5%CD%A5%EB">カーネル</a> 2.4以降で取り込まれ、現在 net/netfilter/ipvs 以下に<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BD%A1%BC%A5%B9%A5%B3%A1%BC%A5%C9">ソースコード</a>が配置されている)の他、L7レベルでパケットをロードバランスするKTCPVS (Kernel <a class="keyword" href="http://d.hatena.ne.jp/keyword/TCP">TCP</a> Virtual Server)というものもあるが、これは今も開発されているのかよくわからない。</p>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/keepalived">keepalived</a>というソフトウェアもあるが、これはざっくりいうとIPVSを<a class="keyword" href="http://d.hatena.ne.jp/keyword/keepalived">keepalived</a>経由で設定可能にしたものに、さらにヘルスチェック機能や<a class="keyword" href="http://d.hatena.ne.jp/keyword/VRRP">VRRP</a>による<a class="keyword" href="http://d.hatena.ne.jp/keyword/%BE%E9%C4%B9%B2%BD">冗長化</a>機能を追加したもの…という認識。
IPVS単体だと負荷分散先のサーバの死活監視ができないのでサーバが落ちてもリク<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A8%A5%B9">エス</a>トを振り続けるといった事態になるためこれに対応する手段が必要になる。また、<a class="keyword" href="http://d.hatena.ne.jp/keyword/%BE%E9%C4%B9%B2%BD">冗長化</a>機能はないのでシステム全体として可用性を高める必要がある場合は何かしら手段を考える必要がある。</p>

<h3>負荷分散時の通信方式</h3>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/LVS">LVS</a>での負荷分散時の通信方式としてはNATかL2DSRになるのではないかと思う。
NATはロードバランサの<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A2%A5%D7%A5%E9%A5%A4%A5%A2%A5%F3%A5%B9">アプライアンス</a>製品だと一般的だがDSRは最近は馴染みのない人も多いかもしれない。L3DSRというのもあるがいろいろ手間がかかりそうで自分ではやったことないので割愛する。</p>

<h4>NAT</h4>


<p>NAT方式は<a class="keyword" href="http://d.hatena.ne.jp/keyword/LVS">LVS</a>サーバを経由する通信で送信元<a class="keyword" href="http://d.hatena.ne.jp/keyword/IP%A5%A2%A5%C9%A5%EC%A5%B9">IPアドレス</a>変換を行う。往復の通信処理が<a class="keyword" href="http://d.hatena.ne.jp/keyword/LVS">LVS</a>サーバを経由し、<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C8%A5%E9%A5%D5%A5%A3%A5%C3%A5%AF">トラフィック</a>の処理にCPU処理が入る分負荷が高くなるようだが、この方式を試したことはないのでどのくらいのリク<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A8%A5%B9">エス</a>トでどのくらいの負荷がかかるのかは不明。ただ、F社などのLB<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A2%A5%D7%A5%E9%A5%A4%A5%A2%A5%F3%A5%B9">アプライアンス</a>製品を扱っていることが多い人だとNAT方式の方がわかりやすいんじゃないだろうか。
この方式だと行きと戻りの通信が<a class="keyword" href="http://d.hatena.ne.jp/keyword/LVS">LVS</a>を経由することになる(Client -&gt; <a class="keyword" href="http://d.hatena.ne.jp/keyword/LVS">LVS</a> -&gt; Real Server -&gt; <a class="keyword" href="http://d.hatena.ne.jp/keyword/LVS">LVS</a> -&gt; Client)ので通信経路が一致するのと、<a class="keyword" href="http://d.hatena.ne.jp/keyword/LVS">LVS</a>配下のサーバ(リク<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A8%A5%B9">エス</a>ト振り分け先のサーバ)で何か特殊な設定をする必要もないのが良い。</p>

<h4>L2DSR</h4>


<p>一方でL2DSRだと、<a class="keyword" href="http://d.hatena.ne.jp/keyword/LVS">LVS</a>を経由して流れたリク<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A8%A5%B9">エス</a>トを、配下のサーバが<a class="keyword" href="http://d.hatena.ne.jp/keyword/MAC%A5%A2%A5%C9%A5%EC%A5%B9">MACアドレス</a>を書き換えて直接クライアントに返す(Client -&gt; <a class="keyword" href="http://d.hatena.ne.jp/keyword/LVS">LVS</a>サーバ -&gt; Realサーバ -&gt; Client となる)。
この方式だと戻りの通信(レスポンス)が<a class="keyword" href="http://d.hatena.ne.jp/keyword/LVS">LVS</a>サーバを経由しない分<a class="keyword" href="http://d.hatena.ne.jp/keyword/LVS">LVS</a>サーバの負荷が低くなるが、行きと戻りの通信経路が非対称になってしまう。
また、L7レベルの<a class="keyword" href="http://d.hatena.ne.jp/keyword/MAC%A5%A2%A5%C9%A5%EC%A5%B9">MACアドレス</a>変換を行えるようReal サーバ側にもVIPのアドレスの設定が必要(※)であったりと、<a class="keyword" href="http://d.hatena.ne.jp/keyword/LVS">LVS</a>とReal Serverを同一セグメントに置く必要があるなど制約も多い。</p>

<p>※L2DSRでは、Real サーバのloopbackインタフェースに<a class="keyword" href="http://d.hatena.ne.jp/keyword/LVS">LVS</a>でセットしているVIPを割り当てておくことで、<a class="keyword" href="http://d.hatena.ne.jp/keyword/LVS">LVS</a>を経由してきた通信(宛先IPは<a class="keyword" href="http://d.hatena.ne.jp/keyword/LVS">LVS</a>のVIPのまま)を自身のloopbackインタフェースで受けることができる。特定の<a class="keyword" href="http://d.hatena.ne.jp/keyword/NIC">NIC</a>に複数のIPを割り当てることも設定としてはできるが、VIPへの<a class="keyword" href="http://d.hatena.ne.jp/keyword/ARP">ARP</a>要求に<a class="keyword" href="http://d.hatena.ne.jp/keyword/LVS">LVS</a>サーバもReal サーバも応じることになりおかしいことになる。loopbackインタフェースなら<a class="keyword" href="http://d.hatena.ne.jp/keyword/ARP">ARP</a>要求に応答しないため、loopbackインタフェースに設定する。この場合、戻り通信は、受信時の送信元IP(クライアント)を宛先IPにして<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C7%A5%D5%A5%A9%A5%EB%A5%C8%A5%B2%A1%BC%A5%C8%A5%A6%A5%A7%A5%A4">デフォルトゲートウェイ</a>に返す。</p>

<pre class="text"> ※L2DSRの構成イメージ

                      | 
                +-----------+ 
                |    LVS    | eth0:192.168.10.101/24(実IP)
                +-----------+ eth0:192.168.10.100/32(VIP(alias))
                      |
      +--------------------+--------------------+
      |                    |                    |
+-----------+       +-----------+        +-----------+
|Realサーバ1|       |Realサーバ2|        |Realサーバ3|
+-----------+       +-----------+        +-----------+
eth0 192.168.10.1   eth0 192.168.10.2    eth0 192.168.10.3
lo:0 192.168.10.100 lo:0 192.168.10.100  lo:0 192.168.10.100
 </pre>


<p>loopbackインタフェースにVIPのアドレスをセットしていない場合、クライアントから<a class="keyword" href="http://d.hatena.ne.jp/keyword/LVS">LVS</a>のVIPにSYNが送られているけど、Real Serverから<a class="keyword" href="http://d.hatena.ne.jp/keyword/LVS">LVS</a>のVIPに対して<a class="keyword" href="http://d.hatena.ne.jp/keyword/tcp">tcp</a> retransmissionが発生していた。</p>

<p>loopbackインタフェースに<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A8%A5%A4%A5%EA%A5%A2%A5%B9">エイリアス</a>を設定する場合は以下のコマンドを実行する。</p>

<pre class="terminal"> $ sudo ip addr add local LVSのVIP dev lo:0
 </pre>


<p>この辺ちゃんとわかっていないとハマる気がする。</p>

<h3>まとめ</h3>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/LVS">LVS</a>と通信方式について少し調べておいたことを書いた。
L3DSRはまだ触ってないのでそのうちやりたい。</p>

<h3>参考</h3>


<ul>
    <li><a href="http://www.linuxvirtualserver.org/" target="_brank" rel="noopener noreferrer">The Linux Virtual Server Project - Linux Server Cluster for Load Balancing</a></li>
    <li><a href="https://en.wikipedia.org/wiki/Linux_Virtual_Server" target="_brank" rel="noopener noreferrer">Linux Virtual Server - Wikipedia</a></li>
    <li><a href="https://www.janog.gr.jp/meeting/janog32/doc/janog32-lb-tanaka-01.pdf" target="_brank" rel="noopener noreferrer">ロードバランスを考える - JANOG32</a></li>
    <li><a href="http://www.austintek.com/LVS/LVS-HOWTO/HOWTO/LVS-HOWTO.arp_problem.html" target="_brank" rel="noopener noreferrer">6. LVS: The ARP Problem</a></li>
    <li><a href="https://teratail.com/questions/84584" target="_brank" rel="noopener noreferrer">ループバックインターフェイスと仮想IPについて - teratail</a></li>
    <li><a href="https://www.janog.gr.jp/meeting/janog33/doc/janog33-lbaas-miyata-1.pdf" target="_brank" rel="noopener noreferrer">Yahoo! JAPAN 仮想化への取り組み ～ OpenStack with LBaaS ～</a></li>
    <li><a href="https://www.nanog.org/meetings/nanog51/presentations/Monday/NANOG51.Talk45.nanog51-Schaumann.pdf" target="_brank" rel="noopener noreferrer">L3DSR – Overcoming Layer 2 Limitations of Direct Server Return Load Balancing</a></li>
    <li><a hrer="http://d.hatena.ne.jp/halfrack/20160202/1454413805" target="_brank" rel="noopener noreferrer">雑な LVS/TUN の解説図 - mura日記 (halfrack)</a></li>
</ul>

</body>
