---
title: "TOTP をわかっていないので調べたことのメモ"
date: 2022-08-20
slug: "TOTP をわかっていないので調べたことのメモ"
category: blog
tags: [TOTP,認証]
---
<h2 id="はじめに">はじめに</h2>

<p>TOTP の Multi Factor Auth を触ることになったものの、TOTP をよくわかっていないので調査メモ。</p>

<h2 id="仕様">仕様</h2>

<p><a class="keyword" href="https://d.hatena.ne.jp/keyword/RFC">RFC</a> 6238 で定義されている。</p>

<ul>
<li><a href="https://tools.ietf.org/rfc/rfc6238.txt">https://tools.ietf.org/rfc/rfc6238.txt</a></li>
</ul>


<p>また、ベースとなっている HOTP は <a class="keyword" href="https://d.hatena.ne.jp/keyword/RFC">RFC</a> 4226 で定義されている。</p>

<ul>
<li><a href="https://tools.ietf.org/html/rfc4226">RFC 4226 - HOTP: An HMAC-Based One-Time Password Algorithm</a></li>
</ul>


<h3 id="HOTPHMAC-Based-One-Time-Password">HOTP(HMAC-Based One-Time Password)</h3>

<p>HOTP の<a class="keyword" href="https://d.hatena.ne.jp/keyword/%A5%EF%A5%F3%A5%BF%A5%A4%A5%E0%A5%D1%A5%B9%A5%EF%A1%BC%A5%C9">ワンタイムパスワード</a>の生成は、<a class="keyword" href="https://d.hatena.ne.jp/keyword/%C8%EB%CC%A9%B8%B0">秘密鍵</a>とカウンタ値をもとに<a class="keyword" href="https://d.hatena.ne.jp/keyword/%A5%EF%A5%F3%A5%BF%A5%A4%A5%E0%A5%D1%A5%B9%A5%EF%A1%BC%A5%C9">ワンタイムパスワード</a>を生成する形と思われる。サーバー側のカウンタは、クライアント側から送られたHOTPの値と一致した場合に増分するらしい。クライアント側とサーバー側でカウンタ値がずれる場合があるので、再同期する必要があるらしい。<a href="#f-4165bf5a" id="fn-4165bf5a" name="fn-4165bf5a" title="[https://tools.ietf.org/html/rfc4226:title]">*1</a></p>

<ul>
<li><a class="keyword" href="https://d.hatena.ne.jp/keyword/RFC">RFC</a> 4226 の内容抜粋

<blockquote><p>7.2. Validation of HOTP Values
The HOTP client (hardware or software token) increments its counter and then calculates the next HOTP <a class="keyword" href="https://d.hatena.ne.jp/keyword/value">value</a> HOTP client. If the <a class="keyword" href="https://d.hatena.ne.jp/keyword/value">value</a> received by the authentication server matches the <a class="keyword" href="https://d.hatena.ne.jp/keyword/value">value</a> calculated by the client, then the HOTP <a class="keyword" href="https://d.hatena.ne.jp/keyword/value">value</a> is validated. In this case, the server increments the counter <a class="keyword" href="https://d.hatena.ne.jp/keyword/value">value</a> by one.
<br />
:　
<br />
7.4. Resynchronization of the Counter
Although the server's counter <a class="keyword" href="https://d.hatena.ne.jp/keyword/value">value</a> is only incremented after a successful HOTP authentication, the counter on the token is incremented every time a new HOTP is requested by the user. Because of this, the counter values on the server and on the token might be out of synchronization.</p></blockquote></li>
</ul>


<p>8バイトのカウンター(C)と<a class="keyword" href="https://d.hatena.ne.jp/keyword/%C8%EB%CC%A9%B8%B0">秘密鍵</a>(K)を元に <a class="keyword" href="https://d.hatena.ne.jp/keyword/SHA1">SHA1</a> <a class="keyword" href="https://d.hatena.ne.jp/keyword/%A5%CF%A5%C3%A5%B7%A5%E5%B4%D8%BF%F4">ハッシュ関数</a> <code>HMAC-SHA-1(K,C)</code> で得られた値から 31 ビットを取得して数値に変換したものが<a class="keyword" href="https://d.hatena.ne.jp/keyword/%A5%EF%A5%F3%A5%BF%A5%A4%A5%E0%A5%D1%A5%B9%A5%EF%A1%BC%A5%C9">ワンタイムパスワード</a>になるようで、以下で表されている。</p>

<pre class="code" data-lang="" data-unlink>HOTP(K,C) = Truncate(HMAC-SHA-1(K,C))</pre>


<p>HMAC についても <a class="keyword" href="https://d.hatena.ne.jp/keyword/RFC">RFC</a> で定義されている。詳しくわかっていない。</p>

<ul>
<li><iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fwww.rfc-editor.org%2Frfc%2Frfc2404" title="RFC 2404: The Use of HMAC-SHA-1-96 within ESP and AH" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;" loading="lazy"></iframe><cite class="hatena-citation"><a href="https://www.rfc-editor.org/rfc/rfc2404">www.rfc-editor.org</a></cite></li>
</ul>


<h3 id="TOTPTime-Based-One-Time-Password">TOTP(Time-Based One-Time Password)</h3>

<p>TOTP の<a class="keyword" href="https://d.hatena.ne.jp/keyword/%A5%EF%A5%F3%A5%BF%A5%A4%A5%E0%A5%D1%A5%B9%A5%EF%A1%BC%A5%C9">ワンタイムパスワード</a>の生成は、<a class="keyword" href="https://d.hatena.ne.jp/keyword/%C8%EB%CC%A9%B8%B0">秘密鍵</a>と時刻をもとに<a class="keyword" href="https://d.hatena.ne.jp/keyword/%A5%EF%A5%F3%A5%BF%A5%A4%A5%E0%A5%D1%A5%B9%A5%EF%A1%BC%A5%C9">ワンタイムパスワード</a>を生成している。</p>

<p>時間(T)と<a class="keyword" href="https://d.hatena.ne.jp/keyword/%C8%EB%CC%A9%B8%B0">秘密鍵</a>(K)を元に <a class="keyword" href="https://d.hatena.ne.jp/keyword/SHA1">SHA1</a> <a class="keyword" href="https://d.hatena.ne.jp/keyword/%A5%CF%A5%C3%A5%B7%A5%E5%B4%D8%BF%F4">ハッシュ関数</a> <code>HMAC-SHA-1</code>で得られた値から 31 ビットを取得して数値に変換したものが<a class="keyword" href="https://d.hatena.ne.jp/keyword/%A5%EF%A5%F3%A5%BF%A5%A4%A5%E0%A5%D1%A5%B9%A5%EF%A1%BC%A5%C9">ワンタイムパスワード</a>になるようである。</p>

<pre class="code" data-lang="" data-unlink>TOTP = HOTP(K, T)</pre>


<p>T は、その時の <a class="keyword" href="https://d.hatena.ne.jp/keyword/Unix">Unix</a> 時間 (Current <a class="keyword" href="https://d.hatena.ne.jp/keyword/Unix">Unix</a> Time) から T0(カウントを開始する時間、と定義されているが、デフォルトは<a class="keyword" href="https://d.hatena.ne.jp/keyword/Unix">Unix</a> epoch(1970年1月1日午前0時0分0秒)) の差を、X(TOTP を再生成するまでの時間でデフォルトは 30 秒)になる。このうち、T0 と X はシステムパラメータになるらしい。</p>

<pre class="code" data-lang="" data-unlink>T = (Current Unix time - T0) / X</pre>


<p>多分こんな形で表される。</p>

<pre class="code" data-lang="" data-unlink>TOTP = Truncate(HMAC-SHA-1(K, (Current Unix time - T0) / X))</pre>


<p>また、<a class="keyword" href="https://d.hatena.ne.jp/keyword/%C8%EB%CC%A9%B8%B0">秘密鍵</a>の共有は、よく <a class="keyword" href="https://d.hatena.ne.jp/keyword/QR">QR</a> コードが用いられる。</p>

<h2 id="処理の概要">処理の概要</h2>

<p>おそらくこんな感じになる。</p>

<p><span itemscope itemtype="http://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/d/dshimizu/20221101/20221101200128.png" width="831" height="403" loading="lazy" title="" class="hatena-fotolife" itemprop="image"></span></p>
<div class="footnote">
<p class="footnote"><a href="#fn-4165bf5a" id="f-4165bf5a" name="f-4165bf5a" class="footnote-number">*1</a><span class="footnote-delimiter">:</span><span class="footnote-text"><a href="https://tools.ietf.org/html/rfc4226">RFC 4226 - HOTP: An HMAC-Based One-Time Password Algorithm</a></span></p>
</div>
