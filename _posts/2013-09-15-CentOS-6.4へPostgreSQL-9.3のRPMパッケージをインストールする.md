---
layout: post
Categories:  ["tech"]
Description:  " はじめに  2013年9月9日にオープンソースのRDBであるPostgreSQLの最新版となる「PostgreSQL 9.3」が正式にリリースされましたので、CentOS 6.4環境へインストールしてみました。      PostgreS"
Tags: ["PostgreSQL", "さくらのVPS", "CentOS"]
date: "2013-09-15T17:52:00+09:00"
title: "CentOS 6.4へPostgreSQL 9.3のRPMパッケージをインストールする"
author: "dshimizu"
archive: ["2013"]
draft: "true"
---

<body>
<h4>はじめに</h4>
<p>2013年9月9日に<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AA%A1%BC%A5%D7%A5%F3%A5%BD%A1%BC%A5%B9">オープンソース</a>の<a class="keyword" href="http://d.hatena.ne.jp/keyword/RDB">RDB</a>である<a class="keyword" href="http://d.hatena.ne.jp/keyword/PostgreSQL">PostgreSQL</a>の最新版となる「<a class="keyword" href="http://d.hatena.ne.jp/keyword/PostgreSQL">PostgreSQL</a> 9.3」が正式にリリースされましたので、<a class="keyword" href="http://d.hatena.ne.jp/keyword/CentOS">CentOS</a> 6.4環境へインストールしてみました。 </p>
<ul>  <li><a href="http://www.postgresql.org/about/news/1481/">PostgreSQL: PostgreSQL 9.3 released!</a></li>  <li> <a href="http://www.postgresql.org/docs/9.3/static/">PostgreSQL 9.3.0 Documentation</a>
</li>
</ul>
<p>以下では<a class="keyword" href="http://d.hatena.ne.jp/keyword/CentOS">CentOS</a> 6.4環境への<a class="keyword" href="http://d.hatena.ne.jp/keyword/PostgreSQL">PostgreSQL</a> 9.3のインストールからデータベースへ接続するまでを記載しています。 </p>
<a name="more"></a> <h4>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/PostgreSQL">PostgreSQL</a> 9.3のインストール</h4>
<h5>環境</h5>
<p>インストール環境は以下です </p>
<table>
<tr>  <td bgcolor="#cccccc">プラットフォーム</td>  <td>さくらの<a class="keyword" href="http://d.hatena.ne.jp/keyword/VPS">VPS</a> <a class="keyword" href="http://d.hatena.ne.jp/keyword/SSD">SSD</a> 1Gモデル</td>
</tr>
<tr>  <td bgcolor="#cccccc">OS</td>  <td>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/CentOS">CentOS</a> 6.4 <a class="keyword" href="http://d.hatena.ne.jp/keyword/x86">x86</a>_64 (64bit)</td>
</tr>
</table> <h5>事前準備</h5>
<p>事前に必要なパッケージをインストールします。libossp-uuid.so.16というライブラリが必要になりますので、そのライブラリが含まれるuuidのパッケージをインストールします。<br>他にも必要なパッケージがあるかもしれませんが、その際は必要なものをインストールします。 </p>
<pre class="terminal">  # yum install uuid  </pre> <h5>インストール</h5>
<p>スーパーユーザにスイッチします。 </p>
<p></p>
<pre class="terminal">  $ su - パスワード:  
</pre>
<p>pgdg<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EA%A5%DD%A5%B8%A5%C8%A5%EA">リポジトリ</a>(<a class="keyword" href="http://d.hatena.ne.jp/keyword/PostgreSQL">PostgreSQL</a> <a class="keyword" href="http://d.hatena.ne.jp/keyword/Yum">Yum</a> Repository)をインストールしても良いのですが、<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EA%A5%DD%A5%B8%A5%C8%A5%EA">リポジトリ</a>の管理も手間なので、以下のように<a class="keyword" href="http://d.hatena.ne.jp/keyword/RPM">RPM</a>コマンド実行時に<a class="keyword" href="http://d.hatena.ne.jp/keyword/RPM">RPM</a>ファイルのURLを直接指定する形でインストールします。¥で改行していますが、一行で記載いただいて構いません。 </p>
<pre class="terminal">  # rpm -ihv http://yum.postgresql.org/9.3/redhat/rhel-6.4-x86_64/postgresql93-9.3.0-1PGDG.rhel6.x86_64.rpm \ http://yum.postgresql.org/9.3/redhat/rhel-6.4-x86_64/postgresql93-server-9.3.0-1PGDG.rhel6.x86_64.rpm \ http://yum.postgresql.org/9.3/redhat/rhel-6.4-x86_64/postgresql93-libs-9.3.0-1PGDG.rhel6.x86_64.rpm \ http://yum.postgresql.org/9.3/redhat/rhel-6.4-x86_64/postgresql93-contrib-9.3.0-1PGDG.rhel6.x86_64.rpm \ http://yum.postgresql.org/9.3/redhat/rhel-6.4-x86_64/postgresql93-devel-9.3.0-1PGDG.rhel6.x86_64.rpm  
</pre>
<p>インストールはこれだけで完了です。 </p>
<p>起動してみます。 </p>
<pre class="terminal">  # service postgresql-9.3 start  /var/lib/pgsql/9.3/data is missing. Use "service postgresql-9.3 initdb" to initialize the cluster first.                                                            [FAILED]  </pre> <p>データベース<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AF%A5%E9%A5%B9%A5%BF">クラスタ</a>を初期化しろ、と怒られてしまいました。 <br><a class="keyword" href="http://d.hatena.ne.jp/keyword/PostgreSQL">PostgreSQL</a>を使用できる状態にするには、データベース<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AF%A5%E9%A5%B9%A5%BF">クラスタ</a>(データベースを格納する領域)を初期化する必要があり、それを実行していないためです。 </p> <p>メッセージにある通りinitdbを実行します。 </p>
<pre class="terminal">   # service postgresql-9.3 initdb --encoding=UTF8 --no-locale  Initializing database:                                     [  OK  ]  </pre> <p>指定しているオプションの意味は以下です。データベース作成先<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リ(デフォルト:/var/lib/pgsql/9.3/data)等もここで指定できます。各オプションに関しては必ずしもここで指定する必要がないものもありますので、環境に合わせて指定してください。 </p>
<ul>  <li>--encoding: データベースのデフォルトの文字<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A8%A5%F3%A5%B3%A1%BC%A5%C7%A5%A3%A5%F3%A5%B0">エンコーディング</a>を設定するオプション。ここでは文字<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A8%A5%F3%A5%B3%A1%BC%A5%C7%A5%A3%A5%F3%A5%B0">エンコーディング</a>に<a class="keyword" href="http://d.hatena.ne.jp/keyword/UTF-8">UTF-8</a>を指定している。</li>  <li>--no-localeは、<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%ED%A5%B1%A1%BC%A5%EB">ロケール</a>を使用しないことを設定するオプション。localeでは文字列処理やメッセージ等を変更できる。--no-localeは--locale=Cと同じことを指し、C <a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%ED%A5%B1%A1%BC%A5%EB">ロケール</a>以外を設定すると性能へ影響する可能性もある。</li>
</ul>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%ED%A5%B1%A1%BC%A5%EB">ロケール</a>(--locale)と<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A8%A5%F3%A5%B3%A1%BC%A5%C7%A5%A3%A5%F3%A5%B0">エンコーディング</a>(--encoding)は同じ値を設定する必要がありますが、encoding=<a class="keyword" href="http://d.hatena.ne.jp/keyword/SQL">SQL</a>_ASCIIとする場合、またはlocale=C(--no-locale)とする場合は例外です。  </p> <p>これで<a class="keyword" href="http://d.hatena.ne.jp/keyword/PostgreSQL">PostgreSQL</a>を使用できる状態となりました。<br>再度、起動処理を実行してみます。 </p>
<pre class="terminal">  # service postgresql-9.3 start Starting postgresql-9.3 service:                           [  OK  ]  </pre> <p>各プロセスが起動していることが分かります。 </p>
<pre class="terminal">  # ps auxf | grep postgre | grep -v grep postgres 21428  0.0  0.7 224856 13840 ?        S    16:48   0:00 /usr/pgsql-9.3/bin/postmaster -p 5432 -D /var/lib/pgsql/9.3/data postgres 21430  0.0  0.0  80480  1180 ?        Ss   16:48   0:00  \_ postgres: logger process postgres 21432  0.0  0.0 224856  1432 ?        Ss   16:48   0:00  \_ postgres: checkpointer process postgres 21433  0.0  0.1 224856  2268 ?        Ss   16:48   0:00  \_ postgres: writer process postgres 21434  0.0  0.0 224856  1412 ?        Ss   16:48   0:00  \_ postgres: wal writer process postgres 21435  0.0  0.1 225716  2616 ?        Ss   16:48   0:00  \_ postgres: autovacuum launcher process postgres 21436  0.0  0.0  80612  1488 ?        Ss   16:48   0:00  \_ postgres: stats collector process  </pre> <p>では、接続してみます。初期では<a class="keyword" href="http://d.hatena.ne.jp/keyword/PostgreSQL">PostgreSQL</a>側に"postgres"という名前のユーザ、"postgres"という名前のデータベースがありますのでそれに接続してみます、 </p>
<pre class="terminal">  # psql -U postgres -d postgres psql: FATAL:  Peer authentication failed for user "postgres"  </pre> <p>接続できませんでした。これは<a class="keyword" href="http://d.hatena.ne.jp/keyword/PostgreSQL">PostgreSQL</a>のクライアント認証設定が影響しています。 </p>
<p>上記の接続はローカルからの接続だったため、-hでホストを指定しなかったので、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Unix">Unix</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C9%A5%E1%A5%A4%A5%F3">ドメイン</a>ソケット経由の通信となります。<br>設定ファイルを見ると、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Unix">Unix</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C9%A5%E1%A5%A4%A5%F3">ドメイン</a>ソケット経由での接続時の認証方式はデフォルトではpeerとなっており、OSユーザと接続先DBのユーザと一致していなければ接続できません。<br>上記の接続の仕方ですと、OS上でpostgresユーザになっていると接続先データベースのユーザと一致しますので接続できます。<a class="keyword" href="http://d.hatena.ne.jp/keyword/RPM">RPM</a>パッケージをインストールした際に自動的にOS上にpostgresユーザが作成されます。 </p>
<pre class="terminal">  # cat /var/lib/pgsql/9.3/data/pg_hba.conf … # "local" is for Unix domain socket connections only local   all             all                                     peer # IPv4 local connections: host    all             all             127.0.0.1/32            ident # IPv6 local connections: host    all             all             ::1/128                 ident …  </pre> <p>この状態も手間なので、ローカルの全てのユーザが<a class="keyword" href="http://d.hatena.ne.jp/keyword/Unix">Unix</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C9%A5%E1%A5%A4%A5%F3">ドメイン</a>ソケット経由で任意のデータベースに接続することを許可しておきます。<br>セキュリティを考えるとtrustでは無く<a class="keyword" href="http://d.hatena.ne.jp/keyword/md5">md5</a>などにした方が良いかと思いますが、ここでは考慮しません。 </p>
<pre class="terminal">  # vim /var/lib/pgsql/9.3/data/pg_hba.conf … # "local" is for Unix domain socket connections only local   all             all                                     trust  # # IPv4 local connections: host    all             all             127.0.0.1/32            ident # IPv6 local connections: host    all             all             ::1/128                 ident …  
</pre>
<p>設定変更後、<a class="keyword" href="http://d.hatena.ne.jp/keyword/PostgreSQL">PostgreSQL</a>を再起動します。 </p>
<pre class="terminal">  # service postgresql-9.3 restart Stopping postgresql-9.3 service:                           [  OK  ] Starting postgresql-9.3 service:                           [  OK  ]  </pre> <p>再度接続を試します。 </p>
<pre class="terminal">  # psql -U postgres -d postgres psql (9.3.0) Type "help" for help.  postgres=#  </pre> <p>接続できました。<br>接続を終了するには、\qコマンドを実行します。 </p> <p>以上が、インストールからデータベースへ接続するまでの手順です。<br>ここでは細かいところまで記載していませんが、引き続き設定を行っていくにあたって、実行ファイルやライブラリへのPATH指定が.bashrcへ必要になったりなど追加の設定が必要になる知れません。 </p> <h4>おわりに</h4>
<p>ここでは<a class="keyword" href="http://d.hatena.ne.jp/keyword/PostgreSQL">PostgreSQL</a> 9.3をインストールしてからデータベースへ接続するまでの基本的な手順を記載しました。<br><a class="keyword" href="http://d.hatena.ne.jp/keyword/PostgreSQL">PostgreSQL</a> 9.3ではマテ<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EA%A5%A2%A5%E9%A5%A4%A5%BA">リアライズ</a>ドビューや１秒以内での高速フェイルオーバー機能、<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EC%A5%D7%A5%EA%A5%B1%A1%BC%A5%B7%A5%E7%A5%F3">レプリケーション</a>機能改善など、大規模なシステム環境向けの機能追加や耐障害性の強化等がなされているようで、これからもさらに使われていく機会は増えていきそうです。 </p>
</body>

<!-- more -->


