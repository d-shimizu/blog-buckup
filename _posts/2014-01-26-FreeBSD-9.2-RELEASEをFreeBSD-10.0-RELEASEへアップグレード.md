---
layout: post
Categories:  ["tech"]
Description:  " はじめに  2014/1/20 FreeBSD 10-RELEASEが公開されました。10系の初リリースです。      FreeBSD 10.0-RELEASE Announcement    さくらのVPSで使っているFreeBSD "
Tags: ["FreeBSD", "さくらのVPS"]
date: "2014-01-26T23:32:00+09:00"
title: "FreeBSD 9.2-RELEASEをFreeBSD 10.0-RELEASEへアップグレード"
author: "dshimizu"
archive: ["2014"]
draft: "true"
---

<body>
<h4>はじめに</h4>
<p>2014/1/20 <a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a> 10-RELEASEが公開されました。10系の初リリースです。 </p>
<ul>  <li><a href="https://www.freebsd.org/releases/10.0R/announce.html">FreeBSD 10.0-RELEASE Announcement</a></li>
</ul> <p>さくらの<a class="keyword" href="http://d.hatena.ne.jp/keyword/VPS">VPS</a>で使っている<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a> 9.2-RELEASEを10.0-RELEASEへアップグレードしてみましたので、その際に実施した手順を記載します。 </p>
<a name="more"></a><h4>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a> 9.2-RELEASEを10.0-RELEASEへアップグレード</h4>
<p>公式マニュアルの手順を元に、アップデートを実施します。 </p>
<ul>  <li><a href="http://www.freebsd.org/doc/ja/books/handbook/updating-upgrading-freebsdupdate.html#freebsdupdate-upgrade">18.2. FreeBSD Update</a></li>
</ul>
<p>ただし、利用している<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a>のパッチレベルによっては<code>portupgrade</code>コマンドの不具合でアップグレード処理を実行できませんのでパッチを適用する必要があります。 </p>
<ul>  <li><a href="http://www.freebsd.org/security/advisories/FreeBSD-EN-13:04.freebsd-update.asc">FreeBSD-EN-13:04.freebsd-update.asc</a></li>  <li><a href="http://www.freebsd.org/security/advisories/FreeBSD-EN-13:05.freebsd-update.asc">FreeBSD-EN-13:05.freebsd-update.asc</a></li>
</ul>
<p>また、<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a> 10.0-RELEASEからデフォルトのバイナリパッケージ管理ツールが変更になったことで、メジャーバージョンアップ後のソフトウェアの更新が従来通りのやり方ではうまくいきませんでした。この点については以下に記載しているやり方が正しいのかわかりません。 </p>
<h5>実行環境</h5>
<p>実行環境は以下となります。  </p>
<table>
<tr>  <td bgcolor="#cccccc">プラットフォーム</td>  <td>さくらの<a class="keyword" href="http://d.hatena.ne.jp/keyword/VPS">VPS</a> 512</td>
</tr>
<tr>  <td bgcolor="#cccccc">OS</td>  <td>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a> 9.2-RELEASE-p0 (<a class="keyword" href="http://d.hatena.ne.jp/keyword/amd64">amd64</a>)</td>
</tr>
</table> <h5>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/freebsd">freebsd</a>-updateの個別パッチの適用</h5>
<p>セキュリティパッチの当たっていない<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a> 9.2-RELEASE-p0を利用しており、<code>freebsd-update</code>コマンドに不具合があり、<code>freebsd-update</code>コマンド実行時に以下のエラーが出てアップデートを実行できませんでした。 </p>
<pre class="terminal">  The update metadata is correctly signed, but failed an integrity check. Cowardly refusing to proceed any further.  
</pre>
<p>そのため、上記のErrata Noteの内容を参考に<code>freebsd-update</code>コマンドにパッチをあてます。<br>なお、該当の不具合が修正されているセキュリティパッチの適用された<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a>であれば、この手順は不要です。 </p>
<p>作業は全てrootで実施しますので、rootにスイッチします。  </p>
<p></p>
<pre class="terminal">  $ su -  
</pre>
<h6>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a>-EN-13:04のパッチ適用</h6>
<p><code>FreeBSD-EN-13:04</code>のパッチを適用します。 </p>
<p>パッチファイル設置用の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リを作成します。 </p>
<pre class="terminal">  # mkdir /tmp/FreeBSD-EN-13:04  
</pre>
<p>作業用<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リに移動します。 </p>
<pre class="terminal">  # cd /tmp/FreeBSD-EN-13:04  
</pre>
<p>パッチファイルをダウンロードします。 </p>
<pre class="terminal">  # fetch http://security.FreeBSD.org/patches/EN-13:04/freebsd-update.patch  
</pre>
<p>以下の通りにダウロードされます。 </p>
<pre class="terminal">  fetch: http://security.FreeBSD.org/patches/EN-13:04/freebsd-update.patch: size of remote file is not known freebsd-update.patch                                  2754  B 3756 kBps 00m00s  
</pre>
<p><code>gpg</code>コマンド(<a class="keyword" href="http://d.hatena.ne.jp/keyword/GnuPG">GnuPG</a>)がある場合は<a class="keyword" href="http://d.hatena.ne.jp/keyword/PGP">PGP</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B7%A5%B0%A5%CD%A5%C1%A5%E3">シグネチャ</a>ファイルをダウンロードします。 </p>
<pre class="terminal">  # fetch http://security.FreeBSD.org/patches/EN-13:04/freebsd-update.patch.asc  
</pre>
<p>以下の通りにダウロードされます。 </p>
<pre class="terminal">  fetch: http://security.FreeBSD.org/patches/EN-13:04/freebsd-update.patch.asc: size of remote file is not known freebsd-update.patch.asc                               801  B 1245 kBps 00m00s  
</pre>
<p><code>gpg</code>コマンド(<a class="keyword" href="http://d.hatena.ne.jp/keyword/GnuPG">GnuPG</a>)がある場合は<a class="keyword" href="http://d.hatena.ne.jp/keyword/PGP">PGP</a>署名を確認します。なければ飛ばしても構いません。 </p>
<pre class="terminal">  # gpg --verify freebsd-update.patch.asc  </pre> <p><code>/usr/src</code><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リに移動してます。 </p>
<pre class="terminal">  # cd /usr/src  
</pre>
<p>ダウンロードしたパッチファイルを使って修正差分を適用します。 </p>
<pre class="terminal">  # patch &lt; /tmp/FreeBSD-EN-13:04/freebsd-update.patch  
</pre>
<p>以下の通りにパッチが適用されます。 </p>
<pre class="terminal">  Hmm...  Looks like a unified diff to me... The text leading up to this was: -------------------------- |Index: usr.sbin/freebsd-update/freebsd-update.sh |=================================================================== |--- usr.sbin/freebsd-update/freebsd-update.sh |+++ usr.sbin/freebsd-update/freebsd-update.sh -------------------------- Patching file usr.sbin/freebsd-update/freebsd-update.sh using Plan A... Hunk #1 succeeded at 1200. Hunk #2 succeeded at 2814. Hunk #3 succeeded at 2852. Hunk #4 succeeded at 2876. done  </pre> <p><code>/usr/src/usr.sbin/freebsd-update</code><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リに移動します。 </p>
<pre class="terminal">  # cd /usr/src/usr.sbin/freebsd-update  
</pre>
<p><code>freebsd-update</code>コマンドのリビルドを実施します。 </p>
<pre class="terminal">  # make install -DWITHOUT_MAN  
</pre>
<pre class="terminal">  install -o root  -g wheel -m 555  freebsd-update.sh  /usr/sbin/freebsd-update  
</pre>
<h6>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a>-EN-13:05のパッチ適用</h6>
<p><code>FreeBSD-EN-13:05</code>のパッチを適用します。 </p>
<p>パッチファイル設置用の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リを作成します。 </p>
<pre class="terminal">  # mkdir /tmp/FreeBSD-EN-13:05  
</pre>
<p>作業用<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リに移動してます。 </p>
<pre class="terminal">  # cd /tmp/FreeBSD-EN-13:05  
</pre>
<p>パッチファイルをダウンロードします。 </p>
<pre class="terminal">  # fetch http://security.FreeBSD.org/patches/EN-13:05/freebsd-update.patch  
</pre>
<p>以下の通りにダウロードされます。 </p>
<pre class="terminal">  fetch: http://security.FreeBSD.org/patches/EN-13:05/freebsd-update.patch: size of remote file is not known freebsd-update.patch                                   653  B 1521 kBps 00m00s  
</pre>
<p><code>gpg</code>コマンド(GunPG)がある場合は<a class="keyword" href="http://d.hatena.ne.jp/keyword/PGP">PGP</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B7%A5%B0%A5%CD%A5%C1%A5%E3">シグネチャ</a>ファイルをダウンロードします。 </p>
<pre class="terminal">  # fetch http://security.FreeBSD.org/patches/EN-13:05/freebsd-update.patch.asc  
</pre>
<p>以下の通りにダウロードされます。 </p>
<pre class="terminal">  fetch: http://security.FreeBSD.org/patches/EN-13:05/freebsd-update.patch.asc: size of remote file is not known freebsd-update.patch.asc                               801  B 3007 kBps 00m00s  
</pre>
<p><code>gpg</code>コマンド(GunPG)コマンドがある場合は<a class="keyword" href="http://d.hatena.ne.jp/keyword/PGP">PGP</a>署名を確認します。なければ飛ばしても構いません。 </p>
<pre class="terminal">  # gpg --verify freebsd-update.patch.asc  </pre> <p><code>/usr/src</code><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リに移動します。 </p>
<pre class="terminal">  # cd /usr/src  
</pre>
<p>ダウンロードしたパッチファイルを使って修正差分を適用します。 </p>
<pre class="terminal">  # patch &lt; /tmp/FreeBSD-EN-13:05/freebsd-update.patch  
</pre>
<p>以下の通りにパッチが適用されます。 </p>
<pre class="terminal">  Hmm...  Looks like a unified diff to me... The text leading up to this was: -------------------------- |Index: usr.sbin/freebsd-update/freebsd-update.sh |=================================================================== |--- usr.sbin/freebsd-update/freebsd-update.sh  (revision 257878) |+++ usr.sbin/freebsd-update/freebsd-update.sh  (revision 257879) -------------------------- Patching file usr.sbin/freebsd-update/freebsd-update.sh using Plan A... Reversed (or previously applied) patch detected!  Assume -R? [y] y Hunk #1 succeeded at 2884. done  
</pre>
<p><code>/usr/src/usr.sbin/freebsd-update</code><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リに移動します。 </p>
<pre class="terminal">  # cd /usr/src/usr.sbin/freebsd-update  
</pre>
<p><code>freebsd-update</code>コマンドのリビルドを実施します。 </p>
<pre class="terminal">  # make install -DWITHOUT_MAN  
</pre>
<pre class="terminal">  install -o root  -g wheel -m 555  freebsd-update.sh  /usr/sbin/freebsd-update  </pre> <h5>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a>のメジャーバージョンアップ</h5>
<p><code>freebsd-update</code>コマンドを使って<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a> 10.0-RELEASEへのメジャーバージョンアップを実施します。 </p>
<h6>更新ファイルのダウンロード</h6>
<p>10.0-RELEASEへアップデートするために必要なファイルを取得します。 </p>
<pre class="terminal">  # /usr/sbin/freebsd-update -r 10.0-RELEASE upgrade  
</pre>
<p>更新対象となるファイルに対して、<code>Does this look reasonable (y/n)?</code>(変更に問題ないか？)といったことを聞かれるので<code>y</code>(yes)と入力します。  </p>
<pre class="terminal">  Looking up update.FreeBSD.org mirrors... 5 mirrors found. Fetching metadata signature for 9.2-RELEASE from update4.freebsd.org... done. Fetching metadata index... done. Inspecting system... done.  The following components of FreeBSD seem to be installed: kernel/generic src/src world/base  The following components of FreeBSD do not seem to be installed: world/doc world/games world/lib32  Does this look reasonable (y/n)? y  Fetching metadata signature for 10.0-RELEASE from update4.freebsd.org... done. Fetching metadata index... done. Inspecting system... done. Fetching files from 9.2-RELEASE for merging... done. Preparing to download files... done. Fetching 38043 patches.....10....20....30....40....50....60....70....80....90....100....110....120....130....140....150....160....170....180....190....200....210....220....230....240....250....260.. ･･･ ･･･ ･･･ ....36060....36070....36080....36090....36100....36110....36120....36130....36140....36150....36160....36170....36180....36190....36200....36210....36220....36230....36240....36250....36260....36270....36280....36290....36300....36310....36320....36330....36340....36350....36360....36370....36380....36390....36400....36410....36420....36430....36440....36450.. done. Applying patches... done. Fetching 9673 files... Attempting to automatically merge changes in files... done.  
</pre>
<p>変更対象の設定ファイルが表示されます。同様に<code>Does this look reasonable (y/n)?</code>(変更に問題ないか？)といったことを聞かれるので<code>y</code>(yes)と入力します。  </p>
<pre class="terminal">  he following changes, which occurred between FreeBSD 9.2-RELEASE and FreeBSD 10.0-RELEASE have been merged into /etc/group: --- current version +++ new version @@ -1,6 +1,6 @@ -# $FreeBSD: release/9.2.0/etc/group 218046 2011-01-28 22:28:12Z pjd $ +# $FreeBSD: release/10.0.0/etc/group 256366 2013-10-12 06:08:18Z rpaulo $  #  wheel:*:0:root,shimizu,vps,zabbix  daemon:*:1:  kmem:*:2:  sys:*:3: @@ -16,10 +16,11 @@  sshd:*:22:  smmsp:*:25:  mailnull:*:26:  guest:*:31:  bind:*:53: +unbound:*:59:  proxy:*:62:  authpf:*:63:  _pflogd:*:64:  _dhcp:*:65:  uucp:*:66: Does this look reasonable (y/n)? y ･･･ ･･･ ･･･ The following changes, which occurred between FreeBSD 9.2-RELEASE and FreeBSD 10.0-RELEASE have been merged into /etc/ssh/sshd_config: --- current version +++ new version @@ -1,7 +1,7 @@ -#      $OpenBSD: sshd_config,v 1.89 2013/02/06 00:20:42 dtucker Exp $ -#      $FreeBSD: release/9.2.0/crypto/openssh/sshd_config 252339 2013-06-28 09:55:00Z des $ +#      $OpenBSD: sshd_config,v 1.90 2013/05/16 04:09:14 dtucker Exp $ +#      $FreeBSD: release/10.0.0/crypto/openssh/sshd_config 258343 2013-11-19 11:47:30Z des $   # This is the sshd server system-wide configuration file.  See  # sshd_config(5) for more information.   # This sshd was compiled with PATH=/usr/bin:/bin:/usr/sbin:/sbin @@ -31,10 +31,13 @@   # Lifetime and size of ephemeral version 1 server key  #KeyRegenerationInterval 1h  #ServerKeyBits 1024  +# Ciphers and keying +#RekeyLimit default none +  # Logging  # obsoletes QuietMode and FascistLogging  #SyslogFacility AUTH  #LogLevel INFO  @@ -114,11 +117,11 @@  #UseDNS yes  #PidFile /var/run/sshd.pid  #MaxStartups 10:30:100  #PermitTunnel no  #ChrootDirectory none -#VersionAddendum FreeBSD-20130515 +#VersionAddendum FreeBSD-20131111   # no default banner path  #Banner none   # override default of no subsystems Does this look reasonable (y/n)? y  The following files are affected by updates, but no changes have been downloaded because the files have been modified locally: /.cshrc /root/.cshrc  
</pre>
<p>10.0-RELEASEへのアップデートに伴って削除されるファイル一覧が表示されます。 </p>
<pre class="terminal">  The following files will be removed as part of updating to 10.0-RELEASE-p0: /boot/kernel/atadisk.ko /boot/kernel/atadisk.ko.symbols /boot/kernel/atapicam.ko /boot/kernel/atapicam.ko.symbols /boot/kernel/atapicd.ko /boot/kernel/atapicd.ko.symbols /boot/kernel/atapifd.ko /boot/kernel/atapifd.ko.symbols /boot/kernel/atapist.ko /boot/kernel/atapist.ko.symbols /boot/kernel/ataraid.ko /boot/kernel/ataraid.ko.symbols /boot/kernel/coda.ko ･･･ ･･･ ･･･ /usr/src/usr.sbin/zic/Makefile.inc /usr/src/usr.sbin/zic/README /usr/src/usr.sbin/zic/zdump/Makefile /usr/src/usr.sbin/zic/zic/Makefile /usr/src/usr.sbin/zzz/Makefile /usr/src/usr.sbin/zzz/zzz.8 /usr/src/usr.sbin/zzz/zzz.sh /var/cache /var/db/mergemaster.mtree /var/empty /var/yp/Makefile.dist To install the downloaded upgrades, run "/usr/sbin/freebsd-update install".  
</pre>
<h6>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AB%A1%BC%A5%CD%A5%EB">カーネル</a>/<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AB%A1%BC%A5%CD%A5%EB">カーネル</a>モジュール更新</h6>
<p>更新ファイルはまだ反映されていないので、上記<code>freebsd-update</code>コマンド実行後の最後のメッセージにある通りに、<code>freebsd-update install</code>コマンドを実行します。 </p>
<pre class="terminal">  # /usr/sbin/freebsd-update install  </pre> <p>更新が反映(ディスクへ書き込み)されます。 </p>
<pre class="terminal">  Installing updates... Kernel updates have been installed.  Please reboot and run "/usr/sbin/freebsd-update install" again to finish installing updates.  
</pre>
<p>上記メッセージに表示されているとおり、OS再起動を実施すると新しい<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AB%A1%BC%A5%CD%A5%EB">カーネル</a>(10.0-RELEASE)で起動するはずです。 </p>
<pre class="terminal">  # shutdown -r now  </pre> <p>起動後、rootへスイッチします。 </p>
<pre class="terminal">  # su -  
</pre>
<p>OSバージョンが<code>10.0-RELEASE</code>となっていることを確認します。 </p>
<pre class="terminal">  # uname -r 10.0-RELEASE  
</pre>
<h6>古いライブラリ/ファイル類の削除</h6>
<p>再び<code>freebsd-update</code>コマンドを実行します。 </p>
<pre class="terminal">  # /usr/sbin/freebsd-update install  
</pre>
<p>古い共有ライブラリとオブジェクトファイルを削除されます。 </p>
<pre class="terminal">  Installing updates... Completing this upgrade requires removing old shared object files. Please rebuild all installed 3rd party software (e.g., programs installed from the ports tree) and then run "/usr/sbin/freebsd-update install" again to finish installing updates.  </pre>  <h5>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D5%A5%A1%A5%A4%A5%EB%A5%B7%A5%B9%A5%C6%A5%E0">ファイルシステム</a>とストレージプールの更新</h5> <p>利用可能な<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D5%A5%A1%A5%A4%A5%EB%A5%B7%A5%B9%A5%C6%A5%E0">ファイルシステム</a>とストレージプールのバージョンは<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a>のバージョンによって異なります。<br><a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a>のアップグレードによって<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D5%A5%A1%A5%A4%A5%EB%A5%B7%A5%B9%A5%C6%A5%E0">ファイルシステム</a>とストレージプールのバージョンはアップグレードされますが、現在動作している<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D5%A5%A1%A5%A4%A5%EB%A5%B7%A5%B9%A5%C6%A5%E0">ファイルシステム</a>とストレージプールは古いバージョンのままで動作し続けますので、最新バージョンの機能を利用できるように、現在動作している<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D5%A5%A1%A5%A4%A5%EB%A5%B7%A5%B9%A5%C6%A5%E0">ファイルシステム</a>とストレージプールに対して以下のコマンドを実行してアップグレードを実行します。<br>※9.2-RELEASEと10.0-RELEASEで<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D5%A5%A1%A5%A4%A5%EB%A5%B7%A5%B9%A5%C6%A5%E0">ファイルシステム</a>とストレージプールのバージョンに違いはありませんが追加機能等が反映されているかわかりませんので念のため実行しています。 </p>
<pre class="terminal">  # zpool upgrade -a  </pre> <pre class="terminal">  # zfs upgrade -a  </pre> <h5>パッケージの更新</h5>
<p>最後にパッケージの更新を実施します。 </p>
<p>まず、最新<a class="keyword" href="http://d.hatena.ne.jp/keyword/ports">ports</a>を取得し、<code>/usr</code>以下へ展開します。 </p>
<p>既存<a class="keyword" href="http://d.hatena.ne.jp/keyword/ports">ports</a>を移動させます。 </p>
<pre class="terminal">  # mv /usr/ports /usr/ports.bak  
</pre>
<p>最新<a class="keyword" href="http://d.hatena.ne.jp/keyword/ports">ports</a>を取得します。 </p>
<pre class="terminal">  # wget http://ftp.jaist.ac.jp/pub/FreeBSD/ports/ports/ports.tar.gz -P /tmp  
</pre>
<p><code>/usr</code>以下へ展開します。 </p>
<pre class="terminal">  # tar -zxvf /tmp/ports.tar.gz -C /usr/  
</pre>
<p>これまでは<code>portmaster</code>コマンドを実行すればアップデートできてましたが、<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a> 10.0-RELEASEでこれを実行してもアップデートされませんでした。 </p>
<pre class="terminal">  # portmaster -af  
</pre>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a> 10.0-RELEASEからはデフォルトのパッケージ管理システムが従来の<code>pkg_*</code>からpkgngへと変更になったためかと思い、pkgngを利用するためには従来のパッケージ管理データベースをpkgng形式のフォーマットへ変換する必要する必要があるとのことでしたので、pkgng形式への変更を試みました。 </p>
<h6>pkgng</h6>
<p><code>pkgng</code>は<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a> 10.0-RELEASE以降デフォルトとなるパッケージ管理システムです。 </p>
<ul>  <li><a href="http://www.freebsd.org/doc/ja/books/handbook/pkgng-intro.html">5.5. pkgng によるバイナリ package の管理</a></li>  <li><a href="http://lists.freebsd.org/pipermail/freebsd-pkg/2013-October/000107.html">Official FreeBSD Binary Packages now available for pkgng</a></li>
</ul>
<p><code>pkg</code>コマンドがインストールされていない場合、<code>pkg</code>コマンドを実行するとブートストラップユーティリティによって自動でインストール処理が実行されます(<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a> 9.1 以降)。 </p>
<pre class="terminal">  # pkg  
</pre>
<p><code>pkgng</code>形式を利用する以前からインストールされているパッケージ/アプリケーションがある場合は<code>pkg2ng</code>コマンドを実行してフォーマットを変更するようにメッセージが出ます。 </p>
<pre class="terminal">  The package management tool is not yet installed on your system. Do you want to fetch and install it now? [y/N]: y Bootstrapping pkg please wait Installing pkg-1.2.5... done If you are upgrading from the old package format, first run:    $ pkg2ng ･･･  </pre> <p><code>pkg2ng</code>コマンドを実行し、パッケージ管理データベースを新しいフォーマットへ変換します。 </p>
<pre class="terminal">  # pkg2ng  
</pre>
<p><code>pkg2ng</code>コマンド実行後、<code>/var/db/pkg</code><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リにpkgngの<a class="keyword" href="http://d.hatena.ne.jp/keyword/SQLite">SQLite</a>データベースが作成されます。 </p>
<pre class="terminal">  # ls -lt /var/db/pkg | head -n 5 total 43802 -rw-r--r--    1 root  wheel   8911872  1月 22 10:42 local.sqlite drwxr-xr-x    2 root  wheel         3  1月 22 01:02 gettext-0.18.3.1 drwxr-xr-x    2 root  wheel         3  1月 22 01:02 gmake-3.82_1 drwxr-xr-x    2 root  wheel         3  1月 22 01:02 libxml2-2.8.0_3  
</pre>
<p><code>pkg info</code>コマンドを実行すると、pkgng形式になったパッケージ一覧が表示されます。 </p>
<pre class="terminal">  # pkg info  
</pre>
<p>最新のバイナリパッケージへアップデートします。 </p>
<pre class="terminal">  # pkg upgrade -f  </pre> <p>ここで、パッケージの依存関係でconflictが発生したりするので、適宜パッケージを削除/インストールして調整しなければならないと思います。<br>また、細かい<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B3%A5%F3%A5%D1%A5%A4%A5%EB">コンパイル</a>オプションが必要なものは<a class="keyword" href="http://d.hatena.ne.jp/keyword/ports">ports</a>からインストールし直す必要があります。 </p>
<p>依存関係が解決できたら、再度最新のバイナリパッケージへアップデートを試みます。 </p>
<pre class="terminal">  # pkg upgrade -f  </pre> <h4>おわりに</h4>
<p>以上で、<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a> 9.2-RELEASEから10.0-RELEASEへの更新が完了しました。<br>個人的には新しいパッケージ管理システムpkgngが<a class="keyword" href="http://d.hatena.ne.jp/keyword/ports">ports</a>や<code>pkg_*</code>コマンドより手軽な感じが良いなと思いました。<br><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D1%A5%C3%A5%B1%A1%BC%A5%B8%A5%BD%A5%D5%A5%C8">パッケージソフト</a>ウェアのアップデートのやり方が上記のような形で正しいのかはわかっていませんが、問題なく動作しているようです。 10-RELEASEの<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A4%A5%F3%A5%B9%A5%C8%A1%BC%A5%E9">インストーラ</a>からインストール時に<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D5%A5%A1%A5%A4%A5%EB%A5%B7%A5%B9%A5%C6%A5%E0">ファイルシステム</a>で<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a>を選択できるようになったのも嬉しいです。 </p>
<h4>参考</h4>
<ul>  <li><a href="http://news.mynavi.jp/news/2014/01/21/087/">FreeBSD 10.0-RELEASE登場 | マイナビニュース</a></li>  <li><a href="http://sourceforge.jp/magazine/14/01/22/155000">「FreeBSD 10.0-RELEASE」公開、ClangがデフォルトコンパイラになりHyper-V対応も強化 | SourceForge.JP Magazine</a></li>  <li><a href="http://news.mynavi.jp/special/2013/bsd/index.html">間もなく登場! FreeBSD 10.0、IT技術者なら知っておくべき11の新機能 (1) 高速圧縮アルゴリズム、圧縮キャッシュ | マイナビニュース 変更する</a></li>  <li><a href="http://gihyo.jp/admin/clip/01/fdt/201311/05">2013年11月5日　次世代パッケージ管理システムpkg(8)，バイナリパッケージ提供開始：FreeBSD Daily Topics｜gihyo.jp … 技術評論社</a></li>  <li><a href="http://gihyo.jp/admin/clip/01/fdt/201208/08%20">FreeBSD Daily Topics：2012年8月8日　次世代パッケージ管理システムpkgの使い方：従来のパッケージからの移行方法｜gihyo.jp … 技術評論社</a></li>  <li><a href="http://www.atmarkit.co.jp/ait/articles/1208/24/news133.html">FreeBSDのコレ知ってる？（3）：次世代パッケージ管理システム、pkg(8) (1/3) - ＠IT</a></li>
</ul>
</body>

<!-- more -->


