---
layout: post
Categories:  ["tech"]
Description:  " Ubuntu 16.04 LTSでPXE Boot環境構築を作ってみたのでその際の手順を残しておく。 "
Tags: ["tech", "Ubuntu"]
date: "2018-03-04T10:56:00+09:00"
title: "Ubuntu 16.04 LTS でPXE Bootサーバ環境構築"
author: "dshimizu"
archive: ["2018"]
draft: "true"
---

<body>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a> 16.04 LTSで<a class="keyword" href="http://d.hatena.ne.jp/keyword/PXE">PXE</a> Boot環境構築を作ってみたのでその際の手順を残しておく。</p>
</body>

<!-- more -->

<body>
<h3>構築手順</h3>


<h4>環境</h4>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a> 16.04を用いて環境構築する。
1台の<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a> 16.04サーバ上にTFTPサーバ、<a class="keyword" href="http://d.hatena.ne.jp/keyword/DHCP">DHCP</a>サーバを立ち上げ、<a class="keyword" href="http://d.hatena.ne.jp/keyword/PXE">PXE</a>ブートできるようにブートに必要なファイルも設置する。
<a class="keyword" href="http://d.hatena.ne.jp/keyword/RedHat">RedHat</a>系だと<a class="keyword" href="http://d.hatena.ne.jp/keyword/FTP">FTP</a>が必要だと思うが、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a>ならTFTPで良い。</p>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/PXE">PXE</a>でインストールしたいサーバが起動時に<a class="keyword" href="http://d.hatena.ne.jp/keyword/DHCP">DHCP</a>で<a class="keyword" href="http://d.hatena.ne.jp/keyword/IP%A5%A2%A5%C9%A5%EC%A5%B9">IPアドレス</a>を取得後、TFTPでブートに必要なファイルにアクセスしてブートプロセスを走らせるようにする。</p>

<p>なお、本手順で作成する環境は<a class="keyword" href="http://d.hatena.ne.jp/keyword/BIOS">BIOS</a>環境に対応したもので、<a class="keyword" href="http://d.hatena.ne.jp/keyword/UEFI">UEFI</a>では別な設定が必要となる。</p>

<table>
<tbody>
<tr>
<th>OS</th>
<td>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a> 16.04 LTS 4.4.0-21-generic</td>
</tr>
<tr>
<th>TFTPサーバソフトウェア</th>
<td>tftpd-hpa 5.2+20150808-1ubuntu1.16.04.1</td>
</tr>
<tr>
<th>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/DHCP">DHCP</a>サーバ</th>
<td>isc-<a class="keyword" href="http://d.hatena.ne.jp/keyword/dhcp">dhcp</a>-server,isc-<a class="keyword" href="http://d.hatena.ne.jp/keyword/dhcp">dhcp</a>-common,isc-<a class="keyword" href="http://d.hatena.ne.jp/keyword/dhcp">dhcp</a>-client 4.3.3-5ubuntu12.7</td>
</tr>
</tbody>
</table>


<h4>TFTPサーバの設定</h4>


<p>まずTFTPサーバを構築する。</p>

<p>必要なパッケージをインストールする。</p>

<pre class="terminal"> $ sudo apt install -y inetutils-inetd tftpd-hpa
 </pre>


<p><code>/etc/default/tftpd-hpa</code>ができているので、以下のように修正する。
<code>-l</code>で単体で起動可能とし、<code>-s</code>でプロセスが起動時に<code>/var/lib/tftpboot</code>へ<a class="keyword" href="http://d.hatena.ne.jp/keyword/chroot">chroot</a>するようになる。</p>

<pre class="terminal"> --- /etc/default/tftpd-hpa.org  20xx-xx-xx 16:03:10.385093931 +0900
+++ /etc/default/tftpd-hpa      20xx-xx-xx 16:11:23.956043875 +0900
@@ -3,4 +3,6 @@
 TFTP_USERNAME="tftp"
 TFTP_DIRECTORY="/var/lib/tftpboot"
 TFTP_ADDRESS=":69"
-TFTP_OPTIONS="--secure"
+TFTP_OPTIONS="-l -s"
 </pre>


<p>設定変更出来たら <code>tftpd-hpa</code> サービスを起動する。</p>

<pre class="terminal"> $ sudo systemctl restart tftpd-hpa
 </pre>


<h4>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/DHCP">DHCP</a>サーバの設定</h4>


<p>続いて<a class="keyword" href="http://d.hatena.ne.jp/keyword/DHCP">DHCP</a>サーバを設定する。</p>

<p>必要なパッケージをインストールする。</p>

<pre class="terminal"> $ sudo apt install -y isc-dhcp-server
 </pre>


<p><code>/etc/dhcp/dhcpd.conf</code>を以下のように書き直す。
<code>subnet xxx...{ }</code>のセクションの中で、利用する<a class="keyword" href="http://d.hatena.ne.jp/keyword/IP%A5%A2%A5%C9%A5%EC%A5%B9">IPアドレス</a>の範囲や<a class="keyword" href="http://d.hatena.ne.jp/keyword/DNS">DNS</a>サーバ名等を記述する必要があるので環境に応じて書き換える。
他にも必要な設定はありそうだがとりあえずはこれで試すことはできる。</p>

<pre class="terminal"> default-lease-time 1800;
max-lease-time 3600;
ddns-update-style none;
subnet 10.1.0.0 netmask 255.255.255.0 {
  option domain-name "private.exmaple.jp";
  option domain-name-servers 10.1.0.7, 10.1.0.7;
  range                      10.1.0.130 10.1.0.135;
  option routers 10.1.0.254;
  filename "pxelinux.0";
}
 </pre>


<p>設定ファイルを作成したら<code>isc-dhcp-server</code>サービスを起動する。</p>

<pre class="terminal"> $ sudo systemctl start isc-dhcp-server
 </pre>


<h4>pxelinuxの設定</h4>


<p>最後に<a class="keyword" href="http://d.hatena.ne.jp/keyword/PXE">PXE</a>ブートできるように、pxelinuxを使うための必要なファイルをTFTPの<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リ以下に設置する。</p>

<p>まずは<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a>で<a class="keyword" href="http://d.hatena.ne.jp/keyword/PXE">PXE</a>ブートを行うために必要なファイル群を取得する。ここでは <code>/tmp</code> に保存しているが好きな場所に置けば良い。</p>

<pre class="terminal"> $ wget http://archive.ubuntu.com/ubuntu/dists/xenial-updates/main/installer-amd64/current/images/netboot/netboot.tar.gz -P /tmp
 </pre>


<p>取得したファイルを展開する。</p>

<pre class="terminal"> $ mkdir /tmp/ubuntu16.04-netboot

$ cd /tmp

$ sudo tar -zxvf netboot.tar.gz -C ubuntu16.04-netboot
./
./ubuntu-installer/
./ubuntu-installer/amd64/
./ubuntu-installer/amd64/pxelinux.0
./ubuntu-installer/amd64/pxelinux.cfg/
./ubuntu-installer/amd64/pxelinux.cfg/default
./ubuntu-installer/amd64/initrd.gz
./ubuntu-installer/amd64/boot-screens/
./ubuntu-installer/amd64/boot-screens/libutil.c32
./ubuntu-installer/amd64/boot-screens/splash.png
./ubuntu-installer/amd64/boot-screens/ldlinux.c32
./ubuntu-installer/amd64/boot-screens/rqtxt.cfg
./ubuntu-installer/amd64/boot-screens/f9.txt
./ubuntu-installer/amd64/boot-screens/f4.txt
./ubuntu-installer/amd64/boot-screens/exithelp.cfg
./ubuntu-installer/amd64/boot-screens/vesamenu.c32
./ubuntu-installer/amd64/boot-screens/f2.txt
./ubuntu-installer/amd64/boot-screens/f10.txt
./ubuntu-installer/amd64/boot-screens/f8.txt
./ubuntu-installer/amd64/boot-screens/libcom32.c32
./ubuntu-installer/amd64/boot-screens/f6.txt
./ubuntu-installer/amd64/boot-screens/f7.txt
./ubuntu-installer/amd64/boot-screens/syslinux.cfg
./ubuntu-installer/amd64/boot-screens/f3.txt
./ubuntu-installer/amd64/boot-screens/adtxt.cfg
./ubuntu-installer/amd64/boot-screens/stdmenu.cfg
./ubuntu-installer/amd64/boot-screens/f1.txt
./ubuntu-installer/amd64/boot-screens/txt.cfg
./ubuntu-installer/amd64/boot-screens/prompt.cfg
./ubuntu-installer/amd64/boot-screens/menu.cfg
./ubuntu-installer/amd64/boot-screens/f5.txt
./ubuntu-installer/amd64/linux
./pxelinux.0
./pxelinux.cfg
./ldlinux.c32
./version.info
 </pre>


<p>続いて、展開したファイルの中から、pxelinuxの利用に必要なものを取得して<code>/var/lib/tftpboot</code>配下に設置する。</p>

<p>そのために<code>/var/lib/tftpboot</code>配下に必要な<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リを作成する。</p>

<pre class="terminal"> $ mkdir -p /var/lib/tftpboot/{ubuntu/{xenial,preseed},boot-screens,pxelinux.cfg}
 </pre>


<p><code>pxelinux.0</code>, <code>ldlinux.c32</code>を<code>/var/lib/tftpboot</code>直下に設置する。</p>

<pre class="terminal"> $ sudo cp -pr /tmp/ubuntu16.04-netboot/ubuntu-installer/amd64/pxelinux.0 /var/lib/tftpboot/

$ sudo cp -pr /tmp/ubuntu16.04-netboot/ubuntu-installer/amd64/boot-screens/ldlinux.c32 /var/lib/tftpboot/
 </pre>


<p><code>libcom32.c32</code>, <code>libutil.c32</code>,<code>vesamenu.c32</code>を<code>/var/lib/tftpboot/boot-screens</code>配下に設置する。</p>

<pre class="terminal"> $ sudo cp -pr /tmp/ubuntu16.04-netboot/ubuntu-installer/amd64/boot-screens/libcom32.c32 /var/lib/tftpboot/boot-screens

$ sudo cp -pr /tmp/ubuntu16.04-netboot/ubuntu-installer/amd64/boot-screens/libutil.c32 /var/lib/tftpboot/boot-screens

$ sudo cp -pr /tmp/ubuntu16.04-netboot/ubuntu-installer/amd64/boot-screens/vesamenu.c32 /var/lib/tftpboot/boot-screens
 </pre>


<p><code>/var/lib/tftpboot/boot-screens</code>直下に<code>syslinux.cfg</code>というファイルを以下のような内容で作成する。</p>

<pre class="terminal"> path boot-screens
include boot-screens/menu.cfg
default boot-screens/vesamenu.c32
prompt 0
timeout 100
 </pre>


<p>続いて、<code>/var/lib/tftpboot/boot-screens</code>直下に<code>menu.cfg</code>というファイルを以下のような内容で作成する。
これは<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A4%A5%F3%A5%B9%A5%C8%A1%BC%A5%E9">インストーラ</a>起動時のメニュー画面を表す。</p>

<pre class="terminal"> menu hshift 13
menu width 49
menu margin 8
menu tabmsg

menu title Installer boot menu
label auto-ubuntu-16.04
        menu label ^Ubuntu 16.04 automated install
        kernel ubuntu/xenial/ubuntu-installer/amd64/linux
        append auto=true priority=critical vga=788 initrd=ubuntu/xenial/ubuntu-installer/amd64/initrd.gz preseed/url=tftp://10.1.0.129/ubuntu/xenial/preseed/preseed.cfg preseed/interactive=false
menu begin ubuntu-16.04
        menu title Ubuntu 16.04
        label mainmenu
                menu label ^Back..
                menu exit
        include ubuntu/xenial/ubuntu-installer/amd64/boot-screens/menu.cfg
menu end
 </pre>


<p><code>/var/lib/tftpboot/pxelinux.cfg/default</code> というファイルを <code>/var/lib/tftpboot/boot-screens/syslinux.cfg</code> の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B7%A5%F3%A5%DC%A5%EA%A5%C3%A5%AF%A5%EA%A5%F3%A5%AF">シンボリックリンク</a>リンクで作成する。</p>

<pre class="terminal"> $ cd /var/lib/tftpboot/pxelinux.cfg

$ sudo ln -s ../boot-screens/syslinux.cfg default
 </pre>


<h4>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a>の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A4%A5%F3%A5%B9%A5%C8%A1%BC%A5%E9">インストーラ</a>起動、及びインストールに必要なファイルの準備</h4>


<p>まず必要な<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リを作成する。
特に<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リ名や<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リ構成は何でも良いので、ここでは<code>/var/lib/tftpboot</code>以下に<code>ubuntu/xenial/{ubuntu-installer/amd64,preseed}</code>という<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リを作成し、各<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リ以下に必要なファイルを設置する。
ここの設定が<code>/var/lib/tftpboot/boot-screens/menu.cfg</code>の内容と一致してある必要があるので、ここを変更する場合は<code>menu.cfg</code>も変更する必要がある。</p>

<pre class="terminal"> $ mkdir -p /var/lib/tftpboot/ubuntu/xenial/{ubuntu-installer/amd64,preseed}
 </pre>


<p>initrd イメージと<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AB%A1%BC%A5%CD%A5%EB">カーネル</a>を<code>/var/lib/tftpboot/ubuntu/xenial/ubuntu-installer/amd64</code>直下に設置する。</p>

<pre class="terminal"> $ cp -pr /tmp/ubuntu16.04-netboot/ubuntu-installer/amd64/initrd.gz /var/lib/tftpboot/ubuntu/xenial/ubuntu-installer/amd64

$ cp -pr /tmp/ubuntu16.04-netboot/ubuntu-installer/amd64/linux /var/lib/tftpboot/ubuntu/xenial/ubuntu-installer/amd64
 </pre>


<p>自動インストール用に<code>/var/lib/tftpboot/ubuntu/xenial/preseed/preseed.cfg</code> を作成して設置する。
内容は以下のような感じであればいける。</p>

<pre class="terminal"> ### Localization
d-i debian-installer/locale string en_US
d-i console-keymaps-at/keymap select jp
d-i console-setup/ask_detect boolean false

# Keyboard selection.
d-i keyboard-configuration/layoutcode string jp
d-i keyboard-configuration/modelcode jp106

### Network configuration
## For DHCP
d-i netcfg/choose_interface select auto
d-i netcfg/disable_autoconfig boolean false
d-i netcfg/get_domain string localdomain
d-i netcfg/get_hostname string localhost

### Apt setup
d-i mirror/country string manual
#d-i mirror/http/hostname string archive.ubuntu.com
d-i mirror/http/hostname string ja.archive.ubuntu.com
d-i mirror/http/directory string /ubuntu
d-i mirror/http/proxy string

### Clock and time zone setup
d-i clock-setup/utc boolean true
d-i time/zone string Asia/Tokyo
d-i clock-setup/ntp boolean true
#d-i clock-setup/ntp-server string 0.pool.ntp.org
d-i clock-setup/ntp-server string ntp.nict.jp

### Partitioning
d-i partman-lvm/device_remove_lvm boolean true
d-i partman-lvm/device_remove_lvm_span boolean true
d-i partman/confirm_nooverwrite boolean true
d-i partman-lvm/confirm_nooverwrite boolean true
d-i partman-auto/disk string /dev/sda
#d-i partman-auto/disk string /dev/vda
d-i partman-auto/method string lvm
d-i partman-lvm/confirm boolean true
d-i partman/confirm boolean true
d-i partman/confirm_nooverwrite boolean true
d-i partman-auto-lvm/guided_size string max
d-i partman-basicfilesystems/no_swap boolean false
d-i partman-auto-lvm/no_boot boolean true
d-i partman-auto-lvm/new_vg_name string main
d-i partman-auto/choose_recipe select root-boot
d-i partman-auto/expert_recipe string \
    root-boot :: \
        500 1000 1000000000 xfs \
            $defaultignore{ } \
            $lvmok{ } lv_name{ root } \
            $primary{ } $bootable{ } method{ format } \
            format{ } use_filesystem{ } filesystem{ xfs } \
            mountpoint{ / } \
        .
d-i partman-partitioning/confirm_write_new_label boolean true
d-i partman/choose_partition select Finish partitioning and write changes to disk

### Base system installation
d-i base-installer/install-recommends boolean false
d-i base-installer/kernel/image string linux-generic
d-i base-installer/kernel/image string linux-server

### Account setup
d-i passwd/root-login boolean true
d-i passwd/make-user boolean true
d-i passwd/root-password-crypted password **************************************************************************************************
d-i passwd/user-fullname string hogehoge
d-i passwd/username string hogehoeg
d-i passwd/user-password-crypted password **************************************************************************************************
d-i user-setup/allow-password-weak boolean true
d-i passwd/user-default-groups string sudo
d-i user-setup/encrypt-home boolean false

### Package selection
tasksel tasksel/first multiselect none
d-i pkgsel/include string openssh-server
d-i pkgsel/upgrade select none
d-i pkgsel/update-policy select none
popularity-contest popularity-contest/participate boolean false
d-i pkgsel/updatedb boolean true

### Boot loader installation
d-i grub-installer/only_debian boolean true
d-i grub-installer/with_other_os boolean true

### Finishing up the installation
# Avoid that last message about the install being complete.
d-i finish-install/reboot_in_progress note1
 </pre>


<h4>確認</h4>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/PXE">PXE</a> Boot をさせ、そのままインストールが進められればOK。</p>






<h3>まとめ</h3>


<p>Ubuntu16.04での<a class="keyword" href="http://d.hatena.ne.jp/keyword/PXE">PXE</a>ブート環境構築手順について書いた。
よくわからないままやって各<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リ内のファイルが何をしているかとかが良くわからなくなったが、ファイルを消してみたり<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リ構成を変えてみたりしながら、どの処理で何が必要がだいたいつかめてきた。</p>

<h4>参考</h4>


<ul>
    <li><a href="https://www.hiroom2.com/2016/05/05/ubuntu-16-04-debian-8%E3%81%ABpxe%E3%83%96%E3%83%BC%E3%83%88%E3%82%B5%E3%83%BC%E3%83%90%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%97%E3%81%A6%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E7%92%B0%E5%A2%83%E3%82%92%E6%95%B4%E3%81%88%E3%82%8B/" target="_brank" rel="noopener noreferrer">Ubuntu 16.04 / Debian 8: PXEブートサーバをインストールしてネットワークインストール環境を整える - Narrow Escape</a></li>
    <li><a href="https://www.ibm.com/developerworks/jp/linux/library/l-initrd/" target="_brank" rel="noopener noreferrer">Linux 初期 RAM ディスク (initrd) の概要 - IBM developerWorks</a></li>
    <li><a href="https://www.syslinux.org/wiki/index.php?title=PXELINUX" rel="noopener">PXELINUX - Syslinux Wiki</a></li>
    <li><a href="http://h50146.www5.hpe.com/products/software/oe/linux/mainstream/support/doc/general/install/pxelinux_redhat.html" target="_brank" rel="noopener noreferrer">Linux_技術文書_pxelinuxを使用した Red Hat Linuxインストール方法　シリアルコンソール対応 | HPE 日本</a></li>
    <li><a href="https://access.redhat.com/documentation/ja-jp/red_hat_enterprise_linux/6/html/installation_guide/s1-netboot-pxe-config" target="_brank" rel="noopener noreferrer">30.2. ネットワークブートの設定 - Red Hat Customer Portal</a></li>
    <li><a href="https://wiki.archlinux.jp/index.php/Syslinux" target="_brank" rel="noopener noreferrer">Syslinux - ArchWiki</a></li>
    <li><a href="https://help.ubuntu.com/community/TFTP" target="_brank" rel="noopener noreferrer">TFTP - Community Ubuntu Documentation</a></li>
    <li><a href="https://help.ubuntu.com/community/isc-dhcp-server" target="_brank" rel="noopener noreferrer">isc-dhcp-server - Community Ubuntu Documentation</a></li>
    <li><a href="https://help.ubuntu.com/community/Installation/Netboot" target="_brank" rel="noopener noreferrer">Installation/Netboot - Community Ubuntu Documentation</a></li>
    <li><a href="https://wiki.ubuntu.com/UEFI/PXE-netboot-install" target="_brank" rel="noopener noreferrer">UEFI/PXE-netboot-install - Ubuntu Wiki</a></li>
</ul>

</body>
