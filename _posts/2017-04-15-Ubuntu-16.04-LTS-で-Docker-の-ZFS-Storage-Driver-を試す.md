---
layout: post
Categories:  ["tech"]
Description:  " ZFS はかつて Sun Microsystems社（現Oracle社）によって開発され、現在は CDDL というライセンスでオープンソース化されているファイルシステムです。CDDL は Linux の GPL ライセンスと互換性がないた"
Tags: ["Docker", "tech", "Ubuntu", "ZFS"]
date: "2017-04-15T11:46:00+09:00"
title: "Ubuntu 16.04 LTS で Docker の ZFS Storage Driver を試す"
author: "dshimizu"
archive: ["2017"]
draft: "true"
---

<body>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a> はかつて <a class="keyword" href="http://d.hatena.ne.jp/keyword/Sun%20Microsystems">Sun Microsystems</a>社（現<a class="keyword" href="http://d.hatena.ne.jp/keyword/Oracle">Oracle</a>社）によって開発され、現在は CDDL というライセンスで<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AA%A1%BC%A5%D7%A5%F3%A5%BD%A1%BC%A5%B9">オープンソース</a>化されている<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D5%A5%A1%A5%A4%A5%EB%A5%B7%A5%B9%A5%C6%A5%E0">ファイルシステム</a>です。CDDL は <a class="keyword" href="http://d.hatena.ne.jp/keyword/Linux">Linux</a> の <a class="keyword" href="http://d.hatena.ne.jp/keyword/GPL">GPL</a> ライセンスと互換性がないため、<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a> は <a class="keyword" href="http://d.hatena.ne.jp/keyword/Linux">Linux</a> <a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AB%A1%BC%A5%CD%A5%EB">カーネル</a>・モジュールのメインラインに取り込まれません。しかし、<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a> on <a class="keyword" href="http://d.hatena.ne.jp/keyword/Linux">Linux</a> （ZoL）プロジェクトにより、外部モジュールとしてインストールことで利用できるようになっています。</p>

<p><a herf="https://blog.dshimizu.jp/article/188">以前に ZFS on Ubuntu 16.04 LTS な環境を作成していた</a>ので、この環境で Docker の <a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a> Storage Dviver を試してみました。</p>

<ul>
    <li><a href="https://docs.docker.com/engine/userguide/storagedriver/zfs-driver/" target="_blank" rel="noopener noreferrer">Docker and ZFS in practice - Docker Documentation</a></li>
</ul>

</body>

<!-- more -->

<body>
<h3>Docker の <a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a> Storage Driver を使う設定</h3>


<h4>環境</h4>


<p>試した時のOS, <a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a> on <a class="keyword" href="http://d.hatena.ne.jp/keyword/Linux">Linux</a>, Docker のバージョン情報は以下です。</p>

<table border="1">
<tbody>
<tr>
<th>OS</th>
<td>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a> 16.04 LTS</td>
</tr>
<tr>
<th>Docker</th>
<td>docker-ce 17.03.1~ce-0~<a class="keyword" href="http://d.hatena.ne.jp/keyword/ubuntu">ubuntu</a>-xenial</td>
</tr>
<tr>
<th>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a> on <a class="keyword" href="http://d.hatena.ne.jp/keyword/Linux">Linux</a>
</th>
<td>zfsutils-<a class="keyword" href="http://d.hatena.ne.jp/keyword/linux">linux</a> 0.6.5.6 (<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a> 標準パッケージ)</td>
</tr>
</tbody>
</table>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a> ストレージプールは以下のような状態です。
50Gの仮想ディスクを全て<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a>ストレージプールに割り当てています。</p>

<pre class="terminal"> # zpool list
NAME    SIZE  ALLOC   FREE  EXPANDSZ   FRAG    CAP  DEDUP  HEALTH  ALTROOT
rpool  49.8G  1.75G  48.0G         -     8%     3%  1.00x  ONLINE  -
 </pre>


<pre class="terminal"> # zpool status -v rpool
  pool: rpool
 state: ONLINE
  scan: scrub repaired 0 in 0h0m with 0 errors on Sun Apr  9 00:24:16 2017
config:

        NAME        STATE     READ WRITE CKSUM
        rpool       ONLINE       0     0     0
          vda1      ONLINE       0     0     0

errors: No known data errors
 </pre>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a>のデー<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BF%A5%BB%A5%C3%A5%C8">タセット</a>(<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D5%A5%A1%A5%A4%A5%EB%A5%B7%A5%B9%A5%C6%A5%E0">ファイルシステム</a>等)は以下のような状態です。</p>

<pre class="terminal"> # zfs list
NAME                USED  AVAIL  REFER  MOUNTPOINT
rpool              1.76G  46.4G    96K  none
rpool/ROOT         1.76G  46.4G    96K  legacy
rpool/ROOT/ubuntu  1.76G  46.4G  1.76G  /
 </pre>


<h4>Docker <a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a> Storage Driver設定</h4>


<p>まずはじめにdocker用の<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D5%A5%A1%A5%A4%A5%EB%A5%B7%A5%B9%A5%C6%A5%E0">ファイルシステム</a>を作成します。
<code>rpool/ROOT/docker</code> というデー<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BF%A5%BB%A5%C3%A5%C8">タセット</a>を <code>/var/lib/docker</code> にマウントする、という設定です。各名称は環境に応じて置き換えてください。
正常に終了した場合は特に何も出力はありません。</p>

<pre class="terminal"> # zfs create -o mountpoint=/var/lib/docker rpool/ROOT/docker
 </pre>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D5%A5%A1%A5%A4%A5%EB%A5%B7%A5%B9%A5%C6%A5%E0">ファイルシステム</a>の状態を確認します。
<code>rpool/ROOT/docker</code> というデー<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BF%A5%BB%A5%C3%A5%C8">タセット</a>が追加されています。</p>

<pre class="terminal"> root@www4242gi:~# zfs list
NAME                USED  AVAIL  REFER  MOUNTPOINT
rpool              1.76G  46.4G    96K  none
rpool/ROOT         1.76G  46.4G    96K  legacy
rpool/ROOT/docker    96K  46.4G    96K  /var/lib/docker
rpool/ROOT/ubuntu  1.76G  46.4G  1.76G  /
 </pre>


<p>マウントを確認します。 <code>/var/lib/docker</code> が追加されています。</p>

<pre class="terminal"> # df -h
Filesystem         Size  Used Avail Use% Mounted on
udev               982M     0  982M   0% /dev
tmpfs              201M  3.0M  198M   2% /run
rpool/ROOT/ubuntu   49G  1.8G   47G   4% /
tmpfs             1001M     0 1001M   0% /dev/shm
tmpfs              5.0M     0  5.0M   0% /run/lock
tmpfs             1001M     0 1001M   0% /sys/fs/cgroup
rpool/ROOT/docker   47G  128K   47G   1% /var/lib/docker
 </pre>


<h4>Dockerのインストール</h4>


<p>公式手順に沿って <code>docker</code> をインストールします。</p>

<ul>
    <li><a href="https://docs.docker.com/engine/installation/linux/ubuntu/#install-docker" target="_blank" rel="noopener noreferrer">Get Docker for Ubuntu - Docker Documentation</a></li>
</ul>


<p>Dockerの<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EA%A5%DD%A5%B8%A5%C8%A5%EA">リポジトリ</a>追加のためのGPG公開鍵を取得します。</p>

<pre class="terminal"> # curl -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add -
 </pre>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EA%A5%DD%A5%B8%A5%C8%A5%EA">リポジトリ</a>を設定します。</p>

<pre class="terminal"> # add-apt-repository \
"deb [arch=amd64] https://download.docker.com/linux/ubuntu \
$(lsb_release -cs) \
stable"
 </pre>


<p>パッケージをインストールします。</p>

<pre class="terminal"> # apt-get update
# apt-get install docker-ce
 </pre>


<p><code>/etc/default/docker</code>に以下のオプション設定を追加します。</p>

<pre class="terminal"> DOCKER_OPTS="-s zfs --storage-opt zfs.fsname=rpool/ROOT/docker"
 </pre>


<p>Dockerサービスを起動します。</p>

<pre class="terminal"> # systemctl start docker
 </pre>


<p>Storage Driver が <a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a> となっていることを確認します。</p>

<pre class="terminal"> # docker info
:
Storage Driver: zfs
 Zpool: rpool
 Zpool Health: ONLINE
 Parent Dataset: rpool/ROOT/docker
 Space Used By Parent: 122880
 Space Available: 49847799808
 Parent Quota: no
 Compression: lz4
:
 </pre>


<p>これで設定は完了です。</p>

<h4>確認</h4>


<p>適当にコンテナをインストールして立ち上げてみると以下のように変更を加えた分だけ<code>zfs snapshot</code>が自動で作成されて差分管理されていることが確認できます。
従来の aufs だと <code>/var/lib/docker/aufs/{diff,layers,mnt}</code>で差分や<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%E1%A5%BF%A5%C7%A1%BC%A5%BF">メタデータ</a>、コンテナのマウントなどが管理されていましたが、Storage Driverが変わったことで管理方法が変わっていることが確認できます。</p>

<p><strong>コンテナをインストールした後の<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a>のデー<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BF%A5%BB%A5%C3%A5%C8">タセット</a>(<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D5%A5%A1%A5%A4%A5%EB%A5%B7%A5%B9%A5%C6%A5%E0">ファイルシステム</a>等)の状態</strong></p>

<pre class="terminal"> $ sudo zfs list -t snapshot
NAME                                                                                                USED  AVAIL  REFER  MOUNTPOINT
rpool/ROOT/docker/00b9ff93a429baacecbef7019b97d7da6d9a5d009de34b83108035142a1ad745@938599727           0      -   123M  -
rpool/ROOT/docker/00b9ff93a429baacecbef7019b97d7da6d9a5d009de34b83108035142a1ad745@446189193           0      -   123M  -
rpool/ROOT/docker/22119e6615c374c2b051ef2ec4fe00bb2ae8a058c37a6b2b9ea373d1ef7eb719@146404075           0      -   122M  -
rpool/ROOT/docker/225219b9b348c2df9ebde8ebfefff3debc5ddb975261a1d9b4c7b6f3d37d2fe0-init@851168268      0      -   431M  -
rpool/ROOT/docker/4130c95b2e1697cf40b76b39e386e50bb8452277c4a99aed51bad2a4a8dee0d7@255180764           0      -   322M  -
rpool/ROOT/docker/65f1cc11395cd9cf7cc4be47691b322488d679221d05cc1be4d67af9fc7399f7@750276851           0      -   143M  -
rpool/ROOT/docker/6fab13b404736526703d2a4c26dff4ca35397bec23ee317cd912fa7d658fb6b1@750641577           0      -   431M  -
rpool/ROOT/docker/741717566de2684b047f0b66153aaad73928e196b2ea7e1fecc13170de63ab7b@781729949           0      -   143M  -
rpool/ROOT/docker/9aeb536e269ff58d5c0cb3c61baf4ffe64298059496b5c241eaf5298fb611d39-init@362220662      0      -   143M  -
rpool/ROOT/docker/9eab88da0c84800fc44ab80da5983f4f1c1201f44b63bd4f12a26db4af443a79@788361781           0      -   322M  -
rpool/ROOT/docker/b192ed7e72c933114530fa4c93754856380b8c25b1ea68915de27c5b8c85ca2b@377158498           0      -   431M  -
rpool/ROOT/docker/bd40b62d5cc3696c4f27e50c45317d3a5102dc0c2c806830e81fccfea918440a@112467486           0      -   431M  -
rpool/ROOT/docker/d0b5c3c50f6abcf891270fdb439756387ed1a4cb5949f6c14e345846d75e656a@229228012           0      -   126M  -
rpool/ROOT/docker/d1e6bccb690236e83a64072f93aa2be22cab01eacf048ebc5c436326b1be5a23@366231673           0      -   143M  -
rpool/ROOT/docker/df4241d5b1fb552c3ba2cb35914fe32861a46a8a3ba5468b94caa16668fd049f@39803025            0      -   122M  -
rpool/ROOT/docker/e64b1882877ab43170fae3ad7e407e3da17c599d5a544f448191431c96658116@446526209           0      -   126M  -
rpool/ROOT/docker/f17c96a2644a63f37d3ec9de37020e2c690dd28638562856ab3a10badb27165b@167335386           0      -   122M  -
rpool/ROOT/docker/f604d324b0f148a1ce494727b424eb2670387d13e48d8c104990e2a1e493f650@849196370           0      -   143M  -
rpool/ROOT/docker/fde4c9a9788fa76c2457924947c73538ad5db740998e75ca9a8f35b7a7b7aa96@229010432           0      -   431M  -
 </pre>


<h3>まとめ</h3>


<p>いろいろ便利ではある気はするがProductionで使えるのか...</p>
</body>
