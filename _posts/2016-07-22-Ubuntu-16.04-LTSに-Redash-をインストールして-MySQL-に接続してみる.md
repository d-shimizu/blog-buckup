---
layout: post
Categories:  ["tech"]
Description:  " はじめに  話題になっている Redash を使ってみたく、自サーバへインストールして Wordpress の MySQL へ接続して簡単なデータソースの操作を実施してみるまでをやってみました。 "
Tags: ["Re:dash", "tech", "Ubuntu"]
date: "2016-07-22T00:46:00+09:00"
title: "Ubuntu 16.04 LTSに Redash をインストールして MySQL に接続してみる"
author: "dshimizu"
archive: ["2016"]
draft: "true"
---

<body>
<h3>はじめに</h3>


<p>話題になっている Redash を使ってみたく、自サーバへインストールして <a class="keyword" href="http://d.hatena.ne.jp/keyword/Wordpress">Wordpress</a> の <a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a> へ接続して簡単なデータソースの操作を実施してみるまでをやってみました。</p>
</body>

<!-- more -->

<body>
<h3>Redash とは</h3>


<p>Redash は <a class="keyword" href="http://d.hatena.ne.jp/keyword/OSS">OSS</a>のデータコラボレーション・可視化ツールです。</p>

<ul>
    <li><a href="https://redash.io/" target="_blank" rel="noopener noreferrer">redash.io</a></li>
</ul>


<h3>インストールとセットアップ</h3>


<h4>環境</h4>


<table>
<tbody>
<tr>
<th>OS</th>
<td>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a> 16.04 LTS(4.4.0-21-generic)</td>
</tr>
<tr>
<th>Redash</th>
<td>バージョン 0.10.1.b1834</td>
</tr>
</tbody>
</table>


<h4>インストール</h4>


<p>インストールの方法はいくつかありますが、以下にセットアップ用の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">スクリプト</a>がありますので、今回は<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a> 14.04 のものを取得して実行します。
※<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a> 16.04 LTSでも実行は出来ました。</p>

<ul>
    <li><a href="https://github.com/getredash/redash/tree/master/setup" target="_blank" rel="noopener noreferrer">redash/setup at master · getredash/redash · GitHub</a></li>
</ul>


<p>Redashをgit<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EA%A5%DD%A5%B8%A5%C8%A5%EA">リポジトリ</a>からcloneします。</p>

<pre class="terminal"> $ wget -P /tmp https://raw.githubusercontent.com/getredash/redash/master/setup/ubuntu/bootstrap.sh
 </pre>


<p><code>bootstrap.sh</code> を実行すると <a class="keyword" href="http://d.hatena.ne.jp/keyword/PostgreSQL">PostgreSQL</a>(クエリやデータ保存)、Redis(キュー処理)、Nginxが自動でセットアップされます。</p>

<p>そのままだとRedisがソースビルドされたり<a class="keyword" href="http://d.hatena.ne.jp/keyword/PostgreSQL">PostgreSQL</a>が<a class="keyword" href="http://d.hatena.ne.jp/keyword/PostgreSQL">PostgreSQL</a>公式<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EA%A5%DD%A5%B8%A5%C8%A5%EA">リポジトリ</a>の9.3だったので、今回は各種<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a>標準<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EA%A5%DD%A5%B8%A5%C8%A5%EA">リポジトリ</a>から最新取得するように、とりあえず簡単に修正します。</p>

<pre class="terminal"> $ diff -u /tmp/bootstrap.sh{.org,}
--- /tmp/bootstrap.sh.org   2016-yy-dd hh:mm:ss.117005000 +0900
+++ /tmp/bootstrap.sh       2016-yy-dd hh:mm:ss.593005000 +0900
@@ -39,10 +39,8 @@
 pg_available=0
 psql --version || pg_available=$?
 if [ $pg_available -ne 0 ]; then
-    wget $FILES_BASE_URL"postgres_apt.sh" -O /tmp/postgres_apt.sh
-    bash /tmp/postgres_apt.sh
     apt-get update
-    apt-get -y install postgresql-9.3 postgresql-server-dev-9.3
+    apt-get -y install postgresql-9.5 postgresql-server-dev-9.5
 fi

 add_service() {
@@ -70,30 +68,14 @@
 redis_available=0
 redis-cli --version || redis_available=$?
 if [ $redis_available -ne 0 ]; then
-    wget http://download.redis.io/releases/redis-2.8.17.tar.gz
-    tar xzf redis-2.8.17.tar.gz
-    rm redis-2.8.17.tar.gz
-    (cd redis-2.8.17
-    make
-    make install
-
+    apt-get install -y redis-server redis-tools
+    (
     # Setup process init &amp; configuration
-
     REDIS_PORT=6379
     REDIS_CONFIG_FILE="/etc/redis/$REDIS_PORT.conf"
     REDIS_LOG_FILE="/var/log/redis_$REDIS_PORT.log"
     REDIS_DATA_DIR="/var/lib/redis/$REDIS_PORT"
-
-    mkdir -p "$(dirname "$REDIS_CONFIG_FILE")" || die "Could not create redis config directory"
-    mkdir -p "$(dirname "$REDIS_LOG_FILE")" || die "Could not create redis log dir"
-    mkdir -p "$REDIS_DATA_DIR" || die "Could not create redis data directory"
-
-    wget -O /etc/init.d/redis_6379 $FILES_BASE_URL"redis_init"
-    wget -O $REDIS_CONFIG_FILE $FILES_BASE_URL"redis.conf"
-
-    add_service "redis_$REDIS_PORT"
     )
-    rm -rf redis-2.8.17
 fi

 # Directories
 </pre>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">スクリプト</a>を実行します。</p>

<pre class="terminal"> $ sudo sh bootstrap.sh
 </pre>


<p>以下のようなエラーが出たら、 <code>pip</code> を更新します。</p>

<pre class="terminal">  :
AttributeError: 'Requirement' object has no attribute 'project_name'
You are using pip version 8.1.1, however version 8.1.2 is available.
You should consider upgrading via the 'pip install --upgrade pip' command.
 </pre>


<p><code>pip</code> をバージョンアップします。</p>

<pre class="terminal"> $ sudo pip install --upgrade pip
 </pre>


<p>バージョンを確認します。</p>

<pre class="terminal"> $ pip -V
pip 8.1.2 from /home/${USERNAME}/.local/lib/python2.7/site-packages (python 2.7)
 </pre>


<p>再度インストール<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">スクリプト</a>を実行します。</p>

<pre class="terminal"> $ sudo sh bootstrap.sh
 </pre>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">スクリプト</a>が正常終了すればインストールは完了です。</p>

<h4>管理画面へのログイン</h4>


<p>上記<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">スクリプト</a>でインストール後は　redash サービスや PotgreSQL, Redis Nginxが起動しており、http(80番ポート) で管理画面へアクセスできるようになっています。</p>

<p>なお、 redash サービスは以下で起動/停止できます。</p>

<pre class="terminal"> # systemctl start redash_supervisord.service
# systemctl stop redash_supervisord.service
 </pre>


<p>初期id/passはadmin/adminです。
デフォルトのadminユーザでログイン後、パスワードを変更します。</p>

<h4>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/WordPress">WordPress</a>の<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>データベースへ接続</h4>


<p>とりあえず<a class="keyword" href="http://d.hatena.ne.jp/keyword/WordPress">WordPress</a>の<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>データベースに接続してみます。</p>

<p>管理画面から追加しても良いですがコマンドで対応してみます。</p>

<pre class="terminal"> $ cd /opt/redash/current
$ sudo -u redash ./bin/run ./manage.py ds new
 </pre>


<p>対話的に以下のように設定します。</p>

<pre class="terminal"> Name: WordPress []
Select type:
1. bigquery_gce
2. google_spreadsheets
3. redshift
4. url
5. mongodb
6. presto
7. hive
8. bigquery
9. mssql
10. influxdb
11. vertica
12. kibana
13. graphite
14. pg
15. mysql
16. elasticsearch
17. dynamodb_sql
18. impala
19. sqlite
20. treasuredata
[1-20]: [15] (#&lt;- MySQL)
Path to CA certificate file to verify peer against (SSL) (optional):
Host (optional): [MySQLのホスト名]
Path to client certificate file (SSL) (optional):
User (optional): [MySQLのDBユーザ名]
Path to private key file (SSL) (optional):
Password (optional): [MySQLのDBパスワード]
Use SSL (optional):
Database name (required): [MySQLのDB名]
Port (optional): 
Creating mysql data source (データソース名) with options:
{"passwd": "[MySQLのDBパスワード]", "host": "[MySQLのホスト名]", "db": "[MySQLのDB名]", "user": "[MySQLのユーザ名]", "port": 3306}
Id: 2
 </pre>


<p>追加されたデータソースを確認します。</p>

<pre class="terminal"> $ sudo -u redash ./bin/run ./manage.py ds list
[2016-08-22 00:31:30,982][PID:5422][INFO][root] Latest version: 0.11.1 (newer: True)
Id: 1
Name: re:dash metadata
Type: pg
Options: 
--------------------
Id: 2 
Name: WordPress
Type: mysql
Options: 
 </pre>


<p>画面上のメニューの <code>Queries</code> から <code>New Query</code> を選択します。</p>

<p><img src="../wp-content/uploads/2016/08/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88-2016-08-22-0.37.46.png"></p>

<p>画面中央の <code>Data Source</code> から先ほど作成した データソース <code>WordPress</code> を選択します。</p>

<p>タグごとの記事数を取得する<a class="keyword" href="http://d.hatena.ne.jp/keyword/SQL">SQL</a>を記述します。</p>

<p><img src="../wp-content/uploads/2016/08/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88-2016-08-22-0.41.42.png"></p>

<p><code>+ NEW VISUALIZATION</code> をクリックして各種設定を行うと以下のようなグラフも表示できます。</p>

<p><img src="../wp-content/uploads/2016/08/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88-2016-08-22-0.42.56.png"></p>

<h3>おわりに</h3>


<p>以上、 Redash のセットアップと簡単な操作でした。
UIはまだわかりにくいところがありますが、<a class="keyword" href="http://d.hatena.ne.jp/keyword/SQL">SQL</a>を保存できたり結果をグラフ化できたりというのは便利そうです。</p>
</body>
