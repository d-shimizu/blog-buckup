---
layout: post
Categories:  ["tech"]
Description:  " はじめに  昨年末(2012/12/31)に正式アナウンスされたFreeBSD 9.1-RELEASEですが、早々にインストールする機会がありましたので、ZFS Root FileSystem環境となるように構築しました。      Fr"
Tags: ["ZFS", "FreeBSD"]
date: "2013-01-11T00:45:00+09:00"
title: "FreeBSD 9.1-RELEASE で ZFS Root FileSystem 環境を構築する"
author: "dshimizu"
archive: ["2013"]
draft: "true"
---

<body>
<h4>はじめに</h4>
<p>昨年末(2012/12/31)に正式アナウンスされた<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a> 9.1-RELEASEですが、早々にインストールする機会がありましたので、<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a> Root FileSystem環境となるように構築しました。 </p>
<ul>  <li><a href="http://www.freebsd.org/releases/9.1R/relnotes-detailed.html">FreeBSD 9.1-RELEASE Release Notes</a></li>
</ul>
<a name="more"></a><p><a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a>はさくらの<a class="keyword" href="http://d.hatena.ne.jp/keyword/VPS">VPS</a>で<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a>環境を作って使ってはいましたが、自身でインストールメディアからインストールするのははじめてというレベルの初心者です。ただ、<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a>での<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a>はもう十分にプロダクションレベルに達しているとのことで、いろいろと情報もあり、単純に<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a> Root FileSystemとして構築するだけであれば、それほど苦労せず出来ました。<br>今回は、昨年参加させていただいた<a href="https://www.bsdconsulting.co.jp/CGI/BSDC.CGI?CNT=FREEBSDSTUDY_2012120701"> "第13回 FreeBSD 勉強会"</a> の資料に記されている手順をもとに構築を行いました。 </p>
<h6>参考資料</h6>
<ul>  <li><a href="http://people.allbsd.org/~hrs/FreeBSD/sato-FBSD20121207.pdf">第13回 FreeBSD勉強会 ZFS の活用とチューニング [PDF]</a></li>
</ul>
<p>以下に実施した手順をまとめましたので記載致します。<br>なお、インストールは<a class="keyword" href="http://d.hatena.ne.jp/keyword/VMware">VMware</a> ESXi上に作成したゲストOSへ行いました。 </p>
<h6>※2013/5/19追記</h6>
<p style="padding-left:2em">記載していた手順に不備がありましたので修正しました。 </p>
<ul>  <li>"OS起動時に読み込まれる各コンフィグファイルを修正する"の項目でrc.conf作成先PATHの誤りを修正しました。<br>(<code>rc.conf</code>のPATH:<code>/mnt/root/etc/rc.conf</code>を<code>/media/root/etc/rc.conf</code>へ修正)</li>
</ul>  <h4>手順</h4>
<p>勉強会の資料を基に、大まかに以下の順序で作成を行いました。<br>現状の<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a>の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A4%A5%F3%A5%B9%A5%C8%A1%BC%A5%E9">インストーラ</a>は<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a>でのインストールに対応していないので、<a class="keyword" href="http://d.hatena.ne.jp/keyword/CUI">CUI</a>で設定を行っていきます。 </p>
<ol>  <li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a> 9.1-RELEASEのインストールメディアからブートする</li>  <li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/GTP">GTP</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D1%A1%BC%A5%C6%A5%A3%A5%B7%A5%E7%A5%F3">パーティション</a>を作成する</li>  <li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a>ストレージプールとデー<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BF%A5%BB%A5%C3%A5%C8">タセット</a>を作成する</li>  <li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a> 9.1-RELEASE<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AB%A1%BC%A5%CD%A5%EB">カーネル</a>類を展開する</li>  <li>OS起動時に読み込まれる各コンフィグファイルを修正する</li>  <li>zpool.cacheを明示的に作成する</li>  <li>ストレージプール/デー<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BF%A5%BB%A5%C3%A5%C8">タセット</a>にプロパティを指定する</li>  <li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a>でブート可能かチェックを行う</li>  <li>システムを再起動し、設定を確認する</li>
</ol>
<h4>ゲストOS環境</h4>
<p>インストールする<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B2%BE%C1%DB%A5%DE%A5%B7%A5%F3">仮想マシン</a>のスペックは以下です。<br><a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a>を利用するにはメモリリソースやディスクの本数など構成に不足があると思いますが、ここでは<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a>環境構築を優先しています。 </p>
<table>  <tr>    <td bgcolor="#cccccc">仮想プロセッサ数</td>    <td>1コア</td>  </tr>  <tr>    <td bgcolor="#cccccc">メモリサイズ</td>    <td>2GB</td>  </tr>  <tr>    <td bgcolor="#cccccc">
<a class="keyword" href="http://d.hatena.ne.jp/keyword/NIC">NIC</a> アダプタ タイプ</td>    <td>E1000 </td>  </tr>  <tr>    <td bgcolor="#cccccc">
<a class="keyword" href="http://d.hatena.ne.jp/keyword/SCSI">SCSI</a> コントローラ</td>    <td>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/LSI">LSI</a> Logic <a class="keyword" href="http://d.hatena.ne.jp/keyword/SAS">SAS</a>
</td>  </tr>  <tr>    <td bgcolor="#cccccc">ディスクサイズ</td>    <td>200GB HDD*1個</td>  </tr>
</table>
<p>※SCSコントローラに準仮想化を選択したいところでしたが、非推奨となっており認識されませんでした。<br>※仮想<a class="keyword" href="http://d.hatena.ne.jp/keyword/NIC">NIC</a>デ<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D0%A5%A4%A5%B9">バイス</a>については<code>VMXNET2</code>も選択してみましたが、<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a> 9.1では認識されませんでした。 </p>
<h4>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a> 9.1-RELEASEで<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a> Root FileSystem環境を構築する</h4>
<h5>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a> 9.1-RELEASEのインストールメディアからブートする</h5>
<p>作成したゲストOSで、インストール用のメディア( <a href="http://ftp.jaist.ac.jp/pub/FreeBSD/releases/ISO-IMAGES/9.1/FreeBSD-9.1-RELEASE-amd64-dvd1.iso">FreeBSD-9.1-RELEASE-amd64-dvd1.iso</a> )からブートさせます。 <code>[Enter]</code>を押下して、通常ブートさせます(シングルユーザモードでも構いません)。 </p>
<div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-avLVUNyZTTo/UO2eN3dSEzI/AAAAAAAAAPM/8I2PA1Hl5io/s1600/freebsd9.1-R_install_01.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" src="http://1.bp.blogspot.com/-avLVUNyZTTo/UO2eN3dSEzI/AAAAAAAAAPM/8I2PA1Hl5io/s600/freebsd9.1-R_install_01.png"></a></div>
<p><code>[Install]</code>を選択します </p>
<div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-NnnlJxqL1Ys/UO2dE_qTEqI/AAAAAAAAAOM/wHOgUl6eibs/s1600/freebsd9.1-R_install_02.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" src="https://cdn-ak.f.st-hatena.com/images/fotolife/d/dshimizu/20220322/20220322113723.png"></a></div>
<br><code>[YES]</code>を押下して、キーボードの設定を行います。 <div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-Nnb1ppoISFo/UO2dLLgqFYI/AAAAAAAAAOc/hYAdaFym04M/s1600/freebsd9.1-R_install_03.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" src="https://cdn-ak.f.st-hatena.com/images/fotolife/d/dshimizu/20220322/20220322113719.png"></a></div>
<p>使っているキーボードのタイプに合わせて指定します。 ここでは<code>Japanese 106</code>を指定しました。 </p>
<div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-KRKr5iwwJ_Q/UO2bzUSyjoI/AAAAAAAAANw/WN6QqaLTS9k/s1600/freebsd9.1-R_insall_04.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" src="http://3.bp.blogspot.com/-KRKr5iwwJ_Q/UO2bzUSyjoI/AAAAAAAAANw/WN6QqaLTS9k/s600/freebsd9.1-R_insall_04.png"></a></div>
<p>ホスト名を設定します。 </p>
<div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-09MI6vLORt8/UO2dlA4ETpI/AAAAAAAAAOo/oWHZs7l5tm0/s1600/freebsd9.1-R_install_05.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" src="http://4.bp.blogspot.com/-09MI6vLORt8/UO2dlA4ETpI/AAAAAAAAAOo/oWHZs7l5tm0/s600/freebsd9.1-R_install_05.png"></a></div>
<br>インストールする<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B3%A5%F3%A5%DD%A1%BC%A5%CD%A5%F3%A5%C8">コンポーネント</a>を指定します。 <div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-DgE5cgB1Ocs/UO2dlqNOKJI/AAAAAAAAAO0/hmMIMUH9Gkk/s1600/freebsd9.1-R_install_06.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" src="http://4.bp.blogspot.com/-DgE5cgB1Ocs/UO2dlqNOKJI/AAAAAAAAAO0/hmMIMUH9Gkk/s600/freebsd9.1-R_install_06.png"></a></div>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D1%A1%BC%A5%C6%A5%A3%A5%B7%A5%E7%A5%F3">パーティション</a>の設定を行います。ここで<code>[Shell]</code>を選択します。 </p>
<div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-y9Mprae1tBc/UO2dmHf04yI/AAAAAAAAAPA/o7WS-IovrcA/s1600/freebsd9.1-R_install_07.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" src="http://4.bp.blogspot.com/-y9Mprae1tBc/UO2dmHf04yI/AAAAAAAAAPA/o7WS-IovrcA/s600/freebsd9.1-R_install_07.png"></a></div>
<p>ここから以下のように<a class="keyword" href="http://d.hatena.ne.jp/keyword/CUI">CUI</a>に切り替わりますので、先に記載した資料をもとに<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a>の設定を行います。 </p>
<div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-Z4Uc-yflHDc/UO2gHMojs_I/AAAAAAAAAPg/qDwPPSMfzxA/s1600/freebsd9.1-R_install_08.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" src="http://3.bp.blogspot.com/-Z4Uc-yflHDc/UO2gHMojs_I/AAAAAAAAAPg/qDwPPSMfzxA/s600/freebsd9.1-R_install_08.png"></a></div> <h5>GPT<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D1%A1%BC%A5%C6%A5%A3%A5%B7%A5%E7%A5%F3">パーティション</a>を作成する</h5>
<p>新規にGPT<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D1%A1%BC%A5%C6%A5%A3%A5%B7%A5%E7%A5%F3">パーティション</a>を作成します。<br>※<a class="keyword" href="http://d.hatena.ne.jp/keyword/VMware">VMware</a> ESXiから認識される<a class="keyword" href="http://d.hatena.ne.jp/keyword/LSI">LSI</a> Logic <a class="keyword" href="http://d.hatena.ne.jp/keyword/SAS">SAS</a>のデ<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D0%A5%A4%A5%B9">バイス</a>名は<code>/dev/da0</code>でしたが、ここは環境に合わせて読み替えてください。 </p>
<pre class="terminal"> # gpart create -s gpt /dev/da0 da0 created  
</pre>
<p>最初の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D1%A1%BC%A5%C6%A5%A3%A5%B7%A5%E7%A5%F3">パーティション</a>にブート<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D1%A1%BC%A5%C6%A5%A3%A5%B7%A5%E7%A5%F3">パーティション</a><code>freebsd-boot</code>を作成します。 ここには<code>/boot/pmbr</code>(約512B)と<code>/boot/gptzfsboot</code>(約40KB)が読み込まれることになるため、その分だけ確保しておけば良いのですが、念のため64KB確保しています。 なお、LBA(論理ブロック・アドレシング)34がディスク上の最初に使用可能なセクタですので、<code>-b 34</code>としています(省略可)。 </p>
<pre class="terminal">  # gpart add -s 64K -b 34 -t freebsd-boot -l /boot/boot0 /dev/da0 da0p1 added  
</pre>
<p>2番目の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D1%A1%BC%A5%C6%A5%A3%A5%B7%A5%E7%A5%F3">パーティション</a>に<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%EF%A5%C3%A5%D7">スワップ</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D1%A1%BC%A5%C6%A5%A3%A5%B7%A5%E7%A5%F3">パーティション</a><code>freebsd-swap</code>を作成します。 <a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%EF%A5%C3%A5%D7">スワップ</a>サイズは1GBとしておきます。 </p>
<pre class="terminal">  # gpart add -s 1G -t freebsd-swap -l swap0 /dev/da0 da0p2 added  
</pre>
<p>3番目の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D1%A1%BC%A5%C6%A5%A3%A5%B7%A5%E7%A5%F3">パーティション</a>は<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D5%A5%A1%A5%A4%A5%EB%A5%B7%A5%B9%A5%C6%A5%E0">ファイルシステム</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D1%A1%BC%A5%C6%A5%A3%A5%B7%A5%E7%A5%F3">パーティション</a><code>freebsd-zfs</code>として作成します。 </p>
<pre class="terminal">  # gpart add -t freebsd-zfs -l disk0 /dev/da0 da0p3 added  
</pre>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D6%A1%BC%A5%C8%A5%ED%A1%BC%A5%C0">ブートローダ</a>ーへの書き込みを行います。<br>GPTでは、<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a>のブートシーケンスは<code>BIOS→pmbr→gptzfsboot(ZFSの場合)/gptufsboot(UFSの場合)→/boot/loader→kernel</code>となっているようなので、<code>-b</code>オプションでブートストラップコードを含むファイル<code>/boot/pmbr</code>を指定し、<code>-p</code>オプションで<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D1%A1%BC%A5%C6%A5%A3%A5%B7%A5%E7%A5%F3">パーティション</a>に書き込まれるブートストラップコード<code>/boot/gptzfsboot</code>を指定し、<code>-i</code>オプションの引数で最初の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D1%A1%BC%A5%C6%A5%A3%A5%B7%A5%E7%A5%F3">パーティション</a>に書き込むように指定します。 </p>
<pre class="terminal">  # gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 /dev/da0 bootcode written to da0  </pre> <h6>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D1%A1%BC%A5%C6%A5%A3%A5%B7%A5%E7%A5%F3">パーティション</a>作成失敗時の対応</h6>※<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D1%A1%BC%A5%C6%A5%A3%A5%B7%A5%E7%A5%F3">パーティション</a>作成の手順に失敗した場合は、以下の手順でディスク<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D1%A1%BC%A5%C6%A5%A3%A5%B7%A5%E7%A5%F3">パーティション</a>情報を削除できます。 <pre class="terminal">  # gpart delete -i 1 /dev/da0 da0p1 deleted # gpart delete -i 2 /dev/da0 da0p2 deleted # gpart delete -i 3 /dev/da0 da0p3 deleted # gpart destroy /dev/da0 da0 destroyed  </pre> <h5>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a>ストレージプールとデー<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BF%A5%BB%A5%C3%A5%C8">タセット</a>を作成する</h5>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a>ストレージプールを作成します。<br>メディアからブートしているため<code>/</code>には書き込めないので、代替ルート<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リとして<code>/media</code>を指定します。 これにより、プール内のすべてのマウントポイントの先頭にこの<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リが付加されます。 </p>
<pre class="terminal">  # zpool create -f -o altroot=/media rpool /dev/gpt/disk0  </pre> <p>メモリ搭載量が4GB以下の場合は<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a>のプリフェッチ機能がデフォルトで無効になっている旨のメッセージと、<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D5%A5%A1%A5%A4%A5%EB%A5%B7%A5%B9%A5%C6%A5%E0">ファイルシステム</a>、ストレージプールのバージョンが表示されます。<br><a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a>のプリフェッチ機能とは、ファイル読み取りパターンから一部のファイル読み取りを予測することでIO待ち時間を削減する機能です。<br>有効にしたい場合はメッセージのとおり、 <code>/boot/loader.conf</code> 内に <code>vfs.zfs.prefetch_disable=0</code>を追加してください。 </p>
<pre class="terminal">  ZFS NOTICE: Prefetch is disabled by default if less than 4GB of RAM is present to enable, add "vfs.zfs.prefetch_disable=0" to /boot/loader.conf. ZFS filesystem version 5 ZFS storage pool version 25  </pre> <p>デー<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BF%A5%BB%A5%C3%A5%C8">タセット</a>を作成します。ここでは<a class="keyword" href="http://d.hatena.ne.jp/keyword/Solaris10">Solaris10</a>のようなデー<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BF%A5%BB%A5%C3%A5%C8">タセット</a>構成にするため、以下のようなデー<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BF%A5%BB%A5%C3%A5%C8">タセット</a>にしています。 他にも必要なデー<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BF%A5%BB%A5%C3%A5%C8">タセット</a>があれば、作成します。 </p>
<pre class="terminal">  # zfs create rpool/ROOT # zfs create rpool/ROOT/FreeBSD  
</pre>
<p>ブートに利用するデー<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BF%A5%BB%A5%C3%A5%C8">タセット</a>(<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D5%A5%A1%A5%A4%A5%EB%A5%B7%A5%B9%A5%C6%A5%E0">ファイルシステム</a>)を設定します。ここでは<code>rpool/ROOT/FreeBSD</code>を設定します。 ここで設定したデー<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BF%A5%BB%A5%C3%A5%C8">タセット</a>が<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a>ルート<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D5%A5%A1%A5%A4%A5%EB%A5%B7%A5%B9%A5%C6%A5%E0">ファイルシステム</a>となります。 </p>
<pre class="terminal">  # zpool set bootfs=rpool/ROOT/FreeBSD rpool  
</pre>
<p>現時点での各デー<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BF%A5%BB%A5%C3%A5%C8">タセット</a>とそのマウントポイントは以下のようになっております。 <code>/media</code>を代替ルート<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リとしていますので、すべてのマウントポイントの先頭に<code>/media</code>が付与されています。 </p>
<pre class="terminal">  # zfs list  NAME                 USED  AVAIL  REFER  MOUNTPOINT rpool                178K  198G     31K  /media rpool/ROOT            62K  198G     31K  /media/ROOT rpool/ROOT/FreeBSD    31K  198G     31K  /media/ROOT/FreeBSD  </pre> <h5>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a> 9.1-RELEASE<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AB%A1%BC%A5%CD%A5%EB">カーネル</a>類を展開する</h5>
<p>ベースシステム、<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AB%A1%BC%A5%CD%A5%EB">カーネル</a>、<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BD%A1%BC%A5%B9%A5%B3%A1%BC%A5%C9">ソースコード</a>を、<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a> ルート<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D5%A5%A1%A5%A4%A5%EB%A5%B7%A5%B9%A5%C6%A5%E0">ファイルシステム</a>のマウントポイントである<code>/media/ROOT/FreeBSD</code>配下へ展開します。 </p>
<pre class="terminal">  # tar xzpf /usr/freebsd-dist/base.txz -C /media/ROOT/FreeBSD  
</pre>
<pre class="terminal">  # tar xzpf /usr/freebsd-dist/kernel.txz -C /media/ROOT/FreeBSD  
</pre>
<pre class="terminal">  # tar xzpf /usr/freebsd-dist/src.txz -C /media/ROOT/FreeBSD  </pre> <h5>OS起動時に読み込まれる各コンフィグファイルを設定する</h5>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AB%A1%BC%A5%CD%A5%EB">カーネル</a>バイナリを展開後、<code>/media/ROOT/FreeBSD</code>配下に<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a>の各<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リが作成されますので、<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a>用にコンフィグファイルを設定していきます。 まず、システム起動時に<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a>関連モジュールを読み込むように、<code>loader.conf</code>に<code>zfs_load="YES"</code>を設定します。 <code>vfs.root.mountfrom</code>には<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a>ルート<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D5%A5%A1%A5%A4%A5%EB%A5%B7%A5%B9%A5%C6%A5%E0">ファイルシステム</a>となるデー<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BF%A5%BB%A5%C3%A5%C8">タセット</a>を指定します。 </p>
<pre class="terminal">  # echo 'zfs_load="YES"' &gt;&gt; /media/ROOT/FreeBSD/boot/loader.conf  
</pre>
<pre class="terminal">  # echo 'vfs.root.mountfrom="zfs:rpool/ROOT/FreeBSD"' &gt;&gt; /media/ROOT/FreeBSD/boot/loader.conf  
</pre>
<p>システム起動時に<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a>が有効になるようにrc.confを設定します。 </p>
<pre class="terminal">  # echo 'zfs_enable="YES"' &gt;&gt; /media/ROOT/FreeBSD/etc/rc.conf  
</pre>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a>管理ではないswapデ<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D0%A5%A4%A5%B9">バイス</a>の設定を<code>/etc/fstab</code>に記載します。 </p>
<pre class="terminal">  # echo "/dev/da0p2 none swap sw 0 0" &gt; /media/ROOT/FreeBSD/etc/fstab  </pre> <h5>zpool.cacheを明示的に作成する</h5>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D5%A5%A1%A5%A4%A5%EB%A5%B7%A5%B9%A5%C6%A5%E0">ファイルシステム</a>を一度アンマウントします。 </p>
<pre class="terminal">  # zfs umount -a  
</pre>
<p>作成したpoolを<code>export</code>し、再度<code>import</code>します。<br><code>zpool.cache</code>はOS起動時に読み込まれ、ストレージプールを認識するために利用されるファイルで、<code>import</code>時には<code>zpool.cache</code>ファイルを<code>/tmp</code>上に作成するように指定します。これは、本来<code>/boot/zfs</code>配下へ作成されるこのファイルが、この時点では該当<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リに書き込めないため、暫定的に<code>/tmp</code>へ作成するようにしています。 </p>
<pre class="terminal">  # mount -t tmpfs tmpfs /tmp  
</pre>
<pre class="terminal">  # zpool export rpool  
</pre>
<pre class="terminal">  # zpool import -o cachefile=/tmp/zpool.cache -o altroot=/media rpool  
</pre>
<p><code>/tmp/zpool.cache</code>ファイルをコピーします。 </p>
<pre class="terminal">  # cp -p /tmp/zpool.cache /media/ROOT/FreeBSD/boot/zfs/  </pre> <h5>ストレージプール/デー<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BF%A5%BB%A5%C3%A5%C8">タセット</a>にプロパティを指定する</h5>
<p>ストレージプールと同名のデー<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BF%A5%BB%A5%C3%A5%C8">タセット</a><code>rpool</code>はマウントしないようにし、その配下のデー<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BF%A5%BB%A5%C3%A5%C8">タセット</a><code>rpool/ROOT</code>を<code>legacy</code>へ、<code>rpool/ROOT/FreeBSD</code>を<code>/</code>へマウントするようにマウントポイントを指定します。<br>※他にもデー<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BF%A5%BB%A5%C3%A5%C8">タセット</a>を作成している場合は、ここで全てマウントポイントを指定します。 </p>
<pre class="terminal">  # zfs set mountpoint=none rpool  
</pre>
<pre class="terminal">  # zfs set mountpoint=legacy rpool/ROOT  
</pre>
<pre class="terminal">  # zfs set mountpoint=/ rpool/ROOT/FreeBSD  
</pre>
<p>指定したマウントポイントを確認します。 </p>
<pre class="terminal">  # zfs get -r mountpoint rpool NAME                 PROPERTY    VALUE       SOURCE rpool                mountpoint  none        default rpool/ROOT           mountpoint  legacy      local rpool/ROOT/FreeBSD   mountpoint  /media      local  </pre> <h5>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a>でブート可能かチェックを行う。※これは飛ばしても構いません。</h5>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a> 9.1より、<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a>でブートが可能かをチェックする<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">スクリプト</a>が導入されたようですので、それをビルドしてチェックを行います。 下記のコマンドでビルドします。<br></p>
<pre class="terminal">  # cd /media/usr/src/tools/tools/zfsboottest  
</pre>
<pre class="terminal">  # make &amp;&amp; make DESTDIR=/media install  </pre> <p>以下のような出力があります。 </p>
<pre class="terminal">  Warning: Object directory not changed from original /usr/src/tools/tools/zfsboottest ln -sf /usr/src/tools/tools/zfsboottest/../../../sys/i386/include machine cc -O1  -I/usr/src/tools/tools/zfsboottest/../../../sys/boot/zfs  -I/usr/src/tools/tools/zfsboottest/../../../sys/cddl/boot/zfs  -I.  -fdiagnostics-show-option  -W -Wextra -Wno-sign-compare -Wno-unused-parameter  -Werror -std=gnu99 -fstack-protector  -c zfsboottest.c cc -O1  -I/usr/src/tools/tools/zfsboottest/../../../sys/boot/zfs  -I/usr/src/tools/tools/zfsboottest/../../../sys/cddl/boot/zfs  -I.  -fdiagnostics-show-option  -W -Wextra -Wno-sign-compare -Wno-unused-parameter  -Werror -std=gnu99 -fstack-protector   -lmd -o zfsboottest zfsboottest.o install -s -o root -g wheel -m 555   zfsboottest /usr/bin install -o root  -g wheel -m 555  zfsboottest.sh  /usr/bin/zfsboottest.sh  
</pre>
<p>チェック<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">スクリプト</a>を実行します。 </p>
<pre class="terminal">  # env PATH=$PATH:/media/usr/bin sh ./zfsboottest.sh rpool  
</pre>
<p>以下のような、<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a>ルート<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D5%A5%A1%A5%A4%A5%EB%A5%B7%A5%B9%A5%C6%A5%E0">ファイルシステム</a>に指定しているデー<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BF%A5%BB%A5%C3%A5%C8">タセット</a><code>rpool/ROOT/FreeBSD</code>を<code>legacy</code>にマウントするようにメッセージが出ます。 </p>
<pre class="terminal">  The "mountpoint" property of dataset "rpool/ROOT/FreeBSD" should be set to "legacy".  
</pre>
<p><code>legacy</code>は従来通り<code>/etc/fstab</code>で管理を行う設定で、<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a>で<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a>を使う場合、<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a>の自動マウントが制御できないなどの問題回避のためにルート<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D5%A5%A1%A5%A4%A5%EB%A5%B7%A5%B9%A5%C6%A5%E0">ファイルシステム</a>を<code>legacy</code>でマウントすることが推奨されているようです。<br>今回は<a class="keyword" href="http://d.hatena.ne.jp/keyword/Solaris10">Solaris10</a>のようなデー<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BF%A5%BB%A5%C3%A5%C8">タセット</a>構成としてルート<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D5%A5%A1%A5%A4%A5%EB%A5%B7%A5%B9%A5%C6%A5%E0">ファイルシステム</a>を<code>/</code>にするため、この作業は飛ばします。実施しなくても手順に誤りがなければ問題なく起動します。 </p>
<h6>実施する場合</h6>
<pre class="terminal">  # zfs set mountpoint=legacy rpool/ROOT/FreeBSD  (チェックスクリプト実行時の出力メッセージの通りにrpool/ROOT/FreeBSDのマウントポイントをlegacyへ変更)  </pre> <h5>システムを再起動し、設定を確認する</h5>
<p>リブートし、OSが正常に起動することを確認します。 </p>
<pre class="terminal">  # sync;sync;sync  
</pre>
<pre class="terminal">  # shutdown -r now  
</pre>
<p>ログインし、<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D1%A1%BC%A5%C6%A5%A3%A5%B7%A5%E7%A5%F3">パーティション</a>やストレージプール、デー<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BF%A5%BB%A5%C3%A5%C8">タセット</a>を見ると以下のようになっております。 </p>
<h6>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D1%A1%BC%A5%C6%A5%A3%A5%B7%A5%E7%A5%F3">パーティション</a>構成</h6>
<pre class="terminal">  # gpart show =&gt;       34  419430333   da0  GPT  (200G)          34        128     1  freebsd-boot  (64k)         162    2097152     2  freebsd-swap  (1.0G)     2097314  411041597     3  freebsd-zfs   (199G)  </pre> <h6>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a>ストレージプール構成</h6>
<pre class="terminal">  # zpool status   pool: rpool  state: ONLINE  scan: none requested config:          NAME         STATE     READ WRITE CKSUM         rpool        ONLINE       0     0     0           gpt/disk0  ONLINE       0     0     0  errors: No known data errors  </pre> <h6>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a>デー<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BF%A5%BB%A5%C3%A5%C8">タセット</a>構成</h6>
<pre class="terminal">  # zfs list NAME                 USED  AVAIL  REFER  MOUNTPOINT rpool               1.31G  197G     31K  none rpool/ROOT          1.31G  197G     32K  legacy rpool/ROOT/FreeBSD  1.31G   197G  1.31G  /  
</pre>
<p>以上で、<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a>での<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a> Root FileSystem環境が構築できました。<br>※続いて、OSの設定を行う必要がありますが、ここでは割愛します。 </p>
<h4>おわりに</h4>
<p>以上で<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a> 9.1-RELEASEでの<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a> Root環境の構築は完了です。<br>ARCやZIL、ミラー、<a class="keyword" href="http://d.hatena.ne.jp/keyword/RAID">RAID</a>-Zといった<a class="keyword" href="http://d.hatena.ne.jp/keyword/ZFS">ZFS</a>の機能を生かす設定などは全然出来ておらず、<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a>もまだまだ初心者ですが、これからいろいろ触れていきたいと思います。 </p> <iframe src="http://rcm-fe.amazon-adsystem.com/e/cm?t=dshimizu05-22&amp;o=9&amp;p=8&amp;l=as1&amp;asins=B00CPG04JE&amp;ref=qf_sp_asin_til&amp;fc1=000000&amp;IS2=1&amp;lt1=_blank&amp;m=amazon&amp;lc1=0000FF&amp;bc1=000000&amp;bg1=FFFFFF&amp;f=ifr" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0"></iframe>
</body>

<!-- more -->


