---
layout: post
Categories:  ["tech"]
Description:  " はじめに    syslogを利用して出力されるログを、 warn や err などのプライオリティ文字列の出力の有無でZabbixでのキーワード監視をしようとしたところ、デフォルトの設定ではプライオリティの情報が出力されない(出力される"
Tags: ["システム運用", "rsyslog"]
date: "2015-05-31T23:55:00+09:00"
title: "rsyslogの基本設定とログのプライオリティ情報の出力"
author: "dshimizu"
archive: ["2015"]
draft: "true"
---

<body>
<h4>はじめに</h4>  <p>syslogを利用して出力されるログを、 <code>warn</code> や <code>err</code> などのプライオリティ文字列の出力の有無でZabbixでのキーワード監視をしようとしたところ、デフォルトの設定ではプライオリティの情報が出力されない(出力されるメッセージ自体にこれらの文字列が出力されることはある)ことがわかりましたので、rsyslogの基本設定とプライオリティ情報を出力させるための設定について調べたことをメモします。 </p> <a name="more"></a> <h4>rsyslog.confのフォーマット</h4>
<p>rsyslog.confの書式は以下になります。 </p>
<pre class="terminal">  selector    action  
</pre>
<ul>    <li>selector・・・出力するログの内容の指定</li>    <li>action・・・ログの出力先の指定</li>
</ul> <h5>selector</h5>
<p>selectorは出力するログの内容を指定するもので、「facility」と「priority」を<code>.</code>で接続したものになります。特定のactionに対して複数のselectorを指定したい場合は、<code>;</code>で接続します。 </p>
<p>例えば、<code>/var/log/messages</code>へ出力されるログのselectorは以下のようになっています。<code>*.info</code>でinfoレベル以上のログは全て出力し、あとに続く<code>mail.none;authpriv.none;cron.none</code>で、メール、認証サービス、cron関連のログは除くような指定がされています。 </p>
<pre class="terminal">  *.info;mail.none;authpriv.none;cron.none  </pre> <h6>facility</h6>
<p>facilityはログの種類を示します。あらかじめ定義されているものと独自に利用できるものがあります。 </p> <table>  <tr>    <th bgcolor="#cccccc"><strong>facility</strong></th>    <th bgcolor="#cccccc"><strong>対象のログ</strong></th>  </tr>  <tr>    <th>auth（security）</th>    <td>認証サービスのメッセージ（現在はauthprivが推奨されている）</td>  </tr>  <tr>    <th>authpriv</th>    <td>認証サービス（カテゴリはauthと同じ。authとは出力結果が異なる）</td>  </tr>  <tr>    <th>cron</th>    <td>cronのメッセージ</td>  </tr>  <tr>    <th><a class="keyword" href="http://d.hatena.ne.jp/keyword/daemon">daemon</a></th>    <td>デーモンのメッセージ</td>  </tr>  <tr>    <th>kern</th>    <td>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AB%A1%BC%A5%CD%A5%EB">カーネル</a>のメッセージ</td>  </tr>  <tr>    <th>lpr</th>    <td>プリンタサービスのメッセージ</td>  </tr>  <tr>    <th>mail</th>    <td>メールサービスのメッセージ</td>  </tr>  <tr>    <th>news</th>    <td>ニュースサービスのメッセージ</td>  </tr>  <tr>    <th>syslog</th>    <td>syslogのメッセージ</td>  </tr>  <tr>    <th>user</th>    <td>ユーザープロセスのメッセージ</td>  </tr>  <tr>    <th>uucp</th>    <td>uucp転送を行うプログラムのメッセージ</td>  </tr>  <tr>    <th>local0～7</th>    <td>独自に利用できるファシリティ</td>  </tr>
</table> <h6>priority</h6>
<p>priorityはログのレベルの重要度を設定します。通常は指定したpriority以上のログが出力されます。例えば、<code>err</code>を指定すれば<code>crit</code>、<code>alert</code>、<code>emerg</code>のログも出力されます。  </p> <table>  <tr>    <th bgcolor="#cccccc"><strong>priority</strong></th>    <th bgcolor="#cccccc"><strong>内容</strong></th>  </tr>  <tr>    <th>debug</th>    <td>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C7%A5%D0%A5%C3%A5%B0">デバッグ</a>情報</td>  </tr>  <tr>    <th>info</th>    <td>情報</td>  </tr>  <tr>    <th>notice</th>    <td>通知</td>  </tr>  <tr>    <th>warn</th>    <td>警告</td>  </tr>  <tr>    <th>err</th>    <td>一般的なエラー</td>  </tr>  <tr>    <th>crit</th>    <td>致命的なエラー</td>  </tr>  <tr>    <th>alert</th>    <td>緊急に対処すべきエラー</td>  </tr>  <tr>    <th>emerg</th>    <td>システムが落ちるような状態</td>&gt;  </tr>
</table> <h5>action</h5>
<p>actionには、selectorで指定したメッセージをどこに出力するかを設定します。 </p>
<ul>  <li>指定したファイルのパスに出力する</li>  <li>
<code>|</code>(パイプ)でほかのプログラムに渡す</li>  <li>
<code>@ホスト名</code>で指定したホストに転送する</li>  <li>ユーザーのコンソール(<code>/dev/condole</code>)に出力</li>  <li>指定したユーザに通知</li>
</ul> <h4>テンプレートやマクロでのログ出力内容のカスタマイズ</h4>
<p>rsyslogで出力されるログをカスタマイズするには<b>テンプレート</b>という機能を使用します。<code>$template</code>という記述で定義します。その際、<b>マクロ</b>という定義を使って出力する内容を指定できます。マクロは<code>%マクロ名%</code>のように、前後に「%」を付けて使用します。 </p> <table>  <tr>    <th bgcolor="#cccccc"><strong>ファシリティ</strong></th>    <th bgcolor="#cccccc"><strong>用途</strong></th>  </tr>  <tr>    <th><strong>msg</strong></th>    <td>ログメッセージ</td>  </tr>  <tr>    <th><strong>hostname</strong></th>    <td>ログを出力したホストの名前</td>  </tr>  <tr>    <th><strong>fromhost</strong></th>    <td>ログを受け取ったホストの名前</td>  </tr>  <tr>    <th><strong>programname</strong></th>    <td>プログラム名</td>  </tr>  <tr>    <th><strong>syslogfacility</strong></th>    <td>ファシリティ（数字）</td>  </tr>  <tr>    <th><strong>syslogfacility-text</strong></th>    <td>ファシリティ（テキスト）</td>  </tr>  <tr>    <th><strong>syslogseverity</strong></th>    <td>プライオリティ（数字）</td>  </tr>  <tr>    <th><strong>syslogseverity-text</strong></th>    <td>プライオリティ（テキスト）</td>  </tr>  <tr>    <th><strong>syslogpriority</strong></th>    <td>syslogseverityと同等</td>  </tr>  <tr>    <th><strong>syslogpriority-text</strong></th>    <td>syslogseverity-textと同等</td>  </tr>  <tr>    <th><strong>timegenerated</strong></th>    <td>ログを受け取った日時</td>  </tr>  <tr>    <th><strong>timereported</strong></th>    <td>ログが出力された日時</td>  </tr>  <tr>    <th><strong>timestamp</strong></th>    <td>timereportedと同等</td>  </tr>  <tr>    <th><strong>$now</strong></th>    <td>現在時刻（書式：YYYY-MM-DD）</td>  </tr>  <tr>    <th><strong>$year</strong></th>    <td>現在の年（4けた）</td>  </tr>  <tr>    <th><strong>$month</strong></th>    <td>現在の月（2けた）</td>  </tr>  <tr>    <th><strong>$day</strong></th>    <td>現在の日（2けた）</td>  </tr>  <tr>    <th><strong>$hour</strong></th>    <td>現在の時（24時間表記、2けた）</td>  </tr>  <tr>    <th><strong>$minute</strong></th>    <td>現在の分（2けた）</td>  </tr>
</table>
<br><p><code>/var/log/messages</code>にファシリティのプライオリティの情報を出力する場合は、<code>/etc/rsyslog.conf</code>へ以下のような指定をします。 </p>
<pre class="terminal">  # 既存/var/log/messagesへのログ出力設定をコメントアウト #*.info;mail.none;authpriv.none;cron.none                /var/log/messages  # 新規に設定を追加 $template mytemplate,"%timegenerated% %hostname% %programname% %syslogpriority-text% %msg%\n" *.info;mail.none;authpriv.none;cron.none                /var/log/messages;mytemplate  </pre> <p>設定をおこなったあとは rsyslog を再起動します。 </p>
<pre class="terminal">  # service rsyslog restart  </pre> <h4>おわりに</h4>
<p>以上で設定は終了です。 </p> <h4>参考</h4> <ul>  <li><a href="http://www.atmarkit.co.jp/ait/articles/0812/05/news152.html">新世代syslogデーモン徹底活用（5）：マクロとテンプレートによるrsyslog活用法 (1/2) - ＠IT</a></li>
</ul>
</body>

<!-- more -->


