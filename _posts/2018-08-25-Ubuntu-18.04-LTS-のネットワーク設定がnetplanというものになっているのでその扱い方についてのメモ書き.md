---
layout: post
Categories:  ["tech"]
Description:  " Ubuntu 18.04 LTSを使っていたらネットワーク設定の方法がifup/downからnetplanというものへと置き換わり、サービスの管理もnetworkingからsystemd-networkd, systemd-resolve"
Tags: ["tech", "Ubuntu"]
date: "2018-08-25T11:12:00+09:00"
title: "Ubuntu 18.04 LTS のネットワーク設定がnetplanというものになっているのでその扱い方についてのメモ書き"
author: "dshimizu"
archive: ["2018"]
draft: "true"
---

<body>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a> 18.04 LTSを使っていたらネットワーク設定の方法がifup/downからnetplanというものへと置き換わり、サービスの管理もnetworkingからsystemd-networkd, systemd-resolvedというものに変わっていた。</p>

<ul>
    <li><a target="_blank" rel="noopener noreferrer" href="https://wiki.ubuntu.com/Netplan/Design">Netplan/Design - Ubuntu Wiki</a></li>
    <li><a target="_blank" rel="noopener noreferrer" href="https://netplan.io">netplan.io</a></li>
</ul>


<p>厳密にいつから変わったのか追ってみるのと、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a> 17.04 で<a class="keyword" href="http://d.hatena.ne.jp/keyword/DNS">DNS</a>の設定でsystemd-resolvedを使うようになっており、17.10でネットワーク設定で netplan を使うように変わっていた。</p>

<ul>
    <li><a target="_blank" rel="noopener noreferrer" href="https://wiki.ubuntu.com/ZestyZapus/ReleaseNotes">ZestyZapus/ReleaseNotes - Ubuntu Wiki</a></li>
</ul>
<pre class="doc"> Networking
The default DNS resolver is now systemd-resolved.
 </pre>



<ul>
    <li><a target="_blank" rel="noopener noreferrer" href="https://wiki.ubuntu.com/ArtfulAardvark/ReleaseNotes">ArtfulAardvark/ReleaseNotes - Ubuntu Wiki</a></li>
</ul>
<pre class="doc"> Network configuration
ifupdown has been deprecated in favor of netplan and is no longer present on new installs. The installer will generate a configuration file for netplan in /etc/netplan, which will set up the system to configure the network via systemd-networkd or NetworkManager. Desktop users will see their system fully managed via NetworkManager as it has been the case in previous releases, but Server users now have their network devices managed via systemd-networkd on new installs. This only applies to new installations.
Given that ifupdown is no longer installed by default, its commands will not be present: ifup and ifdown are thus unavailable, replaced by ip link set $device up and ip link set $device down.
The networkctl command is also available for users to see a summary of the network devices. networkctl status will display the current global state of IP addresses on the system; and networkctl status $device can display the details specific to a network device.
For more information about netplan, please refer to the manual page using the man 5 netplan command.
 </pre>


</body>

<!-- more -->

<body>
<p>ただ、一応従来の<code>/etc/network/interfaces</code>や <code>/etc/network/interfaces.d/</code>以下のネットワーク設定ファイルと networkingサービスでも動く模様。(少なくともUbuntu16.04LTS-&gt;Ubuntu18.04LTSへアップグレードした際には従来の<code>/etc/network/interfaces</code>や <code>/etc/network/interfaces.d/</code>+networkingサービスで動いた。)</p>

<h4>Netplanの設定</h4>


<p>現行のnetworkingサービスからnetplan + systemd-networkdへの移行を行ってみる。
現行のネットワーク設定(<code>/etc/network/interfaces</code>)を以下のようなものであるとする。</p>

<pre class="terminal"> auto ens3
iface ens3 inet static
        address 192.168.1.10
        netmask 255.255.255.0
        network 192.168.1.0
        broadcast 192.168.1.255
        gateway 192.168.1.254
        # dns-* options are implemented by the resolvconf package, if installed
        dns-nameservers 192.168.1.3 192.168.1.4
        dns-search example.jp
 </pre>


<p>上記のファイルを <code>netplan</code> の設定ファイルへ置き換える。
<code>netplan</code> の設定ファイルは<a class="keyword" href="http://d.hatena.ne.jp/keyword/YAML">YAML</a>形式となっている。以下にサンプルがあるので必要に応じて参考にするのが良さそう。</p>

<ul>
    <li><a target="_blank" rel="noopener noreferrer" href="https://netplan.io/">Examples | netplan.io</a></li>
</ul>


<p>設定ファイルの設置場所は <code>/etc/netplan/*.yaml</code> となる。
現行の設定をnetplanの<a class="keyword" href="http://d.hatena.ne.jp/keyword/YAML">YAML</a>ファイル(<code>/etc/netplan/01-netcfg.yaml</code>)に書き換えると以下のようにな感じになる。</p>

<pre class="terminal"> network:
  version: 2
  renderer: networkd
  ethernets:
    ens3:
      dhcp4: no
      dhcp6: no
      addresses:
        - 192.168.1.10/24
      gateway4: 192.168.1.254
      nameservers:
        addresses: [192.168.1.3,192.168.1.4]
        search: [example.jp]
 </pre>


<p><code>addresses:</code>のところは/32ではなく、属しているネットワークのクラスまたはCIDRとするのが注意点な気がする。</p>

<p>netplanの設定ファイルを作成後、以下を実行する。</p>

<pre class="terminal"> $ sudo netplan generate
 </pre>


<p>すると、systemdで扱うための以下のような設定ファイルが生成される。</p>

<pre class="terminal"> /run/systemd/network/10-netplan-ens3.network
/run/systemd/resolve/resolv.conf
 </pre>


<p>ちなみに以下を実行すると上記設定ファイルが生成されて、かつネットワーク設定が反映される。</p>

<pre class="terminal"> $ sudo netplan apply
 </pre>


<p>これで設定のほうは完了。</p>

<p><code>networking</code>サービスは不要なので、OS起動時の<code>networking</code>サービスの起動を無効化する。</p>

<pre class="terminal"> $ sudo systemctl disable networking
 </pre>


<p>続いて systemd-networkd をOS起動時に起動するように設定しておく必要がある。</p>

<pre class="terminal"> $ sudo systemctl enable systemd-networkd.service
Synchronizing state of networking.service with SysV service script with /lib/systemd/systemd-sysv-install.
Executing: /lib/systemd/systemd-sysv-install enable networking
insserv: warning: current start runlevel(s) (empty) of script `networking' overrides LSB defaults (S).
insserv: warning: current stop runlevel(s) (0 6 S) of script `networking' overrides LSB defaults (0 6).
insserv: warning: current start runlevel(s) (empty) of script `networking' overrides LSB defaults (S).
insserv: warning: current stop runlevel(s) (0 6 S) of script `networking' overrides LSB defaults (0 6).
 </pre>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/%BC%AB%C6%B0%B5%AF%C6%B0">自動起動</a>になっているか確認する。 enabled であれば問題ない。</p>

<pre class="terminal"> $ sudo systemctl is-enabled systemd-networkd.service
enabled
 </pre>


<p>上記は、netplanはデフォルトでは <code>systemd-networkd</code> から設定ファイル等を処理されるようになっているための対応。</p>

<ul>
    <li><a target="_brank" rel="nopener noopener noreferrer" href="http://manpages.ubuntu.com/manpages/cosmic/man5/netplan.5.html">Ubuntu Manpage: netplan - YAML network configuration abstraction for various backends</a></li>
</ul>
<pre class="doc">    Introduction
       Distribution  installers, cloud instantiation, image builds for particular devices, or any
       other way to deploy an operating system put its desired network  configuration  into  YAML
       configuration file(s).  During early boot, the netplan “network renderer” runs which reads
       /{lib,etc,run}/netplan/*.yaml and writes configuration to /run  to  hand  off  control  of
       devices to the specified networking daemon.

       · Configured  devices get handled by systemd-networkd by default, unless explicitly marked
         as managed by a specific renderer (NetworkManager)

       · Devices not covered by the network config do not get touched at all.

       · Usable in initramfs (few dependencies and fast)

       · No persistent generated config, only original YAML config

       · Parser supports multiple config files to allow  applications  like  libvirt  or  lxd  to
         package  up  expected  network  config (virbr0, lxdbr0), or to change the global default
         policy to use NetworkManager for everything.

       · Retains  the  flexibility  to  change  backends/policy  later  or  adjust  to   removing
         NetworkManager, as generated configuration is ephemeral.
 </pre>



<p>そして<code>systemd-networkd</code>が、生成された以下のファイル読み込む。</p>

<pre class="terminal"> /run/systemd/network/10-netplan-ens3.network
/run/systemd/resolve/resolv.conf
 </pre>


<p>これらは一時的なファイルであるため、永続化させたいときは <code>/etc/systemd/network</code> と <code>/etc/systemd/resolve</code> にファイルを置く。</p>

<p>ここまで終わったらOSを reboot する。</p>

<pre class="terminal"> $ sudo reboot
 </pre>


<p>再起動後、無事接続等できれば完了。</p>

<h3>まとめ</h3>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a> 18.04 LTS ではネットワーク設定の管理が従来のifup/downでの管理から netplan へと変わっており、ネットワークサービスの管理がnetworkingから systemd-networkd, systemd-resolvedへと変わっている。(厳密には <a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a> 17.04 から変わり始めている。)
netplanでは設定ファイルが<a class="keyword" href="http://d.hatena.ne.jp/keyword/YAML">YAML</a>形式に変わっている。</p>

<h3>参考</h3>


<ul>
    <li><a target="_blank" rel="noopener noreferrer" href="https://wiki.ubuntu.com/Netplan/Design">Netplan/Design - Ubuntu Wiki</a></li>
    <li><a target="_blank" rel="noopener noreferrer" href="https://netplan.io">netplan.io</a></li>
    <li><a target="_brank" rel="noopener noreferrer" href="http://manpages.ubuntu.com/manpages/cosmic/man5/netplan.5.html">Ubuntu Manpage: netplan - YAML network configuration abstraction for various backends</a></li>
    <li>
<a target="_brank" rel="noopener noreferrer" href="http://manpages.ubuntu.com/manpages/cosmic/man5/netplan.5.html"></a><a target="_blank" rel="noopener noreferrer" href="https://wiki.ubuntu.com/ZestyZapus/ReleaseNotes">ZestyZapus/ReleaseNotes - Ubuntu Wiki</a>
</li>
    <li><a target="_blank" rel="noopener noreferrer" href="https://wiki.ubuntu.com/ArtfulAardvark/ReleaseNotes">ArtfulAardvark/ReleaseNotes - Ubuntu Wiki</a></li>
    <li><a target="_blank" rel="noopener noreferrer" href="https://wiki.archlinux.jp/index.php/Systemd-networkd">systemd-networkd - ArchWiki</a></li>
    <li><a target="_blank" rel="noopener noreferrer" href="https://blog.ubuntu.com/2017/12/01/ubuntu-bionic-netplan">Ubuntu Bionic: Netplan | Ubuntu blog</a></li>
    <li><a target="_brank" rel="noopener noreferrer" href="https://askubuntu.com/questions/850339/what-is-the-networking-service">16.04 - What is the networking.service? - Ask Ubuntu</a></li>
</ul>

</body>
