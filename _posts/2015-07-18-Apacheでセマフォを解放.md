---
layout: post
Categories:  ["tech"]
Description:  " はじめに  Apacheが応答不能になり、再起動しても起動できなくなってしまったので確認すると、セマフォを使い切っていたことが問題だったようなので、その際に調べたことなどをメモします。     セマフォの解放   セマフォとは  セマフォ"
Tags: ["Apache", "Linux"]
date: "2015-07-18T15:54:00+09:00"
title: "Apacheでセマフォを解放"
author: "dshimizu"
archive: ["2015"]
draft: "true"
---

<body>
<h4>はじめに</h4>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>が応答<a class="keyword" href="http://d.hatena.ne.jp/keyword/%C9%D4%C7%BD">不能</a>になり、再起動しても起動できなくなってしまったので確認すると、<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BB%A5%DE%A5%D5%A5%A9">セマフォ</a>を使い切っていたことが問題だったようなので、その際に調べたことなどをメモします。 </p> <a name="more"></a> <h4>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BB%A5%DE%A5%D5%A5%A9">セマフォ</a>の解放</h4> <h5>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BB%A5%DE%A5%D5%A5%A9">セマフォ</a>とは</h5>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BB%A5%DE%A5%D5%A5%A9">セマフォ</a>は<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%DE%A5%EB%A5%C1%A5%BF%A5%B9%A5%AF">マルチタスク</a>OSなど、並行して複数のタスク/プロセスが動作する<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AA%A5%DA%A5%EC%A1%BC%A5%C6%A5%A3%A5%F3%A5%B0%A5%B7%A5%B9%A5%C6%A5%E0">オペレーティングシステム</a>で用意されている仕組みで、既定数以上のプロセスが共有資源(変数やメモリ、ファイル等)に同時にアクセスしないようにカウンタを使って制御する仕組みです。<br></p>
<p>例えば、IPC(<a class="keyword" href="http://d.hatena.ne.jp/keyword/UNIX">UNIX</a>の<a class="keyword" href="http://d.hatena.ne.jp/keyword/API">API</a>の一種)ではプロセス間通信のための機能として用意され、プロセス間の共有資源へのアクセス衝突を防止(<a class="keyword" href="http://d.hatena.ne.jp/keyword/%C7%D3%C2%BE%C0%A9%B8%E6">排他制御</a>)するために共有メ<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%E2%A5%EA%A1%BC">モリー</a>上のフラグ変数を格納したデータ配列、およびそれに対する操作機能として提供/利用されています。<br>OSにより仕様や使い方に差はありますが、一般に<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BB%A5%DE%A5%D5%A5%A9">セマフォ</a>用のデータは配列のためフラグは複数個用意することが可能で、処理内容によって使い分けることができます。 </p> <h5>原因確認</h5>
<p>異常があった場合に確認するものの１つはログです。<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>のログを見ると以下のエラーが出ていました。 </p> <pre class="terminal">  [emerg] (28)No space left on device: Couldn't create accept lock ($APACHE_LOG_DIR/logs/accept.lock.12236) (5) Notice: cleaning up shared memory  
</pre>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>のログにこのようなエラーが出力されていると、OSで利用可能な<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BB%A5%DE%A5%D5%A5%A9">セマフォ</a>が限界値に達してしまったために、新しい<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BB%A5%DE%A5%D5%A5%A9">セマフォ</a>を使ってプロセス(ここでは<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>)を起動することができなくなっている可能性があります。 </p> <p>このような場合、以下のコマンドを実行して<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BB%A5%DE%A5%D5%A5%A9">セマフォ</a>の情報を表示して、使用中の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BB%A5%DE%A5%D5%A5%A9">セマフォ</a>の数を確認します。  </p> <pre class="terminal">  # ipcs -s  ------ セマフォ配列 -------- キー     semid      所有者  権限     nsems 0x0052e2c1 0          httpd      600        17 0x0052e2c2 32769      httpd      600        17 0x0052e2c3 65538      httpd      600        17 0x0052e2c4 98307      httpd      600        17 0x0052e2c5 131076     httpd      600        17 ：  </pre> <pre class="terminal">  # ipcs -s | grep httpd | wc -l 128  </pre> <p>それが以下<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AB%A1%BC%A5%CD%A5%EB">カーネル</a>パラメータの一番右の設定値と同じであれば、<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BB%A5%DE%A5%D5%A5%A9">セマフォ</a>が原因になります。 </p> <pre class="terminal">  # sysctl -a | grep kernel.sem kernel.sem = 250 32000 32 128  </pre> <p><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AB%A1%BC%A5%CD%A5%EB">カーネル</a>パラメータは以下を意味します。 </p>
<table>
<tr>
<th><span class="honbun">パラメータ</span></th>
<th><span class="honbun">設定例</span></th>
<th><span class="honbun">説明</span></th>
</tr>
<tr>
<th><span class="honbun">kernel.<a class="keyword" href="http://d.hatena.ne.jp/keyword/sem">sem</a></span></th>
<td><span class="honbun">SEMMSL SEMMNS SEMOPM SEMMNI</span></td>
<td><span class="honbun">スペースで区切られた4つの値で設定します。4つの値はそれぞれ以下を意味します。</span></td>
</tr>
</table> <pre class="file">  SEMMSL セマフォ数の最大値 SEMMNS システム全体のセマフォの最大値 SEMOPM semop(2)コールに指定されるオペレーション数の最大値 SEMMNI セマフォ識別子の最大値  </pre> <p><code>sysctl</code>の結果から、ここでは<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BB%A5%DE%A5%D5%A5%A9">セマフォ</a>の限界値が128個であることを意味します。この結果と<cod>ipcsで出力される結果の個数が128であれば、 </cod></p> <h5>復旧方法</h5>
<p>こうなった場合、不要と思われる<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BB%A5%DE%A5%D5%A5%A9">セマフォ</a>を使っているプロセスをKILLすることで復旧できます。 </p> <p>プロセスIDを１つずつ削除するには以下のコマンドを実行します。 </p>
<pre class="terminal">  # ipcrm -m プロセスID  </pre> <p><a class="keyword" href="http://d.hatena.ne.jp/keyword/httpd">httpd</a>のプロセスIDを一度に取得して削除するには以下のコマンドを実行します。 </p>
<pre class="terminal">  # for i in `ipcs -s | awk '/httpd/ {print $2}'`; do (ipcrm -s $i); done  </pre> <h4>おわりに</h4>
<p>以上が<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BB%A5%DE%A5%D5%A5%A9">セマフォ</a>を解放する手順になります。 </p> <h4>参考</h4> <ul>
<li><a href="http://selfkleptomaniac.org/archives/2418">Apacheの救急救助手順 | Selfkleptomaniac 変更する</a></li>
<li><a href="https://teratail.com/questions/367">apacheのエラーログに「No space left on device: Couldn't create accept lock 」という文字が出力されていました。</a></li>
</ul>
</body>

<!-- more -->


