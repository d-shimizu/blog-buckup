---
layout: post
Categories:  ["tech"]
Description:  " KVMのゲスト仮想マシンを外部からメンテナンスをする際に便利な libguestfs というツールを知った。 といってもゲスト仮想マシンが外部から操作可能な状態、sshやvirsh consoleでログインできる状態ならそこまでお世話にな"
Tags: ["CentOS", "KVM", "tech"]
date: "2018-10-20T12:37:00+09:00"
title: "オフラインのKVMゲスト仮想マシンを直接操作するツール"
author: "dshimizu"
archive: ["2018"]
draft: "true"
---

<body>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/KVM">KVM</a>のゲスト<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B2%BE%C1%DB%A5%DE%A5%B7%A5%F3">仮想マシン</a>を外部からメンテナンスをする際に便利な <code>libguestfs</code> というツールを知った。<br>
といってもゲスト<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B2%BE%C1%DB%A5%DE%A5%B7%A5%F3">仮想マシン</a>が外部から操作可能な状態、<code>ssh</code>や<code>virsh console</code>でログインできる状態ならそこまでお世話になることはない。<br>
何らかの理由でゲスト<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B2%BE%C1%DB%A5%DE%A5%B7%A5%F3">仮想マシン</a>にログインできなくなり、ホストOS上からゲスト<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B2%BE%C1%DB%A5%DE%A5%B7%A5%F3">仮想マシン</a>のファイルを直接参照したり編集したりしたいとか、rescueモードでログインしたいといったときに役立つ。</p>










<ul><li><a href="https://access.redhat.com/documentation/ja-jp/red_hat_enterprise_linux/6/html/virtualization_administration_guide/chap-virtualization_administration_guide-guest_disks_libguestfs">第17章 オフラインツールでゲスト仮想マシンのディスクにアクセスする - Red Hat Customer Portal</a></li></ul>










<p>上記はRHEL6のドキュメントのものだが<a class="keyword" href="http://d.hatena.ne.jp/keyword/CentOS">CentOS</a>にも同様のツールは存在する。</p>









</body>

<!-- more -->

<body>
<h4>libguestfsの使い方</h4>










<h5>インストール</h5>










<p><strong>環境</strong></p>










<ul><li>OS: CentOS6</li></ul>










<p>パッケージがあるのでインストールは簡単。</p>










<pre class="terminal"> $ sudo yum install libguestfs libguestfs-tools
 </pre>










<h4>使い方</h4>










<p><strong>※操作する対象のゲスト<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B2%BE%C1%DB%A5%DE%A5%B7%A5%F3">仮想マシン</a>を停止しておく必要がある。</strong></p>










<h5>ゲスト<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B2%BE%C1%DB%A5%DE%A5%B7%A5%F3">仮想マシン</a>内のファイルを直接参照したい場合</h5>










<p><code>virt-cat</code>というコマンドを実行する。<br>
例えばguestvm01というゲスト<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B2%BE%C1%DB%A5%DE%A5%B7%A5%F3">仮想マシン</a>の<code>/etc/fstab</code>というファイルの中身を見たい場合はguestvm01を停止した状態で以下を実行する。<br>
<code>-d</code>オプションは<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C9%A5%E1%A5%A4%A5%F3">ドメイン</a>(ゲスト<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B2%BE%C1%DB%A5%DE%A5%B7%A5%F3">仮想マシン</a>)を指定するための引数。</p>










<pre class="terminal"> $ sudo virt-cat -d guestvm01 /etc/fstab
 </pre>










<h5>ゲスト<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B2%BE%C1%DB%A5%DE%A5%B7%A5%F3">仮想マシン</a>内のファイルを直接編集したい場合</h5>










<p><code>virt-edit</code>というコマンドを実行する。<br>
例えばguestvm01というゲスト<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B2%BE%C1%DB%A5%DE%A5%B7%A5%F3">仮想マシン</a>の<code>/etc/fstab</code>というファイルの中身を編集したい場合はguestvm01を停止した状態で以下を実行する。<br>
<code>-d</code>オプションは<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C9%A5%E1%A5%A4%A5%F3">ドメイン</a>(ゲスト<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B2%BE%C1%DB%A5%DE%A5%B7%A5%F3">仮想マシン</a>)を指定するための引数。</p>










<pre class="terminal"> $ sudo virt-edit -d guestvm01 /etc/fstab
 </pre>










<h5>ゲスト<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B2%BE%C1%DB%A5%DE%A5%B7%A5%F3">仮想マシン</a>内のファイルの一覧を参照したい場合</h5>










<p><code>virt-ls</code>というコマンドを実行する。<br>
例えばguestvm01というゲスト<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B2%BE%C1%DB%A5%DE%A5%B7%A5%F3">仮想マシン</a>の<code>/var/log</code>以下のファイルの一覧を見たい場合はguestvm01を停止した状態で以下を実行する。<br>
<code>-d</code>オプションは<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C9%A5%E1%A5%A4%A5%F3">ドメイン</a>(ゲスト<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B2%BE%C1%DB%A5%DE%A5%B7%A5%F3">仮想マシン</a>)を指定するための引数。</p>










<pre class="terminal"> $ sudo virt-ls -d guestvm01 /var/log
 </pre>










<h5>ゲスト<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B2%BE%C1%DB%A5%DE%A5%B7%A5%F3">仮想マシン</a>にレスキューモードでログインしたい場合</h5>










<p><code>virt-rescue</code>というコマンドを実行する。<br>
例えばguestvm01というゲスト<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B2%BE%C1%DB%A5%DE%A5%B7%A5%F3">仮想マシン</a>にログインしたい場合、guestvm01を停止した状態で以下を実行する。</p>










<pre class="terminal"> $ sudo virt-rescue guestvm01
 </pre>










<p>しばらく待っているとレスキューシェルが起動して以下のようなプロンプトが表示されるので後はこの状態で必要な操作を実行する。</p>










<pre class="terminal"> &gt;&lt;rescue&gt;
 </pre>










<h3>まとめ</h3>










<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/KVM">KVM</a>のメンテナンスを行うための <code>libguestfs</code> というツールを知ったので、いくつかのオペレーションコマンドの使い方を簡単に記載した。<br>
上記以外にもいくつかコマンドが存在するので必要に応じて使っていこうと思う。</p>










<h3>参考</h3>










<ul>
<li><a href="https://access.redhat.com/documentation/ja-jp/red_hat_enterprise_linux/6/html/virtualization_administration_guide/chap-virtualization_administration_guide-guest_disks_libguestfs">第17章 オフラインツールでゲスト仮想マシンのディスクにアクセスする - Red Hat Customer Portal</a></li>
<li><a href="https://access.redhat.com/documentation/ja-jp/red_hat_enterprise_linux/6/html/virtualization_getting_started_guide/ch05s05">5.5. 他の便利ツール - Red Hat Customer Portal</a></li>
</ul>




</body>
