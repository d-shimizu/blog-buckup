---
layout: post
Categories:  ["tech"]
Description:  " 2018/10/1 Zabbix 4.0 がリリースされた。Zabbix4.0 は、長期サポート（LTS）版となるため、サポート期間が5年となっている。       Release Notes for Zabbix 4.0.0      "
Tags: ["tech", "Zabbix"]
date: "2018-10-07T23:24:00+09:00"
title: "Ubuntu 16.04 LTSのZabbix3.4をZabbix4.0へアップグレード"
author: "dshimizu"
archive: ["2018"]
draft: "true"
---

<body>
<p>2018/10/1 Zabbix 4.0 がリリースされた。
Zabbix4.0 は、長期サポート（LTS）版となるため、サポート期間が5年となっている。</p>

<ul>
    <li><a target="_brank" rel="noopener noreferrer" href="https://www.zabbix.com/rn/rn4.0.0">Release Notes for Zabbix 4.0.0</a></li>
    <li><a target="_brank" rel="noopener noreferrer" href="http://www.zabbix.jp/node/4470">Zabbix 4.0.0リリース | 日本Zabbixユーザー会</a></li>
</ul>


<p>前バージョン3.4のリリースから約1年ぶりの新バージョンのリリースとなるため、早速現在遊びで使っているZabbix3.4からのアップデートを行った。</p>
</body>

<!-- more -->

<body>
<h3>Zabbix3.4-&gt;4.0へのアップデート</h3>


<p>基本的には下記オフィシャルドキュメントに記載の手順通りに実施した。
<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a>/<a class="keyword" href="http://d.hatena.ne.jp/keyword/Debian">Debian</a>のZabbix4.0のパッケージのアップグレードに関しては3.4<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A4%AB%A4%E9%A4%B7">からし</a>かサポートされてないようなことが書かれているような気がするが、よくわからないし今やろうとしているのはZabbix3.4から4.0へのアップグレードなので気にしないことにする。</p>

<ul>
    <li><a target="_brank" rel="noopener noreferrer" href="https://www.zabbix.com/documentation/4.0/manual/installation/upgrade/packages/debian_ubuntu">2 Debian/Ubuntu [Zabbix Documentation 4.0] </a></li>
</ul>


<p>以下のURLから環境にあったパッケージを取得する。</p>

<ul>
    <li><a target="_brank" rel="noopener noreferrer" href="https://www.zabbix.com/jp/download">Download Zabbix</a></li>
</ul>


<p>ここではUbuntu16.04 LTS環境なのでそのZabbix4.0用<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EA%A5%DD%A5%B8%A5%C8%A5%EA">リポジトリ</a>パッケージを取得する。</p>

<pre class="terminal"> $ wget https://repo.zabbix.com/zabbix/4.0/ubuntu/pool/main/z/zabbix-release/zabbix-release_4.0-2+xenial_all.deb
 </pre>


<p>該当パッケージをインストールする。</p>

<pre class="terminal"> $ sudo dpkg -i zabbix-release_4.0-2+xenial_all.deb
 </pre>


<p>現行Zabbix Serverを停止する。</p>

<pre class="terminal"> $ sudo systemctl stop zabbix-server
 </pre>


<p>現行Zabbix Serverのファイルをバックアップする。
まずはバックアップファイル保存用の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リを作成する。</p>

<pre class="terminal"> $ sudo mkdir /opt/zabbix-backup/
 </pre>


<p>現行Zabbix Serverのコンフィグファイルをバックアップする。</p>

<pre class="terminal"> $ sudo cp -pr /etc/zabbix/zabbix_server.conf /opt/zabbix-backup/
 </pre>


<p>現行Zabbixフロントエンド用<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>コンフィグファイルをバックアップする。</p>

<pre class="terminal"> $ sudo cp -pr /etc/apache2/conf-enabled/zabbix.conf /opt/zabbix-backup/
 </pre>


<p>現行Zabbixフロントエンド用<a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a>ソースをバックアップする。</p>

<pre class="terminal"> $ sudo cp -prR /usr/share/zabbix/ /opt/zabbix-backup/
 </pre>


<p>現行Zabbixの<a class="keyword" href="http://d.hatena.ne.jp/keyword/ChangeLog">ChangeLog</a>等のファイルもバックアップする。</p>

<pre class="terminal"> $ sudo cp -prR /usr/share/doc/zabbix-* /opt/zabbix-backup/
 </pre>


<p>オフィシャル手順には書かれていないが<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>をバックアップする。
<code>--single-transaction</code>とか<code>mater-data</code>とかのオプションは環境に合わせてお好みで。</p>

<pre class="terminal"> $ mysqldump -u zabbix -p -h localhost zabbix &gt; zabbix.dump
 </pre>


<p>Zabbix Server(<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>用)、Zabbixフロントエンド、Zabbixエージェントのパッケージをインストール(アップグレード)する。</p>

<pre class="terminal"> $ sudo apt install --only-upgrade zabbix-server-mysql zabbix-frontend-php zabbix-agent
 </pre>


<p>Zabbix Serverを起動する。</p>

<pre class="terminal"> $ sudo systemctl start zabbix-server
 </pre>


<p>...と思ったら起動できなかった。</p>

<p>Zabbix Server起動時に<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>のDB定義等をアップグレードしてくれているが、<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>が止まってしまったようでそれが失敗していた。
しょぼいスペックで動かしていたからかな...</p>

<pre class="terminal">  10449:20181007:175245.487 Starting Zabbix Server. Zabbix 4.0.0 (revision 85308).
 10449:20181007:175245.487 ****** Enabled features ******
 10449:20181007:175245.487 SNMP monitoring:           YES
 10449:20181007:175245.487 IPMI monitoring:           YES
 10449:20181007:175245.487 Web monitoring:            YES
 10449:20181007:175245.487 VMware monitoring:         YES
 10449:20181007:175245.487 SMTP authentication:       YES
 10449:20181007:175245.487 Jabber notifications:      YES
 10449:20181007:175245.487 Ez Texting notifications:  YES
 10449:20181007:175245.487 ODBC:                      YES
 10449:20181007:175245.488 SSH2 support:              YES
 10449:20181007:175245.488 IPv6 support:              YES
 10449:20181007:175245.488 TLS support:               YES
 10449:20181007:175245.488 ******************************
 10449:20181007:175245.488 using configuration file: /etc/zabbix/zabbix_server.conf
 10449:20181007:175245.522 current database version (mandatory/optional): 03040000/03040000
 10449:20181007:175245.523 required mandatory version: 04000000
 10449:20181007:175245.523 starting automatic database upgrade
 10449:20181007:175245.680 completed 0% of database upgrade
 10449:20181007:175245.826 completed 1% of database upgrade
 10449:20181007:175245.902 completed 2% of database upgrade
 10449:20181007:175246.115 completed 3% of database upgrade
 10449:20181007:175246.136 completed 4% of database upgrade
 10449:20181007:175246.291 completed 5% of database upgrade
 10449:20181007:175503.224 [Z3005] query failed: [1317] Query execution was interrupted [alter table `events` add `name` varchar(2048) default '' not null]
 10449:20181007:175503.225 slow query: 136.934211 sec, "alter table `events` add `name` varchar(2048) default '' not null"
 </pre>


<p>ということで<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>を起動する。</p>

<pre class="terminal"> $ sudo systemctl start mysql
 </pre>


<p>再度Zabbix Serverを起動する。</p>

<pre class="terminal"> $ sudo systemctl restart zabbix-server
 </pre>


<p>起動できた。</p>

<p>画面は、新しいテーマのハイ<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B3%A5%F3%A5%C8%A5%E9">コントラ</a>スト(ダーク)というテーマの画面。</p>

<p><img src="/wp-content/uploads/zabbix40.png" alt="" width="1024" height="768" class="aligncenter size-full wp-image-1086"></p>

<h3>まとめ</h3>


<p>Zabbix3.4-&gt;Zabbix4.0へのアップグレードを行った。
パッケージを使っていればアップグレードも<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%E9%A5%AF">ラク</a>チンだった。</p>
</body>
