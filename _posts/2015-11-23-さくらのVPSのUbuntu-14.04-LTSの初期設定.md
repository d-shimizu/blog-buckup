---
layout: post
Categories:  ["tech"]
Description:  " はじめに  さくらのVPSへUbuntuをインストールしたので、その初期設定です。 "
Tags: ["tech", "Ubuntu", "さくらのVPS"]
date: "2015-11-23T18:38:00+09:00"
title: "さくらのVPSのUbuntu 14.04 LTSの初期設定"
author: "dshimizu"
archive: ["2015"]
draft: "true"
---

<body>
<h3>はじめに</h3>


<p>さくらの<a class="keyword" href="http://d.hatena.ne.jp/keyword/VPS">VPS</a>へ<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a>をインストールしたので、その初期設定です。</p>
</body>

<!-- more -->

<body>
<h3>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a> 14.04 LTSの初期設定項目</h3>


<ul>
    <li>一般ユーザ/グループ作成</li>
    <li>sudo設定</li>
    <li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/ssh">ssh</a>の設定</li>
    <li>localeの設定</li>
    <li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/Postfix">Postfix</a>の設定</li>
    <li>ntpの設定</li>
    <li>リ<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BE%A5%EB">ゾル</a>バの設定</li>
    <li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/iptables">iptables</a>の設定</li>
    <li>パッケージアップデート</li>
</ul>


<h4>一般ユーザ/グループ作成</h4>


<p>グループを作成します。ここではグループ名:<a class="keyword" href="http://d.hatena.ne.jp/keyword/hoge">hoge</a>、<a class="keyword" href="http://d.hatena.ne.jp/keyword/gid">gid</a>:10000としています。</p>

<pre class="terminal"> # groupadd -g 10000 hoge
 </pre>


<p>一般ユーザを作成します。ユーザ名:<a class="keyword" href="http://d.hatena.ne.jp/keyword/hoge">hoge</a>、uid:10000、所属グループ:<a class="keyword" href="http://d.hatena.ne.jp/keyword/hoge">hoge</a>で作成しています。</p>

<pre class="terminal"> # useradd -u 10000 -g hoge -d /home/hoge -m -s /bin/bash hoge
 </pre>


<p>パスワードを設定します。</p>

<pre class="terminal"> # passwd hoge
 </pre>


<h4>公開鍵作成</h4>


<p>先ほど作成したユーザの<a class="keyword" href="http://d.hatena.ne.jp/keyword/ssh">ssh</a>鍵ペアを作成します。</p>

<pre class="terminal"> # su - hoge
 </pre>


<pre class="terminal"> $ ssh-keygen -t rsa　←RSA暗号方式の鍵を作成
Generating public/private rsa key pair.
Enter file in which to save the key (/home/hoge/.ssh/id_rsa): ←［Enter］キーを押す
Enter passphrase (empty for no passphrase): ←パスフレーズを入力
Enter same passphrase again: ←もう一度同じパスフレーズを入力
Your identification has been saved in id_rsa.
Your public key has been saved inid_rsa.pub.
The key fingerprint is:
1c:4b:4b:81:3b:66:54:d2:2b:26:c3:c6:52:28:fe:3b hoge@XXXXXXXX.sakura.ne.jp
The key's randomart image is:
+--[ RSA 2048]----+
|   .  .+o        |
|. . . o...       |
|.. + . .+.       |
| .. * B+.+       |
|  .o * oS        |
|   .             |
|    .            |
|   E             |
|    .            |
+-----------------+
 </pre>


<p>公開鍵id_<a class="keyword" href="http://d.hatena.ne.jp/keyword/rsa">rsa</a>.pubをauthorized_keysという名称に変更して、<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D1%A1%BC%A5%DF%A5%C3%A5%B7%A5%E7%A5%F3">パーミッション</a>を600(所有者のみ読み書き可能)にします。</p>

<pre class="terminal"> $ cd ~/.ssh
$ mv id_rsa.pub authorized_keys
$ chmod 600 authorized_keys
 </pre>


<h4>sudo設定</h4>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/hoge">hoge</a>グループでsudo可能なように設定します。</p>

<pre class="terminal"> # vim /etc/sudoers.d/hoge
%hoge ALL=(ALL) ALL
 </pre>


<pre class="terminal"> # chmod 600 /etc/sudoers.d/hoge
 </pre>


<h4>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/ssh">ssh</a>の設定</h4>


<p>まずは<a class="keyword" href="http://d.hatena.ne.jp/keyword/ssh">ssh</a>の設定をします。</p>

<pre class="terminal"> # vim /etc/ssh/sshd_config
 :
### sshdのポートを22から別ポートへ変更します。
### 以下は10022にしてますがなんでも構いません。
Port 10022
 :
### sshプロトコルバージョン2のみ許可します。
Protocol 2
 :
### rootユーザでの外部からのログインを拒否します。
### デフォルトでは鍵認証でのログインのみ許可(without-password)されています。
PermitRootLogin no
:
### パスワード認証でのログインを拒否します。
PasswordAuthentication no
 :
### sshバージョン1でのRSA認証を拒否します。
RSAAuthentication no
 :
### SSH公開鍵認証を許可します。
PubkeyAuthentication yes
 </pre>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sshd">sshd</a>を再起動します。</p>

<pre class="terminal"> # service ssh restart
 </pre>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/%C8%EB%CC%A9%B8%B0">秘密鍵</a>を使って外部からログインできるか確認します。</p>

<h4>localeの設定</h4>


<p>デフォルトではシステムの言語設定が英語になっています。
これは<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B4%C4%B6%AD%CA%D1%BF%F4">環境変数</a>LANGUAGEがen_USになっているためです。</p>

<pre class="terminal"> # cat /etc/default/locale
LANG="en_US.UTF-8"
LANGUAGE="en_US:"
 </pre>


<p>このままですとユーザの<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B4%C4%B6%AD%CA%D1%BF%F4">環境変数</a>に ja_JP.<a class="keyword" href="http://d.hatena.ne.jp/keyword/UTF-8">UTF-8</a>を設定してもうまく日本語で表示されません。</p>

<p>ja_JP.<a class="keyword" href="http://d.hatena.ne.jp/keyword/UTF-8">UTF-8</a> 自体が<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a> 14.04 LTSでサポートされているかを確認します。</p>

<pre class="terminal"> # grep ja /usr/share/i18n/SUPPORTED
ja_JP.EUC-JP EUC-JP
ja_JP.UTF-8 UTF-8
 </pre>


<p>続いて現在の<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a>で利用可能な<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%ED%A5%B1%A1%BC%A5%EB">ロケール</a>を確認します。</p>

<pre class="terminal"> # locale -a
locale: Cannot set LC_CTYPE to default locale: No such file or directory
locale: Cannot set LC_MESSAGES to default locale: No such file or directory
locale: Cannot set LC_COLLATE to default locale: No such file or directory
C
C.UTF-8
POSIX
en_US.utf8
 </pre>


<p>ja_JP.<a class="keyword" href="http://d.hatena.ne.jp/keyword/UTF-8">UTF-8</a> は登録されていません。</p>

<p>そこで、システムで利用可能な<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%ED%A5%B1%A1%BC%A5%EB">ロケール</a>に新たな値を locale-gen コマンドを使って登録します。</p>

<pre class="terminal"> # locale-gen ja_JP.UTF-8
Generating locales...
  ja_JP.UTF-8... done
Generation complete.
 </pre>


<p>再度登録されている<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%ED%A5%B1%A1%BC%A5%EB">ロケール</a>を確認します。</p>

<pre class="terminal"> # locale -a
C
C.UTF-8
POSIX
en_US.utf8
ja_JP.utf8
 </pre>


<p>これでja_JP.<a class="keyword" href="http://d.hatena.ne.jp/keyword/UTF-8">UTF-8</a>が利用可能になりました。</p>

<p>最後に update-locale コマンドを使って、デフォルトの<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%ED%A5%B1%A1%BC%A5%EB">ロケール</a>設定をja_JP.<a class="keyword" href="http://d.hatena.ne.jp/keyword/UTF-8">UTF-8</a>に設定します。</p>

<pre class="terminal"> # update-locale LANG=ja_JP.UTF-8
*** update-locale: Warning: LANGUAGE ("en_US:") is not compatible with LANG (ja_JP.UTF-8). Disabling it.
 </pre>


<p>LANGUAGEが<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B3%A5%E1%A5%F3%A5%C8%A5%A2%A5%A6%A5%C8">コメントアウト</a>され、LANG<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B4%C4%B6%AD%CA%D1%BF%F4">環境変数</a>がja_JP.<a class="keyword" href="http://d.hatena.ne.jp/keyword/UTF-8">UTF-8</a>へと変更されました。</p>

<pre class="terminal"> # cat /etc/default/locale
LANG=ja_JP.UTF-8
#LANGUAGE="en_US:"
 </pre>


<h4>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/Postfix">Postfix</a>の設定</h4>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Postfix">Postfix</a>の設定を行います。
外部へメール送信可能なように設定します。</p>

<pre class="terminal"> # ホスト名の設定
myhostname = xxxxxxxx.sakura.ne.jp
 :
# メール送信時に利用するドメインの設定
mydomain = xxxxxxxx.sakura.ne.jp
 :
# 外部からのメール受信許可設定
inet_interfaces = all
 :
# 利用プロトコルをipv4に変更
inet_protocols = ipv4
 :
# 宛先の設定(自ホストが最終的な宛先になるようドメイン名を指定)
mydestination = $myhostname, localhost.$mydomain, localhost, $mydomain
 :
# 自ホストのアドレスのみSMTP接続を許可
mynetworks_style = host
  :
# mynetworks_styleに変わって以下でも良い
mynetworks = さくらのVPSのIPアドレス
 :
# リレーを許可するアドレスの指定
relay_domains = $mydestination
 :
# telnetなどで接続された時にメールソフトの情報を非表示
smtpd_banner = $myhostname ESMTP unknown
 </pre>


<p>設定できたら<a class="keyword" href="http://d.hatena.ne.jp/keyword/Postfix">Postfix</a>を再起動します。</p>

<pre class="terminal"> # service postfix restart
 </pre>


<h4>ntpの設定</h4>


<p>NTPの設定を行います。
既存の設定を全て削除して、下記のような設定を行います。</p>

<pre class="terminal"> # vim /etc/ntp.conf
restrict default ignore
restrict -6 default ignore
restrict -4 ntp1.sakura.ad.jp kod nomodify notrap nopeer noquery
restrict -6 ntp1.sakura.ad.jp kod nomodify notrap nopeer noquery
restrict 127.0.0.1
restrict -6 ::1
server -4 ntp1.sakura.ad.jp iburs
server -6 ntp1.sakura.ad.jp iburs
 </pre>


<p>リ<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BE%A5%EB">ゾル</a>バの設定</p>

<p>リージョンに合ったネームサーバを指定します。</p>

<pre class="terminal"> # vim /etc/resolv.conf
nameserver xxx.xxx.xxx.xxx
nameserver xxx.xxx.xxx.xxx
search sakura.ne.jp
 </pre>


<h4>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/iptables">iptables</a>の設定</h4>


<p>細かく設定する場合は<a class="keyword" href="http://d.hatena.ne.jp/keyword/iptables">iptables</a>コマンドで頑張る必要がありますが、ここでは<a class="keyword" href="http://d.hatena.ne.jp/keyword/ufw">ufw</a>を使います。
<a class="keyword" href="http://d.hatena.ne.jp/keyword/ufw">ufw</a>では外部から内部への<a class="keyword" href="http://d.hatena.ne.jp/keyword/%C4%CC%BF%AE%C0%A9">通信制</a>御ができます。
ひとまずここまでで必要な<a class="keyword" href="http://d.hatena.ne.jp/keyword/ssh">ssh</a>(10022), <a class="keyword" href="http://d.hatena.ne.jp/keyword/smtp">smtp</a>(25)くらいを開けておきます。</p>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/ufw">ufw</a>を起動します。</p>

<pre class="terminal"> # ufw enable
 </pre>


<p>まず外部からの全ての通信を拒否します。</p>

<pre class="terminal"> # ufw default DENY
 </pre>


<p>ログの記録を有効にします。</p>

<pre class="terminal"> # ufw logging on
 </pre>


<p>外部からの<a class="keyword" href="http://d.hatena.ne.jp/keyword/ssh">ssh</a>(10022)の通信を許可します。</p>

<pre class="terminal"> # ufw allow 10022
 </pre>


<p>外部からの<a class="keyword" href="http://d.hatena.ne.jp/keyword/smtp">smtp</a>のポート(25)への通信を許可します。</p>

<pre class="terminal"> # ufw allow 25
 </pre>


<p>設定を確認します。</p>

<pre class="terminal"> # ufw status
 </pre>


<h4>パッケージアップデート
<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EA%A5%DD%A5%B8%A5%C8%A5%EA">リポジトリ</a>のパッケージ・リストを更新します。
<pre class="terminal"> # apt update
 </pre>
インストールされてるパッケージを更新します。
<pre class="terminal"> # apt upgrade
 </pre>
OSを再起動します。
<pre class="terminal"> # reboot
 </pre>
</h4>


<h3>おわりに</h3>


<p>以上で、さくらの<a class="keyword" href="http://d.hatena.ne.jp/keyword/VPS">VPS</a>の<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a> 14.04 LTSの初期設定が完了です。</p>
</body>
