---
title: "Debian 11 を 12 にアップグレードしたら Neovim でエラーが出るようになった"
date: 2023-09-19
slug: "Debian 11 を 12 にアップグレードしたら Neovim でエラーが出るようになった"
category: blog
tags: [Debian,Neovim]
---
<h2 id="はじめに">はじめに</h2>

<p><a class="keyword" href="https://d.hatena.ne.jp/keyword/Debian">Debian</a> 12 にアップグレードして Neovim を起動したら以下のようなエラーが出るようになりました。</p>

<pre class="code terminal" data-lang="terminal" data-unlink>[deoplete] deoplete requires Python3 support(&#34;+python3&#34;).
VimEnter Autocommands for &#34;*&#34;..function deoplete#enable[9]..deoplete#initialize[1]..deoplete#init#_initialize[15]..deoplete#init#_channel[59]..VimEnter Autocommands for &#34;*&#34;..function deoplete#enable[9]..deoplete#initialize[1]..deoplete#init#_initialize[15]..deoplete#init#_channel[42]..deoplete#init#_python_version_check の処理中にエラーが検出されました:
行    8:
E319: No &#34;python3&#34; provider found. Run &#34;:checkhealth provider&#34;</pre>


<p>どうも <a class="keyword" href="https://d.hatena.ne.jp/keyword/Python">Python</a> の環境に問題がありそうです。</p>

<h2 id="解決手順">解決手順</h2>

<p><code>:checkhealth provider</code> を実行しろ、と言われているので実行してみたら以下のような出力がありました。</p>

<pre class="code terminal" data-lang="terminal" data-unlink>==============================================================================
provider: health#provider#check

Clipboard (optional) ~
- WARNING No clipboard tool found. Clipboard registers (`&#34;+` and `&#34;*`) will not work.
  - ADVICE:
    - :help |clipboard|

Python 3 provider (optional) ~
- WARNING No Python executable found that can `import neovim`. Using the first available executable for diagnostics.
- WARNING Could not load Python 3:
  /usr/bin/python3 does not have the &#34;neovim&#34; module.
  python3.10 not found in search path or not executable.
  python3.9 not found in search path or not executable.
  python3.8 not found in search path or not executable.
  python3.7 not found in search path or not executable.
  python not found in search path or not executable.
  - ADVICE:
    - See :help |provider-python| for more information.
    - You may disable this provider (and warning) by adding `let g:loaded_python3_provider = 0` to your init.vim
- Executable: Not found

Python virtualenv ~
- OK no $VIRTUAL_ENV

Ruby provider (optional) ~
- WARNING `ruby` and `gem` must be in $PATH.
  - ADVICE:
    - Install Ruby and verify that `ruby` and `gem` commands work.

Node.js provider (optional) ~
- Node.js: v18.14.0
- WARNING Missing &#34;neovim&#34; npm (or yarn, pnpm) package.
  - ADVICE:
    - Run in shell: npm install -g neovim
    - Run in shell (if you use yarn): yarn global add neovim
    - Run in shell (if you use pnpm): pnpm install -g neovim
    - You may disable this provider (and warning) by adding `let g:loaded_node_provider = 0` to your init.vim

Perl provider (optional) ~
- WARNING &#34;Neovim::Ext&#34; cpan module is not installed
  - ADVICE:
    - See :help |provider-perl| for more information.
    - You may disable this provider (and warning) by adding `let g:loaded_perl_provider = 0` to your init.vim</pre>


<p>いくつかの provider があるようですが、Python3 のところで <code>/usr/bin/python3 does not have the "neovim" module.</code> といったような出力ありました。</p>

<p>仮想環境を作成します。</p>

<pre class="code terminal" data-lang="terminal" data-unlink>% python3 -m venv ~/.local/venv</pre>


<p>仮想環境を有効化します。</p>

<pre class="code terminal" data-lang="terminal" data-unlink>% cd ~/.local/venv

% source bin/activate
(venv) %</pre>


<p>パスが通り、使えるようになりました。</p>

<pre class="code terminal" data-lang="terminal" data-unlink>(venv) % which python3
/home/dshimizu/.local/venv/bin/python3</pre>


<p><code>~/.config/nvim/init.vim</code> を開き、以下の設定を追加します。</p>

<pre class="code lang-vim" data-lang="vim" data-unlink><span class="synStatement">let</span> <span class="synIdentifier">g:python3_host_prog</span> <span class="synStatement">=</span> <span class="synConstant">'~/.local/venv/bin/python3'</span>
</pre>


<p>この状態で Neovim を起動すると以下のようなエラーが出ます。</p>

<pre class="code terminal" data-lang="terminal" data-unlink>[deoplete] deoplete failed to load. Try the :UpdateRemotePlugins command and restart Neovim. See also :checkhealth.</pre>


<p><code>:UpdateRemotePlugins</code>を実行すると以下のようなエラーが出ました。</p>

<pre class="code terminal" data-lang="terminal" data-unlink>function remote#host#UpdateRemotePlugins[6]..&lt;SNR&gt;103_RegistrationCommands[15]..remote#host#Require[10]..provider#pythonx#Require[12]..provider#Poll, 行 7
Vim(if):Error invoking &#39;poll&#39; on channel 7:^@ch 7 was closed by the client
function remote#host#UpdateRemotePlugins[6]..&lt;SNR&gt;103_RegistrationCommands[15]..remote#host#Require[10]..provider#pythonx#Require[12]..provider#Poll, 行 17
Failed to load python3 host. You can try to see what happened by starting nvim with $NVIM_PYTHON_LOG_FILE set and opening the generated log file. Also, the host stderr is available in messages.
remote/host: generated rplugin manifest: /home/dshimizu/.local/share/nvim/rplugin.vim</pre>


<p><code>:checkhealth</code> を実行すると以下のようなエラーが出ました。</p>

<pre class="code terminal" data-lang="terminal" data-unlink>==============================================================================
deoplete: health#deoplete#check

deoplete.nvim ~
- OK exists(&#34;v:t_list&#34;) was successful
- OK has(&#34;timers&#34;) was successful
- OK has(&#34;python3&#34;) was successful
- OK Require Python 3.6.1+ was successful
- OK Require msgpack 1.0.0+ was successful
- If you&#39;re still having problems, try the following commands:
  - $ export NVIM_PYTHON_LOG_FILE=/tmp/log
  - $ export NVIM_PYTHON_LOG_LEVEL=DEBUG
  - $ nvim
  - $ cat /tmp/log_{PID}
  - and then create an issue on github

==============================================================================
nvim: require(&#34;nvim.health&#34;).check()

Configuration ~
- OK no issues found

Runtime ~
- OK $VIMRUNTIME: /home/daisukeshimizu/.local/neovim/share/nvim/runtime

Performance ~
- OK Build type: Release

Remote Plugins ~
- OK Up to date

terminal ~
- key_backspace (kbs) terminfo entry: `key_backspace=\177`
- key_dc (kdch1) terminfo entry: `key_dc=\E[3~`
- $SSH_TTY=&#34;/dev/pts/0&#34;

==============================================================================
provider: health#provider#check

Clipboard (optional) ~
- WARNING No clipboard tool found. Clipboard registers (`&#34;+` and `&#34;*`) will not work.
  - ADVICE:
    - :help |clipboard|

Python 3 provider (optional) ~
- Using: g:python3_host_prog = &#34;~/.local/venv/bin/python3&#34;
- Executable: /home/dshimizu/.local/venv/bin/python3
- ERROR Command error (job=9, exit code 1): `&#39;/home/dshimizu/.local/venv/bin/python3&#39; -c &#39;import sys; sys.path = [p for p in sys.path if p != &#34;&#34;]; import neovim; print(neovim.__file__)&#39;` (in &#39;/home/dshimizu/.local/venv&#39;)
  stderr: Traceback (most recent call last):  File &#34;&lt;string&gt;&#34;, line 1, in &lt;module&gt;ModuleNotFoundError: No module named &#39;neovim&#39;
- Python version: 3.11.2
- pynvim version: unable to load neovim Python module
- ERROR pynvim is not installed.
  Error: unable to load neovim Python module
  - ADVICE:
    - Run in shell: /home/dshimizu/.local/venv/bin/python3 -m pip install pynvim

Python virtualenv ~
- $VIRTUAL_ENV is set to: /home/dshimizu/.local/venv
- Python version: 3.11.2
- OK $VIRTUAL_ENV provides :!python.

Ruby provider (optional) ~
- WARNING `ruby` and `gem` must be in $PATH.
  - ADVICE:
    - Install Ruby and verify that `ruby` and `gem` commands work.

Node.js provider (optional) ~
- Node.js: v18.14.0
- WARNING Missing &#34;neovim&#34; npm (or yarn, pnpm) package.
  - ADVICE:
    - Run in shell: npm install -g neovim
    - Run in shell (if you use yarn): yarn global add neovim
    - Run in shell (if you use pnpm): pnpm install -g neovim
    - You may disable this provider (and warning) by adding `let g:loaded_node_provider = 0` to your init.vim

Perl provider (optional) ~
- WARNING &#34;Neovim::Ext&#34; cpan module is not installed
  - ADVICE:
    - See :help |provider-perl| for more information.
    - You may disable this provider (and warning) by adding `let g:loaded_perl_provider = 0` to your init.vim

==============================================================================
vim.lsp: require(&#34;vim.lsp.health&#34;).check()

- LSP log level : WARN
- Log path: /home/dshimizu/.local/state/nvim/lsp.log
- Log size: 2620 KB

vim.lsp: Active Clients ~
- copilot (id=1, root_dir=nil)

==============================================================================
vim.treesitter: require(&#34;vim.treesitter.health&#34;).check()

- Nvim runtime ABI version: 14
- OK Parser: c          ABI: 13, path: /home/dshimizu/.local/neovim/lib/nvim/parser/c.so
- OK Parser: lua        ABI: 13, path: /home/dshimizu/.local/neovim/lib/nvim/parser/lua.so
- OK Parser: query      ABI: 14, path: /home/dshimizu/.local/neovim/lib/nvim/parser/query.so
- OK Parser: vim        ABI: 14, path: /home/dshimizu/.local/neovim/lib/nvim/parser/vim.so
- OK Parser: vimdoc     ABI: 14, path: /home/dshimizu/.local/neovim/lib/nvim/parser/vimdoc.so</pre>


<p><a class="keyword" href="https://d.hatena.ne.jp/keyword/Python">Python</a> の neovim モジュールが見つからない、といったような出力があるので、Python3 の venv 仮想環境が有効な状態で pip でパッケージをインストールします。</p>

<pre class="code terminal" data-lang="terminal" data-unlink>(venv) % python3 -m pip install pynvim</pre>


<p>この状態で再度 Neovim を起動して、<code>:UpdateRemotePlugins</code> を実行すると、エラーが出ることなく利用可能になりました。</p>

<p><code>$HOEM/.local/share/nvim/rplugin.vim</code> というファイルに Python3 <a class="keyword" href="https://d.hatena.ne.jp/keyword/%A5%D7%A5%E9%A5%B0%A5%A4%A5%F3">プラグイン</a>の情報が追記されていました。</p>

<pre class="code terminal" data-lang="terminal" data-unlink>% cat /home/dshimizu/.local/share/nvim/rplugin.vim
&#34; perl plugins


&#34; node plugins


&#34; python3 plugins
call remote#host#RegisterPlugin(&#39;python3&#39;, &#39;/home/dshimizu/.config/nvim/dein/.cache/init.vim/.dein/rplugin/python3/deoplete&#39;, [
      \ {&#39;sync&#39;: v:false, &#39;name&#39;: &#39;_deoplete_init&#39;, &#39;type&#39;: &#39;function&#39;, &#39;opts&#39;: {}},
     \ ])


&#34; ruby plugins


&#34; python plugins</pre>


<h2 id="まとめ">まとめ</h2>

<p><a class="keyword" href="https://d.hatena.ne.jp/keyword/Debian">Debian</a> 12 にアップグレードしたら Python3 が PEP 668 に則る形になり pip でのグローバルなインストールができなくなったことで Neovim <a class="keyword" href="https://d.hatena.ne.jp/keyword/%A5%D7%A5%E9%A5%B0%A5%A4%A5%F3">プラグイン</a>でエラーが出るようになっていました。それを修正する手順を記載しました。</p>

<h2 id="参考">参考</h2>

<ul>
<li><a href="https://blog.fakiyer.com/entry/2018/11/20/101826">deoplete.nvim&#x306E;&#x30A8;&#x30E9;&#x30FC;&#x89E3;&#x6D88; - &#x7D99;&#x7D9A;&#x7684;&#x30D6;&#x30ED;&#x30B0;</a></li>
</ul>


