---
layout: post
Categories:  ["tech"]
Description:  " Ubuntu 16.04 LTS で KVM 仮想マシンを Open vSwitch に接続して使用するための方法について、現時点でやったことや調べたことを記載しておく。 "
Tags: ["Network", "Open vSwitch", "tech", "Ubuntu"]
date: "2018-04-14T18:46:00+09:00"
title: "Ubuntu 16.04.4 LTS の KVM の仮想ネットワークで Open vSwitch を使用する"
author: "dshimizu"
archive: ["2018"]
draft: "true"
---

<body>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a> 16.04 LTS で <a class="keyword" href="http://d.hatena.ne.jp/keyword/KVM">KVM</a> <a class="keyword" href="http://d.hatena.ne.jp/keyword/%B2%BE%C1%DB%A5%DE%A5%B7%A5%F3">仮想マシン</a>を Open vSwitch に接続して使用するための方法について、現時点でやったことや調べたことを記載しておく。</p>
</body>

<!-- more -->

<body>
<h3>Open vSwitch on <a class="keyword" href="http://d.hatena.ne.jp/keyword/KVM">KVM</a>
</h3>


<p>普段<a class="keyword" href="http://d.hatena.ne.jp/keyword/KVM">KVM</a>では <a class="keyword" href="http://d.hatena.ne.jp/keyword/Linux">Linux</a> Kernel の macvlan 機能を使用した macvtap を使うことがパフォーマンス上良いということで使っているが(※実際に自分自身でパフォーマンス検証したわけではない)、Open vSwitchではvlanも使え、<a class="keyword" href="http://d.hatena.ne.jp/keyword/KVM">KVM</a>でより柔軟なネットワークが構成できるのではないかと思い試し始めた。</p>

<p>なお、macvlanは仮想的な<a class="keyword" href="http://d.hatena.ne.jp/keyword/MAC%A5%A2%A5%C9%A5%EC%A5%B9">MACアドレス</a>を持つ仮想的な<a class="keyword" href="http://d.hatena.ne.jp/keyword/NIC">NIC</a>を作成する機能で、macvtapはmacvlanで作成された仮想<a class="keyword" href="http://d.hatena.ne.jp/keyword/NIC">NIC</a>を物理<a class="keyword" href="http://d.hatena.ne.jp/keyword/NIC">NIC</a>に論理的に直接接続させて通信させることができるようにする機能…という程度の個人的な雑な認識。
この機能自体は上述の通り<a class="keyword" href="http://d.hatena.ne.jp/keyword/Linux">Linux</a> Kernelの機能であり、<a class="keyword" href="http://d.hatena.ne.jp/keyword/KVM">KVM</a>のものではない。</p>

<p><img src="./wp-content/uploads/macvtap_on_kvm.png" alt="" width="750" height="400" class="aligncenter size-full wp-image-930"></p>

<p>では、Open vSwitchを使って以下のようになるよう<a class="keyword" href="http://d.hatena.ne.jp/keyword/KVM">KVM</a>のネットワーク環境構築してみる。
まずはVLANなどは設定せず、ブリッジ(単なる中継点)として使えるように設定する。
<a class="keyword" href="http://d.hatena.ne.jp/keyword/KVM">KVM</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/%B2%BE%C1%DB%A5%DE%A5%B7%A5%F3">仮想マシン</a>に割り当てる<a class="keyword" href="http://d.hatena.ne.jp/keyword/IP%A5%A2%A5%C9%A5%EC%A5%B9">IPアドレス</a>は<a class="keyword" href="http://d.hatena.ne.jp/keyword/DHCP">DHCP</a>ではなく固定のIPとする。</p>

<p><img src="./wp-content/uploads/ovs_on_kvm.png" alt="" width="750" height="400" class="aligncenter size-full wp-image-939"></p>

<h3>Open vSwitch on <a class="keyword" href="http://d.hatena.ne.jp/keyword/KVM">KVM</a>環境構築</h3>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a> 16.04 LTS上で<a class="keyword" href="http://d.hatena.ne.jp/keyword/KVM">KVM</a>とOpen vSwitchの環境を構築する。</p>

<h5>利用OSバージョン</h5>


<ul>
    <li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a> 16.04.4 LTS</li>
    <li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AB%A1%BC%A5%CD%A5%EB">カーネル</a> 4.4.0-122-generic #146-<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a> SMP</li>
</ul>


<h5>利用パッケージバージョン</h5>


<ul>
    <li>openvswitch-switch 2.5.4-0ubuntu0.16.04.1</li>
    <li>openvswitch-common 2.5.4-0ubuntu0.16.04.1</li>
    <li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/qemu">qemu</a>-utils 1:2.5+dfsg-5ubuntu10.26</li>
    <li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/qemu">qemu</a>-system-common 1:2.5+dfsg-5ubuntu10.26</li>
    <li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/qemu">qemu</a>-system-<a class="keyword" href="http://d.hatena.ne.jp/keyword/x86">x86</a> 1:2.5+dfsg-5ubuntu10.26</li>
    <li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/qemu">qemu</a>-<a class="keyword" href="http://d.hatena.ne.jp/keyword/kvm">kvm</a> 1:2.5+dfsg-5ubuntu10.26</li>
    <li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/qemu">qemu</a>-block-extra:<a class="keyword" href="http://d.hatena.ne.jp/keyword/amd64">amd64</a> 1:2.5+dfsg-5ubuntu10.26</li>
</ul>


<h4>Open vSwitchのインストール</h4>


<p>続いてOpen vSwitchをインストールする。</p>

<pre class="terminal"> $ sudo apt install openvswitch-switch
 </pre>


<h4>Open vSwitchの設定</h4>


<p>Open vSwitchを起動してみる。</p>

<pre class="terminal"> $ sudo systemctl start openvswitch
 </pre>


<p><code>ovs-vsctl show</code>コマンドで設定の概要を確認できる。</p>

<pre class="terminal"> $ sudo ovs-vsctl show
********-****-****-****-************
    ovs_version: "2.3.1"
 </pre>


<p>ブリッジを作成する。
<code>ovs-vsctl</code>コマンドの<code>add-br</code>や<code>add-port</code>を使って作成することもできるが、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a>のネットワーク設定に任せてしまうこともできるので、ここでは<code>br-ex</code>という名称の仮想ブリッジを作成するよう<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a>のネットワーク設定を行う。</p>

<p><code>/etc/network/interfaces.d/br-ex</code>というファイルを作成し、以下のような内容を記述する。</p>

<pre class="terminal"> auto br-ex
iface br-ex inet static
    address 172.16.1.129
    netmask 255.255.255.0
    gateway 172.16.1.255
    dns-nameservers 8.8.8.8
    ovs_type OVSBridge
    ovs_port eth1
 </pre>


<p>仮想ブリッジインタフェースそのものに割り当てる<a class="keyword" href="http://d.hatena.ne.jp/keyword/IP%A5%A2%A5%C9%A5%EC%A5%B9">IPアドレス</a>はとりあえず何でも良い。
ブリッジさせるために<code>ovs_type</code>には<code>OVSBridge</code>を設定する。
<code>ovs_port</code>には<a class="keyword" href="http://d.hatena.ne.jp/keyword/KVM">KVM</a>ホストOSの物理インタフェースを割り当てる。今回は<code>eth1</code>とする。</p>

<p>仮想ブリッジに割り当てる物理インタフェース eth1 のネットワーク設定は、<code>/etc/network/interfaces.d/eth1</code>というファイルを作成し、以下のような内容を記述する。</p>

<pre class="terminal"> auto eth1
iface eth1 inet static
        address 0.0.0.0
        ovs_bridge br-ex
        ovs_type OVSPort
 </pre>


<p>物理インタフェースと仮想ブリッジインタフェースをアップする。</p>

<pre class="terminal"> $ sudo ifup eth1
 </pre>


<pre class="terminal"> $ sudo ifup br-ex
 </pre>


<p>この時点で以下のように仮想ブリッジに eth1 というインタフェースが割り当てられている。</p>

<pre class="terminal"> $ sudo ovs-vsctl show
********-****-****-****-************
    Bridge br-ex
        Port "eth1"
            Interface "eth1"
        Port br-ex
            Interface br-ex
                type: internal
    ovs_version: "2.5.4"
 </pre>


<h4>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/KVM">KVM</a>のインストール</h4>


<p>続いて<a class="keyword" href="http://d.hatena.ne.jp/keyword/KVM">KVM</a>環境を構築する。必要なパッケージをインストールする。</p>

<pre class="terminal"> $ sudo apt install qemu-kvm libvirt-bin libvirt0 python-libvirt virtinst
 </pre>


<p>とりあえずはこれだけでOK。</p>

<h4>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/KVM">KVM</a>のネットワーク周りの設定</h4>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/KVM">KVM</a>(<a class="keyword" href="http://d.hatena.ne.jp/keyword/libvirt">libvirt</a>)側で、上記で設定した仮想インタフェースを扱えるようにネットワークを定義する。
以下のような内容で、<code>/etc/libvirt/qemu/networks/ovs-br0.xml</code>というファイルを作成する。</p>

<p>[terminal]
<network>
<name>ovs-br0</name>
<uuid><strong><strong><strong><strong>-</strong></strong>-</strong></strong>-<strong><strong>-</strong></strong>********</uuid>
<forward mode="bridge">
<bridge name="br-ex">
<virtualport type="openvswitch">
</virtualport></bridge></forward></network>
[/terminal]</p>

<p>ファイル名や<a class="keyword" href="http://d.hatena.ne.jp/keyword/XML">XML</a>内の <name> 属性は何でも良い。<bridge name="">属性は<code>/etc/network/interfaces.d/br-ex</code>で設定したものと同様の名称を記載する。
uuidはuuidgenコマンドで生成するか、uuid属性そのものを記載しなくても設定を登録(define)したときに自動で記入される。</bridge></name></p>

<p>仮想ネットワークの設定を登録する。</p>

<pre class="terminal"> $ sudo virsh net-define /etc/libvirt/qemu/networks/ovs-br0.xml
 </pre>


<p>登録された仮想ネットワークを確認する。</p>

<pre class="terminal"> $ sudo virsh net-list --all
 Name                 State      Autostart     Persistent
----------------------------------------------------------
 default              active     yes           yes
 ovs-br0              inactive   no            yes
 </pre>


<p>登録したネットワークを起動する。</p>

<pre class="terminal"> $ sudo virsh net-start ovs-br0
Network ovs-br0 started
 </pre>


<p>登録した ovs-br0 が active になっていることを確認する。</p>

<pre class="terminal"> $ sudo virsh net-list --all
 Name                 State      Autostart     Persistent
----------------------------------------------------------
 default              active     yes           yes
 ovs-br0              active     no            yes
 </pre>


<h4>確認</h4>


<p>dev01,dev02 という<a class="keyword" href="http://d.hatena.ne.jp/keyword/KVM">KVM</a>の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B2%BE%C1%DB%A5%DE%A5%B7%A5%F3">仮想マシン</a>を作成し、双方で通信できることを確認する。</p>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/virt-install">virt-install</a> で network の指定に上記で作成したovs-br0を指定すればOpen vSwitchの仮想ブリッジを使用して<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B2%BE%C1%DB%A5%DE%A5%B7%A5%F3">仮想マシン</a>が起動する。
OSインストールに使うISOイメージとかは所定の場所にあらかじめ設置しておく。
2台の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B2%BE%C1%DB%A5%DE%A5%B7%A5%F3">仮想マシン</a>の<a class="keyword" href="http://d.hatena.ne.jp/keyword/IP%A5%A2%A5%C9%A5%EC%A5%B9">IPアドレス</a>は固定のもの(static)で設定する。ここでは192.168.10.1, 192.168.10.2 とする。</p>

<pre class="terminal"> $ sudo virt-install
 --connect qemu:///system
 -n dev01
 --ram 1024 
 --vcpus 1 
 --network network=ovs-br0
 --location '/var/lib/libvirt/iso/ubuntu-16.04.4-server-amd64.iso' 
 --graphics vnc,listen=0.0.0.0,port=15991
 --disk size=10,path=/var/lib/libvirt/images/dev01.img
 --extra-args='console=tty0 console=ttyS0,115200n8 serial'
 --debug
 </pre>


<pre class="terminal"> $ sudo virt-install
 --connect qemu:///system
 -n dev02
 --ram 1024 
 --vcpus 1 
 --network network=ovs-br0
 --location '/var/lib/libvirt/iso/ubuntu-16.04.4-server-amd64.iso' 
 --graphics vnc,listen=0.0.0.0,port=15992
 --disk size=10,path=/var/lib/libvirt/images/dev02.img
 --extra-args='console=tty0 console=ttyS0,115200n8 serial'
 --debug
 </pre>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/%B2%BE%C1%DB%A5%DE%A5%B7%A5%F3">仮想マシン</a>作成後、仮想ブリッジに vnet0, vnet1 というインタフェースが作成される。</p>

<pre class="terminal"> $ sudo ovs-vsctl show
********-****-****-****-************
    Bridge br-ex
        Port "eth1"
            Interface "eth1"
        Port br-ex
            Interface br-ex
                type: internal
        Port "vnet0"
            Interface "vnet0"
        Port "vnet1"
            Interface "vnet1"
    ovs_version: "2.5.4"
 </pre>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/KVM">KVM</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/%B2%BE%C1%DB%A5%DE%A5%B7%A5%F3">仮想マシン</a>定義ファイル上のネットワーク設定は以下のようになっている。</p>

<p>[terminal]
$ sudo virsh dumpxml dev01 | <a class="keyword" href="http://d.hatena.ne.jp/keyword/awk">awk</a> '/<interface interface="">/'
<interface type="network">
<mac address="**:**:**:**:**:**"><source network="ovs-br0"><model type="rtl8139">
</model></source></mac></interface></interface></p>

<address type="pci" domain="0x0000" bus="0x00" slot="0x03" function="0x0">[/terminal]

これでKVM仮想マシンは外部との通信が可能となる。
適当にPingでも打って応答があることを確認する。
<pre class="terminal"> $ ping 192.168.10.2
 </pre>
<h3>まとめ</h3>
Open vSwitchをインストールして仮想ブリッジを作成し、KVMから利用する方法について書いた。
最初は仮想ブリッジの概念やイメージがつかみづらく、KVMのネットワーク設定と合わせるととっつきづらいところではありましたが、ちゃんと調べているうちにだんだんわかってきた。
<h3>参考</h3>
</address>
<ul>
    <li><a href="https://access.redhat.com/documentation/ja-JP/Red_Hat_Enterprise_Linux_OpenStack_Platform/6/html/Administration_Guide/Networking-ExternalConnectivity.html" target="_brank" rel="noopener noreferrer">5.3. 物理ネットワークのブリッジ - Red Hat Customer Portal</a></li>
    <li><a href="https://access.redhat.com/documentation/ja-jp/red_hat_enterprise_linux/7/html-single/virtualization_deployment_and_administration_guide/index" target="_brank" rel="noopener noreferrer">仮想化の導入および管理ガイド - Red Hat Customer Portal</a></li>
    <li><a href="https://events.static.linuxfound.org/sites/events/files/slides/LinuxConJapan2014_makita_0.pdf" target="_brank" rel="noopener noreferrer">Virtual switching technologies and Linux bridge</a></li>
    <li><a href="https://www.nic.ad.jp/ja/materials/iw/2012/proceedings/d1/d1-Asama.pdf" target="_brank" rel="noopener noreferrer">極める！KVM</a></li>
    <li><a href="https://access.redhat.com/documentation/ja-jp/red_hat_enterprise_linux/7/html/virtualization_deployment_and_administration_guide/sect-managing_guest_virtual_machines_with_virsh-managing_virtual_networks" target="_brank" rel="noopener noreferrer">21.39. 仮想ネットワークの管理 - Red Hat Customer Portal</a></li>
    <li><a href="https://qiita.com/ryuta-ito/items/17ed3642d2264451ed07" target="_brank" rel="noopener noreferrer">Open vSwicthでVLAN構築 - Qiita</a></li>
    <li><a href="https://www.ainoniwa.net/pelican/2014/0524a.html" target="_brank" rel="noopener noreferrer">UbuntuでOpen vSwitchを使うときに/etc/network/interfacesが使える</a></li>
    <li><a href="http://komeiy.hatenablog.com/entry/2015/06/26/233746" target="_brank" rel="noopener noreferrer">OpenvSwitch関連コマンドのチートシート的な何か - ぽぽぽぽーんのネットワークとOSS</a></li>
    <li><a href="http://gihyo.jp/admin/serial/01/linux_containers/0006?page=2" target="_brank" rel="noopener noreferrer">第6回　Linuxカーネルのコンテナ機能［5］ ─ネットワーク：LXCで学ぶコンテナ入門 －軽量仮想化環境を実現する技術｜gihyo.jp … 技術評論社</a></li>
    <li><a href="https://qiita.com/Kaz_K/items/d9d50ac70c02a09c498f" target="_brank" rel="noopener noreferrer">openvswitchのvxlanで、KVM(libvirt)ホストの仮想ネットワークを接続する - Qiita</a></li>
</ul>


</body>
