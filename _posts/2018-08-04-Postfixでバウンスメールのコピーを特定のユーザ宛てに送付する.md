---
layout: post
Categories:  ["tech"]
Description:  " Postfixでバウンスメールのコピーをエラーとして指定したユーザ(デフォルトはPostmaster)へ送付したいときの設定メモ。 "
Tags: ["Postfix", "tech"]
date: "2018-08-04T21:04:00+09:00"
title: "Postfixでバウンスメールのコピーを特定のユーザ宛てに送付する"
author: "dshimizu"
archive: ["2018"]
draft: "true"
---

<body>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Postfix">Postfix</a>でバウンスメールのコピーをエラーとして指定したユーザ(デフォルトはPostmaster)へ送付したいときの設定メモ。</p>
</body>

<!-- more -->

<body>
<h3>バウンスメールとは</h3>


<p>バウンスメールとは<a class="keyword" href="http://d.hatena.ne.jp/keyword/wikipedia">wikipedia</a>によると以下のものを指す。</p>

<ul>
    <li><a target="_brank" rel="noopener noreferrer" href="https://ja.wikipedia.org/wiki/%E3%83%90%E3%82%A6%E3%83%B3%E3%82%B9%E3%83%A1%E3%83%BC%E3%83%AB">バウンスメール - Wikipedia</a></li>
</ul>
<pre class="doc"> バウンスメール (bounce message) とは、電子メールの仕組みにおいて、送信したメールメッセージが何等かの理由で目的の送信先に正常に配信されなかった場合に、メールサーバからその旨を送信元に通知されるメールメッセージのこと。
 </pre>



<p>メールアカウントのユーザ設定をきちんと行っていれば、送信したメールが何らかの形でエラーになった場合のバウンスメールは、送信したメールアカウント宛てに返されるので何もしなくても特に問題ない...はず。</p>

<p>しかしそれ以外のユーザ宛てのメッセージや、不正に発生したエラーを一通り取っておきたいとかのケースもあるのでそんなときのためにどこをいじれば良いかのメモ。</p>

<h3>環境</h3>


<p>試した環境は以下のもの。</p>

<ul>
    <li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/Postfix">Postfix</a> 2.6.6 と 3.3.0</li>
</ul>


<h3>設定内容</h3>


<p><code>main.cf</code>に以下をパラメータを設定する。
<code>notify_classes</code>は postmaster@ 宛に報告されるエラーのリスト。以下の設定はエラー系のものをすべて通知するようにしているが、バウンスのみ受信したい場合は <code>bounce</code> を追記するだけで良い。
ただし、外部に公開されていてリレーを禁止しているようなメールサーバでこのあたりの設定をすると、スパム等の不正な<a class="keyword" href="http://d.hatena.ne.jp/keyword/SMTP">SMTP</a>接続がdouble <a class="keyword" href="http://d.hatena.ne.jp/keyword/bounce">bounce</a>となって、半端ない数のメールを受信することになる可能性があるので要注意。特にprotocolの指定があると中途半端に接続されてすぐ切られたときにもメールが来て結構ツライ。</p>

<pre class="terminal"> notify_classes = bounce, delay, policy, protocol, resource, software
 </pre>


<p>この状態で、相手にメールが送れなかった場合にその内容が postmaster 宛てに通知される。
バウンスの通知先を postmaster@ から変えたい場合は<a class="keyword" href="http://d.hatena.ne.jp/keyword/bounce">bounce</a>_notice_recipientや2bounce_notice_recipientのパラメータを変更する(デフォルトがpostmaster )。</p>

<ul>
    <li><a target="_brank" rel="noopener noreferrer" href="http://www.postfix.org/postconf.5.html">Postfix Configuration Parameters</a></li>
</ul>
<pre class="doc"> 2bounce_notice_recipient (default: postmaster)
    The recipient of undeliverable mail that cannot be returned to the sender. This feature is enabled with the notify_classes parameter.

bounce_notice_recipient (default: postmaster)
    The recipient of postmaster notifications with the message headers of mail that Postfix did not deliver and of SMTP conversation transcripts of mail that Postfix did not receive. This feature is enabled with the notify_classes parameter.
 </pre>
また、バウンス関連のその他の設定項目としては下記がある。
<pre class="doc"> bounce_queue_lifetime (default: 5d)
    Consider a bounce message as undeliverable, when delivery fails with a temporary error, and the time in the queue has reached the bounce_queue_lifetime limit. By default, this limit is the same as for regular mail.
    Time units: s (seconds), m (minutes), h (hours), d (days), w (weeks). The default time unit is d (days).
    Specify 0 when mail delivery should be tried only once.
    This feature is available in Postfix 2.1 and later.

bounce_service_name (default: bounce)
    The name of the bounce(8) service. This service maintains a record of failed delivery attempts and generates non-delivery notifications.
    This feature is available in Postfix 2.0 and later.

bounce_size_limit (default: 50000)
    The maximal amount of original message text that is sent in a non-delivery notification. Specify a byte count. A message is returned as either message/rfc822 (the complete original) or as text/rfc822-headers (the headers only). With Postfix version 2.4 and earlier, a message is always returned as message/rfc822 and is truncated when it exceeds the size limit.

    Notes:
        If you increase this limit, then you should increase the mime_nesting_limit value proportionally.
        Be careful when making changes. Excessively large values will result in the loss of non-delivery notifications, when a bounce message size exceeds a local or remote MTA's message size limit.
 </pre>



<p>設定したら <a class="keyword" href="http://d.hatena.ne.jp/keyword/postfix">postfix</a> の reload を忘れずに。</p>

<pre class="terminal"> $ sudo systemctl reload postfix
 </pre>


<h3>まとめ</h3>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Postfix">Postfix</a>でバウンスメール、およびその他エラーメールの通知・受信の設定方法について書いた。
とりあえず何かあったときのためにエラー系のメールを受信して残しておきたいならpostmaster 宛てメールを保存できるようにしておけばよい。</p>

<h3>参考</h3>


<ul>
    <li><a target="_brank" rel="noopener noreferrer" href="http://www.postfix.org/postconf.5.html#notify_classes">Postfix Configuration Parameters</a></li>
    <li><a target="_brank" rel="noopener noreferrer" href="https://hacknote.jp/archives/26899/">[Postfix] バウンスメールのコピーを残す | ハックノート</a></li>
    <li><a target="_brank" rel="noopener noreferrer" href="https://ja.stackoverflow.com/questions/2242/postfix%E3%81%A7%E3%83%A1%E3%83%BC%E3%83%AB%E9%80%81%E4%BF%A1%E3%81%8C%E5%A4%B1%E6%95%97%E3%81%97%E3%81%9F%E6%99%82%E3%81%AB%E3%83%AA%E3%83%88%E3%83%A9%E3%82%A4%E3%81%9B%E3%81%9A%E3%81%AB%E3%82%A8%E3%83%A9%E3%83%BC%E3%83%A1%E3%83%BC%E3%83%AB%E3%82%92%E9%80%81%E4%BF%A1%E8%80%85%E3%81%AB%E8%BF%94%E3%81%99%E3%81%AB%E3%81%AF%E3%81%A9%E3%81%86%E3%81%97%E3%81%9F%E3%82%89%E3%81%84%E3%81%84%E3%81%A7%E3%81%99%E3%81%8B">linux - Postfixでメール送信が失敗した時にリトライせずにエラーメールを送信者に返すにはどうしたらいいですか？ - スタック・オーバーフロー</a></li>
    <li><a target="_brank" rel="noopener noreferrer" href="http://www.postfix-jp.info/ML/arc-2.4/msg00929.html">[postfix-jp: 3931] Re:  【ご質問】　postfix のバウンス設定につきまして</a></li>
    <li><a target="_brank" rel="noopener noreferrer" href="https://www.slideshare.net/yaasita/ss-30560641">メールサーバをちゃんとする</a></li>
    <li><a target="_brank" rel="noopener noreferrer" href="http://ascii.jp/elem/000/000/778/778651/index-3.html">ASCII.jp：多段攻撃！　でも右往左往しない、メール関連のIT用語 (3/4)｜なれる！ＳＥ 間違いだらけの？ＩＴ用語辞典（中二版）</a></li>
    <li><a target="_brank" rel="noopener noreferrer" href="https://sendgrid.kke.co.jp/blog/?p=1338">バウンスメールとその対策 | SendGridブログ</a></li>
</ul>

</body>
