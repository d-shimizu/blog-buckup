---
layout: post
Categories:  ["tech"]
Description:  " 元ネタは、結構前に流れてきたこちらのツイート。   1/ Hey all! If you were watching #containersfromthecouch earlier today, I mentioned an aws cl"
Tags: ["AWS", "tech"]
date: "2020-10-18T22:18:00+09:00"
title: "IAM ユーザー・グループ・ロール・ポリシーからどの AWS リソースへアクセスしているのか確認する時のコマンドメモ"
author: "dshimizu"
archive: ["2020"]
draft: "true"
---

<body>
<p>元ネタは、結構前に流れてきたこちらのツイート。</p>

<blockquote class="twitter-tweet">
<p lang="en" dir="ltr">1/ Hey all! If you were watching <a href="https://twitter.com/hashtag/containersfromthecouch?src=hash&amp;ref_src=twsrc%5Etfw">#containersfromthecouch</a> earlier today, I mentioned an <a class="keyword" href="http://d.hatena.ne.jp/keyword/aws">aws</a> <a class="keyword" href="http://d.hatena.ne.jp/keyword/cli">cli</a> command that you can run to get insight into what <a href="https://twitter.com/hashtag/AWS?src=hash&amp;ref_src=twsrc%5Etfw">#AWS</a> resources were accessed from a particular IAM role/user/group/policy.</p>— Adam Keller (@realadamjkeller) <a href="https://twitter.com/realadamjkeller/status/1298013673634402305?ref_src=twsrc%5Etfw">August 24, 2020</a>
</blockquote>


<p> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></p>

<p>参考にしていたけどたまにしかやらずに忘れるのでメモとして残しておく。</p>
</body>

<!-- more -->

<body>
<h3 id="やり方">やり方</h3>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/AWS">AWS</a> IAM の<code>GetServiceLastAccessedDetail</code> <a class="keyword" href="http://d.hatena.ne.jp/keyword/API">API</a> を使う。</p>

<ul>
  <li><a target="_brank" rel="noopener norefere" href="https://docs.aws.amazon.com/cli/latest/reference/iam/generate-service-last-accessed-details.html">generate-service-last-accessed-details — AWS CLI 1.19.5 Command Reference</a></li>
</ul>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/AWS">AWS</a> <a class="keyword" href="http://d.hatena.ne.jp/keyword/CLI">CLI</a> だと、まず、以下のような感じで引数に確認したい IAM の ARN を指定して実行する。以下では Role としている。</p>

<pre class="terminal"> $ aws iam generate-service-last-accessed-details --arn arn:aws:iam::123456789012:role/foo
 </pre>


<p><code>Job id</code>が返ってくるので、この値を利用して再度 <code>GetServiceLastAccessedDetail</code> を実行する。今度は<code>Job id</code>を引数にして実行する。</p>

<pre class="terminal"> $ aws iam get-service-last-accessed-details --job-id ********-xxxx-****-xxxx-************
 </pre>


<p>これで対象 IAM が過去にアクセスした <a class="keyword" href="http://d.hatena.ne.jp/keyword/AWS">AWS</a> リソースの履歴一覧が表示される。</p>

<p>元ツイートだと<code>jq</code>コマンドを使っていい感じに表示する方法も紹介されてた。</p>

<pre class="terminal"> $ aws iam get-service-last-accessed-details --job-id ********-xxxx-****-xxxx-************ | jq '.ServicesLastAccessed[] | select( .TotalAuthenticatedEntities &gt; 0) | .ServiceName'
 </pre>




<blockquote class="twitter-tweet">
<p lang="en" dir="ltr">4/ Next, I will use that job id to gather the details for review. Notice that I added some jq goodness in there to parse the results to only return the services that my user has made calls to. Also, one will likely have to use pagination here to get all of the data. <a href="https://t.co/zEmSmnoY4k">pic.twitter.com/zEmSmnoY4k</a></p>— Adam Keller (@realadamjkeller) <a href="https://twitter.com/realadamjkeller/status/1298013676318756864?ref_src=twsrc%5Etfw">August 24, 2020</a>
</blockquote>


<p> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></p>

<p>なんか<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EF%A5%F3%A5%E9%A5%A4%A5%CA%A1%BC">ワンライナー</a>とかで良い感じにしたいけど何も考えていない。</p>

<p></p>
<h3>参考&gt;

</h3>
<p></p>
<ul>
  <li><a target="_brank" rel="noopener norefere" href="https://docs.aws.amazon.com/cli/latest/reference/iam/generate-service-last-accessed-details.html">generate-service-last-accessed-details — AWS CLI 1.18.1 Command Reference</a></li>
</ul>
</body>
