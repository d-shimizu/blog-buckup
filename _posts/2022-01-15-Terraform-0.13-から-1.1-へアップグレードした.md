---
title: "Terraform 0.13 から 1.1 へアップグレードした"
date: 2022-01-15
slug: "Terraform 0.13 から 1.1 へアップグレードした"
category: blog
tags: [Terraform]
---
<h2>はじめに</h2>

<p>個人プロジェクトだけども、いまだに Terraform 0.13 系を使っていたけどもう 1.1 まで出ているのでアップグレードしようと思ってやってみた。
0.13 から 1.1 へは直接アップグレードできず、段階的にアップグレードする必要があったのでその辺りの手順を一応まとめておく。</p>

<ul>
<li><a href="https://www.terraform.io/language/upgrade-guides">Upgrade Guides | Terraform by HashiCorp</a></li>
</ul>


<p>tfevn は使っておらず、docker イメージを使っているので、各バージョンの terraform のイメージを取得して実行している。
0.13 -> 0.14.11 の時だけちょっとハマったが、大したことやっていなかったのもあるけど普通にアップグレードできた。</p>

<h2>バージョンアップ</h2>

<h3>0.13 -> 0.14.11</h3>

<p>0.13 から 0.14.11 へアップグレードしようとすると以下のエラーが出る。</p>

<pre class="code shell" data-lang="shell" data-unlink>%  docker run -it --rm -v $PWD:/work -w /work -e AWS_ACCESS_KEY_ID=`aws --profile default configure get aws_access_key_id` -e AWS_SECRET_ACCESS_KEY=`aws --profile default configure get aws_secret_access_key` hashicorp/terraform:0.14.11 init -upgrade
    :
Error: Invalid legacy provider address

This configuration or its associated state refers to the unqualified provider
&#34;aws&#34;.

You must complete the Terraform 0.13 upgrade process before upgrading to later
versions.
</pre>


<p>provider の指定の仕方(?)が変わっているようなので、<code>state replace-provider</code> で置き換える。</p>

<pre class="code shell" data-lang="shell" data-unlink>%  docker run -it --rm -v $PWD:/work -w /work -e AWS_ACCESS_KEY_ID=`aws --profile default configure get aws_access_key_id` -e AWS_SECRET_ACCESS_KEY=`aws --profile default configure get aws_secret_access_key` hashicorp/terraform:0.14.11 state replace-provider &#34;registry.terraform.io/-/aws&#34; &#34;hashicorp/aws&#34;
Terraform will perform the following actions:

  ~ Updating provider:
    - registry.terraform.io/-/aws
    + registry.terraform.io/hashicorp/aws

Changing XX resources:

  data.aws_caller_identity.current
  aws_iam_access_key.xxxx
  aws_iam_policy.xxxx
  aws_iam_user.xxxx
  aws_iam_user_login_profile.xxxx
  aws_iam_group.xxxx
  aws_iam_group_membership.xxxx
  aws_iam_group_policy_attachment.xxxx
  data.aws_iam_policy_document.xxxx
    :

Do you want to make these changes?
Only &#39;yes&#39; will be accepted to continue.

Enter a value: yes

Successfully replaced provider for X resources.</pre>


<p>再度アップグレードを試す。</p>

<pre class="code shell" data-lang="shell" data-unlink>% docker run -it --rm -v $PWD:/work -w /work -e AWS_ACCESS_KEY_ID=`aws --profile default configure get aws_access_key_id` -e AWS_SECRET_ACCESS_KEY=`aws --profile default configure get aws_secret_access_key` hashicorp/terraform:0.14.11 init -upgrade

Initializing the backend...

Initializing provider plugins...
- Finding latest version of hashicorp/aws...
- Using previously-installed hashicorp/aws v4.9.0


Terraform has been successfully initialized!

You may now begin working with Terraform. Try running &#34;terraform plan&#34; to see
any changes that are required for your infrastructure. All Terraform commands
should now work.

If you ever set or change modules or backend configuration for Terraform,
rerun this command to reinitialize your working directory. If you forget, other
commands will detect it and remind you to do so if necessary.</pre>


<p>いけた。
差分を確認し、必要に応じて修正する。</p>

<pre class="code shell" data-lang="shell" data-unlink>% docker run -it --rm -v $PWD:/work -w /work -e AWS_ACCESS_KEY_ID=`aws --profile default configure get aws_access_key_id` -e AWS_SECRET_ACCESS_KEY=`aws --profile default configure get aws_secret_access_key` hashicorp/terraform:0.14.11 plan -var-file=terraform.tfvars</pre>


<h3>0.14.11 -> 0.15.5</h3>

<p>0.15.5 の Terraform でアップグレードを行う。</p>

<pre class="code shell" data-lang="shell" data-unlink>% docker run -it --rm -v $PWD:/work -w /work -e AWS_ACCESS_KEY_ID=`aws --profile default configure get aws_access_key_id` -e AWS_SECRET_ACCESS_KEY=`aws --profile default configure get aws_secret_access_key` hashicorp/terraform:0.15.5 init -upgrade

Initializing the backend...

Initializing provider plugins...
- Finding latest version of hashicorp/aws...
- Using previously-installed hashicorp/aws v4.9.0

Terraform has been successfully initialized!

You may now begin working with Terraform. Try running &#34;terraform plan&#34; to see
any changes that are required for your infrastructure. All Terraform commands
should now work.

If you ever set or change modules or backend configuration for Terraform,
rerun this command to reinitialize your working directory. If you forget, other
commands will detect it and remind you to do so if necessary.</pre>


<p>差分を確認し、必要に応じて修正する。</p>

<pre class="code shell" data-lang="shell" data-unlink>% docker run -it --rm -v $PWD:/work -w /work -e AWS_ACCESS_KEY_ID=`aws --profile default configure get aws_access_key_id` -e AWS_SECRET_ACCESS_KEY=`aws --profile default configure get aws_secret_access_key` hashicorp/terraform:1.0.11  plan -var-file=terraform.tfvars</pre>


<h3>0.15.5 -> 1.0.11</h3>

<p>1.0.11 の Terraform でアップグレードを行う。</p>

<pre class="code shell" data-lang="shell" data-unlink>% docker run -it --rm -v $PWD:/work -w /work -e AWS_ACCESS_KEY_ID=`aws --profile default configure get aws_access_key_id` -e AWS_SECRET_ACCESS_KEY=`aws --profile default configure get aws_secret_access_key` hashicorp/terraform:1.0.11 init --upgrade

Initializing the backend...

Initializing provider plugins...
- Finding latest version of hashicorp/aws...
- Using previously-installed hashicorp/aws v4.9.0

Terraform has been successfully initialized!

You may now begin working with Terraform. Try running &#34;terraform plan&#34; to see
any changes that are required for your infrastructure. All Terraform commands
should now work.

If you ever set or change modules or backend configuration for Terraform,
rerun this command to reinitialize your working directory. If you forget, other
commands will detect it and remind you to do so if necessary.</pre>


<p>差分を確認し、必要に応じて修正する。</p>

<pre class="code shell" data-lang="shell" data-unlink>% docker run -it --rm -v $PWD:/work -w /work -e AWS_ACCESS_KEY_ID=`aws --profile default configure get aws_access_key_id` -e AWS_SECRET_ACCESS_KEY=`aws --profile default configure get aws_secret_access_key` hashicorp/terraform:1.0.11  plan -var-file=terraform.tfvars</pre>


<h3>1.0.11 -> 1.1.3</h3>

<p>1.1.3 の Terraform でアップグレードを行う。</p>

<pre class="code shell" data-lang="shell" data-unlink>% docker run -it --rm -v $PWD:/work -w /work -e AWS_ACCESS_KEY_ID=`aws --profile default configure get aws_access_key_id` -e AWS_SECRET_ACCESS_KEY=`aws --profile default configure get aws_secret_access_key` hashicorp/terraform:1.1.3 init --upgrade
Initializing the backend...

Initializing provider plugins...
- Finding latest version of hashicorp/aws...
- Using previously-installed hashicorp/aws v4.9.0

Terraform has been successfully initialized!

You may now begin working with Terraform. Try running &#34;terraform plan&#34; to see
any changes that are required for your infrastructure. All Terraform commands
should now work.

If you ever set or change modules or backend configuration for Terraform,
rerun this command to reinitialize your working directory. If you forget, other
commands will detect it and remind you to do so if necessary.</pre>


<p>差分を確認し、必要に応じて修正する。</p>

<pre class="code shell" data-lang="shell" data-unlink>% docker run -it --rm -v $PWD:/work -w /work -e AWS_ACCESS_KEY_ID=`aws --profile default configure get aws_access_key_id` -e AWS_SECRET_ACCESS_KEY=`aws --profile default configure get aws_secret_access_key` hashicorp/terraform:1.1.3 plan -var-file=terraform.tfvars</pre>


<h2>まとめ</h2>

<p>個人プロジェクトで Terraform 0.13 系を使っていたけど 1.1 が出ているのでアップグレードした際の内容をメモがてら記載した。
大したことをやっていないので、ほぼ差分も出ずバージョンアップできた。実際には複数の環境があったりいろんな定義があったりするので、こんなに一気にはいけないだろうな...と思った。</p>

<h2>参考</h2>

<ul>
<li><a href="https://www.terraform.io/language/upgrade-guides">Upgrade Guides | Terraform by HashiCorp</a></li>
<li><a href="https://www.terraform.io/cli/commands/state/replace-provider">Command: state replace-provider | Terraform by HashiCorp</a></li>
<li><a href="https://discuss.hashicorp.com/t/unqualified-provider-aws/18554">Unqualified provider &quot;aws&quot; - Terraform - HashiCorp Discuss</a></li>
<li><a href="https://qiita.com/yuta_vamdemic/items/0b92a4fbbecea378ae68#v013701411">terraform&#x30D0;&#x30FC;&#x30B8;&#x30E7;&#x30F3;&#x3092;0.12.29&rarr;0.15.3&#x3078;&#x30A2;&#x30C3;&#x30D7;&#x30B0;&#x30EC;&#x30FC;&#x30C9;&#x3059;&#x308B;&#x65B9;&#x6CD5; - Qiita</a></li>
</ul>


