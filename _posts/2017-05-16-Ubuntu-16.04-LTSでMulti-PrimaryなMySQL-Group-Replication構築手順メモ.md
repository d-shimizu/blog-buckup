---
layout: post
Categories:  ["tech"]
Description:  " MySQLのレプリケーションは、あるMySQLデータベースから、別のMySQLデータベースへデータや操作(DDL)を反映して複製を作成します。  従来のレプリケーションはプライマリ・セカンダリの構成となり、特定の1つのMySQLデータベー"
Tags: ["MySQL", "tech", "Ubuntu"]
date: "2017-05-16T00:51:00+09:00"
title: "Ubuntu 16.04 LTSでMulti-PrimaryなMySQL Group Replication構築手順メモ"
author: "dshimizu"
archive: ["2017"]
draft: "true"
---

<body>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EC%A5%D7%A5%EA%A5%B1%A1%BC%A5%B7%A5%E7%A5%F3">レプリケーション</a>は、ある<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>データベースから、別の<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>データベースへデータや操作(<a class="keyword" href="http://d.hatena.ne.jp/keyword/DDL">DDL</a>)を反映して複製を作成します。</p>

<p>従来の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EC%A5%D7%A5%EA%A5%B1%A1%BC%A5%B7%A5%E7%A5%F3">レプリケーション</a>はプライマリ・<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BB%A5%AB%A5%F3%A5%C0%A5%EA">セカンダリ</a>の構成となり、特定の1つの<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>データベースサーバ(マスター)のデータを、1つまたは複数の<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>データベースサーバー(スレーブ)に複製することでした。データは非同期、または準同期でマスターからスレーブへコピーされます。通常、マスターとなるデータベースサーバは読み取り書き込み操作を行うことができ、スレーブとなるデータベースサーバは読み取りのみで通常はデータ書き込みを実行できませんでした。マスターは1つのみとなるため、マスターの<a class="keyword" href="http://d.hatena.ne.jp/keyword/%BE%E9%C4%B9%B2%BD">冗長化</a>を行う場合には<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AF%A5%E9%A5%B9%A5%BF%A5%EA%A5%F3%A5%B0">クラスタリング</a>ソフトウェアを使うなどのアプローチが必要でした。</p>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a> 5.7.17 で取り入れられた Group Replication は、より柔軟で可用性の高い<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EC%A5%D7%A5%EA%A5%B1%A1%BC%A5%B7%A5%E7%A5%F3">レプリケーション</a>構成するための<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D7%A5%E9%A5%B0%A5%A4%A5%F3">プラグイン</a>で、Group ReplicationはMySQL5.7.12で取り入れられた「Rapid<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D7%A5%E9%A5%B0%A5%A4%A5%F3">プラグイン</a>(新機能を<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D7%A5%E9%A5%B0%A5%A4%A5%F3">プラグイン</a>として提供するMySQL5.7.12からの仕組み)」として提供されているようです。
マスターデータベースの<a class="keyword" href="http://d.hatena.ne.jp/keyword/%BE%E9%C4%B9%B2%BD">冗長化</a>を目的とした機能で、マルチマスターの<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EC%A5%D7%A5%EA%A5%B1%A1%BC%A5%B7%A5%E7%A5%F3">レプリケーション</a>構成を行うための仕組みが<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>の機能として実装されています。</p>

<p>グループ内で実行された<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C8%A5%E9%A5%F3%A5%B6%A5%AF%A5%B7%A5%E7%A5%F3">トランザクション</a>を識別するためにGTIDを用いており、さらにXCOMと呼ばれる、<a href="https://ja.wikipedia.org/wiki/Paxos%E3%82%A2%E3%83%AB%E3%82%B4%E3%83%AA%E3%82%BA%E3%83%A0" target="blank" rel="noopener noreferrer">Paxos</a>という合意<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A2%A5%EB%A5%B4%A5%EA%A5%BA%A5%E0">アルゴリズム</a>をベースとした仕組みを用いて、グループ内のメンバーへの<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C8%A5%E9%A5%F3%A5%B6%A5%AF%A5%B7%A5%E7%A5%F3">トランザクション</a>のブロードキャストやメンバー間の認証の管理が行われているようです。</p>

<p>以下ではマルチマスタなGroupReplicationを構成するための基本的な手順を記載します。</p>
</body>

<!-- more -->

<body>
<h3>構築手順</h3>


<h4>環境</h4>


<table>
<tbody>
<tr>
<th>OS</th>
<td>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a> 16.04 LTS</td>
</tr>
<tr>
<th><a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a></th>
<td>5.7.18 (<a class="keyword" href="http://d.hatena.ne.jp/keyword/Oracle">Oracle</a>社オフィシャルパッケージ)</td>
</tr>
</tbody>
</table>


<h4>構成</h4>


<p>1つのホストOS内に、複数の<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>プロセスを異なるポート/データ<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リで起動して、それらでGroup Replicationを構成します。</p>

<table>
<tbody>
<tr>
<th><a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a></th>
<th>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>ポート</th>
<th>グループ<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EC%A5%D7%A5%EA%A5%B1%A1%BC%A5%B7%A5%E7%A5%F3">レプリケーション</a>用ポート</th>
<th>データ<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リ</th>
</tr>
<tr>
<td>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>#01</td>
<td>24801</td>
<td>24901</td>
<td>/var/lib/<a class="keyword" href="http://d.hatena.ne.jp/keyword/mysql">mysql</a>-01/</td>
</tr>
<tr>
<td>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>#02</td>
<td>24802</td>
<td>24902</td>
<td>/var/lib/<a class="keyword" href="http://d.hatena.ne.jp/keyword/mysql">mysql</a>-02/</td>
</tr>
<tr>
<td>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>#03</td>
<td>24803</td>
<td>24903</td>
<td>/var/lib/<a class="keyword" href="http://d.hatena.ne.jp/keyword/mysql">mysql</a>-03/</td>
</tr>
</tbody>
</table>


<p>図で表すと以下のようになります。</p>

<div align="center">
<img src="http://blog.dshimizu.jp/wp-content/uploads/2017/05/MGR.png" alt="" width="518" height="400" class="alignnone size-full wp-image-445">
</div>


<h4>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>のインストール</h4>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a>公式<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EA%A5%DD%A5%B8%A5%C8%A5%EA">リポジトリ</a>の<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>パッケージではGroup Replicationが使えませんでしたので、<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>公式ソフトウェア<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EA%A5%DD%A5%B8%A5%C8%A5%EA">リポジトリ</a>から<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a> <a class="keyword" href="http://d.hatena.ne.jp/keyword/Community%20Server">Community Server</a> / Client の最新版を取得してインストールします。</p>

<p>以下から、<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>公式APT<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EA%A5%DD%A5%B8%A5%C8%A5%EA">リポジトリ</a>設定用のパッケージを取得してそこからインストールするか、直接<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>サーバ/クライアントパッケージを取得してインストールします。</p>

<ul>
    <li><a href="https://dev.mysql.com/downloads/repo/apt/" target="_blank" rel="noopener noreferrer">MySQL :: Download MySQL APT Repository</a></li>
    <li><a href="https://dev.mysql.com/downloads/mysql/" target="_blank" rel="noopener noreferrer">MySQL :: Download MySQL Community Server </a></li>
</ul>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>公式APT<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EA%A5%DD%A5%B8%A5%C8%A5%EA">リポジトリ</a>設定用のパッケージを取得してインストールするには以下のコマンドを実行します。</p>

<pre class="terminal"> # curl -OL https://dev.mysql.com/get/mysql-apt-config_0.8.6-1_all.deb
 </pre>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>公式APT<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EA%A5%DD%A5%B8%A5%C8%A5%EA">リポジトリ</a>設定用のパッケージをインストールします。</p>

<pre class="terminal"> # dpkg -i mysql-apt-config*
 </pre>


<p>以下のような設定画面が出ますが、デフォルトのままOKを選択します。(後での変更も可能)</p>

<pre class="terminal"> パッケージの設定
 lqqqqqqqqqqqqqqqqqqqu mysql-apt-config を設定しています tqqqqqqqqqqqqqqqqqqqk
 x MySQL APT Repo features MySQL Server along with a variety of MySQL        x
 x components. You may select the appropriate product to choose the version  x
 x that you wish to receive.                                                 x
 x                                                                           x
 x Once you are satisfied with the configuration then select last option     x
 x 'Apply' to save the configuration. Advanced users can always change the   x
 x configurations later, depending on their own needs.                       x
 x                                                                           x
 x Which MySQL product do you wish to configure?                             x
 x                                                                           x
 x          MySQL Server (Currently selected: mysql-5.7)                     x
 x          MySQL Tools &amp; Connectors (Currently selected: Enabled)           x
 x          MySQL Preview Packages (Currently selected: Disabled)            x
 x          Ok                                                               x
 x                                                                           x
 x                                                                           x
 x                                  &lt;Ok&gt;                                     x
 x                                                                           x
 mqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqj
 </pre>


<p>パッケージリストを更新します。</p>

<pre class="terminal"> # apt update
 </pre>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>のパッケージをインストールします。</p>

<pre class="terminal"> # apt install mysql-server mysql-community-server
 </pre>


<p>rootパスワードの入力を求められるので入力して設定します。</p>

<pre class="terminal"> パッケージの設定

                                                                                
  lqqqqqqqqqqqqqqqu mysql-community-server を設定しています tqqqqqqqqqqqqqqqqk
  x Please provide a strong password that will be set for the root account   x
  x of your MySQL database. Leave it blank to enable password less login     x
  x using UNIX socket based authentication.                                  x
  x                                                                          x
  x Enter root password:                                                     x
  x                                                                          x
  x ________________________________________________________________________ x
  x                                                                          x
  x                                  &lt;了解&gt;                                  x
  x                                                                          x
  mqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqj
 </pre>


<p>再度rootパスワードの入力を求められるので入力して設定します。</p>

<pre class="terminal"> パッケージの設定
                                                                                
                                                                                
    lqqqqqqqqqqqqqu mysql-community-server を設定しています tqqqqqqqqqqqqqqk
    x Now that you have selected a password for the root account, please   x
    x confirm by typing it again. Do not share the password with anyone.   x
    x                                                                      x
    x Re-enter root password:                                              x
    x                                                                      x
    x ____________________________________________________________________ x
    x                                                                      x
    x                                &lt;了解&gt;                                x
    x                                                                      x
    mqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqj
 </pre>


<p>以下のパッケージがインストールされていることを確認します。</p>

<pre class="terminal"> # dpkg -l | grep mysql
ii  mysql-apt-config                   0.8.6-1                            all          Auto configuration for MySQL APT Repo.
ii  mysql-client                       5.7.18-1ubuntu16.04                amd64        MySQL Client meta package depending on latest version
ii  mysql-common                       5.7.18-1ubuntu16.04                amd64        MySQL Common
ii  mysql-community-client             5.7.18-1ubuntu16.04                amd64        MySQL Client
ii  mysql-community-server             5.7.18-1ubuntu16.04                amd64        MySQL Server
ii  mysql-server                       5.7.18-1ubuntu16.04                amd64        MySQL Server meta package depending on latest version
 </pre>


<h4>設定ファイル準備</h4>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>をインストールしたら、以下のような3つの設定ファイルを準備します。
loose-group_replication_group_name には各サーバで一意な値 uuid を設定します。uuidgenコマンド等で作成したものを記載します。
もし、Single-Primaryモード(1台のサーバのみ書き込み可能で、その他は読み取り専用)で稼働させたい場合は <code>loose-group_replication_single_primary_mode = OFF</code>, <code>loose-group_replication_enforce_update_everywhere_checks = ON</code> の設定を削除 or <a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B3%A5%E1%A5%F3%A5%C8%A5%A2%A5%A6%A5%C8">コメントアウト</a>します。</p>

<p><strong><a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>#01の設定ファイル(<code>/etc/mysql/mysqld-01.cnf</code>)</strong></p>

<pre class="terminal"> [mysqld_safe]
socket          = /tmp/mysqld-01.sock
nice            = 0

[mysqld]
#
# * Basic Settings
#
server_id = 100001
user            = mysql
pid-file        = /tmp/mysqld-01.pid
socket          = /tmp/mysqld-01.sock
port            = 24801
basedir         = /usr
datadir         = /var/lib/mysql-01/
tmpdir          = /tmp
skip-external-locking
slow_query_log          = 1
slow_query_log_file     = /var/log/mysql/mysql-01-slow.log
log-error       = /var/log/mysql/mysql-01-error.log
log_timestamps = SYSTEM
explicit_defaults_for_timestamp = true
#
# * Binary-log setting
#
log_bin = /var/log/mysql/gr-mysql-01-bin.log
binlog_format = ROW
#
# * General replication settings
#
gtid_mode = ON
enforce_gtid_consistency = ON
master_info_repository = TABLE
relay_log_info_repository = TABLE
binlog_checksum = NONE
log_slave_updates = ON
transaction_write_set_extraction = XXHASH64
loose-group_replication_bootstrap_group = OFF
loose-group_replication_start_on_boot = OFF
loose-group_replication_ssl_mode = DISABLED
loose-group_replication_recovery_use_ssl = 0
#
# * Replication group settings
#
loose-group_replication_group_name = "********-****-****-****-************"
loose-group_replication_ip_whitelist = "127.0.0.1"
loose-group_replication_group_seeds= "127.0.0.1:24901,127.0.0.1:24902,127.0.0.1:24903"
#
# * Multi-primary mode settings
#
loose-group_replication_single_primary_mode = OFF
loose-group_replication_enforce_update_everywhere_checks = ON
#
# * Host specific replication configuration
#
report_host = "127.0.0.1"
loose-group_replication_local_address= "127.0.0.1:24901"
 </pre>


<p><strong><a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>#02の設定ファイル(<code>/etc/mysql/mysqld-02.cnf</code>)</strong></p>

<pre class="terminal"> [mysqld_safe]
socket          = /tmp/mysqld-02.sock
nice            = 0

[mysqld]
#
# * Basic Settings
#
server_id = 100002
user            = mysql
pid-file        = /tmp/mysqld-02.pid
socket          = /tmp/mysqld-02.sock
port            = 24802
basedir         = /usr
datadir         = /var/lib/mysql-02/
tmpdir          = /tmp
skip-external-locking
slow_query_log          = 1
slow_query_log_file     = /var/log/mysql/mysql-02-slow.log
log-error       = /var/log/mysql/mysql-02-error.log
log_timestamps = SYSTEM
explicit_defaults_for_timestamp = true
#
# * Binary-log setting
#
log_bin = /var/log/mysql/gr-mysql-02-bin.log
binlog_format = ROW
#
# * General replication settings
#
gtid_mode = ON
enforce_gtid_consistency = ON
master_info_repository = TABLE
relay_log_info_repository = TABLE
binlog_checksum = NONE
log_slave_updates = ON
transaction_write_set_extraction = XXHASH64
loose-group_replication_bootstrap_group = OFF
loose-group_replication_start_on_boot = OFF
loose-group_replication_ssl_mode = DISABLED
loose-group_replication_recovery_use_ssl = 0
#
# * Replication group settings
#
loose-group_replication_group_name = "********-****-****-****-************"
loose-group_replication_ip_whitelist = "127.0.0.1"
loose-group_replication_group_seeds= "127.0.0.1:24901,127.0.0.1:24902,127.0.0.1:24903"
#
# * Multi-primary mode settings
#
loose-group_replication_single_primary_mode = OFF
loose-group_replication_enforce_update_everywhere_checks = ON
#
# * Host specific replication configuration
#
report_host = "127.0.0.1"
loose-group_replication_local_address= "127.0.0.1:24902"
 </pre>


<p><strong><a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>#03の設定ファイル(<code>/etc/mysql/mysqld-03.cnf</code>)</strong></p>

<pre class="terminal"> [mysqld_safe]
socket          = /tmp/mysqld-03.sock
nice            = 0

[mysqld]
#
# * Basic Settings
#
server_id = 100003
user            = mysql
pid-file        = /tmp/mysqld-03.pid
socket          = /tmp/mysqld-03.sock
port            = 24803
basedir         = /usr
datadir         = /var/lib/mysql-01/
tmpdir          = /tmp
skip-external-locking
slow_query_log          = 1
slow_query_log_file     = /var/log/mysql/mysql-03-slow.log
log-error       = /var/log/mysql/mysql-03-error.log
log_timestamps = SYSTEM
explicit_defaults_for_timestamp = true
#
# * Binary-log setting
#
log_bin = /var/log/mysql/gr-mysql-03-bin.log
binlog_format = ROW
#
# * General replication settings
#
gtid_mode = ON
enforce_gtid_consistency = ON
master_info_repository = TABLE
relay_log_info_repository = TABLE
binlog_checksum = NONE
log_slave_updates = ON
transaction_write_set_extraction = XXHASH64
loose-group_replication_bootstrap_group = OFF
loose-group_replication_start_on_boot = OFF
loose-group_replication_ssl_mode = DISABLED
loose-group_replication_recovery_use_ssl = 0
#
# * Replication group settings
#
loose-group_replication_group_name = "********-****-****-****-************"
loose-group_replication_ip_whitelist = "127.0.0.1"
loose-group_replication_group_seeds= "127.0.0.1:24901,127.0.0.1:24902,127.0.0.1:24903"
#
# * Multi-primary mode settings
#
loose-group_replication_single_primary_mode = OFF
loose-group_replication_enforce_update_everywhere_checks = ON
#
# * Host specific replication configuration
#
report_host = "127.0.0.1"
loose-group_replication_local_address= "127.0.0.1:24903"
 </pre>


<h4>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>データ<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リ初期化</h4>


<p>単一ホスト内に異なる<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>を起動する必要があるため、データ<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リを分けます。
ここでは <code>/var/lib/mysql-{01,02,03}</code> としていますが、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a>ではAppArmorによって<code>/var/lib/mysql</code>以外をデータ<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リとて初期化しようとするとエラーになります。
まずは <code>/etc/apparmor.d/usr.sbin.mysqld</code> へ <code>/var/lib/mysql-{01,02,03}</code> をデータ<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リとして扱えるように許可設定を行います。</p>

<pre class="terminal"> # diff -u /etc/apparmor.d/usr.sbin.mysqld{.org,}
--- /etc/apparmor.d/usr.sbin.mysqld.org YYYY-MM-DD hh:mm:ss.000000000 +0900
+++ /etc/apparmor.d/usr.sbin.mysqld     YYYY-MM-DD hh:mm:ss.********* +0900
@@ -48,6 +48,10 @@
 # Allow data dir access
   /var/lib/mysql/ r,
   /var/lib/mysql/** rwk,
+  /var/lib/mysql-01/ r,
+  /var/lib/mysql-01/** rwk,
+  /var/lib/mysql-02/ r,
+  /var/lib/mysql-02/** rwk,
+  /var/lib/mysql-03/ r,
+  /var/lib/mysql-03/** rwk,

 </pre>


<p>設定を反映します。</p>

<pre class="terminal"> # apparmor_parser -r /etc/apparmor.d/usr.sbin.mysqld
 </pre>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>#01のデータ<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リを初期化します。</p>

<pre class="terminal"> # install -d -o mysql -g mysql -m 700 /var/lib/mysql-01
# mysqld --defaults-file=/etc/mysql/mysqld-01.cnf --initialize --user=mysql --explicit_defaults_for_timestamp
(ログファイルにテンポラリパスワードが記録されているのでメモ)
 </pre>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>#02のデータ<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リを初期化します。</p>

<pre class="terminal"> # install -d -o mysql -g mysql -m 700 /var/lib/mysql-02
# mysqld --defaults-file=/etc/mysql/mysqld-02.cnf --initialize --user=mysql --explicit_defaults_for_timestamp
(ログファイルにテンポラリパスワードが記録されているのでメモ)
 </pre>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>#03のデータ<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リを初期化します。</p>

<pre class="terminal"> # install -d -o mysql -g mysql -m 700 /var/lib/mysql-03
# mysqld --defaults-file=/etc/mysql/mysqld-03.cnf --initialize --user=mysql --explicit_defaults_for_timestamp
(ログファイルにテンポラリパスワードが記録されているのでメモ)
 </pre>


<h4>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>起動</h4>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>#01を起動します。</p>

<pre class="terminal"> # mysqld --defaults-file=/etc/mysql/mysqld-01.cnf --user=mysql &amp;
 </pre>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>#02を起動します。</p>

<pre class="terminal"> # mysqld --defaults-file=/etc/mysql/mysqld-02.cnf --user=mysql &amp;
 </pre>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>#03を起動します。</p>

<pre class="terminal"> # mysqld --defaults-file=/etc/mysql/mysqld-03.cnf --user=mysql &amp;
 </pre>


<h4>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a> rootパスワード再設定</h4>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>#01のrootパスワードを再設定します。</p>

<pre class="terminal"> # mysql -u root -P 24801 --protocol=tcp -h localhost -p

mysql#01&gt; set password for root@localhost=password('********');
Query OK, 0 rows affected, 1 warning (0.01 sec)
 </pre>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>#02のrootパスワードを再設定します。</p>

<pre class="terminal"> # mysql -u root -P 24802 --protocol=tcp -h localhost -p

mysql#02&gt; set password for root@localhost=password('********');
Query OK, 0 rows affected, 1 warning (0.01 sec)
 </pre>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>#03のrootパスワードを再設定します。</p>

<pre class="terminal"> # mysql -u root -P 24803 --protocol=tcp -h localhost -p

mysql#03&gt; set password for root@localhost=password('********');
Query OK, 0 rows affected, 1 warning (0.01 sec)
 </pre>


<h4>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a> <a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EC%A5%D7%A5%EA%A5%B1%A1%BC%A5%B7%A5%E7%A5%F3">レプリケーション</a>用ユーザ作成</h4>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>#01に<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EC%A5%D7%A5%EA%A5%B1%A1%BC%A5%B7%A5%E7%A5%F3">レプリケーション</a>用のユーザを作成します。</p>

<pre class="terminal"> mysql#01&gt; SET SQL_LOG_BIN=0;

mysql#01&gt; GRANT REPLICATION SLAVE ON *.* TO 'repl'@'%' IDENTIFIED BY '********';
Query OK, 0 rows affected, 1 warning (0.00 sec)

mysql#01&gt; SET SQL_LOG_BIN=1;
 </pre>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>#02に<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EC%A5%D7%A5%EA%A5%B1%A1%BC%A5%B7%A5%E7%A5%F3">レプリケーション</a>用のユーザを作成します。</p>

<pre class="terminal"> mysql#02&gt; SET SQL_LOG_BIN=0;

mysql#02&gt; GRANT REPLICATION SLAVE ON *.* TO 'repl'@'%' IDENTIFIED BY '********';
Query OK, 0 rows affected, 1 warning (0.00 sec)

mysql#02&gt; SET SQL_LOG_BIN=1;
 </pre>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>#03に<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EC%A5%D7%A5%EA%A5%B1%A1%BC%A5%B7%A5%E7%A5%F3">レプリケーション</a>用のユーザを作成します。</p>

<pre class="terminal"> mysql#03&gt; SET SQL_LOG_BIN=0;

mysql#03&gt; GRANT REPLICATION SLAVE ON *.* TO 'repl'@'%' IDENTIFIED BY '********';
Query OK, 0 rows affected, 1 warning (0.00 sec)

mysql#03&gt; SET SQL_LOG_BIN=1;
 </pre>


<h4>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EC%A5%D7%A5%EA%A5%B1%A1%BC%A5%B7%A5%E7%A5%F3">レプリケーション</a>接続用パラメータ設定</h4>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>#01に<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EC%A5%D7%A5%EA%A5%B1%A1%BC%A5%B7%A5%E7%A5%F3">レプリケーション</a>接続用の設定を行います。</p>

<pre class="terminal"> mysql#01&gt; RESET MASTER;

mysql#01&gt; CHANGE MASTER TO MASTER_USER='repl', MASTER_PASSWORD='********' FOR CHANNEL 'group_replication_recovery';
 </pre>


<p>※マニュアルでは以下の実行は必要とありますが、2台目、3台目はやらなくても<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EC%A5%D7%A5%EA%A5%B1%A1%BC%A5%B7%A5%E7%A5%F3">レプリケーション</a>構成は組めました</p>

<pre class="terminal"> mysql#02&gt; RESET MASTER;

mysql#02&gt; CHANGE MASTER TO MASTER_USER='repl', MASTER_PASSWORD='********' FOR CHANNEL 'group_replication_recovery';
 </pre>


<pre class="terminal"> mysql#03&gt; RESET MASTER;

mysql#03&gt; CHANGE MASTER TO MASTER_USER='repl', MASTER_PASSWORD='********' FOR CHANNEL 'group_replication_recovery';
 </pre>


<h4>Group Replication<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D7%A5%E9%A5%B0%A5%A4%A5%F3">プラグイン</a>の有効化</h4>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>#01のGroup Replication<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D7%A5%E9%A5%B0%A5%A4%A5%F3">プラグイン</a>を有効化します。</p>

<pre class="terminal"> mysql#01&gt; select * from information_schema.plugins where plugin_name='group_replication'\G
Empty set (0.00 sec)

mysql#01&gt; INSTALL PLUGIN group_replication SONAME 'group_replication.so';
Query OK, 0 rows affected (0.00 sec)

mysql#01&gt; select * from information_schema.plugins where plugin_name='group_replication'\G
*************************** 1. row ***************************
           PLUGIN_NAME: group_replication
        PLUGIN_VERSION: 1.0
         PLUGIN_STATUS: ACTIVE
           PLUGIN_TYPE: GROUP REPLICATION
   PLUGIN_TYPE_VERSION: 1.1
        PLUGIN_LIBRARY: group_replication.so
PLUGIN_LIBRARY_VERSION: 1.7
         PLUGIN_AUTHOR: ORACLE
    PLUGIN_DESCRIPTION: Group Replication (1.0.0)
        PLUGIN_LICENSE: GPL
           LOAD_OPTION: ON
1 row in set (0.00 sec)
 </pre>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>#02のGroup Replication<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D7%A5%E9%A5%B0%A5%A4%A5%F3">プラグイン</a>を有効化します。</p>

<pre class="terminal"> mysql#02&gt; select * from information_schema.plugins where plugin_name='group_replication'\G
Empty set (0.00 sec)

mysql#02&gt; INSTALL PLUGIN group_replication SONAME 'group_replication.so';
Query OK, 0 rows affected (0.00 sec)

mysql#02&gt; select * from information_schema.plugins where plugin_name='group_replication'\G
*************************** 1. row ***************************
           PLUGIN_NAME: group_replication
        PLUGIN_VERSION: 1.0
         PLUGIN_STATUS: ACTIVE
           PLUGIN_TYPE: GROUP REPLICATION
   PLUGIN_TYPE_VERSION: 1.1
        PLUGIN_LIBRARY: group_replication.so
PLUGIN_LIBRARY_VERSION: 1.7
         PLUGIN_AUTHOR: ORACLE
    PLUGIN_DESCRIPTION: Group Replication (1.0.0)
        PLUGIN_LICENSE: GPL
           LOAD_OPTION: ON
1 row in set (0.00 sec)
 </pre>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>#03のGroup Replication<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D7%A5%E9%A5%B0%A5%A4%A5%F3">プラグイン</a>を有効化します。</p>

<pre class="terminal"> mysql#03&gt; select * from information_schema.plugins where plugin_name='group_replication'\G
Empty set (0.00 sec)

mysql#03&gt; INSTALL PLUGIN group_replication SONAME 'group_replication.so';
Query OK, 0 rows affected (0.00 sec)

mysql#03&gt; select * from information_schema.plugins where plugin_name='group_replication'\G
*************************** 1. row ***************************
           PLUGIN_NAME: group_replication
        PLUGIN_VERSION: 1.0
         PLUGIN_STATUS: ACTIVE
           PLUGIN_TYPE: GROUP REPLICATION
   PLUGIN_TYPE_VERSION: 1.1
        PLUGIN_LIBRARY: group_replication.so
PLUGIN_LIBRARY_VERSION: 1.7
         PLUGIN_AUTHOR: ORACLE
    PLUGIN_DESCRIPTION: Group Replication (1.0.0)
        PLUGIN_LICENSE: GPL
           LOAD_OPTION: ON
1 row in set (0.00 sec)
 </pre>


<h4>Group Replicationの開始</h4>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>#01 で以下を実行します。
Group Replicationを起動する最初の1台目のみ、Group Replicationの開始前に<code>group_replication_bootstrap_group</code>を有効化する必要があります。
(これをしないと、Group内のほかのサーバに接続しに行こうとして接続できずエラーとなり失敗します。)</p>

<pre class="terminal"> mysql#01&gt; SET GLOBAL group_replication_bootstrap_group=ON;
Query OK, 0 rows affected (0.00 sec)

mysql#01&gt; START GROUP_REPLICATION;
Query OK, 0 rows affected (0.00 sec)

mysql#01&gt; SET GLOBAL group_replication_bootstrap_group=OFF;
Query OK, 0 rows affected (0.00 sec)

mysql#01&gt; SELECT * FROM performance_schema.replication_group_members;
+---------------------------+--------------------------------------+-------------+-------------+--------------+
| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE |
+---------------------------+--------------------------------------+-------------+-------------+--------------+
| group_replication_applier | ********-****-****-****-************ | 127.0.0.1   |       24801 | ONLINE       |
+---------------------------+--------------------------------------+-------------+-------------+--------------+
1 row in set (0.00 sec)
 </pre>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>#01 へテスト用のデータベースを作成します。</p>

<pre class="terminal"> mysql#01&gt; CREATE DATABASE playground;
Query OK, 1 row affected (0.01 sec)

mysql#01&gt; CREATE TABLE playground.equipment ( id INT NOT NULL AUTO_INCREMENT, type VARCHAR(50), quant INT, color VARCHAR(25), PRIMARY KEY(id));
Query OK, 0 rows affected (0.02 sec)

mysql#01&gt; INSERT INTO playground.equipment (type, quant, color) VALUES ("slide", 2, "blue");
Query OK, 1 row affected (0.01 sec)

mysql#01&gt; SELECT * FROM playground.equipment;
+----+-------+-------+-------+
| id | type  | quant | color |
+----+-------+-------+-------+
|  1 | slide |     2 | blue  |
+----+-------+-------+-------+
1 row in set (0.00 sec)
 </pre>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>#02, <a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>#03 でも Group Replicationを開始します。
Group Replicationが正常に開始されたら<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>#01で作成したテスト用のDBが存在することを確認します。</p>

<pre class="terminal"> mysql#02&gt; RESET MASTER;
Query OK, 1 row affected (0.01 sec)

mysql#02&gt; START GROUP_REPLICATION;
Query OK, 0 rows affected (1.06 sec)

mysql#02&gt; SELECT * FROM performance_schema.replication_group_members;
+---------------------------+--------------------------------------+-------------+-------------+--------------+
| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE |
+---------------------------+--------------------------------------+-------------+-------------+--------------+
| group_replication_applier | ********-****-****-****-************ | 127.0.0.1   |       24801 | ONLINE       |
| group_replication_applier | ********-****-****-****-************ | 127.0.0.1   |       24802 | ONLINE       |
+---------------------------+--------------------------------------+-------------+-------------+--------------+
2 rows in set (0.00 sec)

mysql#02&gt; SELECT * FROM playground.equipment;
+----+-------+-------+-------+
| id | type  | quant | color |
+----+-------+-------+-------+
|  1 | slide |     2 | blue  |
+----+-------+-------+-------+
1 row in set (0.00 sec)
 </pre>


<pre class="terminal"> mysql#03&gt; RESET MASTER;
Query OK, 1 row affected (0.01 sec)

mysql#03&gt; start group_replication;
Query OK, 0 rows affected (1.88 sec)

mysql#03&gt; SELECT * FROM performance_schema.replication_group_members;
+---------------------------+--------------------------------------+-------------+-------------+--------------+
| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE |
+---------------------------+--------------------------------------+-------------+-------------+--------------+
| group_replication_applier | ********-****-****-****-************ | 127.0.0.1   |       24801 | ONLINE       |
| group_replication_applier | ********-****-****-****-************ | 127.0.0.1   |       24802 | ONLINE       |
| group_replication_applier | ********-****-****-****-************ | 127.0.0.1   |       24803 | ONLINE       |
+---------------------------+--------------------------------------+-------------+-------------+--------------+
3 rows in set (0.00 sec)

mysql#03&gt; SELECT * FROM playground.equipment;
+----+-------+-------+-------+
| id | type  | quant | color |
+----+-------+-------+-------+
|  1 | slide |     2 | blue  |
+----+-------+-------+-------+
1 row in set (0.00 sec)
 </pre>


<h4>マルチマスタでの更新確認</h4>


<p>マルチマスタであることを確認するために<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>#02での更新後に、他のサーバに更新データが反映されるかを試します。</p>

<pre class="terminal"> mysql#02&gt; CREATE DATABASE test;
Query OK, 1 row affected (0,00 sec)

mysql#02&gt; use test
Database changed

mysql#02&gt; CREATE TABLE t1 (c1 INT PRIMARY KEY, c2 TEXT NOT NULL);
Query OK, 0 rows affected (0,00 sec)

mysql#02&gt; INSERT INTO t1 VALUES (1, 'Luis');
Query OK, 1 row affected (0,01 sec)

mysql#02&gt; SELECT * FROM test.t1;
+----+------+
| c1 | c2   |
+----+------+
|  1 | Luis |
+----+------+
1 row in set (0,00 sec)
 </pre>


<p>ほかのサーバからも確認します。</p>

<pre class="terminal"> mysql#03&gt; SELECT * FROM test.t1;
+----+------+
| c1 | c2   |
+----+------+
|  1 | Luis |
+----+------+
1 row in set (0,00 sec)
 </pre>


<p>これでGroup Replication環境を構築できました。</p>

<h4>Group Replicationの停止</h4>


<p>以下のコマンドで停止できます。</p>

<pre class="terminal"> mysql#01&gt; stop group_replication;
Query OK, 0 rows affected (0.01 sec)
 </pre>


<h4>Group Replicationの再開</h4>


<p>停止中のマスターで<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C8%A5%E9%A5%F3%A5%B6%A5%AF%A5%B7%A5%E7%A5%F3">トランザクション</a>が実行されておらず、GTIDを追えれば以下で再度Groupに組み込まれます。</p>

<pre class="terminal"> mysql#01&gt; START GROUP_REPLICATION;
Query OK, 0 rows affected (1.06 sec)
 </pre>


<h4>Group Replicationの停止から再開まで</h4>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>#01の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EC%A5%D7%A5%EA%A5%B1%A1%BC%A5%B7%A5%E7%A5%F3">レプリケーション</a>を止めてみます。
止める前の状態は以下です。</p>

<pre class="terminal"> mysql#01&gt; SELECT * FROM performance_schema.replication_group_members;
+---------------------------+--------------------------------------+-------------+-------------+--------------+
| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE |
+---------------------------+--------------------------------------+-------------+-------------+--------------+
| group_replication_applier | ********-****-****-****-************ | 127.0.0.1   |       24801 | ONLINE       |
| group_replication_applier | ********-****-****-****-************ | 127.0.0.1   |       24802 | ONLINE       |
| group_replication_applier | ********-****-****-****-************ | 127.0.0.1   |       24803 | ONLINE       |
+---------------------------+--------------------------------------+-------------+-------------+--------------+
3 rows in set (0.00 sec)

mysql#01&gt; show global variables like 'GTID%';
+----------------------------------+---------------------------------------------------------------------------+
| Variable_name                    | Value                                                                     |
+----------------------------------+---------------------------------------------------------------------------+
| gtid_executed                    | ********-****-****-****-************:1-40:1000003-1000004:2000003-2000104 |
| gtid_executed_compression_period | 1000                                                                      |
| gtid_mode                        | ON                                                                        |
| gtid_owned                       |                                                                           |
| gtid_purged                      |                                                                           |
+----------------------------------+---------------------------------------------------------------------------+
5 rows in set (0.01 sec)
 </pre>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>#01の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EC%A5%D7%A5%EA%A5%B1%A1%BC%A5%B7%A5%E7%A5%F3">レプリケーション</a>を止めます。</p>

<pre class="terminal"> mysql#01&gt; stop group_replication;
Query OK, 0 rows affected (8.53 sec)
 </pre>


<pre class="terminal"> mysql&gt; show global variables like 'GTID%';
+----------------------------------+---------------------------------------------------------------------------+
| Variable_name                    | Value                                                                     |
+----------------------------------+---------------------------------------------------------------------------+
| gtid_executed                    | ********-****-****-****-************:1-40:1000003-1000004:2000003-2000104 |
| gtid_executed_compression_period | 1000                                                                      |
| gtid_mode                        | ON                                                                        |
| gtid_owned                       |                                                                           |
| gtid_purged                      |                                                                           |
+----------------------------------+---------------------------------------------------------------------------+
5 rows in set (0.01 sec)

mysql&gt; SELECT * FROM performance_schema.replication_group_members;
+---------------------------+--------------------------------------+-------------+-------------+--------------+
| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE |
+---------------------------+--------------------------------------+-------------+-------------+--------------+
| group_replication_applier | ********-****-****-****-************ | 127.0.0.1   |       24801 | OFFLINE      |
+---------------------------+--------------------------------------+-------------+-------------+--------------+
1 row in set (0.00 sec)
 </pre>


<p>稼働中のマスターに対して更新をかけます。
GTIDが更新(ここでは40-&gt;74)されています。</p>

<pre class="terminal"> mysql#02&gt; show global variables like 'GTID%';
+----------------------------------+---------------------------------------------------------------------------+
| Variable_name                    | Value                                                                     |
+----------------------------------+---------------------------------------------------------------------------+
| gtid_executed                    | ********-****-****-****-************:1-74:1000003-1000004:2000003-2000104 |
| gtid_executed_compression_period | 1000                                                                      |
| gtid_mode                        | ON                                                                        |
| gtid_owned                       |                                                                           |
| gtid_purged                      |                                                                           |
+----------------------------------+---------------------------------------------------------------------------+
5 rows in set (0.00 sec)
 </pre>


<p>停止していた<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>#01のグループ<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EC%A5%D7%A5%EA%A5%B1%A1%BC%A5%B7%A5%E7%A5%F3">レプリケーション</a>を開始します。</p>

<pre class="terminal"> mysql#01&gt; start group_replication;
Query OK, 0 rows affected (2.36 sec)

mysql#01&gt; SELECT * FROM performance_schema.replication_group_members;
+---------------------------+--------------------------------------+-------------+-------------+--------------+
| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE |
+---------------------------+--------------------------------------+-------------+-------------+--------------+
| group_replication_applier | ********-****-****-****-************ | 127.0.0.1   |       24801 | ONLINE       |
| group_replication_applier | ********-****-****-****-************ | 127.0.0.1   |       24802 | ONLINE       |
| group_replication_applier | ********-****-****-****-************ | 127.0.0.1   |       24803 | ONLINE       |
+---------------------------+--------------------------------------+-------------+-------------+--------------+
3 rows in set (0.00 sec)
 </pre>


<p>グループ<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EC%A5%D7%A5%EA%A5%B1%A1%BC%A5%B7%A5%E7%A5%F3">レプリケーション</a>が開始されたことで、GTIDがさらに進み(74-&gt;75)ました。</p>

<pre class="terminal"> mysql#01&gt; show global variables like 'GTID%';
+----------------------------------+---------------------------------------------------------------------------+
| Variable_name                    | Value                                                                     |
+----------------------------------+---------------------------------------------------------------------------+
| gtid_executed                    | ********-****-****-****-************:1-75:1000003-1000004:2000003-2000104 |
| gtid_executed_compression_period | 1000                                                                      |
| gtid_mode                        | ON                                                                        |
| gtid_owned                       |                                                                           |
| gtid_purged                      |                                                                           |
+----------------------------------+---------------------------------------------------------------------------+
5 rows in set (0.01 sec)
 </pre>


<p>ほかのマスターでも同一のGTIDになっていることを確認します。</p>

<pre class="terminal"> mysql#02&gt; show global variables like 'GTID%';
+----------------------------------+---------------------------------------------------------------------------+
| Variable_name                    | Value                                                                     |
+----------------------------------+---------------------------------------------------------------------------+
| gtid_executed                    | ********-****-****-****-************:1-75:1000003-1000004:2000003-2000104 |
| gtid_executed_compression_period | 1000                                                                      |
| gtid_mode                        | ON                                                                        |
| gtid_owned                       |                                                                           |
| gtid_purged                      |                                                                           |
+----------------------------------+---------------------------------------------------------------------------+
5 rows in set (0.01 sec)
 </pre>


<h4>Group Replicationの復旧</h4>


<p>データが壊れてしまっていたような場合だと上記の手順ではGroup Replicationを再開できずエラーになってしまいます。その場合は、生きているマスターからdumpを取得 or バックアップのdumpを使って、停止しているマスターにデータを投入してGroup Replicationを再開します。</p>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>#01が障害発生中として、<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>#03からmysqldumpでダンプ取得します。</p>

<pre class="terminal"> # mysqldump --all-databases --lock-all-tables -uroot --triggers --routines --events -p -P 24803 --protocol=tcp &gt; /tmp/dump.`date +%Y%m%d`.sql
 </pre>


<p>従来のマスタースレーブ形式の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EC%A5%D7%A5%EA%A5%B1%A1%BC%A5%B7%A5%E7%A5%F3">レプリケーション</a>だと復旧にはバイナリログのポジションを使っていましたが、マルチマスターのGroup ReplicationではダンプファイルにGTIDが記録されており、ダンプファイルに記録されているこれがリストア時に対象サーバに記録されて復旧に用いられます。</p>

<pre class="terminal"> # grep GTID_PURGED /tmp/dump.sql
SET @@GLOBAL.GTID_PURGED='********-****-****-****-************:*-***'
 </pre>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>#01を復旧させるしていると想定して、/tmp/dump.<a class="keyword" href="http://d.hatena.ne.jp/keyword/sql">sql</a>を使ってリストアします。</p>

<pre class="terminal"> mysql#01&gt; stop group_replication;
Query OK, 0 rows affected (8.32 sec)

mysql#01&gt; SELECT * FROM performance_schema.replication_group_members;
+---------------------------+--------------------------------------+-------------+-------------+--------------+
| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE |
+---------------------------+--------------------------------------+-------------+-------------+--------------+
| group_replication_applier | ********-****-****-****-************ | 127.0.0.1   |       24801 | OFFLINE       |
+---------------------------+--------------------------------------+-------------+-------------+--------------+

mysql#01&gt; reset master;
Query OK, 0 rows affected (0.02 sec)
 
mysql#01&gt; source /tmp/dump.sql
 
mysql#01&gt; start group_replication;
Query OK, 0 rows affected (2.13 sec)

mysql#01&gt; SELECT * FROM performance_schema.replication_group_members;
+---------------------------+--------------------------------------+-------------+-------------+--------------+
| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE |
+---------------------------+--------------------------------------+-------------+-------------+--------------+
| group_replication_applier | ********-****-****-****-************ | 127.0.0.1   |       24801 | ONLINE       |
| group_replication_applier | ********-****-****-****-************ | 127.0.0.1   |       24802 | ONLINE       |
| group_replication_applier | ********-****-****-****-************ | 127.0.0.1   |       24803 | ONLINE       |
+---------------------------+--------------------------------------+-------------+-------------+--------------+
3 rows in set (0.00 sec)
 </pre>


<h3>まとめ</h3>


<p>マルチマスターでのGroup Replicationの構築手順を書きました。
Group Replicationを構成することで、<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>の可用性をこれまで以上に高めることができそうなので、<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A2%A1%BC%A5%AD%A5%C6%A5%AF%A5%C1%A5%E3">アーキテクチャ</a>の選択肢が増えたと思います。<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>の標準機能としての高可用性機能が取り入れられたのはうれしいところです。<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a> Fabricみたいなことに(ry</p>

<h3>参考</h3>


<ul>
    <li><a href="https://www.digitalocean.com/community/tutorials/how-to-configure-mysql-group-replication-on-ubuntu-16-04" target="_blank" rel="noopener noreferrer">How To Configure MySQL Group Replication on Ubuntu 16.04 | DigitalOcean</a></li>
    <li><a href="http://mita2db.blogspot.com/2017/01/group-replication-4.html" target="_blank" rel="noopener noreferrer">mita2 DB メモ: Group Replication を試す(4) リカバリ</a></li>
    <li><a href="https://www.slideshare.net/satoshimitani71/mysql-group-replication-mysql-casual-talk-vol1" target="_blank" rel="noopener noreferrer">MySQL Group Replication - MySQL Casual Talk vol.10</a></li>
    <li><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication.html" target="_blank" rel="noopener noreferrer">MySQL :: MySQL 5.7 Reference Manual :: 18 Group Replication</a></li>
    <li><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication.html" target="_blank" rel="noopener noreferrer">MySQL :: MySQL 5.7 Reference Manual :: 18 Group Replication</a></li>
    <li><a href="https://ja.wikipedia.org/wiki/Paxos%E3%82%A2%E3%83%AB%E3%82%B4%E3%83%AA%E3%82%BA%E" target="_blank" rel="noopener noreferrer">Paxosアルゴリズム - Wikipedia</a></li>
    <li><a href="http://lamport.azurewebsites.net/pubs/pubs.html#lamport-paxos" rel="noopener">The Writings of Leslie Lamport</a></li>
    <li><a href="http://nil.csail.mit.edu/6.824/2015/notes/paxos-code.html" rel="noopener">paxos-code.html</a></li>
</ul>

</body>
