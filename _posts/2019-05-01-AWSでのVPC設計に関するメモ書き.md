---
layout: post
Categories:  ["tech"]
Description:  " AWSのVPC設計に関して考えたことや調べたこと、参考資料やリンクを残しておく。 "
Tags: ["AWS", "tech"]
date: "2019-05-01T20:09:00+09:00"
title: "AWSでのVPC設計に関するメモ書き"
author: "dshimizu"
archive: ["2019"]
draft: "true"
---

<body>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/AWS">AWS</a>の<a class="keyword" href="http://d.hatena.ne.jp/keyword/VPC">VPC</a>設計に関して考えたことや調べたこと、参考資料やリンクを残しておく。</p>
</body>

<!-- more -->

<body>
<h3>事前</h3>


<h4>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/AWS">AWS</a>アカウント</h4>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/VPC">VPC</a>ではないけれど、本番環境とステージング環境・開発環境を1つの<a class="keyword" href="http://d.hatena.ne.jp/keyword/AWS">AWS</a>アカウント内で運用するか、<a class="keyword" href="http://d.hatena.ne.jp/keyword/AWS">AWS</a>アカウントレベルでを分けるか、がある。
要件や組織体制、サービス規模によるところもあると思うのでどっちが良いとは一概には言えないけど、<a class="keyword" href="http://d.hatena.ne.jp/keyword/AWS">AWS</a>アカウントを分けるとその分IAMアカウントの管理とか請求でやや煩雑になる部分もあるが、下記の記事にあるように各環境が完全に疎になるのは良さそう。</p>

<ul>
    <li><a target="_brank" rel="noopener noreferrer" href="https://recruit-tech.co.jp/blog/2018/11/20/iac_terraform/">リクルートテクノロジーズ　メンバーズブログ  Infrastructure as Codeによるインフラ運用：AWSアカウント分離とリソースのコード化</a></li>
</ul>


<h3><a class="keyword" href="http://d.hatena.ne.jp/keyword/VPC">VPC</a></h3>


<p>1つの<a class="keyword" href="http://d.hatena.ne.jp/keyword/AWS">AWS</a>アカウントで運用する場合、本番環境、ステージング環境、開発環境で<a class="keyword" href="http://d.hatena.ne.jp/keyword/VPC">VPC</a>を分けたい。
本番環境とステージング・開発環境で<a class="keyword" href="http://d.hatena.ne.jp/keyword/AWS">AWS</a>アカウントを分ける場合はそのまま作れば良い。</p>

<h3>AZ</h3>


<p>東京リージョンだと、ap-northeast-1a, 1b, 1c, 1dがある。1bは使えない(人によっては使える？)ので3つのAZが利用可能。
1つのリージョン内の各AZは地理的に分離しているらしいので、AZの障害に備えると最低2つ以上のAZを利用する構成にしたい。</p>

<h3>アドレス・サブネット</h3>


<h4>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/VPC">VPC</a>に割り当てるアドレス帯域</h4>


<p>最初に<a class="keyword" href="http://d.hatena.ne.jp/keyword/VPC">VPC</a>に割り当てるアドレスは決める。 <a target="_brank" rel="noopener noreferrer" href="http://www.faqs.org/rfcs/rfc1918.html">RFC 1918</a> に指定されているように、プライベート <a class="keyword" href="http://d.hatena.ne.jp/keyword/IPv4">IPv4</a> アドレス範囲から CIDR ブロック (/16 以下) を指定することが推奨らしい。</p>

<ul>
    <li>10.0.0.0 - 10.255.255.255 (10/8 <a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D7%A5%EC%A5%D5%A5%A3%A5%C3%A5%AF%A5%B9">プレフィックス</a>)</li>
    <li>172.16.0.0 - 172.31.255.255 (172.16/12 <a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D7%A5%EC%A5%D5%A5%A3%A5%C3%A5%AF%A5%B9">プレフィックス</a>)</li>
    <li>192.168.0.0 - 192.168.255.255 (192.168/16 <a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D7%A5%EC%A5%D5%A5%A3%A5%C3%A5%AF%A5%B9">プレフィックス</a>)</li>
</ul>


<ul>
    <li><a target="_brank" rel="noopener noreferrer" href="https://docs.aws.amazon.com/ja_jp/vpc/latest/userguide/VPC_Subnets.html#VPC_Sizing">VPC とサブネット - Amazon Virtual Private Cloud</a></li>
</ul>


<p>会社内でもまだ使われていない /16 のレンジがあると良いと個人的には思う。
下記のサブネットには<a class="keyword" href="http://d.hatena.ne.jp/keyword/VPC">VPC</a>で割り当てられているアドレス帯域の中から割り当てることになるので、余裕を持たせておいた方が良い。(たいてい余るが)</p>

<h4>サブネットアドレス</h4>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/VPC">VPC</a>の中に作るのがサブネット。<a class="keyword" href="http://d.hatena.ne.jp/keyword/VPC">VPC</a>は同一リージョン内の全AZにまたがるが、サブネットは特定のAZのみで扱われる。
よくあるWeb/App/DBの3層構造にする場合、3層×2AZで最低6サブネットが必要となる。</p>

<p>ホスト数に問題ないなら一つのサブネットにクラスB、クラスC単位で割り当てるのが楽。</p>

<ul>
    <li>ap-northeast-1a に10.0.1.0/24 を割り当てる。</li>
    <li>ap-northeast-1c に10.0.2.0/24 を割り当てる。</li>
</ul>


<p>ただ、下記の記事のような形で検討するのも良さそう。</p>

<ul>
    <li><a target="_brank" rel="noopener noreferrer" href="https://qiita.com/nisshiee/items/df4261132ec686964605">AWSのネットワーク設計をサボらないでちゃんとやる - Qiita</a></li>
</ul>


<p>同一の用途のネットワーク(例えばWeb層)でかつMulti AZを使う場合、クラスCを2つに分割して各AZのサブネットに割り当てる、ということもできる。</p>

<ul>
    <li>ap-northeast-1a に10.0.1.0/25 を割り当てる。</li>
    <li>ap-northeast-1c に10.0.1.128/25 を割り当てる。</li>
</ul>


<p>こうすると、Web層の通信をまとめて制御する場合は10.0.1.0/24を指定すれば済む。</p>

<p>AZを考慮したCIDR割り当てをすれば運用面で多少楽できる部分はあるかもしれない。</p>

<p>ただ、現在はAZが3つ使えるので、例えばクラスCを3つに分割しようとすると煩雑なので、やはり可能ならクラスB、クラスC単位でざっくり割り当てるのが楽そう。</p>

<h4>ルートテーブル(ルーティング)</h4>


<p>サブネット内部から外部(インターネット)へ通信するためにはインターネット<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B2%A1%BC%A5%C8%A5%A6%A5%A7%A5%A4">ゲートウェイ</a>を作成し、ルートテーブルでインターネット<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B2%A1%BC%A5%C8%A5%A6%A5%A7%A5%A4">ゲートウェイ</a>へのルーティングを追加する必要がある。
サブネット内部から外部(インターネット)へ通信しても良いサブネットには、インターネット<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B2%A1%BC%A5%C8%A5%A6%A5%A7%A5%A4">ゲートウェイ</a>へのルーティングが許可されたルートテーブルを割り当てる。そうでないものはlocalのみに制限されたルートテーブルを割り当てる。</p>

<h4>セキュリティグループとネットワーク<a class="keyword" href="http://d.hatena.ne.jp/keyword/ACL">ACL</a>
</h4>


<p>セキュリティグループは<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A4%A5%F3%A5%B9%A5%BF%A5%F3%A5%B9">インスタンス</a>へのインとアウトの通信を制御する。ネットワーク <a class="keyword" href="http://d.hatena.ne.jp/keyword/ACL">ACL</a> はサブネットレベルでインとアウトの通信を制御する。</p>

<p>セキュリティグループはほぼ必須で使うことになると思う。
ネットワーク <a class="keyword" href="http://d.hatena.ne.jp/keyword/ACL">ACL</a>もデフォルトで割り当てられているが、サブネットレベルの細かい制御が必要な場合は設定が必要。使うかどうかは要件による。</p>

<h3>まとめ</h3>


<p>ドキュメントやblackbeltの資料を読むのは良い。
各環境の分離レベルをどうするか、<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AF%A5%E9%A5%A6%A5%C9">クラウド</a>(<a class="keyword" href="http://d.hatena.ne.jp/keyword/AWS">AWS</a> の<a class="keyword" href="http://d.hatena.ne.jp/keyword/VPC">VPC</a>/AZ)を考慮したアドレス設計をどうするかを少し自分の中で整理しながら書いた。</p>

<h3>参考</h3>


<ul>
    <li><a target="_brank" rel="noopener noreferrer" href="https://docs.aws.amazon.com/ja_jp/vpc/latest/userguide/VPC_Subnets.html">VPC とサブネット - Amazon Virtual Private Cloud</a></li>
    <li><a target="_brank" rel="noopener noreferrer" href="https://www.slideshare.net/AmazonWebServicesJapan/20190313-aws-black-belt-online-seminar-amazon-vpc-basic">20190313 AWS Black Belt Online Seminar Amazon VPC Basic</a></li>
    <li><a target="_brank" rel="noopener noreferrer" href="https://qiita.com/nisshiee/items/df4261132ec686964605">AWS のネットワーク設計入門</a></li>
    <li><a target="_brank" rel="noopener noreferrer" href="https://qiita.com/nisshiee/items/df4261132ec686964605">AWSのネットワーク設計をサボらないでちゃんとやる - Qiita</a></li>
    <li><a target="_brank" rel="noopener noreferrer" href="https://qiita.com/takuya_tsurumi/items/cbeeeaa1e3a87c679f81">AWS導入前に知っておきたかった「VPC設計」 - Qiita</a></li>
    <li><a target="_brank" rel="noopener noreferrer" href="https://www.slideshare.net/serverworks/aws-121012921">いまさら、AWSのネットワーク設計</a></li>
    <li><a target="_brank" rel="noopener noreferrer" href="https://dev.classmethod.jp/cloud/aws/vpc-cidr/">Amazon VPC IPアドレス設計レシピ ｜ DevelopersIO</a></li>
    <li><a target="_brank" rel="noopener noreferrer" href="https://dev.classmethod.jp/cloud/aws/vpc-knowhow-2014-04/">【AWS】VPC環境構築ノウハウ社内資料 2014年4月版 ｜ DevelopersIO</a></li>
    <li><a target="_brank" rel="noopener noreferrer" href="https://recruit-tech.co.jp/blog/2018/11/20/iac_terraform/">リクルートテクノロジーズ　メンバーズブログ  Infrastructure as Codeによるインフラ運用：AWSアカウント分離とリソースのコード化</a></li>
    <li><a target="_brank" rel="noopener noreferrer" href="http://www.faqs.org/rfcs/rfc1918.html">RFC 1918</a></li>
</ul>

</body>
