---
layout: post
Categories:  ["tech"]
Description:  " はじめに  Ubuntu 16.04でPostfix 3.0+Dovecot 2.2+Dovecot SASLでのメールサーバ構築メモです。PostfixではSMTPsを、DovecotではIMAPs , POP3sを有効にします。 "
Tags: ["Dovecot", "Postfix", "tech", "Ubuntu"]
date: "2016-06-17T23:48:00+09:00"
title: "Ubuntu 16.04でPostfix 3.0+Dovecot 2.2+Dovecot SASLでメールサーバ構築"
author: "dshimizu"
archive: ["2016"]
draft: "true"
---

<body>
<h3>はじめに</h3>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a> 16.04で<a class="keyword" href="http://d.hatena.ne.jp/keyword/Postfix">Postfix</a> 3.0+<a class="keyword" href="http://d.hatena.ne.jp/keyword/Dovecot">Dovecot</a> 2.2+<a class="keyword" href="http://d.hatena.ne.jp/keyword/Dovecot">Dovecot</a> SASLでのメールサーバ構築メモです。
<a class="keyword" href="http://d.hatena.ne.jp/keyword/Postfix">Postfix</a>ではSMTPsを、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Dovecot">Dovecot</a>ではIMAPs , POP3sを有効にします。</p>
</body>

<!-- more -->

<body>
<h3>構築手順</h3>


<h4>環境</h4>


<table>
<tbody>
<tr>
<th>OS</th>
<td>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a> 16.04 LTS(4.4.0-21-generic)</td>
</tr>
<tr>
<th>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/SMTP">SMTP</a>ソフトウェア</th>
<td>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/Postfix">Postfix</a> Version 3.1.0-3</td>
</tr>
<tr>
<th>POP/<a class="keyword" href="http://d.hatena.ne.jp/keyword/IMAP">IMAP</a>ソフト</th>
<td>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/dovecot">dovecot</a> (<a class="keyword" href="http://d.hatena.ne.jp/keyword/dovecot">dovecot</a>-imapd,<a class="keyword" href="http://d.hatena.ne.jp/keyword/dovecot">dovecot</a>-pop3d) Version 2.2.22</td>
</tr>
</tbody>
</table>


<h4>事前準備</h4>


<h5>必要パッケージのインストール</h5>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Postfix">Postfix</a>と<a class="keyword" href="http://d.hatena.ne.jp/keyword/dovecot">dovecot</a>関連のパッケージをインストールします。</p>

<pre class="terminal"> $ sudo apt-get install postfix dovecot-core dovecot-imapd dovecot-pop3d
 </pre>


<h4>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/Postfix">Postfix</a>の設定</h4>


<p><code>/etc/postfix/main.cf</code>を作成します。
<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a> 16.04 LTSの<a class="keyword" href="http://d.hatena.ne.jp/keyword/Postfix">Postfix</a> 3.0では<code>/usr/share/postfix/main.cf.dist</code>にサンプルファイルがあるのでそれを元にしても良いですし、新規に作成しても良いです。</p>

<pre class="terminal"> ### Postfixの互換レベル設定
compatibility_level = 2

### 基本設定
command_directory = /usr/sbin
daemon_directory = /usr/lib/postfix/sbin
data_directory = /var/lib/postfix
myhostname = ホスト名
mydomain = メールサーバのドメイン名
myorigin = $mydomain
unknown_local_recipient_reject_code = 550
mynetworks_style = host, localhost
mynetworks = xxx.xxx.xxx.xxx/32, localhost, 127.0.0.0/8
relay_domains = $mydestination
smtpd_banner = $myhostname ESMTP unknown
debugger_command =
     PATH=/bin:/usr/bin:/usr/local/bin:/usr/X11R6/bin
     ddd $daemon_directory/$process_name $process_id &amp; sleep 5
inet_protocols = ipv4

### 受信も必要な場合は以下を設定。
### mydestinationは最終配送先の設定で、メールアドレスの「@」の右側が mydestination の指定に一致すると、そのメールは他のサーバには配送せず、自ホスト内で処理しようとする。 
### 末尾のほうにあるvirtual_mailbox_domainsを設定している場合には、mydestinationも設定していると受信時にエラーが発生するのでここでは空の値を設定。
### virtual_mailbox_domainsがない場合は$myhostname, $mydomain, localhostあたりを設定しておけば良いはず。
inet_interfaces = all
mydestination =
#mydestination = $myhostname, $mydomain, localhost

### 証明書設定(ここではUbuntu標準のものを指定、必要であれば別途作成)
smtpd_tls_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem
smtpd_tls_key_file=/etc/ssl/private/ssl-cert-snakeoil.key

### アクセス制御等
smtpd_helo_required = yes
smtpd_recipient_restrictions = permit_mynetworks,permit_sasl_authenticated,reject_unauth_destination
smtpd_client_restrictions = permit_mynetworks,reject_invalid_hostname,permit
smtpd_etrn_restrictions = permit_mynetworks, reject_invalid_hostname
smtpd_recipient_limit = 100

smtpd_helo_required = yes
disable_vrfy_command = yes
strict_rfc821_envelopes = yes
allow_percent_hack = yes
swap_bangpath = yes
allow_untrusted_routing = no
disable_vrfy_command = yes
alias_maps = hash:/etc/aliases

### sasl関連設定
smtpd_sasl_auth_enable = yes
smtpd_sasl_type = dovecot
smtpd_sasl_path = private/auth
smtpd_sasl_security_options = noanonymous
smtpd_sasl_local_domain = $myhostname


### 送受信用仮想ドメイン/仮想ユーザの設定
virtual_mailbox_domains = ドメイン名
virtual_mailbox_base = /home/vmail
virtual_mailbox_maps = hash:/etc/postfix/vmailbox
virtual_uid_maps = static:15000
virtual_gid_maps = static:15000
 </pre>


<p><code>/etc/postfix/master.cf</code>を編集します。
以下4行を<del datetime="2017-06-26T15:45:38+00:00"><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B3%A5%E1%A5%F3%A5%C8%A5%A2%A5%A6%A5%C8">コメントアウト</a></del>(※2017/6/27コメント指摘事項修正) アンコメントします。</p>

<pre class="terminal"> submission inet n       -       y       -       -       smtpd
  -o smtpd_sasl_auth_enable=yes

smtps     inet  n       -       y       -       -       smtpd
  -o smtpd_tls_wrappermode=yes
 </pre>


<h4>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/Dovecot">Dovecot</a>の設定</h4>


<p><code>/etc/dovecot/dovecot.conf</code>を編集します。</p>

<pre class="terminal"> ### IPv4のみ有効化
listen = *

### インクルードするファイルの指定
!include conf.d/*.conf
!include_try local.conf
!include_try /usr/share/dovecot/protocols.d/*.protocol
 </pre>


<p><code>/etc/dovecot/conf.d/10-master.conf</code>を編集します。</p>

<pre class="terminal">  service imap-login {
   inet_listener imap {
    ### imap無効化
    port = 0 
   }
   inet_listener imaps {
    ### imaps有効化
    port = 993
    ssl = yes
   }

 service pop3-login {
   inet_listener pop3 {
    ### pop3無効化
    port = 0
   }
   inet_listener pop3s {
    ### pop3s有効化
    port = 995
    ssl = yes
   }
 }

  unix_listener /var/spool/postfix/private/auth {
    mode = 0666
    ### private/authの権限をpostfixへ変更
    user = postfix
    group = postfix
  }
 </pre>


<p><code>/etc/dovecot/conf.d/10-auth.conf</code>を編集します。</p>

<pre class="terminal"> ### PlainText認証を無効化
disable_plaintext_auth = yes

### 認証メカニズムに cram-md5 を利用可能にします。
auth_mechanisms = plain login digest-md5

### auth-system.conf.extファイルのインクルードを停止
#!include auth-system.conf.ext

### auth-static.conf.extファイルのインクルードを有効化
!include auth-static.conf.ext
 </pre>


<p><code>/etc/dovecot/conf.d/10-mail.conf</code>を編集します。</p>

<pre class="terminal"> ### メールの配置先指定
mail_location = maildir:/home/vmail/%d/%n/Maildir

namespace inbox {
  inbox = yes
}

### メールプロセスのchroot先指定
valid_chroot_dirs = /home/vmail/%d/

### UIDLフォーマット指定
pop3_uidl_format = %08Xu%08Xv
 </pre>


<p><code>/etc/dovecot/conf.d/10-ssl.conf</code>を編集します。</p>

<pre class="terminal"> ### sslを有効化
ssl = yes
### 証明書設定(ここではUbuntu標準のものを指定、必要であれば別途作成)
ssl_cert = &lt;/etc/ssl/certs/ssl-cert-snakeoil.pem
ssl_key = &lt;/etc/ssl/private/ssl-cert-snakeoil.key
 </pre>


<p><code>/etc/dovecot/conf.d/auth-static.conf.ext</code>を編集します。</p>

<pre class="terminal"> passdb {
  driver = passwd-file
  args = scheme=CRYPT username_format=%u /etc/dovecot/users
}

userdb {
  driver = static
  args = uid=vmail gid=vmail home=/home/vmail/%d/%n
}
 </pre>


<h4>バーチャ<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EB%A5%E1%A1%BC%A5%EB">ルメール</a>ボックスとメールユーザの設定</h4>


<h5>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/Postfix">Postfix</a>のバーチャ<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EB%A5%E1%A1%BC%A5%EB">ルメール</a>ボックス設定</h5>


<p>バーチャ<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EB%A5%E1%A1%BC%A5%EB">ルメール</a>ボックスを使うことにします。ユーザ管理はOSユーザアカウントではなく、仮想ユーザで管理されます。</p>

<p>バーチャ<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EB%A5%E1%A1%BC%A5%EB">ルメール</a>ボックスの所有者となるユーザ・グループを作成します。
ここでは<code>uid/gid</code>が<code>15000</code>の、<code>vmail</code>というユーザ・グループを作成します。</p>

<pre class="terminal"> $ sudo groupadd -g 15000 vmail
$ sudo useradd -u 15000 -g vmail -s /bin/false -d /home/vmail -m vmail
 </pre>


<p>メールの送受信に使う仮想ユーザとメー<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EB%A5%DC%A5%C3%A5%AF%A5%B9">ルボックス</a>の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%DE%A5%C3%A5%D4%A5%F3%A5%B0">マッピング</a>を <code>/etc/postfix/vmailbox</code> に記載します。</p>

<pre class="terminal"> $ sudo vi /etc/postfix/vmailbox
 </pre>


<p>書式は以下のような形です。</p>

<pre class="text"> ユーザ名@ドメイン名 ユーザ名/Maildir/
 </pre>


<p>記載したら<code>postmap</code>を実行してDBを生成します。</p>

<pre class="terminal"> $ sudo postmap /etc/postfix/vmailbox
 </pre>


<p>ファイルができていることを確認します。</p>

<pre class="terminal"> $ ls /etc/postfix/vmailbox*
/etc/postfix/vmailbox  /etc/postfix/vmailbox.db
 </pre>


<h5>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/imap">imap</a>/<a class="keyword" href="http://d.hatena.ne.jp/keyword/pop3">pop3</a>認証ユーザ設定</h5>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Dovecot">Dovecot</a>での<a class="keyword" href="http://d.hatena.ne.jp/keyword/imap">imap</a>/<a class="keyword" href="http://d.hatena.ne.jp/keyword/pop3">pop3</a>認証用のユーザとパスワードの<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%DE%A5%C3%A5%D4%A5%F3%A5%B0">マッピング</a>ファイルを作成します。
まず、<code>doveadm</code>でパスワードを生成します。</p>

<pre class="terminal"> $ sudo doveadm pw
Enter new password:
Retype new password:
{CRAM-MD5}xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
 </pre>


<p>生成されたパスワードをユーザ名とともに<code>/etc/dovecot/users</code>ファイルに記載します。</p>

<pre class="terminal"> $ sudo vi /etc/dovecot/users
 </pre>


<p>書式は以下のような形です。</p>

<pre class="terminal"> ユーザ名:{CRAM-MD5}xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
 </pre>


<h3>おわりに</h3>


<p>以上、Postfix3.0+Dovecot2.2でのメールサーバ構築の簡単なメモでした。</p>

<h3>参考</h3>


<ul>
    <li><a href="http://www.postfix.org/BASIC_CONFIGURATION_README.html" target="_blank" rel="noopener noreferrer">Postfix Basic Configuration</a></li>
    <li><a href="http://www.postfix.org/postconf.5.html" target="_blank" rel="noopener noreferrer">Postfix Configuration Parameters</a></li>
    <li><a href="http://www.postfix-jp.info/trans-2.3/jhtml/VIRTUAL_README.html" target="_blank" rel="noopener noreferrer">Postfix バーチャルドメインホスティング Howto</a></li>
    <li><a href="http://wiki.dovecot.org/MailLocation" target="_blank" rel="noopener noreferrer">MailLocation - Dovecot Wiki</a></li>
    <li><a href="http://wiki.dovecot.org/SSL/DovecotConfiguration" target="_blank" rel="noopener noreferrer">SSL/DovecotConfiguration - Dovecot Wiki</a></li>
    <li><a href="http://wiki.dovecot.org/Authentication/Mechanisms" target="_blank" rel="noopener noreferrer">Authentication/Mechanisms - Dovecot Wiki</a></li>
    <li><a href="http://www.maruko2.com/mw/Postfix_%E3%81%A7_Submission_%E3%83%9D%E3%83%BC%E3%83%88%E8%A8%AD%E5%AE%9A_(OP25B%E5%AF%BE%E7%AD%96)" target="_blank" rel="noopener noreferrer">Postfix で Submission ポート設定 (OP25B対策) - maruko2 Note.</a></li>
    <li><a href="http://www.goofoo.jp/2012/01/1698" target="_blank" rel="noopener noreferrer">Postfix + Dovecot でSMTP Auth (Dovecot SASL) のメール環境構築 | グーフー WordPressのためのLinuxノート</a></li>
    <li><a href="http://qiita.com/dribble13/items/36847b944caed440d714" target="_blank" rel="noopener noreferrer">PostfixとDovecotでバーチャルメールボックスの設定をする - Qiita</a></li>
</ul>

</body>
