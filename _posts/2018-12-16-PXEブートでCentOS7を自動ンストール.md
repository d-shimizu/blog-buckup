---
layout: post
Categories:  ["tech"]
Description:  " こちらの記事でUbuntu16.04LTSへPXEブートをするための環境を作った。この時はUbuntu16.04LTSを自動インストールする環境のみ作ったがCentOS7も使いたかったので、CentOS7を自動インストールする設定も追加し"
Tags: ["CentOS", "tech", "Ubuntu"]
date: "2018-12-16T17:10:00+09:00"
title: "PXEブートでCentOS7を自動ンストール"
author: "dshimizu"
archive: ["2018"]
draft: "true"
---

<body>
<p><a target="_brank" rel="noopener noreferrer" href="https://blog.dshimizu.jp/article/901">こちらの記事</a>でUbuntu16.04LTSへ<a class="keyword" href="http://d.hatena.ne.jp/keyword/PXE">PXE</a>ブートをするための環境を作った。
この時はUbuntu16.04LTSを自動インストールする環境のみ作ったがCentOS7も使いたかったので、CentOS7を自動インストールする設定も追加してみたときの手順を書いておく。</p>

<p>なお、以下の手順は<a target="_brank" rel="noopener noreferrer" href="https://blog.dshimizu.jp/article/901">こちらの記事</a>にある<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a>にTFTPサーバと<a class="keyword" href="http://d.hatena.ne.jp/keyword/DHCP">DHCP</a>サーバの設定は行ってあるものとする。</p>
</body>

<!-- more -->

<body>
<h3>手順</h3>


<h4>SFTPの準備</h4>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a>の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A4%A5%F3%A5%B9%A5%C8%A1%BC%A5%E9">インストーラ</a>の起動にはTFTPだけで良かったが、<a class="keyword" href="http://d.hatena.ne.jp/keyword/CentOS">CentOS</a>ではSFTPも必要となるため、vsftpdのパッケージをインストールする。</p>

<pre class="terminal"> $ sudo apt install vsftpd
 </pre>


<p>続いて、ブートに必要なファイルの設置場所だが、<code>/var/lib/tftpboot/</code>を利用する。
<code>/var/lib/tftpboot/</code>はTFTPサーバ(<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a>ではtftpd-hpa)が使う<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リとして<code>/etc/default/tftp</code>で指定していたものだが、<a target="_brank" rel="nopener noopener noreferrer" href="https://blog.dshimizu.jp/article/901">前回の記事</a>にある<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a>のブート関連ファイルの設置場所と合わせるためにここを使っているが、環境に合わせて設定すれば良い。これは<code>/etc/vsftpd.conf</code>の<code>local_root</code>パラメータで指定できる。</p>

<p>合わせて<code>anonymous_enable</code>と<code>pasv_enable</code>をYESへと変更する。</p>

<ul>
    <li>
<code>/etc/vsftpd.conf</code>の変更点</li>
</ul>
<pre class="terminal"> @@ -22,7 +22,8 @@
 listen_ipv6=YES
 #
 # Allow anonymous FTP? (Disabled by default).
-anonymous_enable=NO
+anonymous_enable=YES
 #
 # Uncomment this to allow local users to log in.
 local_enable=YES
@@ -153,3 +154,7 @@
 #
 # Uncomment this to indicate that vsftpd use a utf8 filesystem.
 #utf8_filesystem=YES
+
+
+local_root=/var/lib/tftpboot
+pasv_enable=YES
 </pre>



<p>ということで<code>/var/lib/tftpboot/</code>以下に<code>centos/7/pub</code>という<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リを掘っておく。</p>

<pre class="terminal"> $ sudo mkidr -p /var/lib/tftpboot/centos/7/pub
 </pre>


<h4>CentOS7のブートに必要なファイルの準備</h4>


<p>CentOS7の最新ISOを取得する。12/16時点では <a class="keyword" href="http://d.hatena.ne.jp/keyword/CentOS">CentOS</a> 7.5 18.10。
適当に<a class="keyword" href="http://d.hatena.ne.jp/keyword/IIJ">IIJ</a>のミラーから取得したがどこからとってきても良い。</p>

<pre class="terminal"> $ wget http://ftp.iij.ad.jp/pub/linux/centos/7/isos/x86_64/CentOS-7-x86_64-Minimal-1810.iso -P /tmp
 </pre>


<p>適当に<code>/mnt/iso</code>とか作ってISOイメージをマウントする。</p>

<pre class="terminal"> $ sudo mkdir /mnt/iso
$ sudo mount -t iso9660 -o,ro /tmp/CentOS-7-x86_64-Minimal-1810.iso /mnt/iso/
 </pre>


<p>必要なファイルを<code>/var/lib/tftpboot/</code>以下にコピーする。</p>

<pre class="terminal"> $ sudo cp -pr /mnt/iso/isolinux/initrd.img  /var/lib/tftpboot/centos/7/
$ sudo cp -pr /mnt/iso/isolinux/vmlinuz  /var/lib/tftpboot/centos/7/
$ sudo cp -pr /mnt/iso/*  /var/lib/tftpboot/centos/7/pub/
$ sudo cp -pr /mnt/iso/*  /var/lib/tftpboot/centos/7/pub/
$ sudo cp -pr /mnt/iso/.treeinfo /var/lib/tftpboot/centos/7/pub/
 </pre>


<h4>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/kickstart">kickstart</a>ファイルの作成</h4>


<p><code>/var/lib/tftpboot/centos/7/pub/kickstart/centos7.cfg</code>をとりあえずこんな感じのものでを置いておけば良い。
細かいことをしたければもっと詳細に書けば良いけど動作確認を主目的とするので適当にしておく。</p>

<pre class="terminal"> cmdline
install
url --url="ftp://user:password@192.168.34.68/centos/7/pub"

lang ja_JP.UTF-8
keyboard --vckeymap=jp --xlayouts='jp'
timezone Asia/Tokyo --isUtc --nontp

network --bootproto=dhcp --ipv6=auto --activate --hostname=centos

#rootpw --plaintext password
rootpw --iscrypted $1$2c5VfLZS$WKO3i5/aJrKMDe9fudZ/p0

user --groups=wheel --name=centos $1$2c5VfLZS$WKO3i5/aJrKMDe9fudZ/p0 --iscrypted

zerombr
bootloader --location=mbr


clearpart --all --initlabel
part / --fstype=xfs --grow --size=1 --asprimary --label=root

auth --enableshadow --passalgo=sha512
selinux --disabled
firewall --disabled
firstboot --disabled

reboot

%packages
%end
 </pre>


<h4>CentOS7の<a class="keyword" href="http://d.hatena.ne.jp/keyword/PXE">PXE</a>ブート設定</h4>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/PXE">PXE</a>ブート時のメニュー画面を出す<code>/var/lib/tftpboot/boot-screens/menu.cfg</code>へ、<a class="keyword" href="http://d.hatena.ne.jp/keyword/CentOS">CentOS</a>のメニューを追加する。
<code>user:password</code>のところは<code>/var/lib/tftpboot/centos/7/pub</code>以下にあるファイルを取得するために使用するOSユーザとそのパスワードに書き換える。</p>

<pre class="terminal"> menu title Installer boot menu
label auto-install-centos7
        menu label ^CentOS 7 x64 auto install
        kernel centos/7/vmlinuz
        append initrd=centos/7/initrd.img inst.repo=ftp://user:password@10.1.1.129/centos/7/pub ks=ftp://user:password@10.1.1.129/centos/7/pub/kickstart/centos7.cfg
        #append initrd=centos/7/initrd.img method=http://ftp.riken.jp/Linux/centos/7
label auto-install-ubuntu-16.04
        menu label ^Ubuntu 16.04 auto install
        kernel ubuntu/xenial/ubuntu-installer/amd64/linux
        append auto=true priority=critical vga=788 initrd=ubuntu/xenial/ubuntu-installer/amd64/initrd.gz preseed/url=tftp://10.1.1.129/ubuntu/xenial/preseed/preseed.cfg preseed/interactive=false
label ubuntu-16.04
        menu title Ubuntu 16.04
        include ubuntu/xenial/ubuntu-installer/amd64/boot-screens/menu.cfg
label centos7
        menu label ^CentOS 7 x64
        kernel centos/7/vmlinuz
        append initrd=centos/7/initrd.img inst.repo=ftp://user:password@10.1.1.129/centos/7/pub
        label mainmenu
                menu label ^Back..
                menu exit
menu end
 </pre>


<p>後はこれでネットワークブートさせれば起動する。</p>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/KVM">KVM</a>のゲストを起動させて<a class="keyword" href="http://d.hatena.ne.jp/keyword/PXE">PXE</a>ブートさせるとすれば例えば以下(以下はあくまで例なので特に--networkのオプションとかは環境に合わせて修正する。--<a class="keyword" href="http://d.hatena.ne.jp/keyword/pxe">pxe</a>は必須。)のような感じでやると<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A4%A5%F3%A5%B9%A5%C8%A1%BC%A5%E9">インストーラ</a>が起動して自動インストールが始まる。</p>

<pre class="terminal"> $ virt-install \
    --connect qemu:///system \
    -n centos7-pxe-test01 \
    --ram 2048 \
    --vcpus 1 \
    --network type=direct,source=eno1,source_mode=bridge,model=virtio \
    --pxe \
    --graphics vnc,listen=0.0.0.0,port=5990 \
    --noautoconsole \
    --disk size=10,path=/var/lib/libvirt/images/centos7-pxe-test01.img \
    --debug 
 </pre>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/VNC">VNC</a> Viewerとかを使って画面を表示させ、インストールが開始されれば成功。</p>




<h3>まとめ</h3>


<p>Ubuntu16.04LTSの<a class="keyword" href="http://d.hatena.ne.jp/keyword/PXE">PXE</a>ブートサーバを使ってCentOS7を自動インストールさせる方法について書いた。</p>
</body>
