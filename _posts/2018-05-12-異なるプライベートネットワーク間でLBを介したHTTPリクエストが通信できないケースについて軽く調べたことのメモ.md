---
layout: post
Categories:  ["tech"]
Description:  " 異なる2つのプライベートネットワークにあるサーバ間の通信において、間にロードバランサ機器を介したHTTP通信ができないケースがあるが、なんでそうなるのかちゃんとわかっていなかったので、調べたのでメモとして記録しておく。 "
Tags: ["Network", "tech"]
date: "2018-05-12T21:22:00+09:00"
title: "異なるプライベートネットワーク間でLBを介したHTTPリクエストが通信できないケースについて軽く調べたことのメモ"
author: "dshimizu"
archive: ["2018"]
draft: "true"
---

<body>
<p>異なる2つのプライベートネットワークにあるサーバ間の通信において、間にロードバランサ機器を介したHTTP通信ができないケースがあるが、なんでそうなるのかちゃんとわかっていなかったので、調べたのでメモとして記録しておく。</p>
</body>

<!-- more -->

<body>
<h4>通信の状態</h4>


<p>ネットワーク構成は以下のような感じ。
Server#1 からロードバランサが持つVIPを経由してServer#2, Server#3にHTTPリク<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A8%A5%B9">エス</a>トをしたい、というもの。</p>

<p><img src="https://blog.d-shimizu.io/wp-content/uploads/test-network.png" alt="" width="518" height="404" class="aligncenter size-full wp-image-1086"></p>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C7%A5%D5%A5%A9%A5%EB%A5%C8%A5%B2%A1%BC%A5%C8%A5%A6%A5%A7%A5%A4">デフォルトゲートウェイ</a>はL3SWになっているので、行きと戻りの通信が異なるせいだとは思っていたけど実際HTTP通信がどうなっているのかちゃんとわかっていなかったのでパケットを見てみたら以下のような感じになっていた。</p>

<ol>
    <li>Server#1 から LB(のVIP)に対して HTTP リク<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A8%A5%B9">エス</a>トを送る。</li>
    <li>Server#1 から LB(のVIP)に対して SYN が送られる。</li>
    <li>LB から Server#1 に対して SYN, ACK が送られる。</li>
    <li>Server#1 から LB(のVIP)に対して SYN が送られる。</li>
    <li>Server#1 から LB(のVIP)に対して HTTP リク<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A8%A5%B9">エス</a>トが送られる(LBでいったん終端して、配下のサーバにリク<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A8%A5%B9">エス</a>トが流れる？)。</li>
    <li>LB配下のサーバ Sever#2 or #3 から Server#1 に対して SYN, ACK が送られる。</li>
    <li>Server#1 から Sever#2 or #3 に対して RST が送られる。</li>
    <li>Sever#2 or #3 から Server#1 に対して <a class="keyword" href="http://d.hatena.ne.jp/keyword/TCP">TCP</a> Previous segument not capture が送られる。</li>
    <li>6と7の繰り返し</li>
</ol>


<p>最初のHTTPリク<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A8%A5%B9">エス</a>トがLB配下のサーバに到達した後の戻り通信のやり取りが Server#1 ←→ Sever#2 or #3 になってしまい、<a class="keyword" href="http://d.hatena.ne.jp/keyword/TCP">TCP</a>が整合性を取れなくなって通信の中断、パケットを失った、という形になっている模様。</p>

<h4>解決策</h4>


<p>この構成で問題を解消するにはLBを通る段階でSrc IPをNATするようにして行きと戻りの通信を同じような経路になるようにするとか、L7の制御が不要ならL3DSRを組むのでも行けると思う。
BIG-IPだとSNAT Poolという設定ができるがこういうときのためにあるんだと思う。</p>

<h3>まとめ</h3>


<p>あんまりわかっていなかった件について、とりあえず調べて、まだそんなにわかっていないけどいったんメモとして書いた。</p>

<h3>参考</h3>


<ul>
    <li><a href="http://monaski.hatenablog.com/entry/2015/10/31/014026" target="_brank" rel="noopener noreferrer">行きと帰りのルーティングが違うときに通信ができない - conf t</a></li>
    <li><a href="https://www.slideshare.net/ryuichitakashima3/ss-72343772" target="_brank" rel="noopener noreferrer">ロードバランサ再入門</a></li>
</ul>

</body>
