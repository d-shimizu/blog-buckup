---
layout: post
Categories:  ["tech"]
Description:  " はじめに  第15回FreeBSD勉強会へ行ってきましたのでそのまとめです。 理解できていなかった部分や聞き取れなかった部分等は後で調べたりして記載していますが、誤りなどがあれば申し訳ありません。      第15回FreeBSD勉強会 "
Tags: ["FreeBSD", "勉強会"]
date: "2013-02-24T23:07:00+09:00"
title: "第15回 FreeBSD勉強会へ行ってきました"
author: "dshimizu"
archive: ["2013"]
draft: "true"
---

<body>
<h4>はじめに</h4>
<p>第15回<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a>勉強会へ行ってきましたのでそのまとめです。<br>理解できていなかった部分や聞き取れなかった部分等は後で調べたりして記載していますが、誤りなどがあれば申し訳ありません。 </p>
<ul>  <li><a href="https://www.bsdconsulting.co.jp/CGI/BSDC.CGI?CNT=FREEBSDSTUDY">第15回FreeBSD勉強会 インストーラを使わないでFreeBSDをインストールする方法</a></li>
</ul>
<a name="more"></a> <h4>勉強会の概要</h4>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a>に限った話ではないと思いますが、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Unix">Unix</a>/<a class="keyword" href="http://d.hatena.ne.jp/keyword/Linux">Linux</a>系OSの多くは<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A4%A5%F3%A5%B9%A5%C8%A1%BC%A5%E9">インストーラ</a>を利用してインストールを行うことが多いと思います。<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A4%A5%F3%A5%B9%A5%C8%A1%BC%A5%E9">インストーラ</a>はディスクのパーティショニング、kernel等各種ファイルの展開，その他基本的な初期設定などを代替で行ってくれるものですが、その裏ではコマンドを実行してこれらの処理を実行しているだけであり，<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A4%A5%F3%A5%B9%A5%C8%A1%BC%A5%E9">インストーラ</a>を使わなくても<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a>をインストールすることができます。 <br>今回の勉強会では、<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a>の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A4%A5%F3%A5%B9%A5%C8%A1%BC%A5%E9">インストーラ</a>が実施している内容やブートの仕組みについての解説、実際に<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A4%A5%F3%A5%B9%A5%C8%A1%BC%A5%E9">インストーラ</a>を使わない方法での<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a>のインストールを実演していただき、<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a>のインストールの仕組みを理解しよう、というものでした。 </p> <h5>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A4%A5%F3%A5%B9%A5%C8%A1%BC%A5%E9">インストーラ</a>とその役割</h5>
<p>まずは、<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a>のboot(起動)処理の仕組みについてのお話でした。 </p>
<p><strong><u><a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a>の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A4%A5%F3%A5%B9%A5%C8%A1%BC%A5%E9">インストーラ</a></u></strong></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a>の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A4%A5%F3%A5%B9%A5%C8%A1%BC%A5%E9">インストーラ</a>には以下の２つがあります。 </p>
<ul>  <li>sysinstall(<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a> 8.X以前)</li>  <li>bsdinstall(<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a> 9.X以降)</li>
</ul>
<p><strong><u><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A4%A5%F3%A5%B9%A5%C8%A1%BC%A5%E9">インストーラ</a>の役割</u></strong></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A4%A5%F3%A5%B9%A5%C8%A1%BC%A5%E9">インストーラ</a>は以下のことを実行するための手助けをしてくれます。これらは処理としては設定を行うためのコマンドが裏で実行されているだけです。 </p>
<ul>  <li>インストールメディアから、OSを起動するためのプログラムをディスクの決められた場所に配置する</li>  <li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D5%A5%A1%A5%A4%A5%EB%A5%B7%A5%B9%A5%C6%A5%E0">ファイルシステム</a>を作成する</li>  <li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D5%A5%A1%A5%A4%A5%EB%A5%B7%A5%B9%A5%C6%A5%E0">ファイルシステム</a>に必要な配布物/ソフトウェア類をコピーする</li>  <li>その他必要なOS初期設定を行う</li>
</ul> <h5>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a>のboot処理</h5>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a>のboot処理についてのお話です。 </p>
<p><strong><u><a class="keyword" href="http://d.hatena.ne.jp/keyword/MBR">MBR</a>によるboot処理</u></strong></p>
<ol>  <li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/BIOS">BIOS</a>がboot0を読み込む。</li>  </ol>
<ul>    <li>HWに搭載されている<a class="keyword" href="http://d.hatena.ne.jp/keyword/BIOS">BIOS</a>と呼ばれるプログラムがHDDの先頭512バイトを読み込んで実行する。</li>    <li>HDDの先頭512バイトはboot0と呼ばれる<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D6%A1%BC%A5%C8%A5%ED%A1%BC%A5%C0">ブートローダ</a>プログラムが書き込まれており、これが呼び出される。<a class="keyword" href="http://d.hatena.ne.jp/keyword/MBR">MBR</a>に相当する。</li>  </ul>  <li>boot0はboot1を読み込む。</li>  <ul>    <li>boot0はboot1を検索し実行するためのプログラム。boot1/2は<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D5%A5%A1%A5%A4%A5%EB%A5%B7%A5%B9%A5%C6%A5%E0">ファイルシステム</a>の外のディスクの決まった位置にあるためboot0はそこを読みに行く。</li>  </ul>  <li>boot1はboot2を読み込む。</li>  <ul>    <li>boot1はboot2を検索し実行するためのプログラム。boot1は512バイトのサイズである必要があるという制約があり、boot2と分かれている。</li>  </ul>  <li>boot2はloaderを起動する。</li>  <ul>    <li>boot2はUFS上の/boot/loaderを検索して起動するプログラム。UFS<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D5%A5%A1%A5%A4%A5%EB%A5%B7%A5%B9%A5%C6%A5%E0">ファイルシステム</a>を認識することができる。</li>  </ul>  <li>loaderは起動オプションに従ってkernelをロードする。</li>  <li>kernelはデ<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D0%A5%A4%A5%B9">バイス</a>やドライバの認識/初期化し、デ<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D0%A5%A4%A5%B9">バイス</a>ツリーを作成する。</li>  <li>initを実行する。</li>  <pre class="file">  BIOS → MBR(boot0) → boot1 → boot2 → /boot/loader → kernel → init ----    ----------    --------------    ------------------------------ BIOS    MBR           起動セクタ        UFSパーティション ※boot0/1/2はファイルシステムの外側にある </pre> <p><strong><u>GPTと<a class="keyword" href="http://d.hatena.ne.jp/keyword/UEFI">UEFI</a>の特徴と<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a>の対応</u></strong></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/MBR">MBR</a>では2TBを越えるディスクを管理できない(HDDの1セクタ512バイトの場合(512バイト×4バイト(=2の32乗(LBA(Logical Block Addressing)でアクセスできるセクタ数の上限)))という問題があり、昨今の大容量化するディスクに対応できません。そこで新たな規格としてGPTが出てきました。<br>さらに、<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a>では<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a> 9.0からGPTが正式にサポートされました。そのため、今後ブートの規格は<a class="keyword" href="http://d.hatena.ne.jp/keyword/MBR">MBR</a>ではなくGPTへ移行され、GPT化に伴って、従来の<a class="keyword" href="http://d.hatena.ne.jp/keyword/BIOS">BIOS</a>からGPTをサポートしている新しい<a class="keyword" href="http://d.hatena.ne.jp/keyword/BIOS">BIOS</a>である<a class="keyword" href="http://d.hatena.ne.jp/keyword/UEFI">UEFI</a>(<a class="keyword" href="http://d.hatena.ne.jp/keyword/Unified%20Extensible%20Firmware%20Interface">Unified Extensible Firmware Interface</a>)へ移行される予定とのことです。<br></p>
<ul>  <li>GPTでは、最大8ZB迄の領域を管理できる。</li>  <li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/MBR">MBR</a>は512Bの領域を必要とする。4<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D1%A1%BC%A5%C6%A5%A3%A5%B7%A5%E7%A5%F3">パーティション</a>までしか扱えない。GPTは17kBの領域を必要とする。128<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D1%A1%BC%A5%C6%A5%A3%A5%B7%A5%E7%A5%F3">パーティション</a>まで扱える。</li>  <li>GPTヘッダーと<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D1%A1%BC%A5%C6%A5%A3%A5%B7%A5%E7%A5%F3">パーティション</a>テーブルはディスクの先頭と最後部の両方に書き込まれている。</li>  <li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/UEFI">UEFI</a>は<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a>ではまだ未対応であり、今後開発が進められていく予定(UFS2に対応できていない)</li>  <br>  <p><strong>※<u>補足</u></strong></p>  <ul>    <li><a href="http://ja.wikipedia.org/wiki/GUID%E3%83%91%E3%83%BC%E3%83%86%E3%82%A3%E3%82%B7%E3%83%A7%E3%83%B3%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB">GUIDパーティションテーブル</a></li>    <li><a href="http://ja.wikipedia.org/wiki/Unified_Extensible_Firmware_Interface">Unified Extensible Firmware Interface</a></li>  </ul>
</ul>
<p><strong><u>GPTによるboot処理</u></strong></p>
<ol>  <li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/BIOS">BIOS</a>がpmbrを読み込む。</li>  <li>pmbrは<a class="keyword" href="http://d.hatena.ne.jp/keyword/Freebsd">Freebsd</a>-boot<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D1%A1%BC%A5%C6%A5%A3%A5%B7%A5%E7%A5%F3">パーティション</a>を読み込み、そこにあるgptbootを実行する。</li>  <li>gptbootは<a class="keyword" href="http://d.hatena.ne.jp/keyword/freebsd">freebsd</a>-ufs<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D1%A1%BC%A5%C6%A5%A3%A5%B7%A5%E7%A5%F3">パーティション</a>を読み込み、UFS<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D5%A5%A1%A5%A4%A5%EB%A5%B7%A5%B9%A5%C6%A5%E0">ファイルシステム</a>上の/boot/loaderを実行する。</li>
<pre class="file">  BIOS → pmbr → gptboot      → /boot/loader → kernel → init ----    ----    ------------    ------------------------------ BIOS    GPT     freebsd-boot    freebsd-ufs  </pre>  <li>loaderは起動オプションに従ってkernelをロードする。</li>  <li>kernelはデ<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D0%A5%A4%A5%B9">バイス</a>やドライバの認識/初期化し、デ<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D0%A5%A4%A5%B9">バイス</a>ツリーを作成する。</li>  <li>initを実行する。</li>
</ol>
<p><strong><u>PMBR(Protective Master Boot Record)</u></strong></p>
<p></p>
<ul>  <li>GPTで利用される<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D6%A1%BC%A5%C8%A5%ED%A1%BC%A5%C0">ブートローダ</a>。<a class="keyword" href="http://d.hatena.ne.jp/keyword/BIOS">BIOS</a>/<a class="keyword" href="http://d.hatena.ne.jp/keyword/UEFI">UEFI</a>から実行可能。現在の<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a>では<a class="keyword" href="http://d.hatena.ne.jp/keyword/BIOS">BIOS</a>からboot0/1/2と同じような形で必要なファイルを読み込み、起動している。</li>  <li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/freebsd">freebsd</a>-boot<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D1%A1%BC%A5%C6%A5%A3%A5%B7%A5%E7%A5%F3">パーティション</a>を探し出し、gptbootを実行する。</li>  <li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/MBR">MBR</a>の場合と比べて起動時の処理が一つ減る。</li>
</ul> <h5>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A4%A5%F3%A5%B9%A5%C8%A1%BC%A5%E9">インストーラ</a>とコマンドの対応</h5>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A4%A5%F3%A5%B9%A5%C8%A1%BC%A5%E9">インストーラ</a>が裏で実際に行っていることは、以下のように設定に必要なコマンドを実行しているだけであり、<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A4%A5%F3%A5%B9%A5%C8%A1%BC%A5%E9">インストーラ</a>を使わずともコマンドを実行していくことで<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a>をインストールすることができます。実演された内容の一部を記載します。<br></p>
<ul>  <li>キーマップの選択</li>  </ul>
<pre class="terminal"> % kbdmap = printf 'keymap="jp.106.kbd"\n' &gt;&gt; /etc/rc.conf </pre>  <p>※単にkbdmapコマンドを実行すると、キーボード設定用のコンソール画面が起動して設定できるので便利とのことでした。</p>
<br>  <li>ディスク領域の割り当て</li>
<br>  <p><strong><u>GPT<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D1%A1%BC%A5%C6%A5%A3%A5%B7%A5%E7%A5%F3">パーティション</a>作成</u></strong></p>  <pre class="terminal"> % gpart create -s gpt /dev/da0 </pre>  <p><strong><u>1番目のスライスに<a class="keyword" href="http://d.hatena.ne.jp/keyword/freebsd">freebsd</a>-boot<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D1%A1%BC%A5%C6%A5%A3%A5%B7%A5%E7%A5%F3">パーティション</a>作成</u></strong></p>  <pre class="terminal"> % gpart add -s 64K -b 34 -t freebsd-boot -l /boot/boot0 /dev/da0 </pre>  <p><strong><u>3番目のスライスに<a class="keyword" href="http://d.hatena.ne.jp/keyword/freebsd">freebsd</a>-swap<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D1%A1%BC%A5%C6%A5%A3%A5%B7%A5%E7%A5%F3">パーティション</a>作成</u></strong></p>  <pre class="terminal"> %gpart add -s 1G -t freebsd-swap -l swap0 /dev/da0 </pre>  <p><strong>※<u>ディスクフォーマット</u></strong></p>  <pre class="terminal"> % newfs -U /dev/デバイス名 </pre>  <li>ルートパスワードの設定</li>  <pre class="terminal"> % printf '********' | pw usermod -n root -h 0 </pre>  ※adduserなどの<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A4%A5%F3%A5%BF%A5%E9%A5%AF%A5%C6%A5%A3%A5%D6">インタラクティブ</a>なコマンドを使うより、"pw usermod"/"pw useradd"などを使う方が<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">スクリプト</a>化しやすく便利のようです。 <br><br>  <li>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BF%A5%A4%A5%E0%A5%BE%A1%BC%A5%F3">タイムゾーン</a>の設定</li>  <pre class="terminal"> % tzsetup Asia/Tokyo </pre>  <li>ダンプデータの保存先をswapデ<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D0%A5%A4%A5%B9">バイス</a>に設定</li>  <pre class="terminal"> % printf 'dumpdev="AUTO"\n' &gt;&gt; /etc/rc.conf % dumpon /dev/ada0p3 % ln -sf /dev/ada0p3 /dev/dumpdev 
</pre>
<p>これら<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A4%A5%F3%A5%B9%A5%C8%A1%BC%A5%E9">インストーラ</a>と同じ処理を行うコマンドを利用することで、インストール処理を<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">スクリプト</a>で自動化できるということです。<br>また、上記でechoではなくprintfを利用しているのは、echoは<a class="keyword" href="http://d.hatena.ne.jp/keyword/POSIX">POSIX</a>に準拠されていないためのようで、移植性を考えるとprintfを利用した方が良いとのことです。 </p>
<h5>その他</h5>
<ul>  <li><a href="http://2013.asiabsdcon.org/index.ja.html">AsiaBSDCon 2013</a></li>  <p>講師の後藤大地様よりAsiaBSDCon 2013のお知らせです。なお、スポンサーとして500万以上出すとG○○gle様より上に名前が載るそうです。 </p>  <li><a href="http://www.cloudcore.jp/vps/">CloudCore VPS｜KDDIウェブコミュニケーションズ</a></li>  <p>会場を御提供していただいた<a class="keyword" href="http://d.hatena.ne.jp/keyword/KDDI">KDDI</a>ウェブコミュニケーションズ様よりCloudCore <a class="keyword" href="http://d.hatena.ne.jp/keyword/VPS">VPS</a>の御紹介がありました。</p>
</ul> <h4>おわりに</h4>
<p>次回の<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a>勉強会では今回の内容を絡めた内容となるようですね。 </p>
<blockquote class="twitter-tweet" lang="ja">
<p>カスタマイズした自分だけの<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a> LiveUSBメモリスティックを作りたい方は、今回の<a class="keyword" href="http://d.hatena.ne.jp/keyword/FreeBSD">FreeBSD</a>勉強会の内容も聞いておいた方がよいかと思います <a href="http://t.co/ypQ5EdtcZj" title="http://atnd.org/events/35877">atnd.org/events/35877</a></p>— Daichi GOTOさん (@daichigoto) <a href="https://twitter.com/daichigoto/status/304850004282048512">2013年2月22日</a>
</blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>初心者向けということで<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A4%A5%F3%A5%B9%A5%C8%A1%BC%A5%E9">インストーラ</a>についてやboot処理、インストール処理の大枠は理解できたような気がしていますが、もっと実際にいろいろ触ってみたりマニュアルページに目を通したり以下の本を読み込むなどして理解を深めたいと思います。 <p>最後になりましたが、関係者の皆様、このような機会を提供いただきまして誠にありがとうございました。 </p>
<ul><li><a href="http://www.amazon.co.jp/%E5%AE%9F%E8%B7%B5-FreeBSD-%E3%82%B5%E3%83%BC%E3%83%90%E6%A7%8B%E7%AF%89%E3%83%BB%E9%81%8B%E7%94%A8%E3%82%AC%E3%82%A4%E3%83%89-%E4%BD%90%E3%80%85%E6%9C%A8-%E5%AE%A3%E6%96%87/dp/4774150479/ref=sr_1_1?ie=UTF8&amp;qid=1361712228&amp;sr=8-1">実践 FreeBSD サーバ構築・運用ガイド</a></li></ul>
</body>

<!-- more -->


