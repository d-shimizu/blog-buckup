---
title: "Debian 12 で pip でパッケージをインストールしようとしたらエラーが出るようになった"
date: 2023-09-18
slug: "Debian 12 で pip でパッケージをインストールしようとしたらエラーが出るようになった"
category: blog
tags: [Debian,Python]
---
<h2 id="はじめに">はじめに</h2>

<p><a class="keyword" href="https://d.hatena.ne.jp/keyword/Debian">Debian</a> を 12 にアップグレードしたことで、 pip を使おうと思ったら以下のエラーが出るようになりました。</p>

<pre class="code shell" data-lang="shell" data-unlink>% pip3 install --upgrade pip
error: externally-managed-environment

× This environment is externally managed
╰─&gt; To install Python packages system-wide, try apt install
    python3-xyz, where xyz is the package you are trying to
    install.

    If you wish to install a non-Debian-packaged Python package,
    create a virtual environment using python3 -m venv path/to/venv.
    Then use path/to/venv/bin/python and path/to/venv/bin/pip. Make
    sure you have python3-full installed.

    If you wish to install a non-Debian packaged Python application,
    it may be easiest to use pipx install xyz, which will manage a
    virtual environment for you. Make sure you have pipx installed.

    See /usr/share/doc/python3.11/README.venv for more information.

note: If you believe this is a mistake, please contact your Python installation or OS distribution provider. You can override this, at the risk of breaking your Python installation or OS, by passing --break-system-packages.
hint: See PEP 668 for the detailed specification.</pre>


<p>メッセージを見ると、システムにインストールする場合は python3-*** の形式のパッケージをインストールし、そうでない場合は venv か pipx を使うように、といったようなものに思われました。
pipx については私は使ったことがなくわかっていません。</p>

<p>詳細は PEP668を見るように、とあります。</p>

<h2 id="PEP-668">PEP 668</h2>

<p>下記にありますが、これまでにあった OS パッケージ マネージャーと pip などの <a class="keyword" href="https://d.hatena.ne.jp/keyword/Python">Python</a> 固有のパッケージ管理ツールとの間の競合の問題を解決するもののようです。
ユーザー管理のパッケージはグローバルな環境ではなく、<a class="keyword" href="https://d.hatena.ne.jp/keyword/Python">Python</a>仮想環境にインストールするように促していく、といったもののように思われます。</p>

<ul>
<li><a href="https://peps.python.org/pep-0668/">PEP 668 &ndash; Marking Python base environments as &ldquo;externally managed&rdquo; | peps.python.org</a></li>
</ul>


<blockquote><p>Abstract</p>

<p>A long-standing practical problem for <a class="keyword" href="https://d.hatena.ne.jp/keyword/Python">Python</a> users has been conflicts between OS package managers and <a class="keyword" href="https://d.hatena.ne.jp/keyword/Python">Python</a>-specific package management tools like pip. These conflicts include both <a class="keyword" href="https://d.hatena.ne.jp/keyword/Python">Python</a>-level <a class="keyword" href="https://d.hatena.ne.jp/keyword/API">API</a> incompatibilities and conflicts over file ownership.</p>

<p>Historically, <a class="keyword" href="https://d.hatena.ne.jp/keyword/Python">Python</a>-specific package management tools have defaulted to installing packages into an implicit global context. With the <a class="keyword" href="https://d.hatena.ne.jp/keyword/standardization">standardization</a> and popularity of virtual environments, a better solution for <a class="keyword" href="https://d.hatena.ne.jp/keyword/most">most</a> (but not all) use cases is to use <a class="keyword" href="https://d.hatena.ne.jp/keyword/Python">Python</a>-specific package management tools only within a virtual environment.</p>

<p>This PEP proposes a mechanism for a <a class="keyword" href="https://d.hatena.ne.jp/keyword/Python">Python</a> installation to communicate to tools like pip that its global package installation context is managed by some means external to <a class="keyword" href="https://d.hatena.ne.jp/keyword/Python">Python</a>, such as an OS package manager. It specifies that <a class="keyword" href="https://d.hatena.ne.jp/keyword/Python">Python</a>-specific package management tools should neither install nor remove packages into the <a class="keyword" href="https://d.hatena.ne.jp/keyword/interpreter">interpreter</a>’s global context, by default, and should instead guide the end user towards using a virtual environment.</p>

<p>It also standardizes an interpretation of the sysconfig schemes so that, if a <a class="keyword" href="https://d.hatena.ne.jp/keyword/Python">Python</a>-specific package manager is about to install a package in an <a class="keyword" href="https://d.hatena.ne.jp/keyword/interpreter">interpreter</a>-wide context, it can do so in a manner that will avoid conflicting with the external package manager and reduces the risk of breaking software shipped by the external package manager.</p></blockquote>

<h2 id="解決方法">解決方法</h2>

<p>内容はわかりました。</p>

<p>pipx のことはよくわかっていないので、今回はとりあえず<a class="keyword" href="https://d.hatena.ne.jp/keyword/Python">Python</a>仮想環境を使うようにしてみます。</p>

<h3 id="Python仮想環境作成"><a class="keyword" href="https://d.hatena.ne.jp/keyword/Python">Python</a>仮想環境作成</h3>

<p><a class="keyword" href="https://d.hatena.ne.jp/keyword/Python">Python</a>仮想環境を作成しようとしたら下記のエラーが出ました。</p>

<pre class="code shell" data-lang="shell" data-unlink>% python3 -m venv ~/.local/venv
The virtual environment was not created successfully because ensurepip is not
available.  On Debian/Ubuntu systems, you need to install the python3-venv
package using the following command.

    apt install python3.11-venv

You may need to use sudo with that command.  After installing the python3-venv
package, recreate your virtual environment.

Failing command: /home/dshimizu/.local/venv/bin/python3</pre>


<p><code>python3.11-venv</code> をインストールする必要があるようなのでインストールします。</p>

<pre class="code shell" data-lang="shell" data-unlink>% sudo apt install python3.11-venv</pre>


<p>仮想環境を作成します。</p>

<pre class="code shell" data-lang="shell" data-unlink>% python3 -m venv ~/.local/venv</pre>


<p>仮想環境を有効化します。</p>

<pre class="code shell" data-lang="shell" data-unlink>% cd ~/.local/venv

% source bin/activate
(venv) %</pre>


<p>パスが通り、使えるようになりました。</p>

<pre class="code shell" data-lang="shell" data-unlink>(venv) % which python3
/home/dshimizu/.local/venv/bin/python3</pre>


<p>pip でパッケージをインストールできるようになりました。</p>

<pre class="code shell" data-lang="shell" data-unlink>% python3 -m pip install pynvim
Collecting pynvim
  Using cached pynvim-0.4.3.tar.gz (56 kB)
  Preparing metadata (setup.py) ... done
Collecting greenlet
  Downloading greenlet-2.0.2-cp311-cp311-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (618 kB)
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 618.8/618.8 kB 15.3 MB/s eta 0:00:00
Collecting msgpack&gt;=0.5.0
  Downloading msgpack-1.0.5-cp311-cp311-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (325 kB)
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 325.1/325.1 kB 44.9 MB/s eta 0:00:00
Installing collected packages: msgpack, greenlet, pynvim
  DEPRECATION: pynvim is being installed using the legacy &#39;setup.py install&#39; method, because it does not have a &#39;pyproject.toml&#39; and the &#39;wheel&#39; package is not installed. pip 23.1 will enforce this behaviour change. A possible replacement is to enable the &#39;--use-pep517&#39; option. Discussion can be found at https://github.com/pypa/pip/issues/8559
  Running setup.py install for pynvim ... done
Successfully installed greenlet-2.0.2 msgpack-1.0.5 pynvim-0.4.3</pre>


<h2 id="まとめ">まとめ</h2>

<p><a class="keyword" href="https://d.hatena.ne.jp/keyword/Debian">Debian</a> 12 で pip でグローバルな環境にパッケージをインストールしようとするとエラーが出るようになったため、その原因と解消方法について書きました。</p>

<h2 id="参考">参考</h2>

<ul>
<li><a href="https://peps.python.org/pep-0668/">PEP 668 &ndash; Marking Python base environments as &ldquo;externally managed&rdquo; | peps.python.org</a></li>
<li><a href="https://gihyo.jp/admin/serial/01/ubuntu-recipe/0767">&#x7B2C;767&#x56DE; Debian 12 &quot;Bookworm&quot;&#x306E;&#x7D39;&#x4ECB; | gihyo.jp</a></li>
<li><a href="https://github.com/pypa/pip/commit/368c7b4c557e673b05b0f8cffc967d3e333eee19">Bump for release &middot; pypa/pip@368c7b4 &middot; GitHub</a></li>
<li><a href="https://blog.jp.square-enix.com/iteng-blog/posts/00043-play-with-the-pep668/">&#x4FFA;&#x6D41;&#xFF01;PEP668&#x3068;&#x3046;&#x307E;&#x304F;&#x3084;&#x3063;&#x3066;&#x3044;&#x304F;&#x65B9;&#x6CD5; | &#x30B9;&#x30AF;&#x30A8;&#x30CB; IT&#x30A8;&#x30F3;&#x30B8;&#x30CB;&#x30A2; &#x30D6;&#x30ED;&#x30B0;</a></li>
</ul>


