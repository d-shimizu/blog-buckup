---
layout: post
Categories:  ["tech"]
Description:  " KVMの仮想マシンイメージで CentOS 7.5-1804 をPXE Bootからkickstartでインストールを行おうとしたとき、インストーラは起動するもののブート・シーケンス途中で以下のようなエラーで止まった。  [  16.56"
Tags: ["CentOS", "tech"]
date: "2018-12-29T11:42:00+09:00"
title: "CentOS7.5のkickstart処理の途中でメモリ不足によるdracut-initqueue[XXXX]"
author: "dshimizu"
archive: ["2018"]
draft: "true"
---

<body>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/KVM">KVM</a>の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B2%BE%C1%DB%A5%DE%A5%B7%A5%F3">仮想マシン</a>イメージで <a class="keyword" href="http://d.hatena.ne.jp/keyword/CentOS">CentOS</a> 7.5-1804 を<a class="keyword" href="http://d.hatena.ne.jp/keyword/PXE">PXE</a> Bootから<a class="keyword" href="http://d.hatena.ne.jp/keyword/kickstart">kickstart</a>でインストールを行おうとしたとき、<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A4%A5%F3%A5%B9%A5%C8%A1%BC%A5%E9">インストーラ</a>は起動するもののブート・シーケンス途中で以下のようなエラーで止まった。</p>

<pre class="terminal"> [  16.563343] dracut-mount[2273]: Warning: Can't mount root filesystem
[  16.688087] dracut-mount[2273]: Warning: /dev/root does not exist
[  16.699366] dracut-mount[2273]: /lib/dracut-lib.sh line 1049: echo: write error: No space left on device
        Starting Dracut Emergency Shell...
Warning: /dev/root does not exist

Generating "/run/initramfs/rdsosreport.txt"

Entering emergency mode. Exit the shell to continue.
Type "journalctl" to view system logs.
You might want to tsave "/run/initramfs/rdsosreport.txt" to a USB stick or /boot
after mounting then and attach it to a bug report.

:/#
 </pre>

</body>

<!-- more -->

<body>
<h3 id="原因と回避策">原因と回避策</h3>


<p><code>No space left on device</code>とあるのでディスクスペースがないのかと思いつつも、出力をさかのぼっていると以下のようなエラーが出ていた。</p>

<pre class="terminal"> dracut-initqueue[1001]: /sbin/dmsquash-live-root: line 286: printf: write error: No space left on device
 </pre>


<p>Dracutは<a class="keyword" href="http://d.hatena.ne.jp/keyword/RHEL">RHEL</a>の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%B9%A5%C8%A5%EA%A5%D3%A5%E5%A1%BC%A5%B7%A5%E7%A5%F3">ディストリビューション</a>で使われているinitramfsを作成するためのツール。
その処理の中で実行されている<a target="_brank" rel="noopener noreferrer" href="https://github.com/dracutdevs/dracut/blob/master/modules.d/90dmsquash-live/dmsquash-live-root.sh">dmsquash-live-root.sh</a>は起動時にメモリに一時領域用の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D5%A5%A1%A5%A4%A5%EB%A5%B7%A5%B9%A5%C6%A5%E0">ファイルシステム</a>が作成されるもののようだが、そのための領域がないということらしい。</p>

<p>つまり<b>メモリが足りない</b>ということかと思いつつ、もう少し調べると<a class="keyword" href="http://d.hatena.ne.jp/keyword/RHEL">RHEL</a>のカスタマーポータルやBugzillaにも情報が上がっていた。</p>

<ul>
    <li><a target="_brank" rel="noopener noreferrer" href="https://bugzilla.redhat.com/show_bug.cgi?id=1314092">Bug 1314092 - f24 installation fails with 1GB ram | Red Hat Bugzilla</a></li>
    <li><a target="_brank" rel="noopener noreferrer" href="https://access.redhat.com/solutions/3293511">Kickstart on RHEL 7.3 fails with "/sbin/dmsquash-live-root: line 273: write error: No space left on device" - Red Hat Customer Portal</a></li>
</ul>


<p>どうやらメモリが2GB以上ないとだめらしい。</p>

<p>事象が発生したときに作成しようとした<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B2%BE%C1%DB%A5%DE%A5%B7%A5%F3">仮想マシン</a>のスペックは 1CPU / 1GB RAM / 10GB ストレージ だったので RAM を2GBにしたらうまくブートが行われた。</p>

<h3 id="まとめ">まとめ</h3>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/kickstart">kickstart</a>でのインストール時にメモリ不足によりブート処理が途中で止まる事象の原因その回避策について書いた。
新規作成時は2GB以上のメモリを使うようにしておきたい。</p>

<h3 id="参考">参考</h3>


<ul>
    <li><a target="_brank" rel="noopener noreferrer" href="https://bugzilla.redhat.com/show_bug.cgi?id=1314092">Bug 1314092 - f24 installation fails with 1GB ram | Red Hat Bugzilla</a></li>
    <li><a target="_brank" rel="noopener noreferrer" href="https://access.redhat.com/solutions/3293511">Kickstart on RHEL 7.3 fails with "/sbin/dmsquash-live-root: line 273: write error: No space left on device" - Red Hat Customer Portal</a></li>
    <li><a target="_brank" rel="noopener noreferrer" href="https://access.redhat.com/documentation/ja-jp/red_hat_enterprise_linux/6/html/deployment_guide/sec-verifying_the_initial_ram_disk_image">Red Hat Enterprise Linux 6 24.5. 初期 RAM ディスクイメージの検証 - Red Hat Customer Portal</a></li>
    <li><a target="_brank" rel="noopener noreferrer" href="https://dracut.wiki.kernel.org/index.php/Main_Page">Dracut Wiki</a></li>
    <li><a target="_brank" rel="noopener noreferrer" href="https://fedoraproject.org/wiki/LiveOS_image">LiveOS image - Fedora Project Wiki</a></li>
    <li><a target="_brank" rel="noopener noreferrer" href="https://github.com/dracutdevs/dracut/blob/master/modules.d/90dmsquash-live/dmsquash-live-root.sh">dracut/dmsquash-live-root.sh at master · dracutdevs/dracut</a></li>
    <li><a target="_brank" rel="noopener noreferrer" href="https://github.com/zfsonlinux/dracut/blob/master/modules.d/99base/dracut-lib.sh">dracut/dracut-lib.sh at master · zfsonlinux/dracut</a></li>
</ul>

</body>
