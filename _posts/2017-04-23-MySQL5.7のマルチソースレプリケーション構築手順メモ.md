---
layout: post
Categories:  ["tech"]
Description:  " 従来のMySQLレプリケーションではマスタ1台から複数台のスレーブへデータを同期するという1:Nの構成しか出来ませんでしたが、MySQL5.7.6〜実装されたマルチソースレプリケーションの昨日を使うと複数台のマスターから1台以上のスレーブ"
Tags: ["MySQL", "tech"]
date: "2017-04-23T12:26:00+09:00"
title: "MySQL5.7のマルチソースレプリケーション構築手順メモ"
author: "dshimizu"
archive: ["2017"]
draft: "true"
---

<body>
<p>従来の<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EC%A5%D7%A5%EA%A5%B1%A1%BC%A5%B7%A5%E7%A5%F3">レプリケーション</a>ではマスタ1台から複数台のスレーブへデータを同期するという1:Nの構成しか出来ませんでしたが、MySQL5.7.6〜実装されたマルチソース<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EC%A5%D7%A5%EA%A5%B1%A1%BC%A5%B7%A5%E7%A5%F3">レプリケーション</a>の昨日を使うと複数台のマスターから1台以上のスレーブへデータを同期できる構成が可能になります。</p>
</body>

<!-- more -->

<body>
<h3>マルチソース<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EC%A5%D7%A5%EA%A5%B1%A1%BC%A5%B7%A5%E7%A5%F3">レプリケーション</a>を試す</h3>


<p>今回は以下のような2台の master から1台の slave への<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EC%A5%D7%A5%EA%A5%B1%A1%BC%A5%B7%A5%E7%A5%F3">レプリケーション</a>してみます。</p>

<pre class="text"> ┌----------┐    ┌----------┐
｜ master01 ｜    ｜ master02 ｜
｜ [DB01]   ｜    ｜ [BD02]   ｜
└----------┘    └----------┘
      ｜                ｜
      ｜                ｜
      └-------+--------┘
               |
               |
        ┌----------┐
        ｜ slave01  ｜
        ｜ [DB01]   ｜
        ｜ [DB02]   ｜
        └----------┘
 </pre>


<h4>環境</h4>


<table>
<tbody>
<tr>
<th>OS</th>
<td>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a> 16.04 LTS</td>
</tr>
<tr>
<th><a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a></th>
<td>5.7.17 (<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a> オフィシャルパッケージ)</td>
</tr>
</tbody>
</table>


<h4>構築手順</h4>


<h5>マスター1側の準備</h5>


<p>設定ファイルを確認します。
最低限以下のような設定になっていなければ設定して反映します。</p>

<pre class="terminal"> # サーバIDはほかのホストと被らないように
server-id               = 10001
# binaly-logの出力
log_bin                 = /var/log/mysql/mysql-bin.log

### 他のサーバホストから接続できるように bind-address をコメントアウト
#bind-address           = 127.0.0.1
 </pre>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EC%A5%D7%A5%EA%A5%B1%A1%BC%A5%B7%A5%E7%A5%F3">レプリケーション</a>用<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>ユーザ作成します。</p>

<pre class="terminal"> mysql&gt; GRANT REPLICATION SLAVE ON *.* TO 'repl'@'%' IDENTIFIED BY '********';
 </pre>


<p>マスターからダンプ取得します。
オプションは環境に応じて必要なものを付け加えてください。</p>

<pre class="terminal"> $ mysqldump -u root -p --single-transaction --master-data=2 [DB名] [テーブル名] | gzip &gt; db1.dump.sql.gz 
 </pre>


<h5>マスター2側の準備</h5>


<p>設定ファイルを確認します。
最低限以下のような設定になっていなければ設定して反映します。</p>

<pre class="terminal"> # サーバIDはほかのホストと被らないように
server-id               = 10002
# binaly-logの出力
log_bin                 = /var/log/mysql/mysql-bin.log

### 他のサーバホストから接続できるように bind-address をコメントアウト
#bind-address           = 127.0.0.1
 </pre>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EC%A5%D7%A5%EA%A5%B1%A1%BC%A5%B7%A5%E7%A5%F3">レプリケーション</a>用<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>ユーザ作成します。</p>

<pre class="terminal"> mysql&gt; GRANT REPLICATION SLAVE ON *.* TO 'repl'@'%' IDENTIFIED BY '********';
 </pre>


<p>マスターからダンプ取得します。
オプションは環境に応じて必要なものを付け加えてください。</p>

<pre class="terminal"> $ mysqldump -u root -p --single-transaction --master-data=2 [DB名] [テーブル名] | gzip &gt; db2.dump.sql.gz 
 </pre>


<h5>スレーブ側の準備</h5>


<p>設定ファイルを編集します。</p>

<pre class="terminal"> ### バイナリログの設定
# サーバIDはほかのホストと被らないように
server-id               = 20001
log_bin                 = /var/log/mysql/mysql-bin.log

### レプリケーション設定
# クラッシュセーフのための設定
master_info_repository=TABLE
relay_log_info_repository=TABLE
relay_log_recovery=ON
relay_log_purge=ON

### 必要であれば以下を設定 ###
# レプリケーションから除外するDB
replicate-ignore-db=mysql
# レプリケーションするDB
replicate-do-db=hogedb
# レプリケーションから除外するテーブル
replicate-do-table = hogedb.hogetable
 </pre>


<h4>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EC%A5%D7%A5%EA%A5%B1%A1%BC%A5%B7%A5%E7%A5%F3">レプリケーション</a>の開始</h4>


<p>各マスターのデータをスレーブへ持ってきて、スレーブへ各マスターのデータを投入します。</p>

<pre class="terminal"> $ zcat db1.dump.sql.gz | mysql -u root -p [DB名1]
 </pre>


<pre class="terminal"> $ zcat db2.dump.sql.gz | mysql -u root -p [DB名2] 
 </pre>


<p>マスター１との<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EC%A5%D7%A5%EA%A5%B1%A1%BC%A5%B7%A5%E7%A5%F3">レプリケーション</a>を設定を行います。
まず、ダンプデータ取得時点のバイナリログポジションを確認しておきます。</p>

<pre class="terminal"> $ zcat db1.dump.sql.gz  | grep -i "CHANGE MASTER TO"
 </pre>


<p>マスター1との接続設定を行います。
上記で確認したダンプ取得時点のバイナリログファイル名を <code>MASTER_LOG_FILE</code> へ、そのポジションNoを　<code>MASTER_LOG_POS</code> へ指定します。</p>

<pre class="terminal"> mysql&gt; CHANGE MASTER TO MASTER_HOST="192.168.aaa.bbb", MASTER_PORT=3306, MASTER_LOG_FILE="ダンプ取得時点のバイナリログファイル名", MASTER_LOG_POS=ダンプ取得時点のポジションNo, MASTER_USER="repl", MASTER_PASSWORD="salvepass" FOR CHANNEL "master1";
 </pre>


<p>スレーブからマスター1へ<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EC%A5%D7%A5%EA%A5%B1%A1%BC%A5%B7%A5%E7%A5%F3">レプリケーション</a>開始します。</p>

<pre class="terminal"> mysql&gt; start slave for channel "master1";
 </pre>


<p>続いてマスター２の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EC%A5%D7%A5%EA%A5%B1%A1%BC%A5%B7%A5%E7%A5%F3">レプリケーション</a>設定を行います。
ダンプデータ取得時点のバイナリログポジションを確認します。</p>

<pre class="terminal"> $ zcat db2.dump.sql.gz  | grep -i "CHANGE MASTER TO"
 </pre>


<p>マスター2への接続設定を行います。
マスター１の時と同様に、上記で確認したダンプ取得時点のバイナリログファイル名を <code>MASTER_LOG_FILE</code> へ、そのポジションNoを　<code>MASTER_LOG_POS</code> へ指定します。</p>

<pre class="terminal"> mysql&gt; CHANGE MASTER TO MASTER_HOST="192.168.xxx.yyy", MASTER_PORT=3306, MASTER_LOG_FILE="ダンプ取得時点のバイナリログファイル名", MASTER_LOG_POS=ダンプ取得時点のポジションNo, MASTER_USER="repl", MASTER_PASSWORD="salvepass" FOR CHANNEL "master2";
 </pre>


<p>スレーブからマスター1へ<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EC%A5%D7%A5%EA%A5%B1%A1%BC%A5%B7%A5%E7%A5%F3">レプリケーション</a>開始します。</p>

<pre class="terminal"> mysql&gt; start slave for channel "master2";
 </pre>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EC%A5%D7%A5%EA%A5%B1%A1%BC%A5%B7%A5%E7%A5%F3">レプリケーション</a>を確認します。</p>

<pre class="terminal"> mysql&gt; SHOW SLAVE STATUS FOR CHANNEL "master1"\G
 </pre>


<pre class="terminal"> mysql&gt; SHOW SLAVE STATUS FOR CHANNEL "master2"\G
 </pre>


<h4>その他の基本オペレーション</h4>


<p>その他停止、再開、リセットなどの基本的なオペレーション手順は以下です。
<code>for channel</code>句を指定することで特定のマスターとの<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EC%A5%D7%A5%EA%A5%B1%A1%BC%A5%B7%A5%E7%A5%F3">レプリケーション</a>に対してオペレーションできます。</p>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EC%A5%D7%A5%EA%A5%B1%A1%BC%A5%B7%A5%E7%A5%F3">レプリケーション</a>を停止する場合は以下のようにします。</p>

<pre class="terminal"> mysql&gt; stop slave for channel "master1";
 </pre>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EC%A5%D7%A5%EA%A5%B1%A1%BC%A5%B7%A5%E7%A5%F3">レプリケーション</a>を再開するには以下のようにします。</p>

<pre class="terminal"> mysql&gt; start slave for channel "master1";
 </pre>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EC%A5%D7%A5%EA%A5%B1%A1%BC%A5%B7%A5%E7%A5%F3">レプリケーション</a>をリセットするには以下のようにします。</p>

<pre class="terminal"> mysql&gt; reset slave all for channel "master1";
 </pre>


<h3>まとめ</h3>


<p>MySQL5.7.6～で実装された新機能マルチソース<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EC%A5%D7%A5%EA%A5%B1%A1%BC%A5%B7%A5%E7%A5%F3">レプリケーション</a>の設定手順について書きました。
マルチソース<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EC%A5%D7%A5%EA%A5%B1%A1%BC%A5%B7%A5%E7%A5%F3">レプリケーション</a>を使うことで、分析のために複数のDBのデータを集約する、しャーディングされているデータの統合や他にも何か活用方法がありそうなので、いろいろ試してみたいと思います。</p>

<h3>参考</h3>


<ul>
    <li><a href="https://dev.mysql.com/doc/refman/5.7/en/replication-multi-source.html" target="_blank" rel="noopener noreferrer">MySQL :: MySQL 5.7 Reference Manual :: 16.1.4 MySQL Multi-Source Replication</a></li>
    <li><a href="https://nullpopopo.blogcube.info/2015/10/mysql-5-7-multi-source-replication.html" target="_blank" rel="noopener noreferrer">[MySQL5.7]マルチソースレプリケーション設定方法 – (っ´∀｀)っ ゃー | nullpopopo</a></li>
</ul>

</body>
